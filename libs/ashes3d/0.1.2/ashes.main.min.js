/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/ashes3d@0.1.2/build/ashes.main.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).Ashes={})}(this,function(t){"use strict";class e{constructor(t,e,r=2,a=2,i=0){this.channel=null,this.isDirty=!0,this.glType=WebGL2RenderingContext.TEXTURE_2D,this.isCubetex=!1,this.data=null,this.level=0,this.internalformat=WebGL2RenderingContext.RGBA,this.format=WebGL2RenderingContext.RGBA,this.type=WebGL2RenderingContext.UNSIGNED_BYTE,this.flipY=!1,this.sampler=new n(e),this.image=t,this.width=r,this.height=a,this.border=i,t&&6==t.length&&(this.isCubetex=!0,this.glType=WebGL2RenderingContext.TEXTURE_CUBE_MAP)}static clone(t){let n=new e(t.image,t.sampler);return n.sampler=t.sampler,n.flipY=t.flipY,n}static createTexture(t,e){if(e.sampler.texture&&t.deleteTexture(e.sampler.texture),e.sampler.texture=t.createTexture(),t.bindTexture(e.glType,e.sampler.texture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY?1:0),e.isCubetex)for(let n in this.cubetexOrder)t.texImage2D(this.cubetexOrder[n],e.level,e.internalformat,e.format,e.type,e.image[n]);else e.image?t.texImage2D(e.glType,e.level,e.internalformat,e.format,e.type,e.image):(t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.texImage2D(e.glType,e.level,e.internalformat,e.width,e.height,e.border,e.format,e.type,e.data));t.texParameterf(e.glType,t.TEXTURE_WRAP_S,e.sampler.wrapS),t.texParameterf(e.glType,t.TEXTURE_WRAP_T,e.sampler.wrapT),e.sampler.minFilter==WebGL2RenderingContext.NEAREST_MIPMAP_NEAREST||e.sampler.minFilter==WebGL2RenderingContext.NEAREST_MIPMAP_LINEAR||e.sampler.minFilter==WebGL2RenderingContext.LINEAR_MIPMAP_NEAREST||e.sampler.minFilter==WebGL2RenderingContext.LINEAR_MIPMAP_LINEAR?t.generateMipmap(e.glType):(t.texParameterf(e.glType,t.TEXTURE_MIN_FILTER,e.sampler.minFilter),t.texParameterf(e.glType,t.TEXTURE_MAG_FILTER,e.sampler.magFilter)),t.bindTexture(e.glType,null)}static unbindTexture(t,e){null!=e.channel&&t.activeTexture(this.texChannels[e.channel]),t.bindTexture(e.glType,null)}static bindTexture(t,e){null!=e.channel&&t.activeTexture(this.texChannels[e.channel]),(null==e.sampler.texture||e.isDirty&&(e.data||e.image))&&this.createTexture(t,e),t.bindTexture(e.glType,e.sampler.texture)}}e.defaultData=new Uint8Array([1,1,1,1,1,.5,.4,1,.4,.5,1,1,1,1,1,1].map(t=>255*t)),e.cubetexOrder=[WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_X,WebGL2RenderingContext.TEXTURE_CUBE_MAP_NEGATIVE_X,WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_Y,WebGL2RenderingContext.TEXTURE_CUBE_MAP_NEGATIVE_Y,WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_Z,WebGL2RenderingContext.TEXTURE_CUBE_MAP_NEGATIVE_Z],e.texChannels=[WebGL2RenderingContext.TEXTURE0,WebGL2RenderingContext.TEXTURE1,WebGL2RenderingContext.TEXTURE2,WebGL2RenderingContext.TEXTURE3,WebGL2RenderingContext.TEXTURE4,WebGL2RenderingContext.TEXTURE5,WebGL2RenderingContext.TEXTURE6,WebGL2RenderingContext.TEXTURE7];class n{constructor({magFilter:t=WebGL2RenderingContext.NEAREST,minFilter:e=WebGL2RenderingContext.NEAREST,wrapS:n=10497,wrapT:r=10497,texture:a=null}={magFilter:WebGL2RenderingContext.NEAREST,minFilter:WebGL2RenderingContext.NEAREST,wrapS:10497,wrapT:10497,texture:null}){this.texture=null,this.magFilter=t,this.minFilter=e,this.wrapS=n,this.wrapT=r,this.texture=a}}var r=1e-6,a="undefined"!=typeof Float32Array?Float32Array:Array,i=Math.random;Math.PI;function s(){var t=new a(16);return a!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function o(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function l(t,e,n,r,a,i,s,o,l,c,u,h,f,d,m,p,v){return t[0]=e,t[1]=n,t[2]=r,t[3]=a,t[4]=i,t[5]=s,t[6]=o,t[7]=l,t[8]=c,t[9]=u,t[10]=h,t[11]=f,t[12]=d,t[13]=m,t[14]=p,t[15]=v,t}function c(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function u(t,e){if(t===e){var n=e[1],r=e[2],a=e[3],i=e[6],s=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=i,t[11]=e[14],t[12]=a,t[13]=s,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function h(t,e){var n=e[0],r=e[1],a=e[2],i=e[3],s=e[4],o=e[5],l=e[6],c=e[7],u=e[8],h=e[9],f=e[10],d=e[11],m=e[12],p=e[13],v=e[14],g=e[15],b=n*o-r*s,M=n*l-a*s,T=n*c-i*s,x=r*l-a*o,A=r*c-i*o,E=a*c-i*l,C=u*p-h*m,w=u*v-f*m,y=u*g-d*m,_=h*v-f*p,R=h*g-d*p,S=f*g-d*v,O=b*S-M*R+T*_+x*y-A*w+E*C;return O?(O=1/O,t[0]=(o*S-l*R+c*_)*O,t[1]=(a*R-r*S-i*_)*O,t[2]=(p*E-v*A+g*x)*O,t[3]=(f*A-h*E-d*x)*O,t[4]=(l*y-s*S-c*w)*O,t[5]=(n*S-a*y+i*w)*O,t[6]=(v*T-m*E-g*M)*O,t[7]=(u*E-f*T+d*M)*O,t[8]=(s*R-o*y+c*C)*O,t[9]=(r*y-n*R-i*C)*O,t[10]=(m*A-p*T+g*b)*O,t[11]=(h*T-u*A-d*b)*O,t[12]=(o*w-s*_-l*C)*O,t[13]=(n*_-r*w+a*C)*O,t[14]=(p*M-m*x-v*b)*O,t[15]=(u*x-h*M+f*b)*O,t):null}function f(t){var e=t[0],n=t[1],r=t[2],a=t[3],i=t[4],s=t[5],o=t[6],l=t[7],c=t[8],u=t[9],h=t[10],f=t[11],d=t[12],m=t[13],p=t[14],v=t[15];return(e*s-n*i)*(h*v-f*p)-(e*o-r*i)*(u*v-f*m)+(e*l-a*i)*(u*p-h*m)+(n*o-r*s)*(c*v-f*d)-(n*l-a*s)*(c*p-h*d)+(r*l-a*o)*(c*m-u*d)}function d(t,e,n){var r=e[0],a=e[1],i=e[2],s=e[3],o=e[4],l=e[5],c=e[6],u=e[7],h=e[8],f=e[9],d=e[10],m=e[11],p=e[12],v=e[13],g=e[14],b=e[15],M=n[0],T=n[1],x=n[2],A=n[3];return t[0]=M*r+T*o+x*h+A*p,t[1]=M*a+T*l+x*f+A*v,t[2]=M*i+T*c+x*d+A*g,t[3]=M*s+T*u+x*m+A*b,M=n[4],T=n[5],x=n[6],A=n[7],t[4]=M*r+T*o+x*h+A*p,t[5]=M*a+T*l+x*f+A*v,t[6]=M*i+T*c+x*d+A*g,t[7]=M*s+T*u+x*m+A*b,M=n[8],T=n[9],x=n[10],A=n[11],t[8]=M*r+T*o+x*h+A*p,t[9]=M*a+T*l+x*f+A*v,t[10]=M*i+T*c+x*d+A*g,t[11]=M*s+T*u+x*m+A*b,M=n[12],T=n[13],x=n[14],A=n[15],t[12]=M*r+T*o+x*h+A*p,t[13]=M*a+T*l+x*f+A*v,t[14]=M*i+T*c+x*d+A*g,t[15]=M*s+T*u+x*m+A*b,t}function m(t,e,n){var r=e[0],a=e[1],i=e[2],s=e[3],o=r+r,l=a+a,c=i+i,u=r*o,h=r*l,f=r*c,d=a*l,m=a*c,p=i*c,v=s*o,g=s*l,b=s*c;return t[0]=1-(d+p),t[1]=h+b,t[2]=f-g,t[3]=0,t[4]=h-b,t[5]=1-(u+p),t[6]=m+v,t[7]=0,t[8]=f+g,t[9]=m-v,t[10]=1-(u+d),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function p(t,e){var n=e[0]+e[5]+e[10],r=0;return n>0?(r=2*Math.sqrt(n+1),t[3]=.25*r,t[0]=(e[6]-e[9])/r,t[1]=(e[8]-e[2])/r,t[2]=(e[1]-e[4])/r):e[0]>e[5]&&e[0]>e[10]?(r=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/r,t[0]=.25*r,t[1]=(e[1]+e[4])/r,t[2]=(e[8]+e[2])/r):e[5]>e[10]?(r=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/r,t[0]=(e[1]+e[4])/r,t[1]=.25*r,t[2]=(e[6]+e[9])/r):(r=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/r,t[0]=(e[8]+e[2])/r,t[1]=(e[6]+e[9])/r,t[2]=.25*r),t}function v(t,e,n,r){var a=e[0],i=e[1],s=e[2],o=e[3],l=a+a,c=i+i,u=s+s,h=a*l,f=a*c,d=a*u,m=i*c,p=i*u,v=s*u,g=o*l,b=o*c,M=o*u,T=r[0],x=r[1],A=r[2];return t[0]=(1-(m+v))*T,t[1]=(f+M)*T,t[2]=(d-b)*T,t[3]=0,t[4]=(f-M)*x,t[5]=(1-(h+v))*x,t[6]=(p+g)*x,t[7]=0,t[8]=(d+b)*A,t[9]=(p-g)*A,t[10]=(1-(h+m))*A,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function g(t,e,n,r,a){var i=1/Math.tan(e/2),s=void 0;return t[0]=i/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=a&&a!==1/0?(s=1/(r-a),t[10]=(a+r)*s,t[14]=2*a*r*s):(t[10]=-1,t[14]=-2*r),t}function b(t,e,n,a){var i=void 0,s=void 0,o=void 0,l=void 0,u=void 0,h=void 0,f=void 0,d=void 0,m=void 0,p=void 0,v=e[0],g=e[1],b=e[2],M=a[0],T=a[1],x=a[2],A=n[0],E=n[1],C=n[2];return Math.abs(v-A)<r&&Math.abs(g-E)<r&&Math.abs(b-C)<r?c(t):(f=v-A,d=g-E,m=b-C,i=T*(m*=p=1/Math.sqrt(f*f+d*d+m*m))-x*(d*=p),s=x*(f*=p)-M*m,o=M*d-T*f,(p=Math.sqrt(i*i+s*s+o*o))?(i*=p=1/p,s*=p,o*=p):(i=0,s=0,o=0),l=d*o-m*s,u=m*i-f*o,h=f*s-d*i,(p=Math.sqrt(l*l+u*u+h*h))?(l*=p=1/p,u*=p,h*=p):(l=0,u=0,h=0),t[0]=i,t[1]=l,t[2]=f,t[3]=0,t[4]=s,t[5]=u,t[6]=d,t[7]=0,t[8]=o,t[9]=h,t[10]=m,t[11]=0,t[12]=-(i*v+s*g+o*b),t[13]=-(l*v+u*g+h*b),t[14]=-(f*v+d*g+m*b),t[15]=1,t)}function M(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}var T=d,x=M,A=Object.freeze({create:s,clone:function(t){var e=new a(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:o,fromValues:function(t,e,n,r,i,s,o,l,c,u,h,f,d,m,p,v){var g=new a(16);return g[0]=t,g[1]=e,g[2]=n,g[3]=r,g[4]=i,g[5]=s,g[6]=o,g[7]=l,g[8]=c,g[9]=u,g[10]=h,g[11]=f,g[12]=d,g[13]=m,g[14]=p,g[15]=v,g},set:l,identity:c,transpose:u,invert:h,adjoint:function(t,e){var n=e[0],r=e[1],a=e[2],i=e[3],s=e[4],o=e[5],l=e[6],c=e[7],u=e[8],h=e[9],f=e[10],d=e[11],m=e[12],p=e[13],v=e[14],g=e[15];return t[0]=o*(f*g-d*v)-h*(l*g-c*v)+p*(l*d-c*f),t[1]=-(r*(f*g-d*v)-h*(a*g-i*v)+p*(a*d-i*f)),t[2]=r*(l*g-c*v)-o*(a*g-i*v)+p*(a*c-i*l),t[3]=-(r*(l*d-c*f)-o*(a*d-i*f)+h*(a*c-i*l)),t[4]=-(s*(f*g-d*v)-u*(l*g-c*v)+m*(l*d-c*f)),t[5]=n*(f*g-d*v)-u*(a*g-i*v)+m*(a*d-i*f),t[6]=-(n*(l*g-c*v)-s*(a*g-i*v)+m*(a*c-i*l)),t[7]=n*(l*d-c*f)-s*(a*d-i*f)+u*(a*c-i*l),t[8]=s*(h*g-d*p)-u*(o*g-c*p)+m*(o*d-c*h),t[9]=-(n*(h*g-d*p)-u*(r*g-i*p)+m*(r*d-i*h)),t[10]=n*(o*g-c*p)-s*(r*g-i*p)+m*(r*c-i*o),t[11]=-(n*(o*d-c*h)-s*(r*d-i*h)+u*(r*c-i*o)),t[12]=-(s*(h*v-f*p)-u*(o*v-l*p)+m*(o*f-l*h)),t[13]=n*(h*v-f*p)-u*(r*v-a*p)+m*(r*f-a*h),t[14]=-(n*(o*v-l*p)-s*(r*v-a*p)+m*(r*l-a*o)),t[15]=n*(o*f-l*h)-s*(r*f-a*h)+u*(r*l-a*o),t},determinant:f,multiply:d,translate:function(t,e,n){var r=n[0],a=n[1],i=n[2],s=void 0,o=void 0,l=void 0,c=void 0,u=void 0,h=void 0,f=void 0,d=void 0,m=void 0,p=void 0,v=void 0,g=void 0;return e===t?(t[12]=e[0]*r+e[4]*a+e[8]*i+e[12],t[13]=e[1]*r+e[5]*a+e[9]*i+e[13],t[14]=e[2]*r+e[6]*a+e[10]*i+e[14],t[15]=e[3]*r+e[7]*a+e[11]*i+e[15]):(s=e[0],o=e[1],l=e[2],c=e[3],u=e[4],h=e[5],f=e[6],d=e[7],m=e[8],p=e[9],v=e[10],g=e[11],t[0]=s,t[1]=o,t[2]=l,t[3]=c,t[4]=u,t[5]=h,t[6]=f,t[7]=d,t[8]=m,t[9]=p,t[10]=v,t[11]=g,t[12]=s*r+u*a+m*i+e[12],t[13]=o*r+h*a+p*i+e[13],t[14]=l*r+f*a+v*i+e[14],t[15]=c*r+d*a+g*i+e[15]),t},scale:function(t,e,n){var r=n[0],a=n[1],i=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*a,t[5]=e[5]*a,t[6]=e[6]*a,t[7]=e[7]*a,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rotate:function(t,e,n,a){var i,s,o,l,c,u,h,f,d,m,p,v,g,b,M,T,x,A,E,C,w,y,_,R,S=a[0],O=a[1],L=a[2],I=Math.sqrt(S*S+O*O+L*L);return I<r?null:(S*=I=1/I,O*=I,L*=I,i=Math.sin(n),o=1-(s=Math.cos(n)),l=e[0],c=e[1],u=e[2],h=e[3],f=e[4],d=e[5],m=e[6],p=e[7],v=e[8],g=e[9],b=e[10],M=e[11],T=S*S*o+s,x=O*S*o+L*i,A=L*S*o-O*i,E=S*O*o-L*i,C=O*O*o+s,w=L*O*o+S*i,y=S*L*o+O*i,_=O*L*o-S*i,R=L*L*o+s,t[0]=l*T+f*x+v*A,t[1]=c*T+d*x+g*A,t[2]=u*T+m*x+b*A,t[3]=h*T+p*x+M*A,t[4]=l*E+f*C+v*w,t[5]=c*E+d*C+g*w,t[6]=u*E+m*C+b*w,t[7]=h*E+p*C+M*w,t[8]=l*y+f*_+v*R,t[9]=c*y+d*_+g*R,t[10]=u*y+m*_+b*R,t[11]=h*y+p*_+M*R,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},rotateX:function(t,e,n){var r=Math.sin(n),a=Math.cos(n),i=e[4],s=e[5],o=e[6],l=e[7],c=e[8],u=e[9],h=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=i*a+c*r,t[5]=s*a+u*r,t[6]=o*a+h*r,t[7]=l*a+f*r,t[8]=c*a-i*r,t[9]=u*a-s*r,t[10]=h*a-o*r,t[11]=f*a-l*r,t},rotateY:function(t,e,n){var r=Math.sin(n),a=Math.cos(n),i=e[0],s=e[1],o=e[2],l=e[3],c=e[8],u=e[9],h=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*a-c*r,t[1]=s*a-u*r,t[2]=o*a-h*r,t[3]=l*a-f*r,t[8]=i*r+c*a,t[9]=s*r+u*a,t[10]=o*r+h*a,t[11]=l*r+f*a,t},rotateZ:function(t,e,n){var r=Math.sin(n),a=Math.cos(n),i=e[0],s=e[1],o=e[2],l=e[3],c=e[4],u=e[5],h=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*a+c*r,t[1]=s*a+u*r,t[2]=o*a+h*r,t[3]=l*a+f*r,t[4]=c*a-i*r,t[5]=u*a-s*r,t[6]=h*a-o*r,t[7]=f*a-l*r,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotation:function(t,e,n){var a,i,s,o=n[0],l=n[1],c=n[2],u=Math.sqrt(o*o+l*l+c*c);return u<r?null:(o*=u=1/u,l*=u,c*=u,a=Math.sin(e),s=1-(i=Math.cos(e)),t[0]=o*o*s+i,t[1]=l*o*s+c*a,t[2]=c*o*s-l*a,t[3]=0,t[4]=o*l*s-c*a,t[5]=l*l*s+i,t[6]=c*l*s+o*a,t[7]=0,t[8]=o*c*s+l*a,t[9]=l*c*s-o*a,t[10]=c*c*s+i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotationTranslation:m,fromQuat2:function(t,e){var n=new a(3),r=-e[0],i=-e[1],s=-e[2],o=e[3],l=e[4],c=e[5],u=e[6],h=e[7],f=r*r+i*i+s*s+o*o;return f>0?(n[0]=2*(l*o+h*r+c*s-u*i)/f,n[1]=2*(c*o+h*i+u*r-l*s)/f,n[2]=2*(u*o+h*s+l*i-c*r)/f):(n[0]=2*(l*o+h*r+c*s-u*i),n[1]=2*(c*o+h*i+u*r-l*s),n[2]=2*(u*o+h*s+l*i-c*r)),m(t,e,n),t},getTranslation:function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},getScaling:function(t,e){var n=e[0],r=e[1],a=e[2],i=e[4],s=e[5],o=e[6],l=e[8],c=e[9],u=e[10];return t[0]=Math.sqrt(n*n+r*r+a*a),t[1]=Math.sqrt(i*i+s*s+o*o),t[2]=Math.sqrt(l*l+c*c+u*u),t},getRotation:p,fromRotationTranslationScale:v,fromRotationTranslationScaleOrigin:function(t,e,n,r,a){var i=e[0],s=e[1],o=e[2],l=e[3],c=i+i,u=s+s,h=o+o,f=i*c,d=i*u,m=i*h,p=s*u,v=s*h,g=o*h,b=l*c,M=l*u,T=l*h,x=r[0],A=r[1],E=r[2],C=a[0],w=a[1],y=a[2],_=(1-(p+g))*x,R=(d+T)*x,S=(m-M)*x,O=(d-T)*A,L=(1-(f+g))*A,I=(v+b)*A,N=(m+M)*E,P=(v-b)*E,F=(1-(f+p))*E;return t[0]=_,t[1]=R,t[2]=S,t[3]=0,t[4]=O,t[5]=L,t[6]=I,t[7]=0,t[8]=N,t[9]=P,t[10]=F,t[11]=0,t[12]=n[0]+C-(_*C+O*w+N*y),t[13]=n[1]+w-(R*C+L*w+P*y),t[14]=n[2]+y-(S*C+I*w+F*y),t[15]=1,t},fromQuat:function(t,e){var n=e[0],r=e[1],a=e[2],i=e[3],s=n+n,o=r+r,l=a+a,c=n*s,u=r*s,h=r*o,f=a*s,d=a*o,m=a*l,p=i*s,v=i*o,g=i*l;return t[0]=1-h-m,t[1]=u+g,t[2]=f-v,t[3]=0,t[4]=u-g,t[5]=1-c-m,t[6]=d+p,t[7]=0,t[8]=f+v,t[9]=d-p,t[10]=1-c-h,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,n,r,a,i,s){var o=1/(n-e),l=1/(a-r),c=1/(i-s);return t[0]=2*i*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*i*l,t[6]=0,t[7]=0,t[8]=(n+e)*o,t[9]=(a+r)*l,t[10]=(s+i)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=s*i*2*c,t[15]=0,t},perspective:g,perspectiveFromFieldOfView:function(t,e,n,r){var a=Math.tan(e.upDegrees*Math.PI/180),i=Math.tan(e.downDegrees*Math.PI/180),s=Math.tan(e.leftDegrees*Math.PI/180),o=Math.tan(e.rightDegrees*Math.PI/180),l=2/(s+o),c=2/(a+i);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(s-o)*l*.5,t[9]=(a-i)*c*.5,t[10]=r/(n-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*n/(n-r),t[15]=0,t},ortho:function(t,e,n,r,a,i,s){var o=1/(e-n),l=1/(r-a),c=1/(i-s);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+n)*o,t[13]=(a+r)*l,t[14]=(s+i)*c,t[15]=1,t},lookAt:b,targetTo:function(t,e,n,r){var a=e[0],i=e[1],s=e[2],o=r[0],l=r[1],c=r[2],u=a-n[0],h=i-n[1],f=s-n[2],d=u*u+h*h+f*f;d>0&&(u*=d=1/Math.sqrt(d),h*=d,f*=d);var m=l*f-c*h,p=c*u-o*f,v=o*h-l*u;return(d=m*m+p*p+v*v)>0&&(m*=d=1/Math.sqrt(d),p*=d,v*=d),t[0]=m,t[1]=p,t[2]=v,t[3]=0,t[4]=h*v-f*p,t[5]=f*m-u*v,t[6]=u*p-h*m,t[7]=0,t[8]=u,t[9]=h,t[10]=f,t[11]=0,t[12]=a,t[13]=i,t[14]=s,t[15]=1,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t},subtract:M,multiplyScalar:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t},multiplyScalarAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t[9]=e[9]+n[9]*r,t[10]=e[10]+n[10]*r,t[11]=e[11]+n[11]*r,t[12]=e[12]+n[12]*r,t[13]=e[13]+n[13]*r,t[14]=e[14]+n[14]*r,t[15]=e[15]+n[15]*r,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},equals:function(t,e){var n=t[0],a=t[1],i=t[2],s=t[3],o=t[4],l=t[5],c=t[6],u=t[7],h=t[8],f=t[9],d=t[10],m=t[11],p=t[12],v=t[13],g=t[14],b=t[15],M=e[0],T=e[1],x=e[2],A=e[3],E=e[4],C=e[5],w=e[6],y=e[7],_=e[8],R=e[9],S=e[10],O=e[11],L=e[12],I=e[13],N=e[14],P=e[15];return Math.abs(n-M)<=r*Math.max(1,Math.abs(n),Math.abs(M))&&Math.abs(a-T)<=r*Math.max(1,Math.abs(a),Math.abs(T))&&Math.abs(i-x)<=r*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(s-A)<=r*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(o-E)<=r*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-C)<=r*Math.max(1,Math.abs(l),Math.abs(C))&&Math.abs(c-w)<=r*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(u-y)<=r*Math.max(1,Math.abs(u),Math.abs(y))&&Math.abs(h-_)<=r*Math.max(1,Math.abs(h),Math.abs(_))&&Math.abs(f-R)<=r*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(d-S)<=r*Math.max(1,Math.abs(d),Math.abs(S))&&Math.abs(m-O)<=r*Math.max(1,Math.abs(m),Math.abs(O))&&Math.abs(p-L)<=r*Math.max(1,Math.abs(p),Math.abs(L))&&Math.abs(v-I)<=r*Math.max(1,Math.abs(v),Math.abs(I))&&Math.abs(g-N)<=r*Math.max(1,Math.abs(g),Math.abs(N))&&Math.abs(b-P)<=r*Math.max(1,Math.abs(b),Math.abs(P))},mul:T,sub:x});function E(){var t=new a(3);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function C(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function w(t,e,n){var r=new a(3);return r[0]=t,r[1]=e,r[2]=n,r}function y(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function _(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function R(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function S(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function O(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function L(t,e){var n=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+r*r+a*a)}function I(t,e){var n=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2];return n*n+r*r+a*a}function N(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}function P(t,e){var n=e[0],r=e[1],a=e[2],i=n*n+r*r+a*a;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i),t}function F(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function D(t,e,n){var r=e[0],a=e[1],i=e[2],s=n[0],o=n[1],l=n[2];return t[0]=a*l-i*o,t[1]=i*s-r*l,t[2]=r*o-a*s,t}function G(t,e,n,r){var a=e[0],i=e[1],s=e[2];return t[0]=a+r*(n[0]-a),t[1]=i+r*(n[1]-i),t[2]=s+r*(n[2]-s),t}function V(t,e,n){var r=e[0],a=e[1],i=e[2],s=n[3]*r+n[7]*a+n[11]*i+n[15];return s=s||1,t[0]=(n[0]*r+n[4]*a+n[8]*i+n[12])/s,t[1]=(n[1]*r+n[5]*a+n[9]*i+n[13])/s,t[2]=(n[2]*r+n[6]*a+n[10]*i+n[14])/s,t}var U,H=R,W=S,B=O,k=L,q=I,X=C,z=N,j=(U=E(),function(t,e,n,r,a,i){var s=void 0,o=void 0;for(e||(e=3),n||(n=0),o=r?Math.min(r*e+n,t.length):t.length,s=n;s<o;s+=e)U[0]=t[s],U[1]=t[s+1],U[2]=t[s+2],a(U,U,i),t[s]=U[0],t[s+1]=U[1],t[s+2]=U[2];return t}),Y=Object.freeze({create:E,clone:function(t){var e=new a(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:C,fromValues:w,copy:y,set:_,add:function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t},subtract:R,multiply:S,divide:O,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t},distance:L,squaredDistance:I,squaredLength:N,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:P,dot:F,cross:D,lerp:G,hermite:function(t,e,n,r,a,i){var s=i*i,o=s*(2*i-3)+1,l=s*(i-2)+i,c=s*(i-1),u=s*(3-2*i);return t[0]=e[0]*o+n[0]*l+r[0]*c+a[0]*u,t[1]=e[1]*o+n[1]*l+r[1]*c+a[1]*u,t[2]=e[2]*o+n[2]*l+r[2]*c+a[2]*u,t},bezier:function(t,e,n,r,a,i){var s=1-i,o=s*s,l=i*i,c=o*s,u=3*i*o,h=3*l*s,f=l*i;return t[0]=e[0]*c+n[0]*u+r[0]*h+a[0]*f,t[1]=e[1]*c+n[1]*u+r[1]*h+a[1]*f,t[2]=e[2]*c+n[2]*u+r[2]*h+a[2]*f,t},random:function(t,e){e=e||1;var n=2*i()*Math.PI,r=2*i()-1,a=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*a,t[1]=Math.sin(n)*a,t[2]=r*e,t},transformMat4:V,transformMat3:function(t,e,n){var r=e[0],a=e[1],i=e[2];return t[0]=r*n[0]+a*n[3]+i*n[6],t[1]=r*n[1]+a*n[4]+i*n[7],t[2]=r*n[2]+a*n[5]+i*n[8],t},transformQuat:function(t,e,n){var r=n[0],a=n[1],i=n[2],s=n[3],o=e[0],l=e[1],c=e[2],u=a*c-i*l,h=i*o-r*c,f=r*l-a*o,d=a*f-i*h,m=i*u-r*f,p=r*h-a*u,v=2*s;return u*=v,h*=v,f*=v,d*=2,m*=2,p*=2,t[0]=o+u+d,t[1]=l+h+m,t[2]=c+f+p,t},rotateX:function(t,e,n,r){var a=[],i=[];return a[0]=e[0]-n[0],a[1]=e[1]-n[1],a[2]=e[2]-n[2],i[0]=a[0],i[1]=a[1]*Math.cos(r)-a[2]*Math.sin(r),i[2]=a[1]*Math.sin(r)+a[2]*Math.cos(r),t[0]=i[0]+n[0],t[1]=i[1]+n[1],t[2]=i[2]+n[2],t},rotateY:function(t,e,n,r){var a=[],i=[];return a[0]=e[0]-n[0],a[1]=e[1]-n[1],a[2]=e[2]-n[2],i[0]=a[2]*Math.sin(r)+a[0]*Math.cos(r),i[1]=a[1],i[2]=a[2]*Math.cos(r)-a[0]*Math.sin(r),t[0]=i[0]+n[0],t[1]=i[1]+n[1],t[2]=i[2]+n[2],t},rotateZ:function(t,e,n,r){var a=[],i=[];return a[0]=e[0]-n[0],a[1]=e[1]-n[1],a[2]=e[2]-n[2],i[0]=a[0]*Math.cos(r)-a[1]*Math.sin(r),i[1]=a[0]*Math.sin(r)+a[1]*Math.cos(r),i[2]=a[2],t[0]=i[0]+n[0],t[1]=i[1]+n[1],t[2]=i[2]+n[2],t},angle:function(t,e){var n=w(t[0],t[1],t[2]),r=w(e[0],e[1],e[2]);P(n,n),P(r,r);var a=F(n,r);return a>1?0:a<-1?Math.PI:Math.acos(a)},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,e){var n=t[0],a=t[1],i=t[2],s=e[0],o=e[1],l=e[2];return Math.abs(n-s)<=r*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(a-o)<=r*Math.max(1,Math.abs(a),Math.abs(o))&&Math.abs(i-l)<=r*Math.max(1,Math.abs(i),Math.abs(l))},sub:H,mul:W,div:B,dist:k,sqrDist:q,len:X,sqrLen:z,forEach:j});function $(){var t=new a(4);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Q(t){var e=new a(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Z(t,e,n,r){var i=new a(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i}function J(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function K(t,e,n,r,a){return t[0]=e,t[1]=n,t[2]=r,t[3]=a,t}function tt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function et(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function nt(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function rt(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function at(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function it(t,e){var n=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2],i=e[3]-t[3];return Math.sqrt(n*n+r*r+a*a+i*i)}function st(t,e){var n=e[0]-t[0],r=e[1]-t[1],a=e[2]-t[2],i=e[3]-t[3];return n*n+r*r+a*a+i*i}function ot(t){var e=t[0],n=t[1],r=t[2],a=t[3];return Math.sqrt(e*e+n*n+r*r+a*a)}function lt(t){var e=t[0],n=t[1],r=t[2],a=t[3];return e*e+n*n+r*r+a*a}function ct(t,e){var n=e[0],r=e[1],a=e[2],i=e[3],s=n*n+r*r+a*a+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=n*s,t[1]=r*s,t[2]=a*s,t[3]=i*s),t}function ut(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function ht(t,e,n,r){var a=e[0],i=e[1],s=e[2],o=e[3];return t[0]=a+r*(n[0]-a),t[1]=i+r*(n[1]-i),t[2]=s+r*(n[2]-s),t[3]=o+r*(n[3]-o),t}function ft(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function dt(t,e){var n=t[0],a=t[1],i=t[2],s=t[3],o=e[0],l=e[1],c=e[2],u=e[3];return Math.abs(n-o)<=r*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(a-l)<=r*Math.max(1,Math.abs(a),Math.abs(l))&&Math.abs(i-c)<=r*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-u)<=r*Math.max(1,Math.abs(s),Math.abs(u))}var mt=et,pt=nt,vt=rt,gt=it,bt=st,Mt=ot,Tt=lt,xt=function(){var t=$();return function(e,n,r,a,i,s){var o=void 0,l=void 0;for(n||(n=4),r||(r=0),l=a?Math.min(a*n+r,e.length):e.length,o=r;o<l;o+=n)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],t[3]=e[o+3],i(t,t,s),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2],e[o+3]=t[3];return e}}(),At=Object.freeze({create:$,clone:Q,fromValues:Z,copy:J,set:K,add:tt,subtract:et,multiply:nt,divide:rt,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t},max:function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:at,scaleAndAdd:function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t},distance:it,squaredDistance:st,length:ot,squaredLength:lt,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:ct,dot:ut,lerp:ht,random:function(t,e){var n,r,a,s,o,l;e=e||1;do{o=(n=2*i()-1)*n+(r=2*i()-1)*r}while(o>=1);do{l=(a=2*i()-1)*a+(s=2*i()-1)*s}while(l>=1);var c=Math.sqrt((1-o)/l);return t[0]=e*n,t[1]=e*r,t[2]=e*a*c,t[3]=e*s*c,t},transformMat4:function(t,e,n){var r=e[0],a=e[1],i=e[2],s=e[3];return t[0]=n[0]*r+n[4]*a+n[8]*i+n[12]*s,t[1]=n[1]*r+n[5]*a+n[9]*i+n[13]*s,t[2]=n[2]*r+n[6]*a+n[10]*i+n[14]*s,t[3]=n[3]*r+n[7]*a+n[11]*i+n[15]*s,t},transformQuat:function(t,e,n){var r=e[0],a=e[1],i=e[2],s=n[0],o=n[1],l=n[2],c=n[3],u=c*r+o*i-l*a,h=c*a+l*r-s*i,f=c*i+s*a-o*r,d=-s*r-o*a-l*i;return t[0]=u*c+d*-s+h*-l-f*-o,t[1]=h*c+d*-o+f*-s-u*-l,t[2]=f*c+d*-l+u*-o-h*-s,t[3]=e[3],t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:ft,equals:dt,sub:mt,mul:pt,div:vt,dist:gt,sqrDist:bt,len:Mt,sqrLen:Tt,forEach:xt});function Et(){var t=new a(4);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Ct(t,e,n){n*=.5;var r=Math.sin(n);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(n),t}function wt(t,e,n){var r=e[0],a=e[1],i=e[2],s=e[3],o=n[0],l=n[1],c=n[2],u=n[3];return t[0]=r*u+s*o+a*c-i*l,t[1]=a*u+s*l+i*o-r*c,t[2]=i*u+s*c+r*l-a*o,t[3]=s*u-r*o-a*l-i*c,t}function yt(t,e,n,a){var i=e[0],s=e[1],o=e[2],l=e[3],c=n[0],u=n[1],h=n[2],f=n[3],d=void 0,m=void 0,p=void 0,v=void 0,g=void 0;return(m=i*c+s*u+o*h+l*f)<0&&(m=-m,c=-c,u=-u,h=-h,f=-f),1-m>r?(d=Math.acos(m),p=Math.sin(d),v=Math.sin((1-a)*d)/p,g=Math.sin(a*d)/p):(v=1-a,g=a),t[0]=v*i+g*c,t[1]=v*s+g*u,t[2]=v*o+g*h,t[3]=v*l+g*f,t}function _t(t,e){var n=e[0]+e[4]+e[8],r=void 0;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var a=0;e[4]>e[0]&&(a=1),e[8]>e[3*a+a]&&(a=2);var i=(a+1)%3,s=(a+2)%3;r=Math.sqrt(e[3*a+a]-e[3*i+i]-e[3*s+s]+1),t[a]=.5*r,r=.5/r,t[3]=(e[3*i+s]-e[3*s+i])*r,t[i]=(e[3*i+a]+e[3*a+i])*r,t[s]=(e[3*s+a]+e[3*a+s])*r}return t}var Rt,St,Ot,Lt,It,Nt,Pt,Ft=Q,Dt=Z,Gt=J,Vt=K,Ut=tt,Ht=wt,Wt=at,Bt=ut,kt=ht,qt=ot,Xt=qt,zt=lt,jt=zt,Yt=ct,$t=ft,Qt=dt,Zt=(Rt=E(),St=w(1,0,0),Ot=w(0,1,0),function(t,e,n){var r=F(e,n);return r<-.999999?(D(Rt,St,e),X(Rt)<1e-6&&D(Rt,Ot,e),P(Rt,Rt),Ct(t,Rt,Math.PI),t):r>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(D(Rt,e,n),t[0]=Rt[0],t[1]=Rt[1],t[2]=Rt[2],t[3]=1+r,Yt(t,t))}),Jt=(Lt=Et(),It=Et(),function(t,e,n,r,a,i){return yt(Lt,e,a,i),yt(It,n,r,i),yt(t,Lt,It,2*i*(1-i)),t}),Kt=(Nt=new a(9),a!=Float32Array&&(Nt[1]=0,Nt[2]=0,Nt[3]=0,Nt[5]=0,Nt[6]=0,Nt[7]=0),Nt[0]=1,Nt[4]=1,Nt[8]=1,Pt=Nt,function(t,e,n,r){return Pt[0]=n[0],Pt[3]=n[1],Pt[6]=n[2],Pt[1]=r[0],Pt[4]=r[1],Pt[7]=r[2],Pt[2]=-e[0],Pt[5]=-e[1],Pt[8]=-e[2],Yt(t,_t(t,Pt))}),te=Object.freeze({create:Et,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},setAxisAngle:Ct,getAxisAngle:function(t,e){var n=2*Math.acos(e[3]),a=Math.sin(n/2);return a>r?(t[0]=e[0]/a,t[1]=e[1]/a,t[2]=e[2]/a):(t[0]=1,t[1]=0,t[2]=0),n},multiply:wt,rotateX:function(t,e,n){n*=.5;var r=e[0],a=e[1],i=e[2],s=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=r*l+s*o,t[1]=a*l+i*o,t[2]=i*l-a*o,t[3]=s*l-r*o,t},rotateY:function(t,e,n){n*=.5;var r=e[0],a=e[1],i=e[2],s=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=r*l-i*o,t[1]=a*l+s*o,t[2]=i*l+r*o,t[3]=s*l-a*o,t},rotateZ:function(t,e,n){n*=.5;var r=e[0],a=e[1],i=e[2],s=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=r*l+a*o,t[1]=a*l-r*o,t[2]=i*l+s*o,t[3]=s*l-i*o,t},calculateW:function(t,e){var n=e[0],r=e[1],a=e[2];return t[0]=n,t[1]=r,t[2]=a,t[3]=Math.sqrt(Math.abs(1-n*n-r*r-a*a)),t},slerp:yt,random:function(t){var e=i(),n=i(),r=i(),a=Math.sqrt(1-e),s=Math.sqrt(e);return t[0]=a*Math.sin(2*Math.PI*n),t[1]=a*Math.cos(2*Math.PI*n),t[2]=s*Math.sin(2*Math.PI*r),t[3]=s*Math.cos(2*Math.PI*r),t},invert:function(t,e){var n=e[0],r=e[1],a=e[2],i=e[3],s=n*n+r*r+a*a+i*i,o=s?1/s:0;return t[0]=-n*o,t[1]=-r*o,t[2]=-a*o,t[3]=i*o,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},fromMat3:_t,fromEuler:function(t,e,n,r){var a=.5*Math.PI/180;e*=a,n*=a,r*=a;var i=Math.sin(e),s=Math.cos(e),o=Math.sin(n),l=Math.cos(n),c=Math.sin(r),u=Math.cos(r);return t[0]=i*l*u-s*o*c,t[1]=s*o*u+i*l*c,t[2]=s*l*c-i*o*u,t[3]=s*l*u+i*o*c,t},str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},clone:Ft,fromValues:Dt,copy:Gt,set:Vt,add:Ut,mul:Ht,scale:Wt,dot:Bt,lerp:kt,length:qt,len:Xt,squaredLength:zt,sqrLen:jt,normalize:Yt,exactEquals:$t,equals:Qt,rotationTo:Zt,sqlerp:Jt,setAxes:Kt});function ee(){var t=new a(2);return a!=Float32Array&&(t[0]=0,t[1]=0),t}!function(){var t=ee()}();class ne{constructor(t,e,n=WebGL2RenderingContext.TRIANGLES){this.attributes=t,e&&(this.indices=e,this.indices.bufferView.target=WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER),this.mode=n}static bindAccessorsVBO(t,e,n){for(let r of t.attributes){let t=n[r.attribute];if(r.attribute&&null!=t){ae.bindBuffer(r.bufferView,e),e.enableVertexAttribArray(t);let n=r.byteOffset;e.vertexAttribPointer(t,r.size,r.componentType,r.normalized,r.bufferView.byteStride,n)}else console.warn(`Attribute '${r.attribute}' doesn't support in this material!`)}}static drawElements(t,e){let n=t.indices;e.drawElements(t.mode,n.count,n.componentType,n.byteOffset)}static drawArrays(t,e){e.drawArrays(t.mode,0,t.attributes[0].count)}static drawcall(t,e){t.indices?(ae.bindBuffer(t.indices.bufferView,e),this.drawElements(t,e)):this.drawArrays(t,e)}static preComputeTangent(t){let e=t.indices,n={};for(let e of t.attributes){if("POSITION"!=e.attribute&&"TEXCOORD_0"!=e.attribute)continue;let t=re.newFloat32Array(e),r=re.getSubChunks(e,t);n["_"+e.attribute]=t,n[e.attribute]=r,"POSITION"==e.attribute&&(n._TANGENT=new Float32Array(t.length),n.TANGENT=re.getSubChunks(e,n._TANGENT))}n.i=e?re.newUint16Array(e):n.POSITION.map((t,e)=>e);let r=n.POSITION,a=n.TEXCOORD_0,i=n.i,s=n.TANGENT,o=E(),l=E(),c=ee(),u=ee();for(let t=0,e=i.length;t<e;t+=3){let e=i[t],n=i[t+1],h=i[t+2],f=r[e],d=r[n],m=r[h],p=a[e],v=a[n],g=a[h];H(o,d,f),H(l,m,f),H(c,v,p),H(u,g,p);let b=s[e],M=1/(c[0]*u[1]-u[0]*c[1]);b[0]=M*(u[1]*o[0]-c[1]*l[0]),b[1]=M*(u[1]*o[1]-c[1]*l[1]),b[2]=M*(u[1]*o[2]-c[1]*l[2]),P(b,b),y(s[n],b),y(s[h],b)}let h=new ae;h.dataView=n._TANGENT,t.attributes.push(new re({bufferView:h,byteOffset:0,componentType:5126,count:s.length,type:"VEC3"},"TANGENT"))}}class re{constructor({bufferView:t,byteOffset:e=0,componentType:n,normalized:r=!1,count:a,type:i,max:s=[],min:o=[]},l=""){this.attribute=l,this.bufferView=t,this.byteOffset=e,this.componentType=n,this.normalized=r,this.count=a,this.max=s,this.min=o,this.size=re.types[i],this.data=re.getData(this)}static newFloat32Array(t){return new Float32Array(t.bufferView.rawBuffer,t.byteOffset+t.bufferView.byteOffset,t.size*t.count)}static getSubChunks(t,e){let n=[];for(let r=0;r<t.count;r++){let a=r*t.size;n.push(e.subarray(a,a+t.size))}return n}static getFloat32Blocks(t){return this.getSubChunks(t,re.newFloat32Array(t))}static newUint16Array(t){return new Uint16Array(t.bufferView.rawBuffer,t.byteOffset+t.bufferView.byteOffset,t.size*t.count)}static getUint16Blocks(t){return this.getSubChunks(t,re.newUint16Array(t))}static getData(t){return t.size>1?this.getFloat32Blocks(t):this.newUint16Array(t)}}re.types={SCALAR:1,VEC1:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};class ae{constructor(t,{byteOffset:e=0,byteLength:n=0,byteStride:r=0,target:a=34962}={}){this.buffer=null,this.rawBuffer=t,this.byteOffset=e,this.byteLength=n,this.byteStride=r,t&&(this.dataView=new DataView(t,this.byteOffset,this.byteLength)),this.target=a}static updateBuffer(t,e,n=WebGL2RenderingContext.STATIC_DRAW){t.buffer&&e.deleteBuffer(t.buffer),t.buffer=e.createBuffer(),e.bindBuffer(t.target,t.buffer),e.bufferData(t.target,t.dataView,n)}static bindBuffer(t,e){t.buffer||this.updateBuffer(t,e),e.bindBuffer(t.target,t.buffer)}}let ie={basic:{vs:"attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 uv;varying vec4 pos;void main(){uv=TEXCOORD_0;vec4 position=vec4(POSITION,1);pos=position;gl_Position=position;}",fs:"precision mediump float;uniform sampler2D base;varying vec2 uv;varying vec4 pos;void main(){gl_FragColor=texture2D(base,uv);}"},sylize:{vs:"attribute vec3 POSITION;attribute vec3 NORMAL;attribute vec2 TEXCOORD_0;attribute vec2 TEXCOORD_1;attribute vec4 TANGENT;\n#ifdef COLOR_0_SIZE_3\nattribute vec3 COLOR_0;\n#elif defined(COLOR_0_SIZE_4)\nattribute vec4 COLOR_0;\n#endif\n#ifdef HAS_SKINS\n#ifndef JOINT_AMOUNT\n#define JOINT_AMOUNT 200\n#endif\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;uniform mat4 jointMat[JOINT_AMOUNT];\n#endif\nuniform mat4 M;uniform mat4 VP;uniform mat4 nM;varying vec3 normal;varying vec2 uv;varying vec2 uv1;varying vec3 pos;varying vec4 vColor;varying mat3 TBN;void main(){uv=TEXCOORD_0;uv1=TEXCOORD_1;vec3 skinedNormal=NORMAL;vec4 position=vec4(POSITION,1);\n#ifdef HAS_SKINS\nmat4 skinMat=WEIGHTS_0.x*jointMat[int(JOINTS_0.x)]+WEIGHTS_0.y*jointMat[int(JOINTS_0.y)]+WEIGHTS_0.z*jointMat[int(JOINTS_0.z)]+WEIGHTS_0.w*jointMat[int(JOINTS_0.w)];position=M*skinMat*position;skinedNormal=(skinMat*vec4(skinedNormal,0)).xyz;\n#else\nposition=M*position;\n#endif\nnormal=normalize((nM*vec4(skinedNormal,0)).xyz);vec3 tangent=normalize(vec3(nM*vec4(TANGENT.xyz,0)));vec3 bitangent=cross(normal,tangent)*TANGENT.w;TBN=mat3(tangent,bitangent,normal);\n#ifdef COLOR_0_SIZE_3\nvColor=vec4(COLOR_0,1);\n#elif defined(COLOR_0_SIZE_4)\nvColor=COLOR_0;\n#endif\npos=position.xyz/position.w;gl_Position=VP*position;}",fs:"precision mediump float;\n#define PI 3.14159265358979\n#define GAMMA 2.2\nvarying vec3 normal;varying vec2 uv;varying vec2 uv1;varying vec3 pos;varying vec4 vColor;varying mat3 TBN;uniform sampler2D brdfLUT;\n#ifdef HAS_EMISSIVE_MAP\n#ifndef emissiveTexture_uv\n#define emissiveTexture_uv uv\n#endif\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\n#ifndef normalTexture_uv\n#define normalTexture_uv uv\n#endif\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_BASECOLOR_MAP\n#ifndef baseColorTexture_uv\n#define baseColorTexture_uv uv\n#endif\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\n#ifndef metallicRoughnessTexture_uv\n#define metallicRoughnessTexture_uv uv\n#endif\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#ifdef HAS_AO_MAP\n#ifndef occlusionTexture_uv\n#define occlusionTexture_uv uv\n#endif\nuniform sampler2D occlusionTexture;\n#endif\n#ifdef HAS_ENV_MAP\nuniform samplerCube env;\n#endif\nuniform vec3 u_Camera;vec4 sRGBtoLINEAR(vec4 color){return vec4(pow(color.rgb,vec3(GAMMA)),color.a);}vec4 LINEARtoSRGB(vec4 color){return vec4(pow(color.rgb,vec3(1.0/GAMMA)),color.a);}vec3 F_Schlick(float VoH,vec3 F0){return F0+(vec3(1)-F0)*pow(1.0-VoH,5.0);}vec3 F_UE4(float VoH,vec3 F0){return F0+(vec3(1.0)-F0)*pow(2.0,(-5.55473*VoH-6.98316)*VoH);}float G_CookTorrance(float NoV,float NoH,float VoH,float NoL){return min(min(2.0*NoV*NoH/VoH,2.0*NoL*NoH/VoH),1.0);}float G_UE4(float NoV,float NoH,float VoH,float NoL,float roughness){float k=(roughness+1.0)*(roughness+1.0)/8.0;float l=NoL/(NoL*(1.0-k)+k);float v=NoV/(NoV*(1.0-k)+k);return l*v;}float D_GGX(float a,float NoH){a=a*a;float f=NoH*NoH*(a-1.0)+1.0;return a/(PI*f*f);}struct coreData{vec3 diffuse;vec3 f0;vec3 N;vec3 V;vec3 R;float NoV;float metallic;float roughness;float alphaRoughness;};vec3 lightContrib(vec3 lightDir,coreData core){vec3 L=normalize(lightDir);vec3 H=normalize(core.V+L);float NoL=clamp(dot(core.N,L),0.001,1.0);float NoH=clamp(dot(core.N,H),0.0,1.0);float LoH=clamp(dot(L,H),0.0,1.0);float VoH=clamp(dot(core.V,H),0.0,1.0);vec3 F=F_Schlick(VoH,core.f0);float G=G_UE4(core.NoV,NoH,VoH,NoL,core.roughness);float D=D_GGX(core.alphaRoughness,NoH);vec3 specContrib=F*G*D/(4.0*NoL*core.NoV);vec3 diffuseContrib=(1.0-F)*core.diffuse*(1.0-core.metallic);vec3 color=NoL*(diffuseContrib+specContrib);return color;}void main(){\n#ifdef HAS_EMISSIVE_MAP\nvec4 em=sRGBtoLINEAR(texture2D(emissiveTexture,emissiveTexture_uv));\n#endif\n#ifdef HAS_BASECOLOR_MAP\nvec4 base=sRGBtoLINEAR(texture2D(baseColorTexture,baseColorTexture_uv));\n#else\nvec4 base=vec4(1);\n#endif\n#if defined(COLOR_0_SIZE_3) || defined(COLOR_0_SIZE_4)\nbase*=vColor;\n#endif\n#ifdef BASECOLOR_FACTOR\nbase*=BASECOLOR_FACTOR;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\nvec3 rm=texture2D(metallicRoughnessTexture,metallicRoughnessTexture_uv).rgb;\n#else\nvec3 rm=vec3(0,0.7,0);\n#endif\n#ifdef HAS_AO_MAP\nvec4 ao=texture2D(occlusionTexture,occlusionTexture_uv);\n#endif\n#ifdef HAS_NORMAL_MAP\nvec3 normalAddation=texture2D(normalTexture,normalTexture_uv).rgb*2.0-1.0;vec3 N=normalize(TBN*normalAddation);\n#else\nvec3 N=normalize(normal);\n#endif\nvec3 V=normalize(u_Camera-pos);float NoV=clamp(abs(dot(N,V)),0.001,1.0);vec3 R=-normalize(reflect(V,N));float roughness=clamp(rm.g,0.04,1.0);\n#ifdef ROUGHNESS_FACTOR\nroughness*=ROUGHNESS_FACTOR;\n#endif\nfloat alphaRoughness=roughness*roughness;float metallic=clamp(rm.b,0.0,1.0);\n#ifdef METALLIC_FACTOR\nmetallic*=METALLIC_FACTOR;\n#endif\nvec3 f0=vec3(0.04);f0=mix(f0,base.xyz,metallic);vec3 diffuse=base.rgb*(vec3(1)-f0);diffuse*=1.0-metallic;diffuse/=PI;coreData core=coreData(diffuse,f0,N,V,R,NoV,metallic,roughness,alphaRoughness);vec3 color;\n#ifdef HAS_ENV_MAP\nvec3 brdf=sRGBtoLINEAR(texture2D(brdfLUT,vec2(NoV,1.0-alphaRoughness))).rgb;vec3 IBLcolor=sRGBtoLINEAR(textureCube(env,R)).rgb;vec3 IBLspecular=1.0*IBLcolor*(f0*brdf.x+brdf.y);color+=IBLspecular;\n#endif\ncolor+=lightContrib(vec3(2,5,2),core)*vec3(2);color+=lightContrib(vec3(1,1,5),core)*vec3(1.0,0.8902,0.6902)*4.0;color+=lightContrib(vec3(-5,3,-5),core)*vec3(0.6431,0.9176,1.0);\n#ifdef HAS_EMISSIVE_MAP\ncolor+=em.rgb;\n#endif\n#ifdef BLEND\ngl_FragColor=LINEARtoSRGB(vec4(color,base.a));\n#elif defined(MASK)\n#ifndef ALPHA_CUTOFF\n#define ALPHA_CUTOFF 0.5\n#endif\nif(base.a<ALPHA_CUTOFF)discard;gl_FragColor=LINEARtoSRGB(vec4(color,1));\n#else\ngl_FragColor=LINEARtoSRGB(vec4(color,1));\n#endif\n}"},vignetting:{vs:"attribute vec3 POSITION;varying vec2 uv;varying vec2 pos;void main(){vec4 position=vec4(POSITION,1);pos=position.xy;uv=pos+1.*0.5;gl_Position=position;}",fs:"precision mediump float;uniform sampler2D base;varying vec2 uv;varying vec2 pos;void main(){float mask=1.-dot(pos,pos)*FACTOR;mask=clamp(.5+(mask-.5)*HARDNESS,0.,1.);vec4 color=texture2D(base,uv);gl_FragColor=mix(vec4(vec3(0),1),color,mask);}"}};class se{constructor(t=ie.basic.vs,e=ie.basic.fs,n={}){this.isDirty=!0,this.vertexSource=t,this.fragmentSource=e,this.macros=n}static clone(t){let e=new se(t.vertexSource,t.fragmentSource);return e.macros=Object.assign({},t.macros),e}static buildProgram(t,e){t.isDirty=!1,t.ctx=e,this.macros="";for(let e in t.macros)this.macros+=`\n#define ${e} ${t.macros[e]}\n`;t.vertex&&t.ctx.deleteShader(t.vertex),t.vertex=se.compileShader(t.ctx,t.ctx.VERTEX_SHADER,this.macros+t.vertexSource),t.fragment&&t.ctx.deleteShader(t.fragment),t.fragment=se.compileShader(t.ctx,t.ctx.FRAGMENT_SHADER,this.macros+t.fragmentSource),t.vertex&&t.fragment&&(t.program&&t.ctx.deleteProgram(t.program),t.program=se.createShaderProgram(t.ctx,t.vertex,t.fragment),t.attributes=se.pickupActiveAttributes(t.ctx,t.program),t.uniforms=se.pickupActiveUniforms(t.ctx,t.program))}static updateUniform(t){let e=t.ctx;for(let n in t.uniforms){let r=t.uniforms[n];null!=r.value&&r.isDirty&&(r.isDirty=!1,3==r.argLength?e[r.setter](r.location,!1,r.value):e[r.setter](r.location,r.value))}}static pickupActiveAttributes(t,e){const n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);let r={};for(let a=0;a<n;a++){const{name:n}=t.getActiveAttrib(e,a),i=t.getAttribLocation(e,n);r[n]=i}return r}static pickupActiveUniforms(t,e){const n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);let r={};for(let a=0;a<n;a++){const{name:n,type:i}=t.getActiveUniform(e,a),s=t.getUniformLocation(e,n),o=oe.getUnifSetter(i);let l=t[o].length;0==l&&(l=oe.getUnifArgLenght(i)),r[n]=new oe(s,i,o,l)}return r}static compileShader(t,e,n){let r=t.createShader(e);if(t.shaderSource(r,n),t.compileShader(r),!0===t.getShaderParameter(r,t.COMPILE_STATUS))return r;console.warn(t.getShaderInfoLog(r)),t.deleteShader(r)}static createShaderProgram(t,e,n){let r=t.createProgram();if(t.attachShader(r,e),t.attachShader(r,n),t.linkProgram(r),t.getProgramParameter(r,t.LINK_STATUS))return r;console.warn(t.getProgramInfoLog(r)),t.deleteProgram(r),t.deleteShader(e),t.deleteShader(n)}}se.macros="";class oe{constructor(t,e,n,r){this.value=null,this.isDirty=!1,this.location=t,this.type=e,this.setter=n,this.argLength=r}static getUnifSetter(t){switch(t){case WebGLRenderingContext.FLOAT:return"uniform1f";case WebGLRenderingContext.FLOAT_VEC2:return"uniform2f";case WebGLRenderingContext.FLOAT_VEC3:return"uniform3fv";case WebGLRenderingContext.FLOAT_VEC4:return"uniform4f";case WebGLRenderingContext.INT:return"uniform1i";case WebGLRenderingContext.INT_VEC2:return"uniform2i";case WebGLRenderingContext.INT_VEC3:return"uniform3i";case WebGLRenderingContext.INT_VEC4:return"uniform4i";case WebGLRenderingContext.FLOAT_MAT2:return"uniformMatrix2fv";case WebGLRenderingContext.FLOAT_MAT3:return"uniformMatrix3fv";case WebGLRenderingContext.FLOAT_MAT4:return"uniformMatrix4fv";case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return"uniform1i"}}static getUnifArgLenght(t){switch(t){case WebGLRenderingContext.FLOAT:case WebGLRenderingContext.FLOAT_VEC2:case WebGLRenderingContext.FLOAT_VEC3:case WebGLRenderingContext.FLOAT_VEC4:case WebGLRenderingContext.INT:case WebGLRenderingContext.INT_VEC2:case WebGLRenderingContext.INT_VEC3:case WebGLRenderingContext.INT_VEC4:case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return 2;case WebGLRenderingContext.FLOAT_MAT2:case WebGLRenderingContext.FLOAT_MAT3:case WebGLRenderingContext.FLOAT_MAT4:return 3}}}var le;!function(t){t[t.Opaque=0]="Opaque",t[t.Blend=1]="Blend"}(le||(le={}));class ce{constructor(t,e=null,n=!1){this.isDirty=!0,this.textures=new Map,this.queue=le.Opaque,this.shader=se.clone(t),this.name=e,this.shader.macros.SHADER_NAME=e,this.doubleSided=n}static clone(t){return new ce(t.shader,t.name,t.doubleSided)}static useMaterial(t,e){t.shader.isDirty&&se.buildProgram(t.shader,e),e.useProgram(t.shader.program)}static setUniform(t,e,n){null!=t.shader.uniforms[e]&&(t.shader.uniforms[e].value=n,t.shader.uniforms[e].isDirty=!0,t.isDirty=!0)}static updateUniform(t,e){t.shader.isDirty&&(se.buildProgram(t.shader,e),this.useMaterial(t,e)),se.updateUniform(t.shader),t.isDirty=!1}static bindAllTextures(t,n,r=!1){t.textures.size;for(let[a,i]of t.textures)e.bindTexture(n,i),(i.isDirty||r)&&(ce.setUniform(t,a,i.channel),i.isDirty=!1)}static unbindAllTextures(t,n){for(let[,r]of t.textures)e.unbindTexture(n,r)}static setTexture(t,e,n){t.textures.has(e)?n.channel=t.textures.get(e).channel:n.channel=t.textures.size,t.textures.set(e,n),t.isDirty=!0,n.isDirty=!0}}ce.SHADER_PATH="res/shader/";class ue{static create(t=null,e=!1){this.hasNewMember=!0;let n=document.createElement(this.entityTag);return t&&(n.dataset.name=t,n.textContent=t),n.components={},this.getDefaultComponent&&!e&&this.addComponent(n,this.getDefaultComponent()),n.addComponent=(t=>this.addComponent(n,t)),n.addEventListener("pointerdown",t=>{console.log("\t|-"+n.dataset.name),console.log(n.components);let e=n.components.Transform;null!=e&&(e.isVisible=!e.isVisible),t.stopPropagation()}),n}static clone(t){let e=this.create(t.dataset.name,!0);this.addComponent(e,this.cloneMethods._Transform(t.components.Transform));for(let n in t.components)this.cloneMethods[n]&&this.addComponent(e,this.cloneMethods[n](t.components[n]));for(let n=0;n<t.childElementCount;n++)e.appendChild(this.clone(t.children[n]));return e}static find(t,e=document){return Array.from(e.querySelectorAll(t))}static getComponents(t){return this.find(`${this.entityTag}[${t.toLowerCase()}]`).map(({components:e})=>e[t])}static getEntites(t,e=document){return this.find(`${this.entityTag}[${t.join("][")}]`,e)}static addComponent(t,e){this.hasNewMember=!0;let n=e.constructor.name;return t.components[n]=e,t.setAttribute(n,""),e.entity=t,e}}ue.entityTag="ash-entity",ue.hasNewMember=!1,ue.cloneMethods={};class he{}class fe{static loop(){for(let t in this.sysQueue){let e=this.sysQueue[t];(ue.hasNewMember||0==e.group.length)&&(e.group=ue.getEntites(e.depends)),e.onUpdate(this.deltaTime)}ue.hasNewMember=!1,this.deltaTime=(Date.now()-this.lastTime)/1e3,this.lastTime=Date.now(),this.isStoped||requestAnimationFrame(this.loop.bind(this))}static start(){this.isStoped&&(this.isStoped=!1,this.loop())}static stop(){this.isStoped=!0}static registSystem(t){this.sysQueue[t.depends.toString()]=t}static getSystem(t){return this.sysQueue[t.depends.toString()]}static removeSystem(t){this.sysQueue[t.depends.toString()]=null}}fe.lastTime=0,fe.deltaTime=0,fe.isStoped=!0,fe.sysQueue={},fe.start();class de{constructor(t,e,n){this.materials=[],this.isDirty=!0,null!=t&&(this.SID=t.id),this.mesh=e;for(let t of e.attributes)n.shader.macros[`${t.attribute}_SIZE_${t.size}`]="";me.attachMaterial(this,n)}static clone(t){let e=new de(null,t.mesh);e.SID=t.SID;for(let n of t.materials)me.attachMaterial(e,n);return e}}ue.cloneMethods.MeshRenderer=de.clone;class me extends he{constructor(){super(...arguments),this.group=[],this.depends=[de.name]}onUpdate(){for(let t in ge.list){let e=ge.list[t];e.filters.length&&(e.capture.bind(),e.setViewport(e.capture.width,e.capture.height)),e.clear()}for(let{components:t}of this.group)me.render(t.MeshRenderer,le.Opaque);for(let{components:t}of this.group)me.render(t.MeshRenderer,le.Blend);for(let t in ge.list){let e=ge.list[t];for(let[t,n]of e.filters.entries())n.renderToScreen?(n.bind(null),e.setViewport()):(n.bind(),e.setViewport(n.width,n.height),e.clear()),me.render(n.meshRender)}}static useMaterial(t,e){ce.useMaterial(t.materials[e],ge.list[t.SID].gl)}static attachMaterial(t,e){null!=t.SID&&(t.materials.push(e),ce.updateUniform(e,ge.list[t.SID].gl),this.useMaterial(t,0),this.updateVAO(t))}static bindVAO(t,e){"iOS"==ge.platform?ne.bindAccessorsVBO(t.mesh,ge.list[t.SID].gl,t.materials[0].shader.attributes):ge.list[t.SID].gl.bindVertexArray(e)}static updateVAO(t){t.vao&&ge.list[t.SID].gl.deleteVertexArray(t.vao),t.vao=ge.list[t.SID].gl.createVertexArray(),this.bindVAO(t,t.vao),ne.bindAccessorsVBO(t.mesh,ge.list[t.SID].gl,t.materials[0].shader.attributes),this.bindVAO(t,null)}static updateMaterial(t){t.materials[0].isDirty&&ce.updateUniform(t.materials[0],ge.list[t.SID].gl)}static render(t,e=le.Opaque){let n=ge.list[t.SID],{gl:r,mainCamera:a}=n;const i=t.materials[0];if(i.queue!=e)return;let s=i.shader.isDirty;if(this.useMaterial(t,0),i.doubleSided?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),t.entity){if(!t.entity.components.Transform.isVisible)return;let e=t.entity.components.Transform;a&&(ce.setUniform(i,"VP",a.vp),ce.setUniform(i,"u_Camera",a.entity.components.Transform.worldPos)),ce.setUniform(i,"M",e.worldMatrix),ce.setUniform(i,"nM",e.worldNormalMatrix),e.jointsMatrices&&ce.setUniform(i,"jointMat[0]",e.jointsMatrices)}this.updateMaterial(t),ce.bindAllTextures(i,r,s),this.bindVAO(t,t.vao),ne.drawcall(t.mesh,r)}}fe.registSystem(new me);class pe{constructor(t,e,n=t.pow2width,r=t.pow2height){this.color=[],this.depth=[],this.renderToScreen=!0,this.ctx=t.gl,this.screen=t,this.width=n,this.height=r,this.buffer=this.ctx.createFramebuffer(),this.output=this.attachTexture(),this.mesh=new ve,this.material=new ce(e),this.meshRender=new de(t,this.mesh,this.material)}clone(t=this.screen){return new pe(t,se.clone(this.material.shader),this.width,this.height)}setInput(t,e="base"){this.input=t,ce.setTexture(this.material,e,t),this.material.isDirty=!0}bind(t=this.buffer){this.ctx.bindFramebuffer(WebGL2RenderingContext.FRAMEBUFFER,t)}attachTexture(){this.bind();let t=new e(null,pe.sampleColor,this.width,this.height);e.createTexture(this.ctx,t),this.ctx.framebufferTexture2D(pe.FRAMEBUFFER,pe.COLOR_ATTACH_BASE+this.color.length,t.glType,t.sampler.texture,t.level),this.color.push(t);let n=new e(null,pe.sampleDepth,this.width,this.height);return n.internalformat=WebGL2RenderingContext.DEPTH_COMPONENT24,n.format=WebGL2RenderingContext.DEPTH_COMPONENT,n.type=WebGL2RenderingContext.UNSIGNED_INT,e.createTexture(this.ctx,n),this.ctx.framebufferTexture2D(pe.FRAMEBUFFER,pe.DEPTH_ATTACHMENT,n.glType,n.sampler.texture,n.level),this.depth.push(n),this.bind(null),t}}pe.sampleColor={magFilter:WebGL2RenderingContext.LINEAR,minFilter:WebGL2RenderingContext.LINEAR,wrapS:WebGL2RenderingContext.CLAMP_TO_EDGE,wrapT:WebGL2RenderingContext.CLAMP_TO_EDGE},pe.sampleDepth={magFilter:WebGL2RenderingContext.NEAREST,minFilter:WebGL2RenderingContext.NEAREST,wrapS:WebGL2RenderingContext.CLAMP_TO_EDGE,wrapT:WebGL2RenderingContext.CLAMP_TO_EDGE},pe.COLOR_ATTACH_BASE=WebGL2RenderingContext.COLOR_ATTACHMENT0,pe.DEPTH_ATTACHMENT=WebGL2RenderingContext.DEPTH_ATTACHMENT,pe.FRAMEBUFFER=WebGL2RenderingContext.FRAMEBUFFER;class ve extends ne{constructor(){let t=new Float32Array([-1,3,0,-1,-1,0,3,-1,0]),e=new ae(t.buffer,{byteOffset:t.byteOffset,byteLength:t.byteLength,byteStride:12,target:WebGL2RenderingContext.ARRAY_BUFFER});super([new re({bufferView:e,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:3},"POSITION")])}}class ge{constructor(t){if(this.filters=[],this.output=null,this.bgColor=[1,1,1,1],this.id=t,-1==navigator.userAgent.indexOf("iPhone")&&-1==navigator.userAgent.indexOf("iPad")||(ge.platform="iOS"),this.canvas=document.querySelector(t),this.canvas){if(this.gl=this.canvas.getContext("webgl2"),!this.gl)return console.error("Get Context Failed"),void alert("Your browser do not support WebGL2");ge.list[t]=this,this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.setScreenSize(),this.pow2width=be(this.width),this.pow2height=be(this.height),this.capture=new pe(this,new se,this.pow2width,this.pow2height),this.capture.renderToScreen=!1}else console.error("Canvas not found!")}setScreenSize(t=window.innerWidth,e=window.innerHeight){let{devicePixelRatio:n}=window;console.log(n),this.canvas.setAttribute("width",t*n+""),this.canvas.setAttribute("height",e*n+""),this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.width=t*n,this.height=e*n,this.ratio=n,this.setViewport()}setViewport(t=this.width,e=this.height){this.gl.viewport(0,0,t,e)}clear(t=this.bgColor[0],e=this.bgColor[1],n=this.bgColor[2],r=this.bgColor[3],a=this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT){this.gl.clearColor(t,e,n,r),this.gl.clear(a)}attachFilter(t){null==this.output?t.setInput(this.capture.output):(this.output.renderToScreen=!1,t.setInput(this.output.output)),this.filters.push(t),this.output=t}deleteFilter(t){if(!this.filters[t])return void console.error("Filter does not exist!");let e=this.filters[t-1]||this.capture,n=this.filters[t+1];n?n.setInput(e.output):e.renderToScreen=!0,this.filters.splice(t,1),this.output=this.filters[this.filters.length-1]}}function be(t){let e=128;for(;t>e;)e<<=1;return e}function Me(t,e,n,r){return new(n||(n=Promise))(function(a,i){function s(t){try{l(r.next(t))}catch(t){i(t)}}function o(t){try{l(r.throw(t))}catch(t){i(t)}}function l(t){t.done?a(t.value):new n(function(e){e(t.value)}).then(s,o)}l((r=r.apply(t,e||[])).next())})}ge.list={},ge.platform="unknown";class Te{constructor(){this.worldPos=w(0,0,0),this.translate=w(0,0,0),this.rotate=w(0,0,0),this.scale=w(1,1,1),this.quaternion=Z(0,0,0,1),this.localMatrix=s(),this.worldMatrix=s(),this.worldInverseMatrix=s(),this.worldNormalMatrix=s(),this.isVisible=!0,this.isDirty=!1,c(this.localMatrix),c(this.worldMatrix)}static clone(t){let e=new Te;return y(e.translate,t.translate),y(e.rotate,t.rotate),y(e.scale,t.scale),J(e.quaternion,t.quaternion),e}}ue.getDefaultComponent=(()=>new Te),ue.cloneMethods._Transform=Te.clone;class xe extends he{constructor(){super(...arguments),this.group=[],this.depends=[Te.name]}onUpdate(){for(let{components:t}of this.group)xe.updateMatrix(t.Transform)}static decomposeMatrix(t,e=t.localMatrix){_(t.translate,e[0],e[1],e[2]);let n=X(t.translate);_(t.translate,e[4],e[5],e[6]);let r=X(t.translate);_(t.translate,e[8],e[9],e[10]);let a=X(t.translate);_(t.scale,n,r,a),f(e)<0&&(n=-n),_(t.translate,e[12],e[13],e[14]),e[12]=e[13]=e[14]=0,e[0]/=n,e[1]/=n,e[2]/=n,e[4]/=r,e[5]/=r,e[6]/=r,e[8]/=a,e[9]/=a,e[10]/=a,p(t.quaternion,e)}static updateMatrix(t){t.isDirty=!1,v(t.localMatrix,t.quaternion,t.translate,t.scale),h(t.worldInverseMatrix,t.worldMatrix),u(t.worldNormalMatrix,t.worldInverseMatrix);let e=t.entity.parentElement;if(null!=e&&e.components){let n=e.components.Transform;T(t.worldMatrix,n.worldMatrix,t.localMatrix),V(t.worldPos,t.translate,t.worldMatrix)}else o(t.worldMatrix,t.localMatrix)}}fe.registSystem(new xe);class Ae{constructor(){this.ibm=[],this.jointMat=[]}}fe.registSystem(new class extends he{constructor(){super(...arguments),this.group=[],this.depends=[Ae.name]}onUpdate(){for(let{components:t}of this.group){let e=t.Skin,n=t.Transform;for(let[t,r]of e.joints.entries())T(e.jointMat[t],r.worldMatrix,e.ibm[t]),T(e.jointMat[t],n.worldInverseMatrix,e.jointMat[t])}}});class Ee{constructor(){this.channels=[]}static attachChannel(t,e){t.channels.push(e),this.totalTime=Math.max(this.totalTime,e.endTime)}}Ee.totalTime=0;class Ce{constructor(t,e,n){this.isLoop=!0,this.pause=!1,this.currentTime=0,this.startTime=0,this.endTime=0,this.totalTime=0,this.step=0,this.speed=1,this.channel=t,this.timeline=re.newFloat32Array(e),this.endTime=this.timeline[this.timeline.length-1],this.keyframe=re.getFloat32Blocks(n),1!=this.timeline.length?this.startTime=this.timeline[0]:this.currentTime=this.endTime}}class we extends he{constructor(){super(...arguments),this.group=[],this.depends=[Ee.name]}reset(t){t.step=0,t.currentTime=0}static step(t){let e,n,r,a,i=t.channel.length,s=t.step,o=s+1;1==t.timeline.length?(o=0,e=0,t.pause=!0):(e=t.timeline[s],n=t.keyframe[s]),r=t.timeline[o],a=t.keyframe[o];let l=r-e;if(t.currentTime<e||t.currentTime>r)return console.error("Wrong step!",t.currentTime,e,r),void console.log(t.timeline);let c=l?(t.currentTime-e)/l:1;switch(i){case 4:yt(t.channel,n||this.defaultQuat,a,c);break;case 3:G(t.channel,n||this.defaultVec3,a,c)}}playStep(t,e){if(!t.pause){if(t.currentTime>Ee.totalTime)return this.reset(t),void(t.isLoop||(t.pause=!0,console.log("stop")));for(;t.currentTime>t.timeline[t.step+1];)t.step++;t.currentTime>t.startTime&&t.currentTime<=t.endTime&&we.step(t),t.currentTime+=e*t.speed}}onUpdate(t){for(let{components:e}of this.group){t>.016&&(t=.016);let n=e.Animation;for(let e of n.channels)this.playStep(e,t)}}}we.defaultQuat=Et(),we.defaultVec3=E(),fe.registSystem(new we);class ye{constructor(t){this.scene=ue.create("scene"),this.gltf=t,t.materials||(t.materials=[{name:"Default_Material"}]),t.materials=t.materials.map(n=>{let r=new ce(t.commonShader,n.name,n.doubleSided);return console.log(n),this.detectConfig(r,n),ce.setTexture(r,"brdfLUT",e.clone(t.brdfLUT)),t.hasEnvmap&&(r.shader.macros.HAS_ENV_MAP="",ce.setTexture(r,"env",e.clone(t.envmap))),r}),t.accessors=t.accessors.map(e=>{let n=new re(e);return n.bufferView=t.bufferViews[e.bufferView],n}),t.meshes=t.meshes.map(e=>e.primitives.map(e=>{let{attributes:n,targets:r}=e,a=[];for(let e in n){let r=t.accessors[n[e]];r.attribute=e,a.push(r)}let i=t.accessors[e.indices],s=new ne(a,i,e.mode);null==n.TANGENT&&null!=n.TEXCOORD_0&&(console.warn("Using computed tagent!"),ne.preComputeTangent(s));let o=t.materials[e.material||0];return null!=n.JOINTS_0&&(o.shader.macros.HAS_SKINS=""),[s,o]}))}assemble(){return Me(this,void 0,void 0,function*(){let t=this.gltf,{scene:e,scenes:n,nodes:r,skins:a,animations:i}=t;if(this.entities=yield Promise.all(t.nodes.map((t,e)=>this.waitEntity(t,e))),a&&(a=a.map(e=>{if(e.joints=e.joints.map(t=>this.entities[t].components.Transform),null==e.entity)return;let n=new Ae;n.materials=e.materials,n.joints=e.joints;let r=t.accessors[e.inverseBindMatrices];n.ibm=re.getFloat32Blocks(r),n.outputMat=new Float32Array(r.count*r.size),n.jointMat=re.getSubChunks(r,n.outputMat);for(let t of e.transforms){t.jointsMatrices=n.outputMat,t.entity.components.Material.shader.macros.JOINT_AMOUNT=Math.min(e.joints.length,200)}return e.entity&&e.entity.addComponent(n),n})),i)for(let{channels:e,samplers:n}of i)for(let{sampler:r,target:a}of e){let e,i=this.entities[a.node],s=i.components.Transform;switch(a.path){case"translation":e=s.translate;break;case"rotation":e=s.quaternion;break;case"scale":e=s.scale}if(null!=e){let{input:a,interpolation:s,output:o}=n[r],l=t.accessors[a],c=t.accessors[o];null==i.components.Animation&&i.addComponent(new Ee);let u=i.components.Animation;Ee.attachChannel(u,new Ce(e,l,c))}}let s=n[e||0].nodes;for(let t of s){let e=this.parseNode(t,r);this.scene.appendChild(e)}return console.log(this),this})}waitEntity(t,e){return new Promise((n,r)=>{setTimeout(()=>{n(this.createEntity(t,e))},0)})}detectTexture(t,n,r){let{index:a,texCoord:i}=r,s=this.gltf;null!=a&&(ce.setTexture(t,n,e.clone(s.textures[a])),i&&(t.shader.macros[`${n}_uv`]=`uv${i}`))}detectConfig(t,e){let n=t.shader;for(let r in e){let a=e[r];switch(this.detectTexture(t,r,a),r){case"normalTexture":n.macros.HAS_NORMAL_MAP="";break;case"occlusionTexture":n.macros.HAS_AO_MAP="";break;case"baseColorTexture":n.macros.HAS_BASECOLOR_MAP="";break;case"metallicRoughnessTexture":n.macros.HAS_METALLIC_ROUGHNESS_MAP="";break;case"emissiveTexture":n.macros.HAS_EMISSIVE_MAP="";break;case"baseColorFactor":n.macros.BASECOLOR_FACTOR=`vec4(${a.join(",")})`;break;case"metallicFactor":n.macros.METALLIC_FACTOR=`float(${a})`;break;case"roughnessFactor":n.macros.ROUGHNESS_FACTOR=`float(${a})`;break;case"alphaMode":n.macros[a]="","OPAQUE"!=a&&(t.queue=le.Blend);break;case"alphaCutoff":n.macros.ALPHA_CUTOFF=`float(${a})`;break;case"pbrMetallicRoughness":this.detectConfig(t,a)}}}createEntity(t,e){let{mesh:n,name:r,matrix:a,rotation:i,scale:s,translation:o,skin:c,camera:u}=t;r=r||"node_"+e;let h=ue.create(r),f=h.components.Transform;null!=a?(l(f.localMatrix,...a),xe.decomposeMatrix(f)):(null!=i&&K(f.quaternion,...i),null!=s&&_(f.scale,...s),null!=o&&_(f.translate,...o)),xe.updateMatrix(f);let d=[];if(null!=n){let t=h,e=this.gltf.meshes[n],r=e.length-1;for(let[n,a]of e.entries()){let[e,i]=a;r&&(t=h.appendChild(ue.create("subNode_"+n))),t.addComponent(e),t.addComponent(i),d.push(t.components.Transform)}}return null!=c&&(this.gltf.skins[c].entity=h,this.gltf.skins[c].transforms||(this.gltf.skins[c].transforms=[]),this.gltf.skins[c].transforms.push(...d)),null!=u&&h.addComponent(this.gltf.cameras[u]),h}parseNode(t,e){let n=e[t],r=this.entities[t];if(n.children)for(let t of n.children)r.appendChild(this.parseNode(t,e));return r}}class _e{constructor(t=1,e=45,n=.1,r=1e3){this.isDirty=!0,this.aspect=t,this.fov=e,this.near=n,this.far=r,this.projection=s(),this.view=s(),this.vp=s(),this.up=w(0,1,0),this.lookAt=E(),_e.updateProjectionMatrix(this)}static updateProjectionMatrix(t){g(t.projection,t.fov*Math.PI/180,t.aspect,t.near,t.far)}static updateViewMatrix(t){let e=t.entity.components.Transform;b(t.view,e.translate,t.lookAt,t.up),T(t.view,t.view,e.worldInverseMatrix),T(t.vp,t.projection,t.view)}}fe.registSystem(new class extends he{constructor(){super(...arguments),this.group=[],this.depends=[_e.name]}onUpdate(){for(let{components:t}of this.group){let e=t.Camera;_e.updateViewMatrix(e)}}});class Re{static addTask(){this.totalTask++,this.taskObserve&&this.taskObserve(this.finishedTask,this.totalTask)}static finishTask(){this.finishedTask++,this.taskObserve&&this.taskObserve(this.finishedTask,this.totalTask)}static loadImage(t){return new Promise((e,n)=>{this.addTask();let r=new Image;r.crossOrigin="anonymous",r.src=t,r.onload=(()=>{e(r),this.finishTask()})})}static loadBufferImage(t,e){return new Promise((n,r)=>{var a=new Blob([t],{type:e}),i=URL.createObjectURL(a);let s=new Image;s.src=i,s.onload=(()=>{n(s)})})}static adjustDataUri(t,e){return"data:"==e.substr(0,5)?e:t+e}static glbParse(t){return Me(this,void 0,void 0,function*(){let e,n=[],r=yield this.loadBuffer(t),a=0,i=new Int32Array(r,a,3);a+=12;let[s,o,l]=i;if(s==this.glbMagic){for(;a<l;){let[t,i]=new Int32Array(r,a,2);a+=8;let s=r.slice(a,a+t);switch(i){case 1313821514:e=JSON.parse(this.decoder.decode(s));break;case 5130562:n.push(s)}a+=t}return{json:e,bin:n}}console.error("Magic number incorrect! - "+i[0])})}static loadGLTF(t,n,r,a=new se(ie.sylize.vs,ie.sylize.fs)){return Me(this,void 0,void 0,function*(){let i,s=t.split("/"),[o,l]=s.pop().split(".");if(s=s.join("/")+"/","glb"==l){let e=yield this.glbParse(t);(i=e.json).buffers=e.bin,i.bufferViews=i.bufferViews.map(t=>new ae(i.buffers[t.buffer],t)),i.images&&(i.images=yield Promise.all(i.images.map(t=>this.loadBufferImage(i.bufferViews[t.bufferView].dataView,t.mimeType))))}else{if("gltf"!=l)return void console.error("Wrong file!");(i=yield(yield fetch(t)).json()).buffers=yield Promise.all(i.buffers.map(({uri:t})=>this.loadBuffer(this.adjustDataUri(s,t)))),i.bufferViews=i.bufferViews.map(t=>new ae(i.buffers[t.buffer],t)),i.images&&(i.images=yield Promise.all(i.images.map(({uri:t})=>this.loadImage(this.adjustDataUri(s,t)))))}i.cameras&&(i.cameras=i.cameras.map(t=>{if(t.perspective){let{aspectRatio:e,yfov:r,znear:a,zfar:i}=t.perspective,s=new _e(n.width/n.height,180*r/Math.PI,a,i);return s.name=t.name,s}})),i.textures&&(i.textures=i.textures.map(t=>{let r,{source:a,sampler:s}=t;null!=i.samplers&&(r=i.samplers[s]);let o=new e(i.images[a],r);return e.createTexture(n.gl,o),o})),i.commonShader=a,i.brdfLUT=yield this.loadTexture("https://raw.githubusercontent.com/KhronosGroup/glTF-WebGL-PBR/master/textures/brdfLUT.png",{minFilter:WebGL2RenderingContext.LINEAR}),null!=r?(i.hasEnvmap=!0,i.envmap=r):i.hasEnvmap=!1;let{scene:c}=yield new ye(i).assemble(),u=ue.getEntites([ne.name,ce.name],c);for(let t of u){let e=t.components.Mesh,r=t.components.Material;"outline"==r.name&&(t.components.Transform.isVisible=!1),t.addComponent(new de(n,e,r))}return c})}static loadBuffer(t){return Me(this,void 0,void 0,function*(){this.addTask();let e=yield(yield fetch(t)).arrayBuffer();return this.finishTask(),e})}static LoadShaderProgram(t){return Me(this,void 0,void 0,function*(){let e=(t=ce.SHADER_PATH+t)+".vs.glsl",n=t+".fs.glsl",[r,a]=yield Promise.all([e,n].map(t=>fetch(t).then(t=>t.text())));return new se(r,a)})}static LoadMaterial(t){return Me(this,void 0,void 0,function*(){this.addTask();let e=yield this.LoadShaderProgram(t);return this.finishTask(),new ce(e)})}static loadCubeimg(t,e="jpg"){return Me(this,void 0,void 0,function*(){return yield Promise.all(this.cubemapOrder.map(n=>this.loadImage(t+n+e)))})}static loadCubemap(t,n="jpg"){return Me(this,void 0,void 0,function*(){let r=yield this.loadCubeimg(t,n);return new e(r)})}static loadTexture(t,n){return Me(this,void 0,void 0,function*(){let r=yield this.loadImage(t);return new e(r,n)})}}Re.totalTask=0,Re.finishedTask=0,Re.taskObserve=null,Re.glbMagic=1179937895,Re.decoder=new TextDecoder,Re.cubemapOrder=["posx.","negx.","posy.","negy.","posz.","negz."];let Se="\nattribute vec3 POSITION;\nattribute vec2 TEXCOORD_0;\n\nvarying vec2 uv;\nvarying vec4 pos;\n\nvoid main() {\n  uv = TEXCOORD_0;\n  vec4 position = vec4(POSITION, 1);\n  pos = position;\n  gl_Position = position;\n}\n",Oe="\nprecision mediump float;\nuniform sampler2D base;\n\nvarying vec2 uv;\nvarying vec4 pos;\n\n\nvoid main() {\n    vec4 color = texture2D(base, uv);\n    float brightness = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));\n    if(brightness < THRESHOLD) {\n        color.r = color.g = color.b = 0.0;\n    }\n    gl_FragColor = color;\n}\n",Le="\nattribute vec3 POSITION;\nattribute vec2 TEXCOORD_0;\n\nvarying vec2 uv;\nvarying vec4 pos;\n\nvoid main() {\n  uv = TEXCOORD_0;\n  vec4 position = vec4(POSITION, 1);\n  pos = position;\n  gl_Position = position;\n}\n",Ie="\n#define PI 3.1415926535898\nprecision mediump float;\nuniform sampler2D base;\n\nvarying vec2 uv;\nvarying vec4 pos;\n\nvec4 blur9() {\n    vec4 color = vec4(0);\n    vec2 direction = OFFSET;\n    vec2 off1 = vec2(1.3846153846) * direction;\n    vec2 off2 = vec2(3.2307692308) * direction;\n    color += texture2D(base, uv) * 0.2270270270;\n    color += texture2D(base, uv + off1) * 0.3162162162;\n    color += texture2D(base, uv - off1) * 0.3162162162;\n    color += texture2D(base, uv + off2) * 0.0702702703;\n    color += texture2D(base, uv - off2) * 0.0702702703;\n    return color;\n}\nvec4 gaussianBlur() {\n    vec2 offset = OFFSET;\n    float weight[5];\n    weight[0] = 0.227027;\n    weight[1] = 0.1945946;\n    weight[2] = 0.1216216;\n    weight[3] = 0.054054;\n    weight[4] = 0.016216;\n    vec4 color = vec4(0);\n    for(int i = 0; i < 5; i++) {\n        color += texture2D(base, uv + offset * float(i+1) ) * weight[i];\n        color += texture2D(base, uv + offset * float(-i-1) ) * weight[i];\n    }\n    return color;\n}\n\nfloat random(vec3 scale, float seed) {\n    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\n}\n\n// https://redcamel.github.io/RedGL2/example/postEffect/blur/RedPostEffect_BlurX.html\n\nvec4 noiseblur() {\n    vec4 finalColor = vec4(0);\n    vec2 delta;\n    float total = 0.0;\n    float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\n    delta = OFFSET;\n    for (float t = -10.0; t <= 10.0; t++) {\n        float percent = (t + offset - 0.5) / 10.0;\n        float weight = 1.0 - abs(percent);\n        vec4 sample = texture2D(base, uv + delta * percent);\n        sample.rgb *= sample.a;\n        finalColor += sample * weight;\n        total += weight;\n    }\n    finalColor /= total;\n    return finalColor;\n}\n\nvoid main() {\n    // gl_FragColor = gaussianBlur();\n    gl_FragColor = noiseblur();\n    // gl_FragColor = blur9();\n}\n",Ne="\nattribute vec3 POSITION;\nattribute vec2 TEXCOORD_0;\n\nvarying vec2 uv;\nvarying vec4 pos;\n\nvoid main() {\n  uv = TEXCOORD_0;\n  vec4 position = vec4(POSITION, 1);\n  pos = position;\n  gl_Position = position;\n}\n",Pe="\nprecision mediump float;\nuniform sampler2D base;\nuniform sampler2D originTex;\n\nvarying vec2 uv;\nvarying vec4 pos;\n\n\nvoid main() {\n    vec4 origin = texture2D(originTex, uv);\n    vec4 addition = texture2D(base, uv) * vec4(vec3(BLOOM_INTENSITY),1);\n    gl_FragColor = origin + addition;\n}\n";let Fe=ie.vignetting.vs,De=ie.vignetting.fs;class Ge{constructor(t,e,n=90,r=90,a=.2,i=.92){this.movement=E(),this.unprojectMatrix=s(),this.X=w(1,0,0),this.Y=w(0,1,0),this.Z=w(0,0,1),this.vx=0,this.vy=0,this.vz=0,this.vyaw=0,this.vpitch=0,this.vscale=0,this.threshold=.001,this.moveHandler=(t=>{let{movementX:e,movementY:n,buttons:r}=t;if(2==r);else{let t=e*this.speed,r=-n*this.speed;this.vpitch+=r,this.vyaw+=t}}),this.touchHandler=(()=>{let t,e;return n=>{let{pageX:r,pageY:a}=n.touches[0];if(t||e){let n=r-t,i=a-e;this.vpitch+=-i*this.speed,this.vyaw+=n*this.speed}e=a,t=r}}),this.scrollHandler=(({deltaY:t})=>{this.vscale+=t*this.speed*.01}),this.orientationHandler=(t=>{this.lastalpha&&this.lastbeta||(this.lastalpha=t.alpha,this.lastbeta=t.beta);let e=t.alpha-this.lastalpha,n=t.beta-this.lastbeta;this.pitch=this.lastbeta+.1*n,this.yaw=this.lastalpha+.1*e}),this.pitch=n,this.yaw=r,this.speed=a,this.damping=i,this.camera=e.components.Camera,this.trans=e.components.Transform,this.distance=L(this.trans.translate,this.camera.lookAt),t.mainCamera=this.camera,Ge.bindEvents(t.canvas,this),Ve.updatePosition(this)}static bindEvents(t,e){t.oncontextmenu=(()=>!1),t.addEventListener("mousedown",()=>{t.addEventListener("mousemove",e.moveHandler)}),t.addEventListener("mouseup",()=>{t.removeEventListener("mousemove",e.moveHandler)}),t.addEventListener("wheel",e.scrollHandler),t.addEventListener("touchstart",()=>{let n=e.touchHandler();t.addEventListener("touchmove",n),t.addEventListener("touchend",()=>{t.removeEventListener("touchmove",n)})}),t.addEventListener("wheel",e.scrollHandler)}}class Ve extends he{constructor(){super(...arguments),this.group=[],this.depends=[Ge.name]}onUpdate(){for(let{components:t}of this.group)Ve.updatePosition(t.OrbitControl)}static updatePosition(t){Math.abs(t.vyaw)>t.threshold&&(t.yaw+=t.vyaw,t.vyaw*=t.damping),Math.abs(t.vpitch)>t.threshold&&(t.pitch+=t.vpitch,t.vpitch*=t.damping),Math.abs(t.vscale)>t.threshold&&(t.distance+=t.vscale,t.distance=Math.max(t.distance,1),t.vscale*=t.damping),t.pitch=Math.min(180,Math.max(.01,t.pitch)),t.trans.translate[0]=t.camera.lookAt[0]+t.distance*Math.sin(t.pitch/180*Math.PI)*Math.cos(t.yaw/180*Math.PI),t.trans.translate[1]=t.camera.lookAt[1]+t.distance*Math.cos(t.pitch/180*Math.PI),t.trans.translate[2]=t.camera.lookAt[2]+t.distance*Math.sin(t.pitch/180*Math.PI)*Math.sin(t.yaw/180*Math.PI),t.camera.isDirty=!0,xe.updateMatrix(t.trans)}}fe.registSystem(new Ve),t.Screen=ge,t.Asset=Re,t.EntityMgr=ue,t.ComponentSystem=he,t.System=fe,t.vec3=Y,t.vec4=At,t.mat4=A,t.quat=te,t.Texture=e,t.Mesh=ne,t.Accessor=re,t.bufferView=ae,t.QuadMesh=class extends ne{constructor(){let t=new Float32Array([-1,-1,0,0,0,0,0,1,1,-1,0,1,0,0,0,1,1,1,0,1,1,0,0,1,-1,1,0,0,1,0,0,1]),e=new Uint16Array([0,1,2,0,2,3]),n=new ae(t.buffer,{byteOffset:t.byteOffset,byteLength:t.byteLength,byteStride:32,target:WebGL2RenderingContext.ARRAY_BUFFER}),r=new ae(e.buffer,{byteOffset:e.byteOffset,byteLength:e.byteLength,byteStride:0,target:WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER});super([new re({bufferView:n,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:4},"POSITION"),new re({bufferView:n,componentType:WebGL2RenderingContext.FLOAT,byteOffset:12,type:"VEC2",count:4},"TEXCOORD_0"),new re({bufferView:n,componentType:WebGL2RenderingContext.FLOAT,byteOffset:20,type:"VEC3",count:4},"NORMAL")],new re({bufferView:r,componentType:WebGL2RenderingContext.UNSIGNED_SHORT,byteOffset:0,type:"SCALAR",count:6}))}},t.Filter=pe,t.Shader=se,t.Uniform=oe,t.Bloom=class{static initFilters(t,e=.7,n=60,r=1){let a,i=new pe(t,new se(Se,Oe,a={THRESHOLD:e}),128,128),s=t.width/t.ratio,o=t.height/t.ratio;n*=t.ratio;let l=new pe(t,new se(Le,Ie,a={OFFSET:`vec2(${n/s}, 0)`})),c=new pe(t,new se(Le,Ie,a={OFFSET:`vec2(0, ${n/o})`})),u=new pe(t,new se(Ne,Pe,a={BLOOM_INTENSITY:`float(${r})`}));t.output?u.setInput(t.output.output,"originTex"):u.setInput(t.capture.output,"originTex"),t.attachFilter(i),t.attachFilter(l),t.attachFilter(c),t.attachFilter(u)}},t.Vignetting=class extends pe{constructor(t,e=.4,n=1){super(t,new se(Fe,De,{FACTOR:`float(${e})`,HARDNESS:`float(${n})`}))}},t.Transform=Te,t.Camera=_e,t.OrbitControl=Ge,t.Material=ce,t.MeshRenderer=de,t.Animation=Ee,t.AnimationChannel=Ce,t.Skin=Ae,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=/sm/963b9daefb4d5d15ed4ccce3357263520f795df4034ae5e9f2e30187f5e61c6d.map