/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/ashes3d@0.3.2/build/ashes.main.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Ashes={})}(this,function(e){"use strict";class t{constructor(e,t,r=2,i=2,a=0){this.isDirty=!0,this.glType=WebGL2RenderingContext.TEXTURE_2D,this.isCubetex=!1,this.data=null,this.level=0,this.internalformat=WebGL2RenderingContext.RGBA,this.format=WebGL2RenderingContext.RGBA,this.type=WebGL2RenderingContext.UNSIGNED_BYTE,this.flipY=!1,this.sampler=new n(t),this.image=e,this.width=r,this.height=i,this.border=a,e&&6==e.length&&(this.isCubetex=!0,this.glType=WebGL2RenderingContext.TEXTURE_CUBE_MAP)}static clone(e){let n=new t(e.image,e.sampler);return n.flipY=e.flipY,n.data=e.data,n.width=e.width,n.height=e.height,n.isCubetex=e.isCubetex,n.glType=e.glType,n.border=e.border,n.level=e.level,n.internalformat=e.internalformat,n.format=e.format,n.type=e.type,n}static createTexture(e,t){if(t.sampler.texture||(t.sampler.texture=e.createTexture()),e.bindTexture(t.glType,t.sampler.texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY?1:0),t.isCubetex)for(let n in this.cubetexOrder)t.image?e.texImage2D(this.cubetexOrder[n],t.level,t.internalformat,t.format,t.type,t.image[n]):e.texImage2D(this.cubetexOrder[n],t.level,t.internalformat,t.width,t.height,0,t.format,t.type,t.data[n]);else t.image?e.texImage2D(t.glType,t.level,t.internalformat,t.format,t.type,t.image):(e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(t.glType,t.level,t.internalformat,t.width,t.height,t.border,t.format,t.type,t.data));e.texParameterf(t.glType,e.TEXTURE_WRAP_S,t.sampler.wrapS),e.texParameterf(t.glType,e.TEXTURE_WRAP_T,t.sampler.wrapT),e.texParameterf(t.glType,e.TEXTURE_MAG_FILTER,t.sampler.magFilter),e.texParameterf(t.glType,e.TEXTURE_MIN_FILTER,t.sampler.minFilter),t.sampler.minFilter!=WebGL2RenderingContext.NEAREST_MIPMAP_NEAREST&&t.sampler.minFilter!=WebGL2RenderingContext.NEAREST_MIPMAP_LINEAR&&t.sampler.minFilter!=WebGL2RenderingContext.LINEAR_MIPMAP_NEAREST&&t.sampler.minFilter!=WebGL2RenderingContext.LINEAR_MIPMAP_LINEAR||e.generateMipmap(t.glType),e.bindTexture(t.glType,null)}static unbindTexture(e,t,n){null!=n&&e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(t.glType,null)}static bindTexture(e,t,n){null!=n&&e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),(null==t.sampler.texture||t.isDirty&&(t.data||t.image))&&this.createTexture(e,t),e.bindTexture(t.glType,t.sampler.texture)}}t.defaultData=new Uint8Array([1,1,1,1,1,.5,.4,1,.4,.5,1,1,1,1,1,1].map(e=>255*e)),t.cubetexOrder=[WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_X,WebGL2RenderingContext.TEXTURE_CUBE_MAP_NEGATIVE_X,WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_Y,WebGL2RenderingContext.TEXTURE_CUBE_MAP_NEGATIVE_Y,WebGL2RenderingContext.TEXTURE_CUBE_MAP_POSITIVE_Z,WebGL2RenderingContext.TEXTURE_CUBE_MAP_NEGATIVE_Z];class n{constructor({magFilter:e=WebGL2RenderingContext.NEAREST,minFilter:t=WebGL2RenderingContext.NEAREST,wrapS:n=10497,wrapT:r=10497,texture:i=null}={magFilter:WebGL2RenderingContext.NEAREST,minFilter:WebGL2RenderingContext.NEAREST,wrapS:10497,wrapT:10497,texture:null}){this.texture=null,this.magFilter=e,this.minFilter=t,this.wrapS=n,this.wrapT=r,this.texture=i}}var r=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array,a=Math.random;function o(){var e=new i(9);return i!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function s(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],h=n[0],d=n[1],m=n[2],v=n[3],p=n[4],b=n[5],g=n[6],T=n[7],M=n[8];return e[0]=h*r+d*o+m*c,e[1]=h*i+d*s+m*u,e[2]=h*a+d*l+m*f,e[3]=v*r+p*o+b*c,e[4]=v*i+p*s+b*u,e[5]=v*a+p*l+b*f,e[6]=g*r+T*o+M*c,e[7]=g*i+T*s+M*u,e[8]=g*a+T*l+M*f,e}function l(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e}var c=s,u=l,f=Object.freeze({__proto__:null,create:o,fromMat4:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},clone:function(e){var t=new i(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},fromValues:function(e,t,n,r,a,o,s,l,c){var u=new i(9);return u[0]=e,u[1]=t,u[2]=n,u[3]=r,u[4]=a,u[5]=o,u[6]=s,u[7]=l,u[8]=c,u},set:function(e,t,n,r,i,a,o,s,l,c){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e[4]=a,e[5]=o,e[6]=s,e[7]=l,e[8]=c,e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},transpose:function(e,t){if(e===t){var n=t[1],r=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},invert:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],f=u*o-s*c,h=-u*a+s*l,d=c*a-o*l,m=n*f+r*h+i*d;return m?(m=1/m,e[0]=f*m,e[1]=(-u*r+i*c)*m,e[2]=(s*r-i*o)*m,e[3]=h*m,e[4]=(u*n-i*l)*m,e[5]=(-s*n+i*a)*m,e[6]=d*m,e[7]=(-c*n+r*l)*m,e[8]=(o*n-r*a)*m,e):null},adjoint:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8];return e[0]=o*u-s*c,e[1]=i*c-r*u,e[2]=r*s-i*o,e[3]=s*l-a*u,e[4]=n*u-i*l,e[5]=i*a-n*s,e[6]=a*c-o*l,e[7]=r*l-n*c,e[8]=n*o-r*a,e},determinant:function(e){var t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8];return t*(c*a-o*l)+n*(-c*i+o*s)+r*(l*i-a*s)},multiply:s,translate:function(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],h=n[0],d=n[1];return e[0]=r,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=l,e[6]=h*r+d*o+c,e[7]=h*i+d*s+u,e[8]=h*a+d*l+f,e},rotate:function(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],h=Math.sin(n),d=Math.cos(n);return e[0]=d*r+h*o,e[1]=d*i+h*s,e[2]=d*a+h*l,e[3]=d*o-h*r,e[4]=d*s-h*i,e[5]=d*l-h*a,e[6]=c,e[7]=u,e[8]=f,e},scale:function(e,t,n){var r=n[0],i=n[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},fromRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=-n,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromMat2d:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},fromQuat:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n+n,s=r+r,l=i+i,c=n*o,u=r*o,f=r*s,h=i*o,d=i*s,m=i*l,v=a*o,p=a*s,b=a*l;return e[0]=1-f-m,e[3]=u-b,e[6]=h+p,e[1]=u+b,e[4]=1-c-m,e[7]=d-v,e[2]=h-p,e[5]=d+v,e[8]=1-c-f,e},normalFromMat4:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],f=t[9],h=t[10],d=t[11],m=t[12],v=t[13],p=t[14],b=t[15],g=n*s-r*o,T=n*l-i*o,M=n*c-a*o,x=r*l-i*s,_=r*c-a*s,A=i*c-a*l,R=u*v-f*m,E=u*p-h*m,S=u*b-d*m,y=f*p-h*v,O=f*b-d*v,L=h*b-d*p,N=g*L-T*O+M*y+x*S-_*E+A*R;return N?(N=1/N,e[0]=(s*L-l*O+c*y)*N,e[1]=(l*S-o*L-c*E)*N,e[2]=(o*O-s*S+c*R)*N,e[3]=(i*O-r*L-a*y)*N,e[4]=(n*L-i*S+a*E)*N,e[5]=(r*S-n*O-a*R)*N,e[6]=(v*A-p*_+b*x)*N,e[7]=(p*M-m*A-b*T)*N,e[8]=(m*_-v*M+b*g)*N,e):null},projection:function(e,t,n){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/n,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},str:function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e},subtract:l,multiplyScalar:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e},multiplyScalarAndAdd:function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r,e},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},equals:function(e,t){var n=e[0],i=e[1],a=e[2],o=e[3],s=e[4],l=e[5],c=e[6],u=e[7],f=e[8],h=t[0],d=t[1],m=t[2],v=t[3],p=t[4],b=t[5],g=t[6],T=t[7],M=t[8];return Math.abs(n-h)<=r*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(i-d)<=r*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(a-m)<=r*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(o-v)<=r*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(s-p)<=r*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-b)<=r*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(c-g)<=r*Math.max(1,Math.abs(c),Math.abs(g))&&Math.abs(u-T)<=r*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(f-M)<=r*Math.max(1,Math.abs(f),Math.abs(M))},mul:c,sub:u});function h(){var e=new i(16);return i!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function d(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function m(e,t,n,r,i,a,o,s,l,c,u,f,h,d,m,v,p){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e[4]=a,e[5]=o,e[6]=s,e[7]=l,e[8]=c,e[9]=u,e[10]=f,e[11]=h,e[12]=d,e[13]=m,e[14]=v,e[15]=p,e}function v(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function p(e,t){if(e===t){var n=t[1],r=t[2],i=t[3],a=t[6],o=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=a,e[11]=t[14],e[12]=i,e[13]=o,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function b(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],f=t[9],h=t[10],d=t[11],m=t[12],v=t[13],p=t[14],b=t[15],g=n*s-r*o,T=n*l-i*o,M=n*c-a*o,x=r*l-i*s,_=r*c-a*s,A=i*c-a*l,R=u*v-f*m,E=u*p-h*m,S=u*b-d*m,y=f*p-h*v,O=f*b-d*v,L=h*b-d*p,N=g*L-T*O+M*y+x*S-_*E+A*R;return N?(N=1/N,e[0]=(s*L-l*O+c*y)*N,e[1]=(i*O-r*L-a*y)*N,e[2]=(v*A-p*_+b*x)*N,e[3]=(h*_-f*A-d*x)*N,e[4]=(l*S-o*L-c*E)*N,e[5]=(n*L-i*S+a*E)*N,e[6]=(p*M-m*A-b*T)*N,e[7]=(u*A-h*M+d*T)*N,e[8]=(o*O-s*S+c*R)*N,e[9]=(r*S-n*O-a*R)*N,e[10]=(m*_-v*M+b*g)*N,e[11]=(f*M-u*_-d*g)*N,e[12]=(s*E-o*y-l*R)*N,e[13]=(n*y-r*E+i*R)*N,e[14]=(v*T-m*x-p*g)*N,e[15]=(u*x-f*T+h*g)*N,e):null}function g(e){var t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8],u=e[9],f=e[10],h=e[11],d=e[12],m=e[13],v=e[14],p=e[15];return(t*o-n*a)*(f*p-h*v)-(t*s-r*a)*(u*p-h*m)+(t*l-i*a)*(u*v-f*m)+(n*s-r*o)*(c*p-h*d)-(n*l-i*o)*(c*v-f*d)+(r*l-i*s)*(c*m-u*d)}function T(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],h=t[9],d=t[10],m=t[11],v=t[12],p=t[13],b=t[14],g=t[15],T=n[0],M=n[1],x=n[2],_=n[3];return e[0]=T*r+M*s+x*f+_*v,e[1]=T*i+M*l+x*h+_*p,e[2]=T*a+M*c+x*d+_*b,e[3]=T*o+M*u+x*m+_*g,T=n[4],M=n[5],x=n[6],_=n[7],e[4]=T*r+M*s+x*f+_*v,e[5]=T*i+M*l+x*h+_*p,e[6]=T*a+M*c+x*d+_*b,e[7]=T*o+M*u+x*m+_*g,T=n[8],M=n[9],x=n[10],_=n[11],e[8]=T*r+M*s+x*f+_*v,e[9]=T*i+M*l+x*h+_*p,e[10]=T*a+M*c+x*d+_*b,e[11]=T*o+M*u+x*m+_*g,T=n[12],M=n[13],x=n[14],_=n[15],e[12]=T*r+M*s+x*f+_*v,e[13]=T*i+M*l+x*h+_*p,e[14]=T*a+M*c+x*d+_*b,e[15]=T*o+M*u+x*m+_*g,e}function M(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=r+r,l=i+i,c=a+a,u=r*s,f=r*l,h=r*c,d=i*l,m=i*c,v=a*c,p=o*s,b=o*l,g=o*c;return e[0]=1-(d+v),e[1]=f+g,e[2]=h-b,e[3]=0,e[4]=f-g,e[5]=1-(u+v),e[6]=m+p,e[7]=0,e[8]=h+b,e[9]=m-p,e[10]=1-(u+d),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function x(e,t){var n=t[0]+t[5]+t[10],r=0;return n>0?(r=2*Math.sqrt(n+1),e[3]=.25*r,e[0]=(t[6]-t[9])/r,e[1]=(t[8]-t[2])/r,e[2]=(t[1]-t[4])/r):t[0]>t[5]&&t[0]>t[10]?(r=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/r,e[0]=.25*r,e[1]=(t[1]+t[4])/r,e[2]=(t[8]+t[2])/r):t[5]>t[10]?(r=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/r,e[0]=(t[1]+t[4])/r,e[1]=.25*r,e[2]=(t[6]+t[9])/r):(r=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/r,e[0]=(t[8]+t[2])/r,e[1]=(t[6]+t[9])/r,e[2]=.25*r),e}function _(e,t,n,r){var i=t[0],a=t[1],o=t[2],s=t[3],l=i+i,c=a+a,u=o+o,f=i*l,h=i*c,d=i*u,m=a*c,v=a*u,p=o*u,b=s*l,g=s*c,T=s*u,M=r[0],x=r[1],_=r[2];return e[0]=(1-(m+p))*M,e[1]=(h+T)*M,e[2]=(d-g)*M,e[3]=0,e[4]=(h-T)*x,e[5]=(1-(f+p))*x,e[6]=(v+b)*x,e[7]=0,e[8]=(d+g)*_,e[9]=(v-b)*_,e[10]=(1-(f+m))*_,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function A(e,t,n,r,i){var a=1/Math.tan(t/2),o=void 0;return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(o=1/(r-i),e[10]=(i+r)*o,e[14]=2*i*r*o):(e[10]=-1,e[14]=-2*r),e}function R(e,t,n,i){var a=void 0,o=void 0,s=void 0,l=void 0,c=void 0,u=void 0,f=void 0,h=void 0,d=void 0,m=void 0,p=t[0],b=t[1],g=t[2],T=i[0],M=i[1],x=i[2],_=n[0],A=n[1],R=n[2];return Math.abs(p-_)<r&&Math.abs(b-A)<r&&Math.abs(g-R)<r?v(e):(f=p-_,h=b-A,d=g-R,a=M*(d*=m=1/Math.sqrt(f*f+h*h+d*d))-x*(h*=m),o=x*(f*=m)-T*d,s=T*h-M*f,(m=Math.sqrt(a*a+o*o+s*s))?(a*=m=1/m,o*=m,s*=m):(a=0,o=0,s=0),l=h*s-d*o,c=d*a-f*s,u=f*o-h*a,(m=Math.sqrt(l*l+c*c+u*u))?(l*=m=1/m,c*=m,u*=m):(l=0,c=0,u=0),e[0]=a,e[1]=l,e[2]=f,e[3]=0,e[4]=o,e[5]=c,e[6]=h,e[7]=0,e[8]=s,e[9]=u,e[10]=d,e[11]=0,e[12]=-(a*p+o*b+s*g),e[13]=-(l*p+c*b+u*g),e[14]=-(f*p+h*b+d*g),e[15]=1,e)}function E(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e[9]=t[9]-n[9],e[10]=t[10]-n[10],e[11]=t[11]-n[11],e[12]=t[12]-n[12],e[13]=t[13]-n[13],e[14]=t[14]-n[14],e[15]=t[15]-n[15],e}var S=T,y=E,O=Object.freeze({__proto__:null,create:h,clone:function(e){var t=new i(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},copy:d,fromValues:function(e,t,n,r,a,o,s,l,c,u,f,h,d,m,v,p){var b=new i(16);return b[0]=e,b[1]=t,b[2]=n,b[3]=r,b[4]=a,b[5]=o,b[6]=s,b[7]=l,b[8]=c,b[9]=u,b[10]=f,b[11]=h,b[12]=d,b[13]=m,b[14]=v,b[15]=p,b},set:m,identity:v,transpose:p,invert:b,adjoint:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],f=t[9],h=t[10],d=t[11],m=t[12],v=t[13],p=t[14],b=t[15];return e[0]=s*(h*b-d*p)-f*(l*b-c*p)+v*(l*d-c*h),e[1]=-(r*(h*b-d*p)-f*(i*b-a*p)+v*(i*d-a*h)),e[2]=r*(l*b-c*p)-s*(i*b-a*p)+v*(i*c-a*l),e[3]=-(r*(l*d-c*h)-s*(i*d-a*h)+f*(i*c-a*l)),e[4]=-(o*(h*b-d*p)-u*(l*b-c*p)+m*(l*d-c*h)),e[5]=n*(h*b-d*p)-u*(i*b-a*p)+m*(i*d-a*h),e[6]=-(n*(l*b-c*p)-o*(i*b-a*p)+m*(i*c-a*l)),e[7]=n*(l*d-c*h)-o*(i*d-a*h)+u*(i*c-a*l),e[8]=o*(f*b-d*v)-u*(s*b-c*v)+m*(s*d-c*f),e[9]=-(n*(f*b-d*v)-u*(r*b-a*v)+m*(r*d-a*f)),e[10]=n*(s*b-c*v)-o*(r*b-a*v)+m*(r*c-a*s),e[11]=-(n*(s*d-c*f)-o*(r*d-a*f)+u*(r*c-a*s)),e[12]=-(o*(f*p-h*v)-u*(s*p-l*v)+m*(s*h-l*f)),e[13]=n*(f*p-h*v)-u*(r*p-i*v)+m*(r*h-i*f),e[14]=-(n*(s*p-l*v)-o*(r*p-i*v)+m*(r*l-i*s)),e[15]=n*(s*h-l*f)-o*(r*h-i*f)+u*(r*l-i*s),e},determinant:g,multiply:T,translate:function(e,t,n){var r=n[0],i=n[1],a=n[2],o=void 0,s=void 0,l=void 0,c=void 0,u=void 0,f=void 0,h=void 0,d=void 0,m=void 0,v=void 0,p=void 0,b=void 0;return t===e?(e[12]=t[0]*r+t[4]*i+t[8]*a+t[12],e[13]=t[1]*r+t[5]*i+t[9]*a+t[13],e[14]=t[2]*r+t[6]*i+t[10]*a+t[14],e[15]=t[3]*r+t[7]*i+t[11]*a+t[15]):(o=t[0],s=t[1],l=t[2],c=t[3],u=t[4],f=t[5],h=t[6],d=t[7],m=t[8],v=t[9],p=t[10],b=t[11],e[0]=o,e[1]=s,e[2]=l,e[3]=c,e[4]=u,e[5]=f,e[6]=h,e[7]=d,e[8]=m,e[9]=v,e[10]=p,e[11]=b,e[12]=o*r+u*i+m*a+t[12],e[13]=s*r+f*i+v*a+t[13],e[14]=l*r+h*i+p*a+t[14],e[15]=c*r+d*i+b*a+t[15]),e},scale:function(e,t,n){var r=n[0],i=n[1],a=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},rotate:function(e,t,n,i){var a,o,s,l,c,u,f,h,d,m,v,p,b,g,T,M,x,_,A,R,E,S,y,O,L=i[0],N=i[1],C=i[2],I=Math.sqrt(L*L+N*N+C*C);return I<r?null:(L*=I=1/I,N*=I,C*=I,a=Math.sin(n),s=1-(o=Math.cos(n)),l=t[0],c=t[1],u=t[2],f=t[3],h=t[4],d=t[5],m=t[6],v=t[7],p=t[8],b=t[9],g=t[10],T=t[11],M=L*L*s+o,x=N*L*s+C*a,_=C*L*s-N*a,A=L*N*s-C*a,R=N*N*s+o,E=C*N*s+L*a,S=L*C*s+N*a,y=N*C*s-L*a,O=C*C*s+o,e[0]=l*M+h*x+p*_,e[1]=c*M+d*x+b*_,e[2]=u*M+m*x+g*_,e[3]=f*M+v*x+T*_,e[4]=l*A+h*R+p*E,e[5]=c*A+d*R+b*E,e[6]=u*A+m*R+g*E,e[7]=f*A+v*R+T*E,e[8]=l*S+h*y+p*O,e[9]=c*S+d*y+b*O,e[10]=u*S+m*y+g*O,e[11]=f*S+v*y+T*O,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},rotateX:function(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[4],o=t[5],s=t[6],l=t[7],c=t[8],u=t[9],f=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*i+c*r,e[5]=o*i+u*r,e[6]=s*i+f*r,e[7]=l*i+h*r,e[8]=c*i-a*r,e[9]=u*i-o*r,e[10]=f*i-s*r,e[11]=h*i-l*r,e},rotateY:function(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[0],o=t[1],s=t[2],l=t[3],c=t[8],u=t[9],f=t[10],h=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*i-c*r,e[1]=o*i-u*r,e[2]=s*i-f*r,e[3]=l*i-h*r,e[8]=a*r+c*i,e[9]=o*r+u*i,e[10]=s*r+f*i,e[11]=l*r+h*i,e},rotateZ:function(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[0],o=t[1],s=t[2],l=t[3],c=t[4],u=t[5],f=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*i+c*r,e[1]=o*i+u*r,e[2]=s*i+f*r,e[3]=l*i+h*r,e[4]=c*i-a*r,e[5]=u*i-o*r,e[6]=f*i-s*r,e[7]=h*i-l*r,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotation:function(e,t,n){var i,a,o,s=n[0],l=n[1],c=n[2],u=Math.sqrt(s*s+l*l+c*c);return u<r?null:(s*=u=1/u,l*=u,c*=u,i=Math.sin(t),o=1-(a=Math.cos(t)),e[0]=s*s*o+a,e[1]=l*s*o+c*i,e[2]=c*s*o-l*i,e[3]=0,e[4]=s*l*o-c*i,e[5]=l*l*o+a,e[6]=c*l*o+s*i,e[7]=0,e[8]=s*c*o+l*i,e[9]=l*c*o-s*i,e[10]=c*c*o+a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},fromXRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromYRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromZRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotationTranslation:M,fromQuat2:function(e,t){var n=new i(3),r=-t[0],a=-t[1],o=-t[2],s=t[3],l=t[4],c=t[5],u=t[6],f=t[7],h=r*r+a*a+o*o+s*s;return h>0?(n[0]=2*(l*s+f*r+c*o-u*a)/h,n[1]=2*(c*s+f*a+u*r-l*o)/h,n[2]=2*(u*s+f*o+l*a-c*r)/h):(n[0]=2*(l*s+f*r+c*o-u*a),n[1]=2*(c*s+f*a+u*r-l*o),n[2]=2*(u*s+f*o+l*a-c*r)),M(e,t,n),e},getTranslation:function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},getScaling:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[4],o=t[5],s=t[6],l=t[8],c=t[9],u=t[10];return e[0]=Math.sqrt(n*n+r*r+i*i),e[1]=Math.sqrt(a*a+o*o+s*s),e[2]=Math.sqrt(l*l+c*c+u*u),e},getRotation:x,fromRotationTranslationScale:_,fromRotationTranslationScaleOrigin:function(e,t,n,r,i){var a=t[0],o=t[1],s=t[2],l=t[3],c=a+a,u=o+o,f=s+s,h=a*c,d=a*u,m=a*f,v=o*u,p=o*f,b=s*f,g=l*c,T=l*u,M=l*f,x=r[0],_=r[1],A=r[2],R=i[0],E=i[1],S=i[2],y=(1-(v+b))*x,O=(d+M)*x,L=(m-T)*x,N=(d-M)*_,C=(1-(h+b))*_,I=(p+g)*_,w=(m+T)*A,G=(p-g)*A,H=(1-(h+v))*A;return e[0]=y,e[1]=O,e[2]=L,e[3]=0,e[4]=N,e[5]=C,e[6]=I,e[7]=0,e[8]=w,e[9]=G,e[10]=H,e[11]=0,e[12]=n[0]+R-(y*R+N*E+w*S),e[13]=n[1]+E-(O*R+C*E+G*S),e[14]=n[2]+S-(L*R+I*E+H*S),e[15]=1,e},fromQuat:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n+n,s=r+r,l=i+i,c=n*o,u=r*o,f=r*s,h=i*o,d=i*s,m=i*l,v=a*o,p=a*s,b=a*l;return e[0]=1-f-m,e[1]=u+b,e[2]=h-p,e[3]=0,e[4]=u-b,e[5]=1-c-m,e[6]=d+v,e[7]=0,e[8]=h+p,e[9]=d-v,e[10]=1-c-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},frustum:function(e,t,n,r,i,a,o){var s=1/(n-t),l=1/(i-r),c=1/(a-o);return e[0]=2*a*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*a*l,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(i+r)*l,e[10]=(o+a)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*a*2*c,e[15]=0,e},perspective:A,perspectiveFromFieldOfView:function(e,t,n,r){var i=Math.tan(t.upDegrees*Math.PI/180),a=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),l=2/(o+s),c=2/(i+a);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(o-s)*l*.5,e[9]=(i-a)*c*.5,e[10]=r/(n-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*n/(n-r),e[15]=0,e},ortho:function(e,t,n,r,i,a,o){var s=1/(t-n),l=1/(r-i),c=1/(a-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+n)*s,e[13]=(i+r)*l,e[14]=(o+a)*c,e[15]=1,e},lookAt:R,targetTo:function(e,t,n,r){var i=t[0],a=t[1],o=t[2],s=r[0],l=r[1],c=r[2],u=i-n[0],f=a-n[1],h=o-n[2],d=u*u+f*f+h*h;d>0&&(u*=d=1/Math.sqrt(d),f*=d,h*=d);var m=l*h-c*f,v=c*u-s*h,p=s*f-l*u;return(d=m*m+v*v+p*p)>0&&(m*=d=1/Math.sqrt(d),v*=d,p*=d),e[0]=m,e[1]=v,e[2]=p,e[3]=0,e[4]=f*p-h*v,e[5]=h*m-u*p,e[6]=u*v-f*m,e[7]=0,e[8]=u,e[9]=f,e[10]=h,e[11]=0,e[12]=i,e[13]=a,e[14]=o,e[15]=1,e},str:function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e[9]=t[9]+n[9],e[10]=t[10]+n[10],e[11]=t[11]+n[11],e[12]=t[12]+n[12],e[13]=t[13]+n[13],e[14]=t[14]+n[14],e[15]=t[15]+n[15],e},subtract:E,multiplyScalar:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12]*n,e[13]=t[13]*n,e[14]=t[14]*n,e[15]=t[15]*n,e},multiplyScalarAndAdd:function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r,e[9]=t[9]+n[9]*r,e[10]=t[10]+n[10]*r,e[11]=t[11]+n[11]*r,e[12]=t[12]+n[12]*r,e[13]=t[13]+n[13]*r,e[14]=t[14]+n[14]*r,e[15]=t[15]+n[15]*r,e},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},equals:function(e,t){var n=e[0],i=e[1],a=e[2],o=e[3],s=e[4],l=e[5],c=e[6],u=e[7],f=e[8],h=e[9],d=e[10],m=e[11],v=e[12],p=e[13],b=e[14],g=e[15],T=t[0],M=t[1],x=t[2],_=t[3],A=t[4],R=t[5],E=t[6],S=t[7],y=t[8],O=t[9],L=t[10],N=t[11],C=t[12],I=t[13],w=t[14],G=t[15];return Math.abs(n-T)<=r*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(i-M)<=r*Math.max(1,Math.abs(i),Math.abs(M))&&Math.abs(a-x)<=r*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(o-_)<=r*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(s-A)<=r*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(l-R)<=r*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(c-E)<=r*Math.max(1,Math.abs(c),Math.abs(E))&&Math.abs(u-S)<=r*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(f-y)<=r*Math.max(1,Math.abs(f),Math.abs(y))&&Math.abs(h-O)<=r*Math.max(1,Math.abs(h),Math.abs(O))&&Math.abs(d-L)<=r*Math.max(1,Math.abs(d),Math.abs(L))&&Math.abs(m-N)<=r*Math.max(1,Math.abs(m),Math.abs(N))&&Math.abs(v-C)<=r*Math.max(1,Math.abs(v),Math.abs(C))&&Math.abs(p-I)<=r*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(b-w)<=r*Math.max(1,Math.abs(b),Math.abs(w))&&Math.abs(g-G)<=r*Math.max(1,Math.abs(g),Math.abs(G))},mul:S,sub:y});function L(){var e=new i(3);return i!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function N(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)}function C(e,t,n){var r=new i(3);return r[0]=e,r[1]=t,r[2]=n,r}function I(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function w(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e}function G(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function H(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e}function F(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e}function D(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)}function P(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return n*n+r*r+i*i}function V(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r}function B(e,t){var n=t[0],r=t[1],i=t[2],a=n*n+r*r+i*i;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a),e}function U(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function z(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],s=n[1],l=n[2];return e[0]=i*l-a*s,e[1]=a*o-r*l,e[2]=r*s-i*o,e}function W(e,t,n,r){var i=t[0],a=t[1],o=t[2];return e[0]=i+r*(n[0]-i),e[1]=a+r*(n[1]-a),e[2]=o+r*(n[2]-o),e}function k(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[3]*r+n[7]*i+n[11]*a+n[15];return o=o||1,e[0]=(n[0]*r+n[4]*i+n[8]*a+n[12])/o,e[1]=(n[1]*r+n[5]*i+n[9]*a+n[13])/o,e[2]=(n[2]*r+n[6]*i+n[10]*a+n[14])/o,e}var X,q=G,j=H,$=F,Z=D,Y=P,J=N,Q=V,K=(X=L(),function(e,t,n,r,i,a){var o=void 0,s=void 0;for(t||(t=3),n||(n=0),s=r?Math.min(r*t+n,e.length):e.length,o=n;o<s;o+=t)X[0]=e[o],X[1]=e[o+1],X[2]=e[o+2],i(X,X,a),e[o]=X[0],e[o+1]=X[1],e[o+2]=X[2];return e}),ee=Object.freeze({__proto__:null,create:L,clone:function(e){var t=new i(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},length:N,fromValues:C,copy:I,set:w,add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e},subtract:G,multiply:H,divide:F,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},min:function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},max:function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},scale:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},scaleAndAdd:function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e},distance:D,squaredDistance:P,squaredLength:V,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},normalize:B,dot:U,cross:z,lerp:W,hermite:function(e,t,n,r,i,a){var o=a*a,s=o*(2*a-3)+1,l=o*(a-2)+a,c=o*(a-1),u=o*(3-2*a);return e[0]=t[0]*s+n[0]*l+r[0]*c+i[0]*u,e[1]=t[1]*s+n[1]*l+r[1]*c+i[1]*u,e[2]=t[2]*s+n[2]*l+r[2]*c+i[2]*u,e},bezier:function(e,t,n,r,i,a){var o=1-a,s=o*o,l=a*a,c=s*o,u=3*a*s,f=3*l*o,h=l*a;return e[0]=t[0]*c+n[0]*u+r[0]*f+i[0]*h,e[1]=t[1]*c+n[1]*u+r[1]*f+i[1]*h,e[2]=t[2]*c+n[2]*u+r[2]*f+i[2]*h,e},random:function(e,t){t=t||1;var n=2*a()*Math.PI,r=2*a()-1,i=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(n)*i,e[1]=Math.sin(n)*i,e[2]=r*t,e},transformMat4:k,transformMat3:function(e,t,n){var r=t[0],i=t[1],a=t[2];return e[0]=r*n[0]+i*n[3]+a*n[6],e[1]=r*n[1]+i*n[4]+a*n[7],e[2]=r*n[2]+i*n[5]+a*n[8],e},transformQuat:function(e,t,n){var r=n[0],i=n[1],a=n[2],o=n[3],s=t[0],l=t[1],c=t[2],u=i*c-a*l,f=a*s-r*c,h=r*l-i*s,d=i*h-a*f,m=a*u-r*h,v=r*f-i*u,p=2*o;return u*=p,f*=p,h*=p,d*=2,m*=2,v*=2,e[0]=s+u+d,e[1]=l+f+m,e[2]=c+h+v,e},rotateX:function(e,t,n,r){var i=[],a=[];return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],a[0]=i[0],a[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),a[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),e[0]=a[0]+n[0],e[1]=a[1]+n[1],e[2]=a[2]+n[2],e},rotateY:function(e,t,n,r){var i=[],a=[];return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],a[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),a[1]=i[1],a[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),e[0]=a[0]+n[0],e[1]=a[1]+n[1],e[2]=a[2]+n[2],e},rotateZ:function(e,t,n,r){var i=[],a=[];return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],a[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),a[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),a[2]=i[2],e[0]=a[0]+n[0],e[1]=a[1]+n[1],e[2]=a[2]+n[2],e},angle:function(e,t){var n=C(e[0],e[1],e[2]),r=C(t[0],t[1],t[2]);B(n,n),B(r,r);var i=U(n,r);return i>1?0:i<-1?Math.PI:Math.acos(i)},str:function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},equals:function(e,t){var n=e[0],i=e[1],a=e[2],o=t[0],s=t[1],l=t[2];return Math.abs(n-o)<=r*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-s)<=r*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(a-l)<=r*Math.max(1,Math.abs(a),Math.abs(l))},sub:q,mul:j,div:$,dist:Z,sqrDist:Y,len:J,sqrLen:Q,forEach:K});function te(){var e=new i(4);return i!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function ne(e){var t=new i(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function re(e,t,n,r){var a=new i(4);return a[0]=e,a[1]=t,a[2]=n,a[3]=r,a}function ie(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function ae(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e}function oe(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e}function se(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function le(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e}function ce(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e}function ue(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e}function fe(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2],a=t[3]-e[3];return Math.sqrt(n*n+r*r+i*i+a*a)}function he(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2],a=t[3]-e[3];return n*n+r*r+i*i+a*a}function de(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)}function me(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i}function ve(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n*n+r*r+i*i+a*a;return o>0&&(o=1/Math.sqrt(o),e[0]=n*o,e[1]=r*o,e[2]=i*o,e[3]=a*o),e}function pe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function be(e,t,n,r){var i=t[0],a=t[1],o=t[2],s=t[3];return e[0]=i+r*(n[0]-i),e[1]=a+r*(n[1]-a),e[2]=o+r*(n[2]-o),e[3]=s+r*(n[3]-s),e}function ge(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3];return e[0]=n[0]*r+n[4]*i+n[8]*a+n[12]*o,e[1]=n[1]*r+n[5]*i+n[9]*a+n[13]*o,e[2]=n[2]*r+n[6]*i+n[10]*a+n[14]*o,e[3]=n[3]*r+n[7]*i+n[11]*a+n[15]*o,e}function Te(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Me(e,t){var n=e[0],i=e[1],a=e[2],o=e[3],s=t[0],l=t[1],c=t[2],u=t[3];return Math.abs(n-s)<=r*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-l)<=r*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(a-c)<=r*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(o-u)<=r*Math.max(1,Math.abs(o),Math.abs(u))}var xe=se,_e=le,Ae=ce,Re=fe,Ee=he,Se=de,ye=me,Oe=function(){var e=te();return function(t,n,r,i,a,o){var s=void 0,l=void 0;for(n||(n=4),r||(r=0),l=i?Math.min(i*n+r,t.length):t.length,s=r;s<l;s+=n)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],a(e,e,o),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2],t[s+3]=e[3];return t}}(),Le=Object.freeze({__proto__:null,create:te,clone:ne,fromValues:re,copy:ie,set:ae,add:oe,subtract:se,multiply:le,divide:ce,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},min:function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},max:function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},scale:ue,scaleAndAdd:function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},distance:fe,squaredDistance:he,length:de,squaredLength:me,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},normalize:ve,dot:pe,lerp:be,random:function(e,t){var n,r,i,o,s,l;t=t||1;do{s=(n=2*a()-1)*n+(r=2*a()-1)*r}while(s>=1);do{l=(i=2*a()-1)*i+(o=2*a()-1)*o}while(l>=1);var c=Math.sqrt((1-s)/l);return e[0]=t*n,e[1]=t*r,e[2]=t*i*c,e[3]=t*o*c,e},transformMat4:ge,transformQuat:function(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],s=n[1],l=n[2],c=n[3],u=c*r+s*a-l*i,f=c*i+l*r-o*a,h=c*a+o*i-s*r,d=-o*r-s*i-l*a;return e[0]=u*c+d*-o+f*-l-h*-s,e[1]=f*c+d*-s+h*-o-u*-l,e[2]=h*c+d*-l+u*-s-f*-o,e[3]=t[3],e},str:function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},exactEquals:Te,equals:Me,sub:xe,mul:_e,div:Ae,dist:Re,sqrDist:Ee,len:Se,sqrLen:ye,forEach:Oe});function Ne(){var e=new i(4);return i!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Ce(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e}function Ie(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],l=n[1],c=n[2],u=n[3];return e[0]=r*u+o*s+i*c-a*l,e[1]=i*u+o*l+a*s-r*c,e[2]=a*u+o*c+r*l-i*s,e[3]=o*u-r*s-i*l-a*c,e}function we(e,t,n,i){var a=t[0],o=t[1],s=t[2],l=t[3],c=n[0],u=n[1],f=n[2],h=n[3],d=void 0,m=void 0,v=void 0,p=void 0,b=void 0;return(m=a*c+o*u+s*f+l*h)<0&&(m=-m,c=-c,u=-u,f=-f,h=-h),1-m>r?(d=Math.acos(m),v=Math.sin(d),p=Math.sin((1-i)*d)/v,b=Math.sin(i*d)/v):(p=1-i,b=i),e[0]=p*a+b*c,e[1]=p*o+b*u,e[2]=p*s+b*f,e[3]=p*l+b*h,e}function Ge(e,t){var n=t[0]+t[4]+t[8],r=void 0;if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;r=Math.sqrt(t[3*i+i]-t[3*a+a]-t[3*o+o]+1),e[i]=.5*r,r=.5/r,e[3]=(t[3*a+o]-t[3*o+a])*r,e[a]=(t[3*a+i]+t[3*i+a])*r,e[o]=(t[3*o+i]+t[3*i+o])*r}return e}var He,Fe,De,Pe,Ve,Be,Ue=ne,ze=re,We=ie,ke=ae,Xe=oe,qe=Ie,je=ue,$e=pe,Ze=be,Ye=de,Je=Ye,Qe=me,Ke=Qe,et=ve,tt=Te,nt=Me,rt=(He=L(),Fe=C(1,0,0),De=C(0,1,0),function(e,t,n){var r=U(t,n);return r<-.999999?(z(He,Fe,t),J(He)<1e-6&&z(He,De,t),B(He,He),Ce(e,He,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(z(He,t,n),e[0]=He[0],e[1]=He[1],e[2]=He[2],e[3]=1+r,et(e,e))}),it=(Pe=Ne(),Ve=Ne(),function(e,t,n,r,i,a){return we(Pe,t,i,a),we(Ve,n,r,a),we(e,Pe,Ve,2*a*(1-a)),e}),at=(Be=o(),function(e,t,n,r){return Be[0]=n[0],Be[3]=n[1],Be[6]=n[2],Be[1]=r[0],Be[4]=r[1],Be[7]=r[2],Be[2]=-t[0],Be[5]=-t[1],Be[8]=-t[2],et(e,Ge(e,Be))}),ot=Object.freeze({__proto__:null,create:Ne,identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},setAxisAngle:Ce,getAxisAngle:function(e,t){var n=2*Math.acos(t[3]),i=Math.sin(n/2);return i>r?(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i):(e[0]=1,e[1]=0,e[2]=0),n},multiply:Ie,rotateX:function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l+o*s,e[1]=i*l+a*s,e[2]=a*l-i*s,e[3]=o*l-r*s,e},rotateY:function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l-a*s,e[1]=i*l+o*s,e[2]=a*l+r*s,e[3]=o*l-i*s,e},rotateZ:function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l+i*s,e[1]=i*l-r*s,e[2]=a*l+o*s,e[3]=o*l-a*s,e},calculateW:function(e,t){var n=t[0],r=t[1],i=t[2];return e[0]=n,e[1]=r,e[2]=i,e[3]=Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e},slerp:we,random:function(e){var t=a(),n=a(),r=a(),i=Math.sqrt(1-t),o=Math.sqrt(t);return e[0]=i*Math.sin(2*Math.PI*n),e[1]=i*Math.cos(2*Math.PI*n),e[2]=o*Math.sin(2*Math.PI*r),e[3]=o*Math.cos(2*Math.PI*r),e},invert:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n*n+r*r+i*i+a*a,s=o?1/o:0;return e[0]=-n*s,e[1]=-r*s,e[2]=-i*s,e[3]=a*s,e},conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},fromMat3:Ge,fromEuler:function(e,t,n,r){var i=.5*Math.PI/180;t*=i,n*=i,r*=i;var a=Math.sin(t),o=Math.cos(t),s=Math.sin(n),l=Math.cos(n),c=Math.sin(r),u=Math.cos(r);return e[0]=a*l*u-o*s*c,e[1]=o*s*u+a*l*c,e[2]=o*l*c-a*s*u,e[3]=o*l*u+a*s*c,e},str:function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},clone:Ue,fromValues:ze,copy:We,set:ke,add:Xe,mul:qe,scale:je,dot:$e,lerp:Ze,length:Ye,len:Je,squaredLength:Qe,sqrLen:Ke,normalize:et,exactEquals:tt,equals:nt,rotationTo:rt,sqlerp:it,setAxes:at});function st(){var e=new i(2);return i!=Float32Array&&(e[0]=0,e[1]=0),e}function lt(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function ct(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e}function ut(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e}function ft(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)}function ht(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function dt(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)}function mt(e){var t=e[0],n=e[1];return t*t+n*n}var vt=dt,pt=lt,bt=ct,gt=ut,Tt=ft,Mt=ht,xt=mt,_t=function(){var e=st();return function(t,n,r,i,a,o){var s=void 0,l=void 0;for(n||(n=2),r||(r=0),l=i?Math.min(i*n+r,t.length):t.length,s=r;s<l;s+=n)e[0]=t[s],e[1]=t[s+1],a(e,e,o),t[s]=e[0],t[s+1]=e[1];return t}}(),At=Object.freeze({__proto__:null,create:st,clone:function(e){var t=new i(2);return t[0]=e[0],t[1]=e[1],t},fromValues:function(e,t){var n=new i(2);return n[0]=e,n[1]=t,n},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e},set:function(e,t,n){return e[0]=t,e[1]=n,e},add:function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},subtract:lt,multiply:ct,divide:ut,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},min:function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},max:function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},scale:function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},scaleAndAdd:function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},distance:ft,squaredDistance:ht,length:dt,squaredLength:mt,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},normalize:function(e,t){var n=t[0],r=t[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i),e},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]},cross:function(e,t,n){var r=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=r,e},lerp:function(e,t,n,r){var i=t[0],a=t[1];return e[0]=i+r*(n[0]-i),e[1]=a+r*(n[1]-a),e},random:function(e,t){t=t||1;var n=2*a()*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},transformMat2:function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i,e[1]=n[1]*r+n[3]*i,e},transformMat2d:function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i+n[4],e[1]=n[1]*r+n[3]*i+n[5],e},transformMat3:function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[3]*i+n[6],e[1]=n[1]*r+n[4]*i+n[7],e},transformMat4:function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[4]*i+n[12],e[1]=n[1]*r+n[5]*i+n[13],e},rotate:function(e,t,n,r){var i=t[0]-n[0],a=t[1]-n[1],o=Math.sin(r),s=Math.cos(r);return e[0]=i*s-a*o+n[0],e[1]=i*o+a*s+n[1],e},angle:function(e,t){var n=e[0],r=e[1],i=t[0],a=t[1],o=n*n+r*r;o>0&&(o=1/Math.sqrt(o));var s=i*i+a*a;s>0&&(s=1/Math.sqrt(s));var l=(n*i+r*a)*o*s;return l>1?0:l<-1?Math.PI:Math.acos(l)},str:function(e){return"vec2("+e[0]+", "+e[1]+")"},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]},equals:function(e,t){var n=e[0],i=e[1],a=t[0],o=t[1];return Math.abs(n-a)<=r*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=r*Math.max(1,Math.abs(i),Math.abs(o))},len:vt,sub:pt,mul:bt,div:gt,dist:Tt,sqrDist:Mt,sqrLen:xt,forEach:_t});class Rt{constructor(e,t,n=WebGL2RenderingContext.TRIANGLES){this.data={},this.attributes=e,t&&(this.indices=t,this.indices.bufferView.target=WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER),this.mode=n;for(let t of e){const e=t.attribute;this.data[e]=t.data}}static bindAccessorsVBO(e,t,n){for(let r of e.attributes){let e=n[r.attribute];if(r.attribute&&null!=e){St.bindBuffer(r.bufferView,t),t.enableVertexAttribArray(e);let n=r.byteOffset;t.vertexAttribPointer(e,r.size,r.componentType,r.normalized,r.bufferView.byteStride,n)}}}static drawElements(e,t){let n=e.indices;t.drawElements(e.mode,n.count,n.componentType,n.byteOffset)}static drawArrays(e,t){t.drawArrays(e.mode,0,e.attributes[0].count)}static drawcall(e,t){e.indices?(St.bindBuffer(e.indices.bufferView,t),this.drawElements(e,t)):this.drawArrays(e,t)}static preComputeNormal(e){let{indices:t}=e,n={};for(let t of e.attributes){if("POSITION"!=t.attribute)continue;let e=Et.newFloat32Array(t),r=Et.getSubChunks(t,e);n["_"+t.attribute]=e,n[t.attribute]=r,"POSITION"==t.attribute&&(n._NORMAL=new Float32Array(e.length),n.NORMAL=Et.getSubChunks(t,n._NORMAL))}n.i=t?Et.newTypedArray(t):n.POSITION.map((e,t)=>t);let r=n.POSITION,i=n.i,a=n.NORMAL,o=L(),s=L();for(let e=0,t=i.length;e<t;e+=3){let t=i[e],n=i[e+1],l=i[e+2],c=r[t],u=r[n],f=r[l];q(o,u,c),q(s,f,c);let h=a[t];z(h,o,s),B(h,h),I(a[n],h),I(a[l],h)}let l=new St;l.dataView=n._NORMAL,e.attributes.push(new Et({bufferView:l,byteOffset:0,componentType:5126,count:a.length,type:"VEC3"},"NORMAL"))}static preComputeTangent(e){let t=e.indices,n={};for(let t of e.attributes){if("POSITION"!=t.attribute&&"TEXCOORD_0"!=t.attribute)continue;let e=Et.newFloat32Array(t),r=Et.getSubChunks(t,e);n["_"+t.attribute]=e,n[t.attribute]=r,"POSITION"==t.attribute&&(n._TANGENT=new Float32Array(e.length),n.TANGENT=Et.getSubChunks(t,n._TANGENT))}n.i=t?Et.newTypedArray(t):n.POSITION.map((e,t)=>t);let r=n.POSITION,i=n.TEXCOORD_0,a=n.i,o=n.TANGENT,s=L(),l=L(),c=st(),u=st();for(let e=0,t=a.length;e<t;e+=3){let t=a[e],n=a[e+1],f=a[e+2],h=r[t],d=r[n],m=r[f],v=i[t],p=i[n],b=i[f];q(s,d,h),q(l,m,h),q(c,p,v),q(u,b,v);let g=o[t],T=1/(c[0]*u[1]-u[0]*c[1]);g[0]=T*(u[1]*s[0]-c[1]*l[0]),g[1]=T*(u[1]*s[1]-c[1]*l[1]),g[2]=T*(u[1]*s[2]-c[1]*l[2]),B(g,g),I(o[n],g),I(o[f],g)}let f=new St;f.dataView=n._TANGENT,e.attributes.push(new Et({bufferView:f,byteOffset:0,componentType:5126,count:o.length,type:"VEC3"},"TANGENT"))}}class Et{constructor({bufferView:e,byteOffset:t=0,componentType:n,normalized:r=!1,count:i,type:a,max:o=[],min:s=[]},l=""){this.attribute=l,this.bufferView=e,this.byteOffset=t,this.componentType=n,this.normalized=r,this.count=i,this.max=o,this.min=s,this.size=Et.types[a]}get data(){return this._data||(this._data=Et.getData(this)),this._data}static newFloat32Array(e){return new Float32Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count)}static getSubChunks(e,t){let n=[];for(let r=0;r<e.count;r++){let i=r*e.size;n.push(t.subarray(i,i+e.size))}return n}static getFloat32Blocks(e){return this.getSubChunks(e,Et.newTypedArray(e))}static getUint16Blocks(e){return this.getSubChunks(e,Et.newTypedArray(e))}static newTypedArray(e){switch(e.componentType){case 5120:return new Int8Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count);case 5121:return new Uint8Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count);case 5122:return new Int16Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count);case 5123:return new Uint16Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count);case 5125:return new Uint32Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count);case 5126:return new Float32Array(e.bufferView.rawBuffer,e.byteOffset+e.bufferView.byteOffset,e.size*e.count)}}static getData(e){return e.size>1?this.getFloat32Blocks(e):this.newTypedArray(e)}}Et.types={SCALAR:1,VEC1:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};class St{constructor(e,{byteOffset:t=0,byteLength:n=0,byteStride:r=0,target:i=34962}={}){this.buffer=null,this.rawBuffer=e,this.byteOffset=t,this.byteLength=n,this.byteStride=r,e&&(this.dataView=new DataView(e,this.byteOffset,this.byteLength)),this.target=i}static updateBuffer(e,t,n=WebGL2RenderingContext.STATIC_DRAW){e.buffer&&t.deleteBuffer(e.buffer),e.buffer=t.createBuffer(),t.bindBuffer(e.target,e.buffer),t.bufferData(e.target,e.dataView,n)}static bindBuffer(e,t){e.buffer||this.updateBuffer(e,t),t.bindBuffer(e.target,e.buffer)}}let yt={basic:{vs:"#include <macros>\nattribute vec3 POSITION;void main(){gl_Position=vec4(POSITION,1);}",fs:"precision highp float;\n#include <macros>\nuniform sampler2D base;void main(){vec2 uv=gl_FragCoord.xy/screenSize;gl_FragColor=texture2D(base,uv);}"},stylize:{vs:"#include <macros>\nattribute vec3 POSITION;attribute vec3 NORMAL;attribute vec2 TEXCOORD_0;attribute vec2 TEXCOORD_1;attribute vec4 TANGENT;\n#ifdef COLOR_0_SIZE_3\nattribute vec3 COLOR_0;\n#elif defined(COLOR_0_SIZE_4)\nattribute vec4 COLOR_0;\n#endif\n#ifdef HAS_SKINS\n#ifndef JOINT_AMOUNT\n#define JOINT_AMOUNT 200\n#endif\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;uniform mat4 jointMat[JOINT_AMOUNT];\n#endif\nuniform mat4 M;uniform mat4 VP;uniform mat4 nM;\n#ifdef HAS_MORPH_TARGETS\nuniform float weights;attribute vec3 TAR_POSITION;\n#endif\nvarying vec3 normal;varying vec2 uv;varying vec2 uv1;varying vec3 pos;varying vec4 vColor;varying mat3 TBN;void main(){uv=TEXCOORD_0;uv1=TEXCOORD_1;vec3 skinedNormal=NORMAL;\n#ifdef HAS_MORPH_TARGETS\nvec4 position=vec4((POSITION+TAR_POSITION*weights),1);\n#else\nvec4 position=vec4(POSITION,1);\n#endif\n#ifdef HAS_SKINS\nmat4 skinMat=WEIGHTS_0.x*jointMat[int(JOINTS_0.x)]+WEIGHTS_0.y*jointMat[int(JOINTS_0.y)]+WEIGHTS_0.z*jointMat[int(JOINTS_0.z)]+WEIGHTS_0.w*jointMat[int(JOINTS_0.w)];position=M*skinMat*position;skinedNormal=(skinMat*vec4(skinedNormal,0)).xyz;\n#else\nposition=M*position;\n#endif\nnormal=normalize((nM*vec4(skinedNormal,0)).xyz);vec3 tangent=normalize(vec3(nM*vec4(TANGENT.xyz,0)));vec3 bitangent=cross(normal,tangent)*TANGENT.w;TBN=mat3(tangent,bitangent,normal);\n#ifdef COLOR_0_SIZE_3\nvColor=vec4(COLOR_0,1);\n#elif defined(COLOR_0_SIZE_4)\nvColor=COLOR_0;\n#endif\npos=position.xyz/position.w;gl_Position=VP*position;}",fs:"precision highp float;\n#include <macros>\n#define PI 3.14159265358979\n#define GAMMA 2.2\nvarying vec3 normal;varying vec2 uv;varying vec2 uv1;varying vec3 pos;varying vec4 vColor;varying mat3 TBN;uniform sampler2D brdfLUT;\n#ifdef HAS_EMISSIVE_MAP\n#ifndef emissiveTexture_uv\n#define emissiveTexture_uv uv\n#endif\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\n#ifndef normalTexture_uv\n#define normalTexture_uv uv\n#endif\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_BASECOLOR_MAP\n#ifndef baseColorTexture_uv\n#define baseColorTexture_uv uv\n#endif\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\n#ifndef metallicRoughnessTexture_uv\n#define metallicRoughnessTexture_uv uv\n#endif\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#ifdef HAS_AO_MAP\n#ifndef occlusionTexture_uv\n#define occlusionTexture_uv uv\n#endif\nuniform sampler2D occlusionTexture;\n#endif\n#ifdef HAS_ENV_MAP\nuniform samplerCube env;\n#endif\nuniform vec3 u_Camera;vec4 sRGBtoLINEAR(vec4 color){return vec4(pow(color.rgb,vec3(GAMMA)),color.a);}vec4 LINEARtoSRGB(vec4 color){return vec4(pow(color.rgb,vec3(1.0/GAMMA)),color.a);}vec3 F_Schlick(float VoH,vec3 F0){return F0+(vec3(1)-F0)*pow(1.0-VoH,5.0);}vec3 F_UE4(float VoH,vec3 F0){return F0+(vec3(1.0)-F0)*pow(2.0,(-5.55473*VoH-6.98316)*VoH);}float G_CookTorrance(float NoV,float NoH,float VoH,float NoL){return min(min(2.0*NoV*NoH/VoH,2.0*NoL*NoH/VoH),1.0);}float G_UE4(float NoV,float NoH,float VoH,float NoL,float roughness){float k=(roughness+1.0)*(roughness+1.0)/8.0;float l=NoL/(NoL*(1.0-k)+k);float v=NoV/(NoV*(1.0-k)+k);return l*v;}float D_GGX(float a,float NoH){a=a*a;float f=NoH*NoH*(a-1.0)+1.0;return a/(PI*f*f);}struct coreData{vec3 diffuse;vec3 f0;vec3 N;vec3 V;vec3 R;float NoV;float metallic;float roughness;float alphaRoughness;};vec3 lightContrib(vec3 lightDir,coreData core){vec3 L=normalize(lightDir);vec3 H=normalize(core.V+L);float NoL=clamp(dot(core.N,L),0.001,1.0);float NoH=clamp(dot(core.N,H),0.0,1.0);float LoH=clamp(dot(L,H),0.0,1.0);float VoH=clamp(dot(core.V,H),0.0,1.0);vec3 F=F_Schlick(VoH,core.f0);float G=G_UE4(core.NoV,NoH,VoH,NoL,core.roughness);float D=D_GGX(core.alphaRoughness,NoH);vec3 specContrib=F*G*D/(4.0*NoL*core.NoV);vec3 diffuseContrib=(1.0-F)*core.diffuse*(1.0-core.metallic);vec3 color=NoL*(diffuseContrib+specContrib);return color;}void main(){\n#ifdef HAS_EMISSIVE_MAP\nvec4 em=sRGBtoLINEAR(texture2D(emissiveTexture,emissiveTexture_uv));\n#endif\n#ifdef HAS_BASECOLOR_MAP\nvec4 base=sRGBtoLINEAR(texture2D(baseColorTexture,baseColorTexture_uv));\n#else\nvec4 base=vec4(1);\n#endif\n#if defined(COLOR_0_SIZE_3) || defined(COLOR_0_SIZE_4)\nbase*=vColor;\n#endif\n#ifdef BASECOLOR_FACTOR\nbase*=BASECOLOR_FACTOR;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\nvec3 rm=texture2D(metallicRoughnessTexture,metallicRoughnessTexture_uv).rgb;\n#else\nvec3 rm=vec3(1);\n#endif\n#ifdef HAS_AO_MAP\nvec4 ao=texture2D(occlusionTexture,occlusionTexture_uv);\n#endif\n#ifdef HAS_NORMAL_MAP\nvec3 normalAddation=texture2D(normalTexture,normalTexture_uv).rgb*2.0-1.0;vec3 N=normalize(TBN*normalAddation);\n#else\nvec3 N=normalize(normal);\n#endif\nvec3 V=normalize(u_Camera-pos);float NoV=clamp(abs(dot(N,V)),0.001,1.0);vec3 R=-normalize(reflect(V,N));float roughness=clamp(rm.g,0.04,1.0);\n#ifdef ROUGHNESS_FACTOR\nroughness*=ROUGHNESS_FACTOR;\n#endif\nfloat alphaRoughness=roughness*roughness;float metallic=clamp(rm.b,0.0,1.0);\n#ifdef METALLIC_FACTOR\nmetallic*=METALLIC_FACTOR;\n#endif\nvec3 f0=vec3(0.04);vec3 diffuse=base.rgb*(vec3(1)-f0)*(1.0-metallic);diffuse/=PI;f0=mix(f0,base.xyz,metallic);coreData core=coreData(diffuse,f0,N,V,R,NoV,metallic,roughness,alphaRoughness);vec3 color;\n#ifdef HAS_ENV_MAP\nvec3 brdf=sRGBtoLINEAR(texture2D(brdfLUT,vec2(NoV,1.0-alphaRoughness))).rgb;vec3 IBLcolor=sRGBtoLINEAR(textureCube(env,R)).rgb;vec3 IBLspecular=1.0*IBLcolor*(f0*brdf.x+brdf.y);color+=IBLspecular;\n#endif\ncolor+=lightContrib(vec3(2,5,2),core)*vec3(2);color+=lightContrib(vec3(1,1,5),core)*vec3(1.0,0.8902,0.6902)*4.0;color+=lightContrib(vec3(-5,3,-5),core)*vec3(0.6431,0.9176,1.0);\n#ifdef HAS_EMISSIVE_MAP\ncolor+=em.rgb;\n#endif\n#ifdef BLEND\ngl_FragColor=LINEARtoSRGB(vec4(color,base.a));\n#elif defined(MASK)\n#ifndef ALPHA_CUTOFF\n#define ALPHA_CUTOFF 0.5\n#endif\nif(base.a<ALPHA_CUTOFF)discard;gl_FragColor=LINEARtoSRGB(vec4(color,1));\n#else\ngl_FragColor=LINEARtoSRGB(vec4(color,1));\n#endif\n}"},stylize2:{vs:"#version 300 es\n#include <macros>\nin vec3 POSITION;in vec3 NORMAL;in vec2 TEXCOORD_0;in vec2 TEXCOORD_1;in vec4 TANGENT;\n#ifdef COLOR_0_SIZE_3\nin vec3 COLOR_0;\n#elif defined(COLOR_0_SIZE_4)\nin vec4 COLOR_0;\n#endif\n#ifdef HAS_SKINS\n#ifndef JOINT_AMOUNT\n#define JOINT_AMOUNT 200\n#endif\nin vec4 JOINTS_0;in vec4 WEIGHTS_0;uniform mat4 jointMat[JOINT_AMOUNT];\n#endif\nuniform mat4 M;uniform mat4 VP;uniform mat4 nM;\n#ifdef HAS_MORPH_TARGETS\nuniform float weights;in vec3 TAR_POSITION;\n#endif\nout vec3 normal;out vec2 uv;out vec2 uv1;out vec3 pos;out vec4 vColor;out mat3 TBN;void main(){uv=TEXCOORD_0;uv1=TEXCOORD_1;vec3 skinedNormal=NORMAL;\n#ifdef HAS_MORPH_TARGETS\nvec4 position=vec4((POSITION+TAR_POSITION*weights),1);\n#else\nvec4 position=vec4(POSITION,1);\n#endif\n#ifdef HAS_SKINS\nmat4 skinMat=WEIGHTS_0.x*jointMat[int(JOINTS_0.x)]+WEIGHTS_0.y*jointMat[int(JOINTS_0.y)]+WEIGHTS_0.z*jointMat[int(JOINTS_0.z)]+WEIGHTS_0.w*jointMat[int(JOINTS_0.w)];position=M*skinMat*position;skinedNormal=(skinMat*vec4(skinedNormal,0)).xyz;\n#else\nposition=M*position;\n#endif\nnormal=normalize((nM*vec4(skinedNormal,0)).xyz);vec3 tangent=normalize(vec3(nM*vec4(TANGENT.xyz,0)));vec3 bitangent=cross(normal,tangent)*TANGENT.w;TBN=mat3(tangent,bitangent,normal);\n#ifdef COLOR_0_SIZE_3\nvColor=vec4(COLOR_0,1);\n#elif defined(COLOR_0_SIZE_4)\nvColor=COLOR_0;\n#endif\npos=position.xyz/position.w;gl_Position=VP*position;}",fs:"#version 300 es\n#ifdef USE_HDR\n#extension GL_OES_texture_float : enable\n#extension GL_OES_texture_float_linear : enable\n#endif\nprecision highp float;\n#include <macros>\n#define PI 3.14159265358979\n#define GAMMA 2.2\nout vec4 outColor;in vec3 normal;in vec2 uv;in vec2 uv1;in vec3 pos;in vec4 vColor;in mat3 TBN;uniform sampler2D brdfLUT;\n#ifdef HAS_EMISSIVE_MAP\n#ifndef emissiveTexture_uv\n#define emissiveTexture_uv uv\n#endif\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\n#ifndef normalTexture_uv\n#define normalTexture_uv uv\n#endif\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_BASECOLOR_MAP\n#ifndef baseColorTexture_uv\n#define baseColorTexture_uv uv\n#endif\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\n#ifndef metallicRoughnessTexture_uv\n#define metallicRoughnessTexture_uv uv\n#endif\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#ifdef HAS_AO_MAP\n#ifndef occlusionTexture_uv\n#define occlusionTexture_uv uv\n#endif\nuniform sampler2D occlusionTexture;\n#endif\n#ifdef HAS_ENV_MAP\nuniform samplerCube env;\n#endif\n#ifdef HAS_DIFFENV_MAP\nuniform samplerCube diffenv;\n#else\n#define HAS_IRRSH\n#endif\nuniform vec3 u_Camera;\n#ifdef USE_HDR\n#ifdef HAS_EXPUSRE\nuniform float u_Exposure;\n#else\n#define u_Exposure 2.\n#endif\n#endif\n#ifdef HAS_IRRSH\nuniform vec3 u_irrSH[9];vec3 diffuseSH(const in vec3 n){return max(vec3(0),u_irrSH[0]+u_irrSH[1]*n.y+u_irrSH[2]*n.z+u_irrSH[3]*n.x+u_irrSH[4]*n.y*n.x+u_irrSH[5]*n.y*n.z+u_irrSH[6]*(3.0*n.z*n.z-1.0)+u_irrSH[7]*(n.z*n.x)+u_irrSH[8]*(n.x*n.x-n.y*n.y));}\n#endif\nvec4 sRGBtoLINEAR(vec4 color){return vec4(pow(color.rgb,vec3(GAMMA)),color.a);}vec4 LINEARtoSRGB(vec4 color){return vec4(pow(color.rgb,vec3(1.0/GAMMA)),color.a);}vec3 toneMapACES(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return pow(clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0),vec3(1.0/GAMMA));}vec3 F_Schlick(float VoH,vec3 F0){return F0+(vec3(1)-F0)*pow(1.0-VoH,5.0);}vec3 F_UE4(float VoH,vec3 F0){return F0+(vec3(1.0)-F0)*pow(2.0,(-5.55473*VoH-6.98316)*VoH);}float G_CookTorrance(float NoV,float NoH,float VoH,float NoL){return min(min(2.0*NoV*NoH/VoH,2.0*NoL*NoH/VoH),1.0);}float G_UE4(float NoV,float NoH,float VoH,float NoL,float roughness){float k=(roughness+1.0)*(roughness+1.0)/8.0;float l=NoL/(NoL*(1.0-k)+k);float v=NoV/(NoV*(1.0-k)+k);return l*v;}float D_GGX(float a,float NoH){a=a*a;float f=NoH*NoH*(a-1.0)+1.0;return a/(PI*f*f);}struct coreData{vec3 diffuse;vec3 f0;vec3 N;vec3 V;vec3 R;float NoV;float metallic;float roughness;float alphaRoughness;};vec3 lightContrib(vec3 lightDir,coreData core){vec3 L=normalize(lightDir);vec3 H=normalize(core.V+L);float NoL=clamp(dot(core.N,L),0.001,1.0);float NoH=clamp(dot(core.N,H),0.0,1.0);float LoH=clamp(dot(L,H),0.0,1.0);float VoH=clamp(dot(core.V,H),0.0,1.0);vec3 F=F_Schlick(VoH,core.f0);float G=G_UE4(core.NoV,NoH,VoH,NoL,core.roughness);float D=D_GGX(core.alphaRoughness,NoH);vec3 specContrib=F*G*D/(4.0*NoL*core.NoV);vec3 diffuseContrib=(1.0-F)*core.diffuse/PI;vec3 color=NoL*(diffuseContrib+specContrib);return color;}vec3 decoRGBE(vec4 r){if(r.a!=0.){float e=exp2(r.a*255.-128.);return vec3(r.r*e,r.g*e,r.b*e);}return vec3(0);}void main(){\n#ifdef HAS_EMISSIVE_MAP\nvec4 em=sRGBtoLINEAR(texture(emissiveTexture,emissiveTexture_uv));\n#endif\n#ifdef HAS_BASECOLOR_MAP\nvec4 base=sRGBtoLINEAR(texture(baseColorTexture,baseColorTexture_uv));\n#else\nvec4 base=vec4(1);\n#endif\n#if defined(COLOR_0_SIZE_3) || defined(COLOR_0_SIZE_4)\nbase*=vColor;\n#endif\n#ifdef BASECOLOR_FACTOR\nbase*=BASECOLOR_FACTOR;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\nvec3 rm=texture(metallicRoughnessTexture,metallicRoughnessTexture_uv).rgb;\n#else\nvec3 rm=vec3(1);\n#endif\n#ifdef HAS_AO_MAP\nvec4 ao=texture(occlusionTexture,occlusionTexture_uv);\n#endif\n#ifdef HAS_NORMAL_MAP\nvec3 normalAddation=texture(normalTexture,normalTexture_uv).rgb*2.0-1.0;vec3 N=normalize(TBN*normalAddation);\n#else\nvec3 N=normalize(normal);\n#endif\nvec3 V=normalize(u_Camera-pos);float NoV=clamp(abs(dot(N,V)),0.0,1.0);vec3 R=-normalize(reflect(V,N));float roughness=clamp(rm.g,0.04,1.0);\n#ifdef ROUGHNESS_FACTOR\nroughness*=ROUGHNESS_FACTOR;\n#endif\nfloat alphaRoughness=roughness*roughness;float metallic=clamp(rm.b,0.0,1.0);\n#ifdef METALLIC_FACTOR\nmetallic*=METALLIC_FACTOR;\n#endif\nvec3 f0=vec3(0.04);vec3 diffuse=base.rgb*(vec3(1)-f0)*(1.0-metallic);f0=mix(f0,base.xyz,metallic);coreData core=coreData(diffuse,f0,N,V,R,NoV,metallic,roughness,alphaRoughness);vec3 color;color+=lightContrib(vec3(1,5,5),core)*vec3(1.0,0.8902,0.6902)*2.0;float lod=clamp(roughness*11.,0.0,11.);\n#ifdef HAS_DIFFENV_MAP\n#ifdef USE_HDR\nvec3 diffSample=decoRGBE(texture(diffenv,R,lod));\n#else\nvec3 diffSample=sRGBtoLINEAR(texture(diffenv,R,lod)).rgb;\n#endif\ncolor+=diffSample*diffuse;\n#endif\n#ifdef HAS_IRRSH\n#ifdef USE_HDR\ncolor+=diffuse*diffuseSH(N)*.1;\n#else\ncolor+=diffuse*diffuseSH(N);\n#endif\n#endif\n#ifdef HAS_ENV_MAP\nvec3 brdf=sRGBtoLINEAR(texture(brdfLUT,vec2(NoV,1.0-alphaRoughness))).rgb;\n#ifdef USE_HDR\nvec3 IBLcolor=decoRGBE(texture(env,R,lod))*u_Exposure;\n#else\nvec3 IBLcolor=sRGBtoLINEAR(texture(env,R,lod)).rgb;\n#endif\nvec3 IBLspecular=IBLcolor*(f0*brdf.x+brdf.y);color+=IBLspecular;\n#endif\n#ifdef HAS_EMISSIVE_MAP\ncolor+=em.rgb;\n#endif\n#ifdef USE_HDR\ncolor.rgb*=u_Exposure;\n#endif\n#ifdef BLEND\noutColor=LINEARtoSRGB(vec4(color,base.a));\n#elif defined(MASK)\n#ifndef ALPHA_CUTOFF\n#define ALPHA_CUTOFF 0.5\n#endif\nif(base.a<ALPHA_CUTOFF)discard;outColor=vec4(toneMapACES(color),1);\n#else\noutColor=vec4(toneMapACES(color),1);\n#endif\n}"},vignetting:{vs:"attribute vec3 POSITION;void main(){vec4 position=vec4(POSITION,1);gl_Position=position;}",fs:"precision highp float;\n#include <macros>\nuniform sampler2D base;void main(){vec2 uv=gl_FragCoord.xy/screenSize;vec2 pos=uv*2.-1.;float mask=1.-dot(pos,pos)*FACTOR;mask=clamp(.5+(mask-.5)*HARDNESS,0.,1.);vec4 color=texture2D(base,uv);gl_FragColor=mix(vec4(vec3(0),1),color,mask);}"},line:{vs:"#include <macros>\nattribute vec3 POSITION;attribute vec3 NORMAL;attribute vec2 TEXCOORD_0;attribute vec2 TEXCOORD_1;attribute vec4 TANGENT;\n#ifdef COLOR_0_SIZE_3\nattribute vec3 COLOR_0;\n#elif defined(COLOR_0_SIZE_4)\nattribute vec4 COLOR_0;\n#endif\n#ifdef HAS_SKINS\n#ifndef JOINT_AMOUNT\n#define JOINT_AMOUNT 200\n#endif\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;uniform mat4 jointMat[JOINT_AMOUNT];\n#endif\nuniform mat4 M;uniform mat4 VP;uniform mat4 nM;\n#ifdef HAS_MORPH_TARGETS\nuniform float weights;attribute vec3 TAR_POSITION;\n#endif\nvarying vec3 normal;varying vec2 uv;varying vec2 uv1;varying vec3 pos;varying vec4 vColor;varying mat3 TBN;void main(){uv=TEXCOORD_0;uv1=TEXCOORD_1;vec3 skinedNormal=NORMAL;\n#ifdef HAS_MORPH_TARGETS\nvec4 position=vec4((POSITION+TAR_POSITION*weights),1);\n#else\nvec4 position=vec4(POSITION,1);\n#endif\n#ifdef HAS_SKINS\nmat4 skinMat=WEIGHTS_0.x*jointMat[int(JOINTS_0.x)]+WEIGHTS_0.y*jointMat[int(JOINTS_0.y)]+WEIGHTS_0.z*jointMat[int(JOINTS_0.z)]+WEIGHTS_0.w*jointMat[int(JOINTS_0.w)];position=M*skinMat*position;skinedNormal=(skinMat*vec4(skinedNormal,0)).xyz;\n#else\nposition=M*position;\n#endif\nnormal=normalize((nM*vec4(skinedNormal,0)).xyz);vec3 tangent=normalize(vec3(nM*vec4(TANGENT.xyz,0)));vec3 bitangent=cross(normal,tangent)*TANGENT.w;TBN=mat3(tangent,bitangent,normal);\n#ifdef COLOR_0_SIZE_3\nvColor=vec4(COLOR_0,1);\n#elif defined(COLOR_0_SIZE_4)\nvColor=COLOR_0;\n#endif\npos=position.xyz/position.w;gl_Position=VP*position;}",fs:"precision highp float;\n#include <macros>\n#define PI 3.14159265358979\n#define GAMMA 2.2\nvarying vec3 normal;varying vec2 uv;varying vec2 uv1;varying vec3 pos;varying vec4 vColor;varying mat3 TBN;uniform sampler2D brdfLUT;\n#ifdef HAS_EMISSIVE_MAP\n#ifndef emissiveTexture_uv\n#define emissiveTexture_uv uv\n#endif\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\n#ifndef normalTexture_uv\n#define normalTexture_uv uv\n#endif\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_BASECOLOR_MAP\n#ifndef baseColorTexture_uv\n#define baseColorTexture_uv uv\n#endif\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_METALLIC_ROUGHNESS_MAP\n#ifndef metallicRoughnessTexture_uv\n#define metallicRoughnessTexture_uv uv\n#endif\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#ifdef HAS_AO_MAP\n#ifndef occlusionTexture_uv\n#define occlusionTexture_uv uv\n#endif\nuniform sampler2D occlusionTexture;\n#endif\n#ifdef HAS_ENV_MAP\nuniform samplerCube env;\n#endif\nuniform vec3 u_Camera;vec4 sRGBtoLINEAR(vec4 color){return vec4(pow(color.rgb,vec3(GAMMA)),color.a);}vec4 LINEARtoSRGB(vec4 color){return vec4(pow(color.rgb,vec3(1.0/GAMMA)),color.a);}void main(){gl_FragColor=vec4(0,1,.4,0.2);}"},ray:{vs:"#version 300 es\n#include <macros>\n#define SHADER_NAME ray_vs\nin vec3 POSITION;void main(){gl_Position=vec4(POSITION,1);}",fs:"#version 300 es\n#extension GL_OES_texture_float : enable\n#extension GL_OES_texture_float_linear : enable\nprecision highp float;\n#define HDR_IBL\nuniform int DEBUG_NORMAL;uniform float EXP;uniform int iFrame;uniform float iTime;uniform sampler2D base;uniform sampler2D test;uniform sampler2D triangleTex;uniform sampler2D LBVHTex;\n#ifdef HDR_IBL\nuniform sampler2D hdrSky;\n#else\nuniform samplerCube hdrSky;\n#endif\nuniform sampler2D skybox;uniform sampler2D ground;uniform sampler2D uvck;\n#include <mat_params>\nuniform mat3 TBN;uniform vec3 vp;uniform vec2 mousePos;\n#include <macros>\n#define SHADER_NAME ray_fs\n#define PI 3.14159265358979\n#define invPI 0.3183098861837697\n#define invTWO_PI 0.15915494309\n#define GAMMA 2.2\nout vec4 outColor;vec4 sRGBtoLINEAR(vec4 color){return vec4(pow(color.rgb,vec3(GAMMA)),color.a);}vec4 LINEARtoSRGB(vec4 color){return vec4(pow(color.rgb,vec3(1.0/GAMMA)),color.a);}vec2 getuv(vec3 p){float theta=acos(p.y);float phi=atan(p.z,p.x);if(phi<0.0){phi+=2.0*PI;}vec2 s;s.x=1.0-phi*invTWO_PI;s.y=1.-theta*invPI;return s;}vec3 pal(in float t,in vec3 a,in vec3 b,in vec3 c,in vec3 d){return a+b*cos(6.28318530718*(c*t+d));}uint baseHash(uvec2 p){p=1103515245U*((p>>1U)^(p.yx));uint h32=1103515245U*((p.x)^(p.y>>3U));return h32^(h32>>16);}float hash1(inout float seed){uint n=baseHash(floatBitsToUint(vec2(seed+=.1,seed+=.1)));return float(n)/float(0xffffffffU);}vec2 hash2(inout float seed){uint n=baseHash(floatBitsToUint(vec2(seed+=.1,seed+=.1)));uvec2 rz=uvec2(n,n*48271U);return vec2(rz.xy&uvec2(0x7fffffffU))/float(0x7fffffff);}vec2 randomInUnitDisk(inout float seed){vec2 h=hash2(seed)*vec2(1,6.28318530718);float r=sqrt(h.x);return r*vec2(sin(h.y),cos(h.y));}\n#define MAX_DIST 1e10\nfloat hitAABB(vec3 ro,vec3 ird,vec3 bmax,vec3 bmin){vec2 Tx,Ty,Tz=vec2(0);Tx.x=(bmin.x-ro.x)*ird.x;Tx.y=(bmax.x-ro.x)*ird.x;if(Tx.y<Tx.x){Tx=Tx.yx;}Ty.x=(bmin.y-ro.y)*ird.y;Ty.y=(bmax.y-ro.y)*ird.y;if(Ty.y<Ty.x){Ty=Ty.yx;}if(Tx.x>Ty.y||Ty.x>Tx.y){return MAX_DIST;}vec2 T=vec2(0);T.x=max(Tx.x,Ty.x);T.y=min(Tx.y,Ty.y);Tz.x=(bmin.z-ro.z)*ird.z;Tz.y=(bmax.z-ro.z)*ird.z;if(Tz.y<Tz.x){Tz=Tz.yx;}if(T.x>Tz.y||Tz.x>T.y){return MAX_DIST;}return max(T.x,Tz.x);}float iBox(in vec3 ro,in vec3 rd,in vec2 distBound,inout vec3 normal,in vec3 boxSize){vec3 m=sign(rd)/max(abs(rd),1e-8);vec3 n=m*ro;vec3 k=abs(m)*boxSize;vec3 t1=-n-k;vec3 t2=-n+k;float tN=max(max(t1.x,t1.y),t1.z);float tF=min(min(t2.x,t2.y),t2.z);if(tN>tF||tF<=0.){return MAX_DIST;}else{if(tN>=distBound.x&&tN<=distBound.y){normal=-sign(rd)*step(t1.yzx,t1.xyz)*step(t1.zxy,t1.xyz);return tN;}else if(tF>=distBound.x&&tF<=distBound.y){normal=-sign(rd)*step(t1.yzx,t1.xyz)*step(t1.zxy,t1.xyz);return tF;}else{return MAX_DIST;}}}float iPlane(in vec3 ro,in vec3 rd,in vec2 distBound,inout vec3 normal,in vec3 planeNormal,in float planeDist){float a=dot(rd,planeNormal);float d=-(dot(ro,planeNormal)+planeDist)/a;if(a>0.||d<distBound.x||d>distBound.y){return MAX_DIST;}else{normal=planeNormal;return d;}}float iTriangle(in vec3 ro,in vec3 rd,in vec2 distBound,in vec3 v0,in vec3 v1,in vec3 v2){vec3 v1v0=v1-v0;vec3 v2v0=v2-v0;vec3 rov0=ro-v0;vec3 n=cross(v1v0,v2v0);vec3 q=cross(rov0,rd);float d=1.0/dot(rd,n);float u=d*dot(-q,v2v0);float v=d*dot(q,v1v0);float t=d*dot(-n,rov0);if(u<0.||v<0.||(u+v)>1.||t<distBound.x||t>distBound.y){return MAX_DIST;}else{return t;}}struct BVHNode{vec3 bmin;float branch;vec3 bmax;float index;};\n#define INV_TEXTURE_WIDTH 0.00048828125\nBVHNode getBVH(float i){float offset=(i*2.);ivec2 uv0=ivec2(mod(offset+0.,2048.),floor((offset+0.)*INV_TEXTURE_WIDTH));ivec2 uv1=ivec2(mod(offset+1.,2048.),floor((offset+1.)*INV_TEXTURE_WIDTH));vec4 bvh0=texelFetch(LBVHTex,uv0,0);vec4 bvh1=texelFetch(LBVHTex,uv1,0);return BVHNode(bvh0.rgb,bvh0.a,bvh1.rgb,bvh1.a);}\n#define HAS_NORMAL\n#define TRI_TEXSIZE 2048.\n#define INV_TRIANGLE 1./TRI_TEXSIZE\nfloat hitTriangle(float i,vec3 ro,vec3 rd){\n#ifdef HAS_NORMAL\nivec2 puv0=ivec2(mod(i+0.,TRI_TEXSIZE),floor((i+0.)*INV_TRIANGLE));ivec2 nuv0=ivec2(mod(i+1.,TRI_TEXSIZE),floor((i+1.)*INV_TRIANGLE));ivec2 puv1=ivec2(mod(i+2.,TRI_TEXSIZE),floor((i+2.)*INV_TRIANGLE));ivec2 nuv1=ivec2(mod(i+3.,TRI_TEXSIZE),floor((i+3.)*INV_TRIANGLE));ivec2 puv2=ivec2(mod(i+4.,TRI_TEXSIZE),floor((i+4.)*INV_TRIANGLE));ivec2 nuv2=ivec2(mod(i+5.,TRI_TEXSIZE),floor((i+5.)*INV_TRIANGLE));\n#else\nivec2 puv0=ivec2(mod(i+0.,TRI_TEXSIZE),floor((i+0.)*INV_TRIANGLE));ivec2 puv1=ivec2(mod(i+1.,TRI_TEXSIZE),floor((i+1.)*INV_TRIANGLE));ivec2 puv2=ivec2(mod(i+2.,TRI_TEXSIZE),floor((i+2.)*INV_TRIANGLE));\n#endif\nvec4 v0=texelFetch(triangleTex,puv0,0);vec4 v1=texelFetch(triangleTex,puv1,0);vec4 v2=texelFetch(triangleTex,puv2,0);return iTriangle(ro,rd,vec2(0,MAX_DIST),v0.xyz,v1.xyz,v2.xyz);}void getTriangle(float i,vec3 p,inout vec3 N,inout vec2 iuv){\n#ifdef HAS_NORMAL\nivec2 puv0=ivec2(mod(i+0.,TRI_TEXSIZE),floor((i+0.)*INV_TRIANGLE));ivec2 nuv0=ivec2(mod(i+1.,TRI_TEXSIZE),floor((i+1.)*INV_TRIANGLE));ivec2 puv1=ivec2(mod(i+2.,TRI_TEXSIZE),floor((i+2.)*INV_TRIANGLE));ivec2 nuv1=ivec2(mod(i+3.,TRI_TEXSIZE),floor((i+3.)*INV_TRIANGLE));ivec2 puv2=ivec2(mod(i+4.,TRI_TEXSIZE),floor((i+4.)*INV_TRIANGLE));ivec2 nuv2=ivec2(mod(i+5.,TRI_TEXSIZE),floor((i+5.)*INV_TRIANGLE));vec4 v0=texelFetch(triangleTex,puv0,0);vec4 v1=texelFetch(triangleTex,puv1,0);vec4 v2=texelFetch(triangleTex,puv2,0);vec3 e1=v0.xyz-v1.xyz;vec3 e2=v2.xyz-v1.xyz;vec3 ep=p-v1.xyz;float s=length(cross(e1,e2));float s1=length(cross(ep,e1))/s;float s2=length(cross(ep,e2))/s;vec4 n0=texelFetch(triangleTex,nuv0,0);vec4 n1=texelFetch(triangleTex,nuv1,0);vec4 n2=texelFetch(triangleTex,nuv2,0);N=normalize(n0.xyz*s2+n1.xyz*(1.-s1-s2)+n2.xyz*s1);vec2 uv0=vec2(v0.w,n0.w);vec2 uv1=vec2(v1.w,n1.w);vec2 uv2=vec2(v2.w,n2.w);iuv=uv0*s2+uv1*(1.-s1-s2)+uv2*s1;\n#endif\n}\n#ifndef SL\n#define SL 46\n#endif\nfloat hitLBVH2(float i,vec3 ro,vec3 rd,inout float mat,inout float tri){vec3 ird=1./rd;vec3 normal;float offsetStack[SL];int sp=0;float t=MAX_DIST;float pNode=i;BVHNode bvh=getBVH(pNode);float bvhRoot=hitAABB(ro,ird,bvh.bmax,bvh.bmin);if(bvhRoot==MAX_DIST)return MAX_DIST;int c=32;BVHNode l,r,cur;float lt,rt,current;while(c>0){bvh=getBVH(pNode);current=hitAABB(ro,ird,bvh.bmax,bvh.bmin);if(current>=t){if(sp==0)return t;pNode=offsetStack[--sp];}else{if(bvh.index<0.){l=getBVH(pNode+1.);r=getBVH(bvh.branch);lt=hitAABB(ro,ird,l.bmax,l.bmin);rt=hitAABB(ro,ird,r.bmax,r.bmin);if(rt==MAX_DIST&&lt==MAX_DIST){if(sp==0)return t;pNode=offsetStack[--sp];}else{if(sp==SL)return t;if(rt<lt){offsetStack[sp++]=pNode+1.;pNode=bvh.branch;}else{offsetStack[sp++]=bvh.branch;pNode+=1.;}}}else{if(t!=MAX_DIST){current=hitTriangle(bvh.index,ro,rd);if(current>0.&&current<t){tri=bvh.index;mat=bvh.branch;t=current;}}else{current=hitTriangle(bvh.index,ro,rd);if(current>0.&&current!=MAX_DIST){tri=bvh.index;t=current;mat=bvh.branch;}}if(sp==0)return t;pNode=offsetStack[--sp];}}}return t;}vec3 cosWeightedRandomHemisphereDirection(const vec3 n,inout float seed){vec3 t=normalize(cross(n,abs(n.y)>.5 ? vec3(1.,0.,0.): vec3(0.,1.,0.)));vec3 b=cross(t,n);vec2 h=hash2(seed)*vec2(1,6.28318530718);vec3 r=vec3(sqrt(h.x)*vec2(cos(h.y),sin(h.y)),sqrt(1.-h.x));return normalize(mat3(t,b,n)*r);}vec3 modifyDirectionWithRoughness(const vec3 normal,const vec3 n,const float roughness,inout float seed){vec2 r=hash2(seed);vec3 uu=normalize(cross(n,abs(n.y)>.5 ? vec3(1.,0.,0.): vec3(0.,1.,0.)));vec3 vv=cross(uu,n);float a=roughness*roughness;r.x*=6.28318530718;float rz=sqrt(abs((1.0-r.y)/clamp(1.+(a-1.)*r.y,.00001,1.)));float ra=sqrt(abs(1.-rz*rz));float rx=ra*cos(r.x);float ry=ra*sin(r.x);vec3 rr=vec3(rx*uu+ry*vv+rz*n);vec3 ret=normalize(rr);return dot(ret,normal)>0. ? ret : n;}float FresnelSchlickRoughness(float cosTheta,float F0,float roughness){return F0+(max((1.-roughness),F0)-F0)*pow(abs(1.-cosTheta),5.0);}vec3 opU(vec3 d,float iResult,float mat){return(iResult<d.y)? vec3(d.x,iResult,mat): d;}\n#define W_RATIO 0.5625\n#define W_WIDTH 10.\nfloat hitWorld(in vec3 ro,in vec3 rd,in vec2 dist,out vec3 normal,out vec2 iuv,out float mat){vec3 d=vec3(dist,-1);vec3 ird=1./rd;float tri=-1.;d=opU(d,hitLBVH2(0.,ro-vec3(0,0,0),rd,mat,tri),mat);if(tri>=0.){getTriangle(tri,ro+rd*d.y,normal,iuv);}mat=d.z;return d.y;}\n#define PATH_LENGTH 8\nvec3 render(in vec3 ro,in vec3 rd,inout float seed){vec3 albedo,normal,col=vec3(1);vec2 iuv=vec2(0);float roughness=.0;float metal=.01;for(int i=0;i<PATH_LENGTH;i++){float mat=-1.;float t=hitWorld(ro,rd,vec2(0,MAX_DIST),normal,iuv,mat);if(t>0.&&t<MAX_DIST){ro+=rd*(t-.01);if(mat<0.){continue;}if(DEBUG_NORMAL>0){\n#ifdef DEBUG_UV\nreturn sRGBtoLINEAR(texture(uvck,iuv)).rgb;\n#else\nreturn max(vec3(0),normal)*sRGBtoLINEAR(texture(uvck,iuv)).rgb;\n#endif\n}\n#include <mat_route>\nfloat F=FresnelSchlickRoughness(max(0.,-dot(normal,rd)),.04,roughness);if(F>hash1(seed)-metal){col*=albedo;rd=modifyDirectionWithRoughness(normal,reflect(rd,normal),roughness,seed);}else{col*=albedo;rd=cosWeightedRandomHemisphereDirection(normal,seed);}}else{\n#ifdef HDR_IBL\ncol*=texture(hdrSky,getuv(rd)+vec2(0,0)).rgb;\n#else\ncol*=texture(hdrSky,rd).rgb;\n#endif\nreturn col;}}return vec3(0);}\n#define DOF_FACTOR .028\n#define FOV 1.8\nvoid main(){vec2 uv=gl_FragCoord.xy*iResolution;vec3 ro=vec3(0,0,10);ro=vp;int Frame=iFrame;float fpd=texelFetch(base,ivec2(0),0).r;if(all(equal(ivec2(gl_FragCoord),ivec2(0)))){if(Frame==0){float tmp;vec3 tmp3;vec2 tmp2;float nfpd=hitWorld(ro,TBN*normalize(vec3(mousePos,FOV)),vec2(0,MAX_DIST),tmp3,tmp2,tmp);outColor=vec4(nfpd);}else{outColor=vec4(fpd);}}else{vec3 col=vec3(1);vec2 p=(gl_FragCoord.xy*2.-Resolution.xy)*iResolution.y;float seed=float(baseHash(floatBitsToUint(p-iTime)))/float(0xffffffffU);p+=2.*hash2(seed)*iResolution.y;vec3 rd=normalize(vec3(p,FOV));rd=TBN*rd;vec3 fp=ro+rd*fpd;ro=ro+TBN*vec3(randomInUnitDisk(seed),0.)*DOF_FACTOR;rd=normalize(fp-ro);col=render(ro,rd,seed);if(Frame==0){outColor=vec4(col,1);}else{outColor=vec4(col,1)+texelFetch(base,ivec2(gl_FragCoord),0);}}}"},ray_comb:{vs:"#version 300 es\n#include <macros>\nin vec3 POSITION;void main(){gl_Position=vec4(POSITION,1);}",fs:"#version 300 es\n#extension GL_OES_texture_float : enable\n#extension GL_OES_texture_float_linear : enable\nprecision highp float;uniform sampler2D base;uniform sampler2D test;uniform float EXPOSURE;\n#include <macros>\n#define SHADER_NAME ray_final\n#define PI 3.14159265358979\n#define GAMMA 2.2\nout vec4 outColor;vec3 toneMapACES(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return pow(clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0),vec3(1.0/GAMMA));}void main(){vec4 data=texelFetch(test,ivec2(gl_FragCoord),0);outColor=vec4(toneMapACES(data.rgb/data.w*EXPOSURE),1);}"},background:{fs:"#version 300 es\n#define USE_HDR\n#ifdef USE_HDR\n#extension GL_OES_texture_float : enable\n#extension GL_OES_texture_float_linear : enable\n#endif\nprecision highp float;\n#include <macros>\n#define PI 3.14159265358979\n#define GAMMA 2.2\nout vec4 outColor;in vec3 normal;in vec2 uv;in vec2 uv1;in vec3 pos;in vec4 vColor;in mat3 TBN;uniform vec3 u_irrSH[9];\n#ifdef HAS_ENV_MAP\nuniform samplerCube env;\n#endif\nuniform vec3 u_Camera;\n#ifdef USE_HDR\n#ifdef HAS_EXPUSRE\nuniform float u_Exposure;\n#else\n#define u_Exposure 1.\n#endif\n#endif\nvec4 sRGBtoLINEAR(vec4 color){return vec4(pow(color.rgb,vec3(GAMMA)),color.a);}vec4 LINEARtoSRGB(vec4 color){return vec4(pow(color.rgb,vec3(1.0/GAMMA)),color.a);}vec3 toneMapACES(vec3 color){const float A=2.51;const float B=0.03;const float C=2.43;const float D=0.59;const float E=0.14;return pow(clamp((color*(A*color+B))/(color*(C*color+D)+E),0.0,1.0),vec3(1.0/GAMMA));}vec3 diffuseSH(const in vec3 n){return max(vec3(0),u_irrSH[0]+u_irrSH[1]*n.y+u_irrSH[2]*n.z+u_irrSH[3]*n.x+u_irrSH[4]*n.y*n.x+u_irrSH[5]*n.y*n.z+u_irrSH[6]*(3.0*n.z*n.z-1.0)+u_irrSH[7]*(n.z*n.x)+u_irrSH[8]*(n.x*n.x-n.y*n.y));}vec3 decoRGBE(vec4 r){if(r.a!=0.){float e=exp2(r.a*255.-128.);return vec3(r.r*e,r.g*e,r.b*e);}return vec3(0);}void main(){vec3 sh=diffuseSH(normalize(pos))*.05;outColor=vec4(toneMapACES(sh),1);\n#ifdef HAS_ENV_MAP\noutColor=vec4(toneMapACES(decoRGBE(texture(env,pos,0.))*1.5),1);\n#endif\n}"}};class Ot{constructor(e=yt.basic.vs,t=yt.basic.fs,n={}){this.isDirty=!0,this.vertexSource=e,this.fragmentSource=t,this.macros=n}static clone(e){let t=new Ot(e.vertexSource,e.fragmentSource);return t.macros=Object.assign({},e.macros),t}static buildProgram(e,t){e.isDirty=!1,e.ctx=t,this.macros="";for(let t in e.macros)this.macros+=`\n#define ${t} ${e.macros[t]}\n`;e.vertex&&e.ctx.deleteShader(e.vertex),e.vertex=Ot.compileShader(e.ctx,e.ctx.VERTEX_SHADER,e.vertexSource.replace("#include <macros>",this.macros)),e.fragment&&e.ctx.deleteShader(e.fragment),e.fragment=Ot.compileShader(e.ctx,e.ctx.FRAGMENT_SHADER,e.fragmentSource.replace("#include <macros>",this.macros)),e.vertex&&e.fragment&&(e.program&&e.ctx.deleteProgram(e.program),e.program=Ot.createShaderProgram(e.ctx,e.vertex,e.fragment),e.attributes=Ot.pickupActiveAttributes(e.ctx,e.program),e.uniforms=Ot.pickupActiveUniforms(e.ctx,e.program))}static pickupActiveAttributes(e,t){const n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);let r={};for(let i=0;i<n;i++){const{name:n}=e.getActiveAttrib(t,i),a=e.getAttribLocation(t,n);r[n]=a}return r}static pickupActiveUniforms(e,t){const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);let r={};for(let i=0;i<n;i++){const{name:n,type:a}=e.getActiveUniform(t,i),o=e.getUniformLocation(t,n),s=Lt.getUnifSetter(a);let l=e[s].length;0==l&&(l=Lt.getUnifArgLenght(a)),r[n]=new Lt(o,a,s,l)}return r}static compileShader(e,t,n){let r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),!0===e.getShaderParameter(r,e.COMPILE_STATUS))return r;console.log(n),console.warn(e.getShaderInfoLog(r)),e.deleteShader(r)}static createShaderProgram(e,t,n){let r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS))return r;console.warn(e.getProgramInfoLog(r)),e.deleteProgram(r),e.deleteShader(t),e.deleteShader(n)}}Ot.macros="";class Lt{constructor(e,t,n,r){this.location=e,this.type=t,this.setter=n,this.argLength=r}static getUnifSetter(e){switch(e){case WebGLRenderingContext.FLOAT:return"uniform1f";case WebGLRenderingContext.FLOAT_VEC2:return"uniform2fv";case WebGLRenderingContext.FLOAT_VEC3:return"uniform3fv";case WebGLRenderingContext.FLOAT_VEC4:return"uniform4f";case WebGLRenderingContext.INT:return"uniform1i";case WebGLRenderingContext.INT_VEC2:return"uniform2i";case WebGLRenderingContext.INT_VEC3:return"uniform3i";case WebGLRenderingContext.INT_VEC4:return"uniform4i";case WebGLRenderingContext.FLOAT_MAT2:return"uniformMatrix2fv";case WebGLRenderingContext.FLOAT_MAT3:return"uniformMatrix3fv";case WebGLRenderingContext.FLOAT_MAT4:return"uniformMatrix4fv";case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return"uniform1i"}}static getUnifArgLenght(e){switch(e){case WebGLRenderingContext.FLOAT:case WebGLRenderingContext.FLOAT_VEC2:case WebGLRenderingContext.FLOAT_VEC3:case WebGLRenderingContext.FLOAT_VEC4:case WebGLRenderingContext.INT:case WebGLRenderingContext.INT_VEC2:case WebGLRenderingContext.INT_VEC3:case WebGLRenderingContext.INT_VEC4:case WebGLRenderingContext.SAMPLER_2D:case WebGLRenderingContext.SAMPLER_CUBE:return 2;case WebGLRenderingContext.FLOAT_MAT2:case WebGLRenderingContext.FLOAT_MAT3:case WebGLRenderingContext.FLOAT_MAT4:return 3}}}var Nt;!function(e){e[e.Opaque=0]="Opaque",e[e.Blend=1]="Blend"}(Nt||(Nt={}));class Ct{constructor(e,t=null,n=!1){this.isDirty=!0,this.textures=new Map,this.queue=Nt.Opaque,this.uniforms={},this.ref=0,this.shader=Ot.clone(e),this.name=t,t&&(this.shader.macros.SHADER_NAME=t),this.doubleSided=n,Ct.pool.push(this)}static clone(e){return new Ct(e.shader,e.name,e.doubleSided)}static useMaterial(e,t){e.shader.isDirty&&Ot.buildProgram(e.shader,t),t.useProgram(e.shader.program)}static setUniform(e,t,n){null==e.uniforms[t]&&(e.uniforms[t]=new It),e.uniforms[t].value=n,e.uniforms[t].isDirty=!0,e.isDirty=!0}static updateUniform(e){const{shader:t}=e,n=t.ctx;for(let r in e.uniforms){const i=e.uniforms[r];if(null!=i.value&&i.isDirty){i.isDirty=!1;const e=t.uniforms[r];null==e||(3==e.argLength?n[e.setter](e.location,!1,i.value):n[e.setter](e.location,i.value))}}e.isDirty=!1}static bindAllTextures(e,n,r=!1){for(let[,[i,a]]of e.textures)t.bindTexture(n,a,i),(a.isDirty||r)&&(a.isDirty=!1)}static unbindAllTextures(e,n){for(let[,[r,i]]of e.textures)t.unbindTexture(n,i,r)}static setTexture(e,t,n){let r;r=e.textures.has(t)?e.textures.get(t)[0]:e.textures.size,e.textures.set(t,[r,n]),Ct.setUniform(e,t,r),e.isDirty=!0}}Ct.pool=[],Ct.SHADER_PATH="res/shader/";class It{constructor(){this.value=null,this.isDirty=!1}}class wt{static create(e=null,t=!1){this.hasNewMember=!0;let n=document.createElement(this.entityTag);return e&&(n.dataset.name=e,n.textContent=e),n.components={},this.getDefaultComponent&&!t&&this.addComponent(n,this.getDefaultComponent()),n.addComponent=(e=>this.addComponent(n,e)),n.addEventListener("pointerdown",e=>{console.log("\t|-"+n.dataset.name),console.log(n.components);let t=n.components.Transform;null!=t&&(t.isVisible=!t.isVisible),e.stopPropagation()}),n}static clone(e){let t=this.create(e.dataset.name,!0);this.addComponent(t,this.cloneMethods._Transform(e.components.Transform));for(let n in e.components)this.cloneMethods[n]&&this.addComponent(t,this.cloneMethods[n](e.components[n]));for(let n=0;n<e.childElementCount;n++)t.appendChild(this.clone(e.children[n]));return t}static find(e,t=document){return Array.from(t.querySelectorAll(e))}static getComponents(e,t=document){return this.find(`${this.entityTag}[${e.toLowerCase()}]`,t).map(({components:t})=>t[e])}static getEntites(e,t=document){return this.find(`${this.entityTag}[${e.join("][")}]`,t)}static addComponent(e,t){this.hasNewMember=!0;let n=t.constructor.name;return e.components[n]=t,e.setAttribute(n,""),t.entity=e,t}}wt.entityTag="ash-entity",wt.hasNewMember=!1,wt.cloneMethods={};class Gt{}class Ht{static loop(){for(let e in this.sysQueue){let t=this.sysQueue[e];(wt.hasNewMember||0==t.group.length)&&(t.group=wt.getEntites(t.depends)),t.onUpdate(this.deltaTime)}wt.hasNewMember=!1,this.deltaTime=(Date.now()-this.lastTime)/1e3,this.lastTime=Date.now(),this.isStoped||requestAnimationFrame(this.loop.bind(this))}static start(){this.isStoped&&(this.isStoped=!1,this.loop())}static stop(){this.isStoped=!0}static registSystem(e){this.sysQueue[e.depends.toString()]=e}static getSystem(e){return this.sysQueue[e.depends.toString()]}static removeSystem(e){this.sysQueue[e.depends.toString()]=null}}Ht.lastTime=0,Ht.deltaTime=0,Ht.isStoped=!0,Ht.sysQueue={},Ht.start();class Ft{constructor(e,t,n){this.materials=[],this.isDirty=!0,null!=e&&(this.SID=e.id),this.mesh=t;for(let e of t.attributes)n.shader.macros[`${e.attribute}_SIZE_${e.size}`]="";Dt.attachMaterial(this,n)}static clone(e){let t=new Ft(null,e.mesh);t.SID=e.SID;for(let n of e.materials)Dt.attachMaterial(t,n);return t}}wt.cloneMethods.MeshRenderer=Ft.clone;class Dt extends Gt{constructor(){super(...arguments),this.group=[],this.depends=[Ft.name]}onUpdate(e){for(let e in Bt.list){let t=Bt.list[e];t.filters.length&&(t.capture.bind(),t.setViewport(t.capture.width,t.capture.height)),t.clear()}for(let{components:e}of this.group)Dt.render(e.MeshRenderer,Nt.Opaque);for(let{components:e}of this.group){e.MeshRenderer;Dt.render(e.MeshRenderer,Nt.Blend)}for(let t in Bt.list){let n=Bt.list[t];n.gl.depthFunc(WebGL2RenderingContext.ALWAYS),n.gl.disable(WebGL2RenderingContext.BLEND);for(let[t,r]of n.filters.entries())r.renderToScreen?(r.bind(null),n.setViewport()):(r.bind(),n.setViewport(r.width,r.height)),r.onRender&&r.onRender(e),Dt.render(r.meshRender);n.gl.enable(WebGL2RenderingContext.BLEND),n.gl.depthFunc(WebGL2RenderingContext.LESS)}}static useMaterial(e,t){Ct.useMaterial(e.materials[t],Bt.list[e.SID].gl)}static attachMaterial(e,t){null!=e.SID&&null!=t&&(t.ref++,e.materials.push(t),this.useMaterial(e,0),Ct.updateUniform(t),this.updateVAO(e))}static bindVAO(e,t){"iOS"==Bt.platform?Rt.bindAccessorsVBO(e.mesh,Bt.list[e.SID].gl,e.materials[0].shader.attributes):Bt.list[e.SID].gl.bindVertexArray(t)}static updateVAO(e){e.vao&&Bt.list[e.SID].gl.deleteVertexArray(e.vao),e.vao=Bt.list[e.SID].gl.createVertexArray(),this.bindVAO(e,e.vao),Rt.bindAccessorsVBO(e.mesh,Bt.list[e.SID].gl,e.materials[0].shader.attributes),this.bindVAO(e,null)}static updateMaterial(e){e.materials[0].isDirty&&Ct.updateUniform(e.materials[0])}static render(e,t=Nt.Opaque){let n=Bt.list[e.SID],{gl:r,mainCamera:i}=n;const a=e.materials[0];if(a.queue!=t)return;let o=a.shader.isDirty;if(this.useMaterial(e,0),a.doubleSided?r.disable(r.CULL_FACE):r.enable(r.CULL_FACE),e.entity){if(!e.entity.components.Transform.isVisible)return;let t=e.entity.components.Transform;i&&(Ct.setUniform(a,"VP",i.vp),Ct.setUniform(a,"u_Camera",i.entity.components.Transform.worldPos)),Ct.setUniform(a,"M",t.worldMatrix),Ct.setUniform(a,"nM",t.worldNormalMatrix),t.jointsMatrices&&Ct.setUniform(a,"jointMat[0]",t.jointsMatrices)}this.updateMaterial(e),Ct.bindAllTextures(a,r,o),this.bindVAO(e,e.vao),Rt.drawcall(e.mesh,r)}}Ht.registSystem(new Dt);class Pt{constructor(e,t,n=e.width,r=e.height,i=!1){this.color=[],this.depth=[],this.renderToScreen=!0,this.onRender=null,this.useFloatTexture=!1,this.ctx=e.gl,this.screen=e,this.width=n,this.height=r,this.useFloatTexture=!0,this.buffer=this.ctx.createFramebuffer(),this.output=this.attachTexture(),this.mesh=new Vt,t.macros.screenSize=`vec2(${e.width}, ${e.height})`,this.material=new Ct(t),this.meshRender=new Ft(e,this.mesh,this.material)}clone(e=this.screen){return new Pt(e,Ot.clone(this.material.shader),this.width,this.height)}setInput(e,t="base"){this.input=e,Ct.setTexture(this.material,t,e),this.material.isDirty=!0}bind(e=this.buffer){this.ctx.bindFramebuffer(WebGL2RenderingContext.FRAMEBUFFER,e)}attachTexture(){this.bind();let e=new t(null,Pt.sampleColor,this.width,this.height);this.useFloatTexture&&(e.format=WebGL2RenderingContext.RGBA,e.internalformat=WebGL2RenderingContext.RGBA32F,e.type=WebGL2RenderingContext.FLOAT),t.createTexture(this.ctx,e),this.ctx.framebufferTexture2D(Pt.FRAMEBUFFER,Pt.COLOR_ATTACH_BASE+this.color.length,e.glType,e.sampler.texture,e.level),this.color.push(e);let n=new t(null,Pt.sampleDepth,this.width,this.height);return n.internalformat=WebGL2RenderingContext.DEPTH_COMPONENT24,n.format=WebGL2RenderingContext.DEPTH_COMPONENT,n.type=WebGL2RenderingContext.UNSIGNED_INT,t.createTexture(this.ctx,n),this.ctx.framebufferTexture2D(Pt.FRAMEBUFFER,Pt.DEPTH_ATTACHMENT,n.glType,n.sampler.texture,n.level),this.depth.push(n),this.bind(null),e}}Pt.sampleColor={magFilter:WebGL2RenderingContext.LINEAR,minFilter:WebGL2RenderingContext.LINEAR,wrapS:WebGL2RenderingContext.REPEAT,wrapT:WebGL2RenderingContext.REPEAT},Pt.sampleDepth={magFilter:WebGL2RenderingContext.NEAREST,minFilter:WebGL2RenderingContext.NEAREST,wrapS:WebGL2RenderingContext.REPEAT,wrapT:WebGL2RenderingContext.REPEAT},Pt.COLOR_ATTACH_BASE=WebGL2RenderingContext.COLOR_ATTACHMENT0,Pt.DEPTH_ATTACHMENT=WebGL2RenderingContext.DEPTH_ATTACHMENT,Pt.FRAMEBUFFER=WebGL2RenderingContext.FRAMEBUFFER;class Vt extends Rt{constructor(){let e=new Float32Array([-1,3,0,-1,-1,0,3,-1,0]),t=new St(e.buffer,{byteOffset:e.byteOffset,byteLength:e.byteLength,byteStride:12,target:WebGL2RenderingContext.ARRAY_BUFFER});super([new Et({bufferView:t,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:3},"POSITION")])}}class Bt{constructor(e){if(this.filters=[],this.output=null,this.bgColor=[1,1,1,1],this.id=e,-1==navigator.userAgent.indexOf("iPhone")&&-1==navigator.userAgent.indexOf("iPad")||(Bt.platform="iOS"),this.canvas=document.querySelector(e),this.canvas){if(this.gl=this.canvas.getContext("webgl2"),!this.gl)return console.error("Get Context Failed"),void alert("Your browser do not support WebGL2");Bt.list[e]=this,this.gl.enable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.getExtension("OES_texture_float"),this.gl.getExtension("OES_texture_float_linear"),this.gl.getExtension("OES_texture_half_float"),this.gl.getExtension("EXT_color_buffer_float"),this.setScreenSize(),this.capture=new Pt(this,new Ot),this.capture.renderToScreen=!1}else console.error("Canvas not found!")}setScreenSize(e=window.innerWidth,t=window.innerHeight){let{devicePixelRatio:n}=window;console.log(n),this.canvas.setAttribute("width",e*n+""),this.canvas.setAttribute("height",t*n+""),this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.width=e*n,this.height=t*n,this.ratio=n,this.setViewport()}setViewport(e=this.width,t=this.height){this.gl.viewport(0,0,e,t)}clear(e=this.bgColor[0],t=this.bgColor[1],n=this.bgColor[2],r=this.bgColor[3],i=this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT){this.gl.clearColor(e,t,n,r),this.gl.clear(i)}attachFilter(e){null==this.output?e.setInput(this.capture.output):(this.output.renderToScreen=!1,e.setInput(this.output.output)),this.filters.push(e),this.output=e}deleteFilter(e){if(!this.filters[e])return void console.error("Filter does not exist!");let t=this.filters[e-1]||this.capture,n=this.filters[e+1];n?n.setInput(t.output):t.renderToScreen=!0,this.filters.splice(e,1),this.output=this.filters[this.filters.length-1]}}function Ut(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}l((r=r.apply(e,t||[])).next())})}Bt.list={},Bt.platform="unknown";class zt{constructor(){this.worldPos=C(0,0,0),this.translate=C(0,0,0),this.rotate=C(0,0,0),this.scale=C(1,1,1),this.quaternion=re(0,0,0,1),this.localMatrix=h(),this.worldMatrix=h(),this.worldInverseMatrix=h(),this.worldNormalMatrix=h(),this.isVisible=!0,this.isDirty=!1,v(this.localMatrix),v(this.worldMatrix)}static clone(e){let t=new zt;return I(t.translate,e.translate),I(t.rotate,e.rotate),I(t.scale,e.scale),ie(t.quaternion,e.quaternion),t}}wt.getDefaultComponent=(()=>new zt),wt.cloneMethods._Transform=zt.clone;class Wt extends Gt{constructor(){super(...arguments),this.group=[],this.depends=[zt.name]}onUpdate(){for(let{components:e}of this.group)Wt.updateMatrix(e.Transform)}static decomposeMatrix(e,t=e.localMatrix){w(e.translate,t[0],t[1],t[2]);let n=J(e.translate);w(e.translate,t[4],t[5],t[6]);let r=J(e.translate);w(e.translate,t[8],t[9],t[10]);let i=J(e.translate);w(e.scale,n,r,i),g(t)<0&&(n=-n),w(e.translate,t[12],t[13],t[14]),t[12]=t[13]=t[14]=0,t[0]/=n,t[1]/=n,t[2]/=n,t[4]/=r,t[5]/=r,t[6]/=r,t[8]/=i,t[9]/=i,t[10]/=i,x(e.quaternion,t)}static updateMatrix(e){e.isDirty=!1,_(e.localMatrix,e.quaternion,e.translate,e.scale),b(e.worldInverseMatrix,e.worldMatrix),p(e.worldNormalMatrix,e.worldInverseMatrix);let t=e.entity.parentElement;if(null!=t&&t.components){let n=t.components.Transform;S(e.worldMatrix,n.worldMatrix,e.localMatrix),k(e.worldPos,e.translate,e.worldMatrix)}else d(e.worldMatrix,e.localMatrix)}}Ht.registSystem(new Wt);class kt{constructor(){this.ibm=[],this.jointMat=[]}}Ht.registSystem(new class extends Gt{constructor(){super(...arguments),this.group=[],this.depends=[kt.name]}onUpdate(){for(let{components:e}of this.group){let t=e.Skin,n=e.Transform;for(let[e,r]of t.joints.entries())S(t.jointMat[e],n.worldInverseMatrix,r.worldMatrix),S(t.jointMat[e],t.jointMat[e],t.ibm[e])}}});class Xt{constructor(){this.channels=[]}static attachChannel(e,t){e.channels.push(t),this.totalTime=Math.max(this.totalTime,t.endTime)}}Xt.totalTime=0;class qt{constructor(e,t,n){this.isLoop=!0,this.pause=!1,this.currentTime=0,this.startTime=0,this.endTime=0,this.totalTime=0,this.step=0,this.speed=1,this.channel=e,this.timeline=Et.newFloat32Array(t),this.endTime=this.timeline[this.timeline.length-1],this.keyframe=Et.getFloat32Blocks(n),1!=this.timeline.length?this.startTime=this.timeline[0]:this.currentTime=this.endTime}}class jt extends Gt{constructor(){super(...arguments),this.group=[],this.depends=[Xt.name]}reset(e){e.step=0,e.currentTime=0}static step(e){let t,n,r,i,a=e.channel.length,o=e.step,s=o+1;1==e.timeline.length?(s=0,t=0,e.pause=!0):(t=e.timeline[o],n=e.keyframe[o]),r=e.timeline[s],i=e.keyframe[s];let l=r-t;if(e.currentTime<t||e.currentTime>r)return console.error("Wrong step!",e.currentTime,t,r),void console.log(e.timeline);let c=l?(e.currentTime-t)/l:1;switch(a){case 4:we(e.channel,n||this.defaultQuat,i,c);break;case 3:W(e.channel,n||this.defaultVec3,i,c)}}playStep(e,t){if(!e.pause){if(e.currentTime>Xt.totalTime)return this.reset(e),void(e.isLoop||(e.pause=!0,console.log("stop")));for(;e.currentTime>e.timeline[e.step+1];)e.step++;e.currentTime>e.startTime&&e.currentTime<=e.endTime&&jt.step(e),e.currentTime+=t*e.speed}}onUpdate(e){for(let{components:t}of this.group){e>.016&&(e=.016);let n=t.Animation;for(let t of n.channels)this.playStep(t,e)}}}jt.defaultQuat=Ne(),jt.defaultVec3=L(),Ht.registSystem(new jt);class $t{constructor(e){this.scene=wt.create("scene"),this.gltf=e,e.useHDR=e.hasEnvmap&&null!=e.envmap.data,e.materials||(e.materials=[{name:"Default_Material"}]),e.materials=e.materials.map(t=>{let n=new Ct(e.commonShader,t.name,t.doubleSided);return console.log(t),this.detectConfig(n,t),Ct.setTexture(n,"brdfLUT",e.brdfLUT),e.hasEnvmap&&(n.shader.macros.HAS_ENV_MAP="",e.useHDR&&(n.shader.macros.USE_HDR=""),Ct.setTexture(n,"env",e.envmap),e.diffmap&&(n.shader.macros.HAS_DIFFENV_MAP="",Ct.setTexture(n,"diffenv",e.diffmap))),n}),e.accessors=e.accessors.map(t=>{return t.bufferView=e.bufferViews[t.bufferView],new Et(t)}),e.meshes=e.meshes.map(t=>t.primitives.map(t=>{let{attributes:n,targets:r}=t,i=[];for(let t in n){let r=e.accessors[n[t]];r.attribute=t,i.push(r)}let a=e.accessors[t.indices],o=new Rt(i,a,t.mode);null==n.TANGENT&&null!=n.TEXCOORD_0&&(console.warn("Using computed tagent!"),Rt.preComputeTangent(o)),null==n.NORMAL&&(console.warn("Using computed normal!"),Rt.preComputeNormal(o));let s=e.materials[t.material||0];if(null!=n.JOINTS_0&&(s.shader.macros.HAS_SKINS=""),r){s.shader.macros.HAS_MORPH_TARGETS="",Ct.setUniform(s,"weights",new Float32Array([.5]));for(let t of r)for(let n in t){let r=e.accessors[t[n]];r.attribute="TAR_"+n,o.attributes.push(r)}}return[o,s]}))}assemble(){return Ut(this,void 0,void 0,function*(){let e=this.gltf,{scene:t,scenes:n,nodes:r,skins:i,animations:a}=e;if(this.entities=e.nodes.map((e,t)=>this.createEntity(e,t)),i&&(i=i.map(t=>{if(t.joints=t.joints.map(e=>this.entities[e].components.Transform),null==t.entity)return;let n=new kt;n.materials=t.materials,n.joints=t.joints;let r=e.accessors[t.inverseBindMatrices];n.ibm=Et.getFloat32Blocks(r),n.outputMat=new Float32Array(r.count*r.size),n.jointMat=Et.getSubChunks(r,n.outputMat);for(let e of t.transforms){e.jointsMatrices=n.outputMat,e.entity.components.Material.shader.macros.JOINT_AMOUNT=Math.min(t.joints.length,200)}return t.entity&&t.entity.addComponent(n),n})),a)for(let{channels:t,samplers:n}of a)for(let{sampler:r,target:i}of t){let t,a=this.entities[i.node],o=a.components.Transform;a.components.Material;switch(i.path){case"translation":t=o.translate;break;case"rotation":t=o.quaternion;break;case"scale":t=o.scale}if(null!=t){let{input:i,interpolation:o,output:s}=n[r],l=e.accessors[i],c=e.accessors[s];null==a.components.Animation&&a.addComponent(new Xt);let u=a.components.Animation;Xt.attachChannel(u,new qt(t,l,c))}}let o=n[t||0].nodes;for(let e of o){let t=this.parseNode(e,r);this.scene.appendChild(t)}return console.log(this),this})}waitEntity(e,t){return new Promise((n,r)=>{setTimeout(()=>{n(this.createEntity(e,t))},0)})}detectTexture(e,t,n){let{index:r,texCoord:i}=n,a=this.gltf;null!=r&&(Ct.setTexture(e,t,a.textures[r]),i&&(e.shader.macros[`${t}_uv`]=`uv${i}`))}detectConfig(e,t){let n=e.shader;for(let r in t){let i=t[r];switch(this.detectTexture(e,r,i),r){case"normalTexture":n.macros.HAS_NORMAL_MAP="";break;case"occlusionTexture":n.macros.HAS_AO_MAP="";break;case"baseColorTexture":n.macros.HAS_BASECOLOR_MAP="";break;case"metallicRoughnessTexture":n.macros.HAS_METALLIC_ROUGHNESS_MAP="";break;case"emissiveTexture":n.macros.HAS_EMISSIVE_MAP="";break;case"baseColorFactor":n.macros.BASECOLOR_FACTOR=`vec4(${i.join(",")})`;break;case"metallicFactor":n.macros.METALLIC_FACTOR=`float(${i})`;break;case"roughnessFactor":n.macros.ROUGHNESS_FACTOR=`float(${i})`;break;case"alphaMode":n.macros[i]="","OPAQUE"!=i&&(e.queue=Nt.Blend);break;case"alphaCutoff":n.macros.ALPHA_CUTOFF=`float(${i})`;break;case"pbrMetallicRoughness":this.detectConfig(e,i)}}}createEntity(e,t){let{mesh:n,name:r,matrix:i,rotation:a,scale:o,translation:s,skin:l,camera:c}=e;r=r||"node_"+t;let u=wt.create(r),f=u.components.Transform;null!=i?(m(f.localMatrix,...i),Wt.decomposeMatrix(f)):(null!=a&&ae(f.quaternion,...a),null!=o&&w(f.scale,...o),null!=s&&w(f.translate,...s)),Wt.updateMatrix(f);let h=[];if(null!=n){let e=u,t=this.gltf.meshes[n],r=t.length-1;for(let[n,i]of t.entries()){let[t,a]=i;r&&(e=u.appendChild(wt.create("subNode_"+n))),e.addComponent(t),e.addComponent(a),h.push(e.components.Transform)}}return null!=l&&(this.gltf.skins[l].entity=u,this.gltf.skins[l].transforms||(this.gltf.skins[l].transforms=[]),this.gltf.skins[l].transforms.push(...h)),null!=c&&u.addComponent(this.gltf.cameras[c]),u}parseNode(e,t){let n=t[e],r=this.entities[e];if(n.children)for(let e of n.children)r.appendChild(this.parseNode(e,t));return r}}class Zt{constructor(e=1,t=45,n=.1,r=1e3){this.isDirty=!0,this.aspect=e,this.fov=t,this.near=n,this.far=r,this.projection=h(),this.view=h(),this.vp=h(),this.up=C(0,1,0),this.lookAt=L(),Zt.updateProjectionMatrix(this)}static updateProjectionMatrix(e){A(e.projection,e.fov*Math.PI/180,e.aspect,e.near,e.far)}static updateViewMatrix(e){let t=e.entity.components.Transform;R(e.view,t.translate,e.lookAt,e.up),S(e.view,e.view,t.worldInverseMatrix),S(e.vp,e.projection,e.view)}}Ht.registSystem(new class extends Gt{constructor(){super(...arguments),this.group=[],this.depends=[Zt.name]}onUpdate(){for(let{components:e}of this.group){let t=e.Camera;Zt.updateViewMatrix(t)}}});class Yt{static addTask(){this.totalTask++,this.taskObserve&&this.taskObserve(this.finishedTask,this.totalTask)}static finishTask(){this.finishedTask++,this.taskObserve&&this.taskObserve(this.finishedTask,this.totalTask)}static loadImage(e){return new Promise((t,n)=>{this.addTask();let r=new Image;r.crossOrigin="anonymous",r.src=e,r.onload=(()=>{t(r),this.finishTask()})})}static loadBufferImage(e,t){return new Promise((n,r)=>{var i=new Blob([e],{type:t}),a=URL.createObjectURL(i);let o=new Image;o.src=a,o.onload=(()=>{n(o)})})}static adjustDataUri(e,t){return"data:"==t.substr(0,5)?t:e+t}static glbParse(e){return Ut(this,void 0,void 0,function*(){let t,n=[],r=yield this.loadBuffer(e),i=0,a=new Int32Array(r,i,3);i+=12;let[o,s,l]=a;if(o==this.glbMagic){for(;i<l;){let[e,a]=new Int32Array(r,i,2);i+=8;let o=r.slice(i,i+e);switch(a){case 1313821514:t=JSON.parse(this.decoder.decode(o));break;case 5130562:n.push(o)}i+=e}return{json:t,bin:n}}console.error("Magic number incorrect! - "+a[0])})}static loadGLTF(e,n,r,i,a){return Ut(this,void 0,void 0,function*(){let o,s=e.split("/"),[l,c]=s.pop().split(".");if(s=s.join("/")+"/","glb"==c){let t=yield this.glbParse(e);(o=t.json).buffers=t.bin,o.bufferViews=o.bufferViews.map(e=>new St(o.buffers[e.buffer],e)),o.images&&(o.images=yield Promise.all(o.images.map(e=>this.loadBufferImage(o.bufferViews[e.bufferView].dataView,e.mimeType))))}else{if("gltf"!=c)return void console.error("Wrong file!");(o=yield(yield fetch(e)).json()).buffers=yield Promise.all(o.buffers.map(({uri:e})=>this.loadBuffer(this.adjustDataUri(s,e)))),o.bufferViews=o.bufferViews.map(e=>new St(o.buffers[e.buffer],e)),o.images&&(o.images=yield Promise.all(o.images.map(({uri:e})=>this.loadImage(this.adjustDataUri(s,e)))))}if(o.cameras&&(o.cameras=o.cameras.map(e=>{if(e.perspective){let{aspectRatio:t,yfov:r,znear:i,zfar:a}=e.perspective,o=new Zt(n.width/n.height,180*r/Math.PI,i,a);return o.name=e.name,o}})),o.textures&&(o.textures=o.textures.map(e=>{let n,{source:r,sampler:i}=e;return null!=o.samplers&&(n=o.samplers[i]),new t(o.images[r],n)})),o.commonShader=a||"iOS"==Bt.platform?new Ot(yt.stylize.vs,yt.stylize.fs):new Ot(yt.stylize2.vs,yt.stylize2.fs),void 0===this.brdfLUT){const e="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Viewer/master/assets/images/brdfLUT.png";this.brdfLUT=yield this.loadTexture(e,{minFilter:WebGL2RenderingContext.LINEAR})}o.brdfLUT=this.brdfLUT,null!=r?(o.hasEnvmap=!0,o.envmap=r,o.diffmap=i):o.hasEnvmap=!1;let{scene:u}=yield new $t(o).assemble(),f=wt.getEntites([Rt.name,Ct.name],u);for(let e of f){let t=e.components.Mesh,r=e.components.Material;"outline"==r.name&&(e.components.Transform.isVisible=!1),e.addComponent(new Ft(n,t,r))}return u})}static loadBuffer(e){return Ut(this,void 0,void 0,function*(){this.addTask();let t=yield(yield fetch(e)).arrayBuffer();return this.finishTask(),t})}static LoadShaderProgram(e){return Ut(this,void 0,void 0,function*(){let t=(e=Ct.SHADER_PATH+e)+".vs.glsl",n=e+".fs.glsl",[r,i]=yield Promise.all([t,n].map(e=>fetch(e).then(e=>e.text())));return new Ot(r,i)})}static LoadMaterial(e){return Ut(this,void 0,void 0,function*(){this.addTask();let t=yield this.LoadShaderProgram(e);return this.finishTask(),new Ct(t)})}static HDRParse(e){const t=new Uint8Array(e);let n=0;for(;10!=t[n]||10!=t[n+1];)n++;let r=this.decoder.decode(t.subarray(0,n)).split("\n");"#?RADIANCE"!=r[0]&&console.table(r);const i=n+=2;for(;10!=t[++n];);let a=this.decoder.decode(t.subarray(i,n)).split(" "),o=t.subarray(n+1);a[1]*=1,a[3]*=1;const s=a[1]*a[3];let l=a[1],c=a[3],u=new Uint8Array(4*s),f=0;if(4*s!=o.length){const e=Date.now();for(let e=0;e<l;e++){let t=o.subarray(f,f+4);if(f+=4,2!=t[0]||2!=t[1])console.log("this file is not run length encoded");else{const t=[new Uint8Array(c),new Uint8Array(c),new Uint8Array(c),new Uint8Array(c)];for(let e=0;e<4;e++){let n=0;const r=t[e];for(;n<c;){let e=0,t=o.subarray(f,f+2);if(f+=2,t[0]>128)for(e=t[0]-128;e--;)r[n++]=t[1];else for(e=t[0]-1,r[n++]=t[1];e--;)r[n++]=o.subarray(f,++f)[0]}}for(let n=0;n<c;n++){const r=u.subarray(4*(e*c+n),4*(e*c+(n+1)));r[0]=t[0][n],r[1]=t[1][n],r[2]=t[2][n],r[3]=t[3][n]}}}console.log(`RLE decoding cost ${Date.now()-e}ms`)}else for(let e=0;e<s;e++){const[t,n,r,i]=o.subarray(4*e,4*(e+1)),a=u.subarray(4*e,4*(e+1));a[0]=t,a[1]=n,a[2]=r,a[3]=i}return{size:a,buffer:u,decodeRGBE:()=>{const e=new Float32Array(3*s);for(let t=0;t<s;t++){const[n,r,i,a]=u.subarray(4*t,4*(t+1)),o=e.subarray(3*t,3*(t+1));0!=a&&(o[0]=n*Math.pow(2,a-128),o[1]=r*Math.pow(2,a-128),o[2]=i*Math.pow(2,a-128))}return{size:a,buffer:u,rgb:e}}}}static loadCubeimg(e,t="jpg"){return Ut(this,void 0,void 0,function*(){return yield Promise.all(this.cubemapOrder.map(n=>this.loadImage(e+n+t)))})}static loadCubemap(e,n="jpg"){return Ut(this,void 0,void 0,function*(){let r;"hdr"==n?(r=yield Promise.all(this.cubemapOrder.map(t=>fetch(e+t+n))),r=yield Promise.all(r.map(e=>e.arrayBuffer()))):r=yield this.loadCubeimg(e,n);let i=new t(r,{magFilter:WebGL2RenderingContext.LINEAR,minFilter:WebGL2RenderingContext.LINEAR_MIPMAP_LINEAR,wrapS:WebGL2RenderingContext.CLAMP_TO_EDGE,wrapT:WebGL2RenderingContext.CLAMP_TO_EDGE});if("hdr"==n){let e;i.data=r.map(t=>{const{size:n,buffer:r}=this.HDRParse(t);return e=n,r}),i.height=e[1],i.width=e[3],i.glType=WebGL2RenderingContext.TEXTURE_CUBE_MAP,i.image=null,i.isDirty=!0}return i})}static loadTexture(e,n){return Ut(this,void 0,void 0,function*(){if("hdr"==e.split(".").pop()){let n=yield(yield fetch(e)).arrayBuffer();const{size:r,rgb:i}=this.HDRParse(n).decodeRGBE(),a=new t(null,{magFilter:WebGL2RenderingContext.LINEAR,minFilter:WebGL2RenderingContext.LINEAR,wrapS:WebGL2RenderingContext.CLAMP_TO_EDGE,wrapT:WebGL2RenderingContext.CLAMP_TO_EDGE});return a.data=i,a.height=r[1],a.width=r[3],a.format=WebGL2RenderingContext.RGB,a.internalformat=WebGL2RenderingContext.RGB32F,a.type=WebGL2RenderingContext.FLOAT,a.image=null,a.isDirty=!0,a}{let r=yield this.loadImage(e);return new t(r,n)}})}}Yt.totalTask=0,Yt.finishedTask=0,Yt.taskObserve=null,Yt.glbMagic=1179937895,Yt.decoder=new TextDecoder,Yt.cubemapOrder=["posx.","negx.","posy.","negy.","posz.","negz."];let Jt="\nattribute vec3 POSITION;\n\nvoid main() {\n  gl_Position = vec4(POSITION, 1);\n}\n",Qt="\nprecision highp float;\n#include <macros>\nuniform sampler2D base;\n\nvoid main() {\n    vec2 uv = gl_FragCoord.xy / screenSize;\n    vec4 color = texture2D(base, uv);\n    float brightness = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));\n    if(brightness < THRESHOLD) {\n        color.r = color.g = color.b = color.a = 0.0;\n        // discard;\n    }\n    gl_FragColor = color;\n}\n",Kt="\nattribute vec3 POSITION;\n\nvoid main(){\n    gl_Position=vec4(POSITION,1);\n}\n",en="\n#define PI 3.1415926535898\nprecision highp float;\nuniform sampler2D base;\n\nvec2 uv;\n\nvec4 blur9() {\n    vec4 color = vec4(0);\n    vec2 direction = OFFSET;\n    vec2 off1 = vec2(1.3846153846) * direction;\n    vec2 off2 = vec2(3.2307692308) * direction;\n    color += texture2D(base, uv) * 0.2270270270;\n    color += texture2D(base, uv + off1) * 0.3162162162;\n    color += texture2D(base, uv - off1) * 0.3162162162;\n    color += texture2D(base, uv + off2) * 0.0702702703;\n    color += texture2D(base, uv - off2) * 0.0702702703;\n    return color;\n}\nvec4 gaussianBlur() {\n    vec2 offset = OFFSET;\n    float weight[5];\n    weight[0] = 0.227027;\n    weight[1] = 0.1945946;\n    weight[2] = 0.1216216;\n    weight[3] = 0.054054;\n    weight[4] = 0.016216;\n    vec4 color = vec4(0);\n    for(int i = 0; i < 5; i++) {\n        color += texture2D(base, uv + offset * float(i+1) ) * weight[i];\n        color += texture2D(base, uv + offset * float(-i-1) ) * weight[i];\n    }\n    return color;\n}\n\nfloat random(vec3 scale, float seed) {\n    return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);\n}\n\n// https://redcamel.github.io/RedGL2/example/postEffect/blur/RedPostEffect_BlurX.html\n\nvec4 noiseblur() {\n    vec4 finalColor = vec4(0);\n    vec2 delta;\n    float total = 0.0;\n    float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);\n    delta = OFFSET;\n    for (float t = -10.0; t <= 10.0; t++) {\n        float percent = (t + offset - 0.5) / 10.0;\n        float weight = 1.0 - abs(percent);\n        vec4 sample = texture2D(base, uv + delta * percent);\n        sample.rgb *= sample.a;\n        finalColor += sample * weight;\n        total += weight;\n    }\n    finalColor /= total;\n    return finalColor;\n}\n\nvoid main() {\n    uv = gl_FragCoord.xy / oResolution;\n    // gl_FragColor = gaussianBlur();\n    // gl_FragColor = noiseblur();\n    gl_FragColor = blur9();\n    // gl_FragColor = vec4(mod(uv, 1.), 0, 1);\n}\n",tn="\nattribute vec3 POSITION;\n\nvoid main() {\n  gl_Position = vec4(POSITION, 1);\n}\n",nn="\nprecision highp float;\n#include <macros>\nuniform sampler2D base;\nuniform sampler2D originTex;\n\nvoid main() {\n    vec2 uv = gl_FragCoord.xy / screenSize;\n    vec4 origin = texture2D(originTex, uv);\n    vec4 addition = texture2D(base, uv) * vec4(vec3(BLOOM_INTENSITY),0);\n    gl_FragColor = origin + addition;\n}\n";let rn=yt.vignetting.vs,an=yt.vignetting.fs;class on{constructor(e,t,n=90,r=90,i=.01,a=.92){this.movement=L(),this.unprojectMatrix=h(),this.X=C(1,0,0),this.Y=C(0,1,0),this.Z=C(0,0,1),this.vx=0,this.vy=0,this.vz=0,this.vyaw=0,this.vpitch=0,this.vscale=0,this.threshold=.001,this.moveHandler=(e=>{let{movementX:t,movementY:n,buttons:r}=e;if(2==r);else{let e=t*this.speed,r=-n*this.speed;this.vpitch+=r,this.vyaw+=e}}),this.touchHandler=(()=>{let e,t;return n=>{let{pageX:r,pageY:i}=n.touches[0];if(e||t){let n=r-e,a=i-t;this.vpitch+=-a*this.speed,this.vyaw+=n*this.speed}t=i,e=r}}),this.scrollHandler=(({deltaY:e})=>{this.vscale+=e*this.speed*.01}),this.orientationHandler=(e=>{this.lastalpha&&this.lastbeta||(this.lastalpha=e.alpha,this.lastbeta=e.beta);let t=e.alpha-this.lastalpha,n=e.beta-this.lastbeta;this.pitch=this.lastbeta+.1*n,this.yaw=this.lastalpha+.1*t}),this.pitch=n,this.yaw=r,this.speed=i,this.damping=a,this.camera=t.components.Camera,this.trans=t.components.Transform,this.distance=D(this.trans.translate,this.camera.lookAt),e.mainCamera=this.camera,on.bindEvents(e.canvas,this),sn.updatePosition(this)}static bindEvents(e,t){e.addEventListener("mousedown",()=>{e.addEventListener("mousemove",t.moveHandler)}),e.addEventListener("mouseup",()=>{e.removeEventListener("mousemove",t.moveHandler)}),e.addEventListener("wheel",t.scrollHandler),e.addEventListener("touchstart",()=>{let n=t.touchHandler();e.addEventListener("touchmove",n),e.addEventListener("touchend",()=>{e.removeEventListener("touchmove",n)})}),e.addEventListener("wheel",t.scrollHandler)}}class sn extends Gt{constructor(){super(...arguments),this.group=[],this.depends=[on.name]}onUpdate(){for(let{components:e}of this.group)sn.updatePosition(e.OrbitControl)}static updatePosition(e){Math.abs(e.vyaw)>e.threshold&&(e.yaw+=e.vyaw,e.vyaw*=e.damping),Math.abs(e.vpitch)>e.threshold&&(e.pitch+=e.vpitch,e.vpitch*=e.damping),Math.abs(e.vscale)>e.threshold&&(e.distance+=e.vscale,e.distance=Math.max(e.distance,1),e.vscale*=e.damping),e.pitch=Math.min(180,Math.max(.01,e.pitch)),e.trans.translate[0]=e.camera.lookAt[0]+e.distance*Math.sin(e.pitch/180*Math.PI)*Math.cos(e.yaw/180*Math.PI),e.trans.translate[1]=e.camera.lookAt[1]+e.distance*Math.cos(e.pitch/180*Math.PI),e.trans.translate[2]=e.camera.lookAt[2]+e.distance*Math.sin(e.pitch/180*Math.PI)*Math.sin(e.yaw/180*Math.PI),e.camera.isDirty=!0,Wt.updateMatrix(e.trans)}}Ht.registSystem(new sn);class ln{constructor(e=0,t=0,n=0,r=0,i=0,a=0){this.max=L(),this.min=L(),this._center=L(),w(this.max,e,t,n),w(this.min,r,i,a)}pointInsert(e,t,n){return!(e>this.max[0]||e<this.min[0])&&(!(t>this.max[1]||t<this.min[1])&&!(n>this.max[2]||n<this.min[2]))}pointInsertX(e){return!(e>this.max[0]||e<this.min[0])}pointInsertY(e){return!(e>this.max[1]||e<this.min[1])}pointInsertZ(e){return!(e>this.max[2]||e<this.min[2])}isCross(e){return!(!this.pointInsertX(e.max[0])&&!this.pointInsertX(e.min[0]))&&(!(!this.pointInsertY(e.max[1])&&!this.pointInsertY(e.min[1]))&&!(!this.pointInsertZ(e.max[2])&&!this.pointInsertZ(e.min[2])))}update(){}reset(){w(this.max,0,0,0),w(this.min,0,0,0)}get visible(){return this._isVisible}set visible(e){if(this._isVisible=e,e&&!this.agent){this.agent=this.entity.appendChild(wt.create("aabb"));const e=L();q(e,this.max,this.min);const t=this.createMesh(),n=new Ft(this.screen,t,ln.mat);this.agent.addComponent(n)}}createMesh(){const e=this.max[0],t=this.max[1],n=this.max[2],r=this.min[0],i=this.min[1],a=this.min[2];let o=new Float32Array([e,t,n,e,i,n,e,t,a,e,i,a,r,t,n,r,i,n,r,t,a,r,i,a]),s=new Uint16Array([0,1,2,2,1,3,6,7,4,4,7,5,6,4,2,2,4,0,5,7,1,1,7,3,4,5,0,0,5,1,2,3,6,6,3,7]),l=new St(o.buffer,{byteOffset:o.byteOffset,byteLength:o.byteLength,byteStride:12,target:WebGL2RenderingContext.ARRAY_BUFFER}),c=new St(s.buffer,{byteOffset:s.byteOffset,byteLength:s.byteLength,byteStride:0,target:WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER}),u=new Et({bufferView:l,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:8},"POSITION"),f=new Et({bufferView:c,componentType:WebGL2RenderingContext.UNSIGNED_SHORT,byteOffset:0,type:"SCALAR",count:s.length});return new Rt([u],f,WebGL2RenderingContext.LINES)}append(e,t,n){this.max[0]=Math.max(this.max[0],e),this.max[1]=Math.max(this.max[1],t),this.max[2]=Math.max(this.max[2],n),this.min[0]=Math.min(this.min[0],e),this.min[1]=Math.min(this.min[1],t),this.min[2]=Math.min(this.min[2],n)}get center(){return this._center}}ln.mat=new Ct(new Ot(yt.line.vs,yt.line.fs));class cn{constructor(){this.data=[],this.child=[]}}class un{constructor(){this.max=L(),this.min=L(),this.isDefault=!0,this._center=L(),this.isDirty=!1,this._isVisible=!1}get center(){return this.isDirty&&this.updateCenter(),this._center}updateCenter(){if(this.isDefault)return console.error("AABB is incorrect!");this._center[0]=this.min[0]+.5*(this.max[0]-this.min[0]),this._center[1]=this.min[1]+.5*(this.max[1]-this.min[1]),this._center[2]=this.min[2]+.5*(this.max[2]-this.min[2]),this.isDirty=!1}update(e){if(this.isDirty=!0,this.isDefault)return this.max[0]=e[0],this.max[1]=e[1],this.max[2]=e[2],this.min[0]=e[0],this.min[1]=e[1],this.min[2]=e[2],void(this.isDefault=!1);this.max[0]=Math.max(this.max[0],e[0]),this.max[1]=Math.max(this.max[1],e[1]),this.max[2]=Math.max(this.max[2],e[2]),this.min[0]=Math.min(this.min[0],e[0]),this.min[1]=Math.min(this.min[1],e[1]),this.min[2]=Math.min(this.min[2],e[2])}get visible(){return this._isVisible}set visible(e){if(this._isVisible=e,e&&!this.agent){this.agent=this.root.appendChild(wt.create("aabb"));const e=this.createMesh(),t=new Ft(this.screen,e,un.mat);this.agent.addComponent(t)}}createMesh(){const e=this.max[0],t=this.max[1],n=this.max[2],r=this.min[0],i=this.min[1],a=this.min[2];let o=new Float32Array([e,t,n,e,i,n,e,t,a,e,i,a,r,t,n,r,i,n,r,t,a,r,i,a]),s=new Uint16Array([0,1,5,4,0,2,6,4,4,5,7,6,7,3,1,3,2]),l=new St(o.buffer,{byteOffset:o.byteOffset,byteLength:o.byteLength,byteStride:12,target:WebGL2RenderingContext.ARRAY_BUFFER}),c=new St(s.buffer,{byteOffset:s.byteOffset,byteLength:s.byteLength,byteStride:0,target:WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER}),u=new Et({bufferView:l,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:8},"POSITION"),f=new Et({bufferView:c,componentType:WebGL2RenderingContext.UNSIGNED_SHORT,byteOffset:0,type:"SCALAR",count:s.length});return new Rt([u],f,WebGL2RenderingContext.LINE_LOOP)}}un.mat=new Ct(new Ot(yt.line.vs,yt.line.fs));class fn{constructor(){this.bounds=new un,this.isLeaf=!1,this.index=-1,this.mat=-1}get raw(){return new Float32Array(6)}static hitable(e,t){}}class hn{constructor(){this.bounds=new un}}class dn{constructor(e=2048,n=1){const r=e*e,i=r/n,a=4*n,o=new Float32Array(4*r),s=[];for(let e=0;e<i;e++)s[e]=o.subarray(e*a,(e+1)*a);const l=new t(null,{magFilter:WebGL2RenderingContext.LINEAR,minFilter:WebGL2RenderingContext.LINEAR,wrapS:WebGL2RenderingContext.CLAMP_TO_EDGE,wrapT:WebGL2RenderingContext.CLAMP_TO_EDGE});l.data=o,l.height=e,l.width=e,l.format=WebGL2RenderingContext.RGBA,l.internalformat=WebGL2RenderingContext.RGBA32F,l.type=WebGL2RenderingContext.FLOAT,l.isDirty=!0,this.raw=o,this.chunks=s,this.tex=l}}class mn{constructor(e=2048){this.nodeList=[],this.matMap=new Map,this._size=L(),this.LBVHTexture=new dn(e,2),this.LBVH=this.LBVHTexture.raw,this.LBVH_nodes=this.LBVHTexture.chunks}genBounds(e,t=e.length,n){const r=[];let i=0;for(let a=0;a<t;){i<n.length-1&&a>=n[i+1][0]&&i++;const t=new hn;t.mat=n[i][1],t.index=2*a,t.bounds.update(e[a++]),t.bounds.update(e[a++]),t.bounds.update(e[a++]),r.push(t)}return console.log("Materials: "+this.matMap),r}materialsHandler(e){let t="",n="\n        if(mat < -.5) {\n            continue;\n        }",r=[];for(const[i,[a,o]]of e){const e=o.textures;let s="\n            float scale = 100.;\n            float fact = step(.0, sin(iuv.x * scale)*sin(iuv.y * scale));\n            albedo = vec3(1) * clamp(fact, .2, 1.);\n            // albedo = sRGBtoLINEAR(texture(ground, iuv * 15.)).rgb;\n";e.has("baseColorTexture")&&(t+=`\nuniform sampler2D baseColorTexture_${a};\n`,s=`albedo = sRGBtoLINEAR(texture(baseColorTexture_${a}, iuv)).rgb;`,r.push(t=>{Ct.setTexture(t,`baseColorTexture_${a}`,e.get("baseColorTexture")[1])}));let l="\n            vec3 rm = vec3(0, .2, .5);\n            metal = clamp(rm.b, 0.0, 1.0);\n            roughness = clamp(rm.g, 0.04, 1.0);\n            ";e.has("metallicRoughnessTexture")&&(t+=`\nuniform sampler2D metallicRoughnessTexture_${a};\n`,l=`\n                vec3 rm = texture(metallicRoughnessTexture_${a}, iuv).rgb;\n                metal = clamp(rm.b, 0.0, 1.0);\n                roughness = clamp(rm.g, 0.04, 1.0);\n`,r.push(t=>{Ct.setTexture(t,`metallicRoughnessTexture_${a}`,e.get("metallicRoughnessTexture")[1])}));let c="";e.has("emissiveTexture")&&(t+=`\nuniform sampler2D emissiveTexture_${a};\n`,c=`\n                vec3 em = sRGBtoLINEAR(texture(emissiveTexture_${a}, iuv)).rgb;\n                if(dot(em, em) > .01)\n                    return em;\n`,r.push(t=>{Ct.setTexture(t,`emissiveTexture_${a}`,e.get("emissiveTexture")[1])})),n+=`\n            else if(mat < ${a}.5) { // NOTE: ${i}\n                ${s}\n                ${l}\n                ${c}\n            }`}return{params:t,route:n,init:e=>{for(let t of r)t(e)}}}buildBVH(e){const t=Date.now();let n=[];const r=new dn(2048,2);let i=0;const a=L(),o=te();for(let t of e){const e=t.entity.components.Material;let s=-1;this.matMap.has(e.name)?[s]=this.matMap.get(e.name):(s=this.matMap.size,this.matMap.set(e.name,[this.matMap.size,e])),n.push([i,s]);let l=t.entity.components.Transform,c=t.data,u=c.POSITION,f=c.NORMAL,h=c.TEXCOORD_0,d=t.indices.data;for(let e=0;e<d.length;e++){const t=r.chunks[i++];if(k(a,u[d[e]],l.worldMatrix),t.set(a),f){const n=f[d[e]];ae(o,n[0],n[1],n[2],0),ge(o,o,l.worldNormalMatrix),B(o,o),t.set(o,4)}h&&(t[3]=h[d[e]][0],t[7]=h[d[e]][1])}}const s=this.genBounds(r.chunks,i,n),l=this.root=this.splitBVH(s),c=this.fillLBVH(l,this.LBVHTexture),u=this.materialsHandler(this.matMap);return console.log(`Build BVH cost ${Date.now()-t}ms`),{LBVH:c,triangleTexture:r,primitives:s,matHandler:u}}splitBVH(e){if(0==e.length)return null;const t=new fn;for(let n of e)t.bounds.update(n.bounds.max),t.bounds.update(n.bounds.min);if(e.length<2)return t.isLeaf=!0,t.index=e[0].index,t.mat=e[0].mat,t;const n=this._size;q(n,t.bounds.max,t.bounds.min);let r=n.indexOf(Math.max(n[0],n[1],n[2])),i=[],a=[],o=3;for(;o--&&(0==i.length||0==a.length);){const n=t.bounds.center[r%3];i=[],a=[];for(let t of e)t.bounds.center[r]<n?i.push(t):a.push(t);if(r++,0==o){const t=Math.ceil(e.length/2);i=e.slice(0,t),a=e.slice(t)}}if(0==i.length&&a.length,0==i.length){const e=i;i=a,a=e}return t.left=this.splitBVH(i),t.right=this.splitBVH(a),t}static createTree(e){let t=new fn;return e--?(t.left=this.createTree(e),t.right=this.createTree(e)):t.isLeaf=!0,t}fillLBVH(e,t){return t.raw.fill(0),mn.fillLinearNode(e,t.chunks),t}static fillLinearNode(e,t,n=0){let r=e.right?n+1:-1;return e.left&&(r=this.fillLinearNode(e.left,t,n+1)),t[n].set(e.bounds.min),t[n].set(e.bounds.max,4),e.isLeaf?t[n][3]=e.mat:t[n][3]=r,t[n][7]=e.index,n++,e.right&&(n=this.fillLinearNode(e.right,t,r)),n}}e.AABB=un,e.Accessor=Et,e.Animation=Xt,e.AnimationChannel=qt,e.Asset=Yt,e.BVHManager=mn,e.Bloom=class{static initFilters(e,t=.7,n=1,r=1){let i,a=new Pt(e,new Ot(Jt,Qt,i={THRESHOLD:t})),o=e.width,s=e.height,l=[];n=1*e.ratio;let c=3;for(;c--&&o>32&&s>32;){const t=Math.floor(.5*o),r=Math.floor(.5*s);l.push(new Pt(e,new Ot(Kt,en,{OFFSET:`vec2(${n/t}, 0)`,iResolution:`vec2(${o}, ${s})`,oResolution:`vec2(${t}, ${r})`}),o=t,s=r)),l.push(new Pt(e,new Ot(Kt,en,{OFFSET:`vec2(0, ${n/r})`,iResolution:`vec2(${o}, ${s})`,oResolution:`vec2(${t}, ${r})`}),o=t,s=r))}let u=new Pt(e,new Ot(tn,nn,i={BLOOM_INTENSITY:"float(2)"}));e.output?u.setInput(e.output.output,"originTex"):u.setInput(e.capture.output,"originTex"),e.attachFilter(a);for(let t of l)e.attachFilter(t),console.log(t.width,t.height);e.attachFilter(u)}},e.BoxMesh=class extends Rt{constructor(e=1,t=1,n=1){e/=2,t/=2,n/=2;let r=new Float32Array([e,t,n,e,-t,n,e,t,-n,e,-t,-n,-e,t,n,-e,-t,n,-e,t,-n,-e,-t,-n]),i=new Uint16Array([0,1,2,2,1,3,6,7,4,4,7,5,6,4,2,2,4,0,5,7,1,1,7,3,4,5,0,0,5,1,2,3,6,6,3,7]),a=new St(r.buffer,{byteOffset:r.byteOffset,byteLength:r.byteLength,byteStride:12,target:WebGL2RenderingContext.ARRAY_BUFFER}),o=new St(i.buffer,{byteOffset:i.byteOffset,byteLength:i.byteLength,byteStride:0,target:WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER});super([new Et({bufferView:a,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:8},"POSITION")],new Et({bufferView:o,componentType:WebGL2RenderingContext.UNSIGNED_SHORT,byteOffset:0,type:"SCALAR",count:i.length}),WebGL2RenderingContext.LINES)}},e.Camera=Zt,e.ComponentSystem=Gt,e.EntityMgr=wt,e.Filter=Pt,e.Material=Ct,e.Mesh=Rt,e.MeshRenderer=Ft,e.OrbitControl=on,e.QuadMesh=class extends Rt{constructor(){let e=new Float32Array([-1,-1,0,0,0,0,0,1,1,-1,0,1,0,0,0,1,1,1,0,1,1,0,0,1,-1,1,0,0,1,0,0,1]),t=new Uint16Array([0,1,2,0,2,3]),n=new St(e.buffer,{byteOffset:e.byteOffset,byteLength:e.byteLength,byteStride:32,target:WebGL2RenderingContext.ARRAY_BUFFER}),r=new St(t.buffer,{byteOffset:t.byteOffset,byteLength:t.byteLength,byteStride:0,target:WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER});super([new Et({bufferView:n,componentType:WebGL2RenderingContext.FLOAT,byteOffset:0,type:"VEC3",count:4},"POSITION"),new Et({bufferView:n,componentType:WebGL2RenderingContext.FLOAT,byteOffset:12,type:"VEC2",count:4},"TEXCOORD_0"),new Et({bufferView:n,componentType:WebGL2RenderingContext.FLOAT,byteOffset:20,type:"VEC3",count:4},"NORMAL")],new Et({bufferView:r,componentType:WebGL2RenderingContext.UNSIGNED_SHORT,byteOffset:0,type:"SCALAR",count:6}))}},e.Screen=Bt,e.Shader=Ot,e.Skin=kt,e.System=Ht,e.Texture=t,e.Transform=zt,e.UniformInfo=Lt,e.Vignetting=class extends Pt{constructor(e,t=.4,n=1){super(e,new Ot(rn,an,{FACTOR:`float(${t})`,HARDNESS:`float(${n})`,iResolution:`vec2(${e.width*e.ratio}, ${e.height*e.ratio})`,oResolution:`vec2(${e.width*e.ratio}, ${e.height*e.ratio})`}))}},e.bufferView=St,e.glsl=yt,e.mat3=f,e.mat4=O,e.octree=class{constructor(e,t){if(this.maxLength=200,this.temp=new ln,this.screen=t,!e)return void console.error("Mesh not found!");this.entity=e.entity,this.data=e.data,this.pos=this.data.POSITION,this.face=e.indices.data;let n=new cn;n.bound=new ln,n.bound.entity=this.entity,n.bound.screen=this.screen;let r=[];for(let e=0,t=this.face.length/3;e<t;e++){r.push(e);let t,i=3*e;t=this.pos[this.face[i++]],n.bound.append(t[0],t[1],t[2]),t=this.pos[this.face[i++]],n.bound.append(t[0],t[1],t[2]),t=this.pos[this.face[i++]],n.bound.append(t[0],t[1],t[2])}n.bound.visible=!0,this.tree=this.buildNode(null,r,n.bound)}visible(e=this.tree){if(e&&!(e.data.length<this.maxLength)){e.bound.visible=!0;for(let t of e.child)this.visible(t)}}trangleIntersection(e,t){this.temp.reset();let n,r=3*e;return n=this.pos[this.face[r++]],this.temp.append(n[0],n[1],n[2]),n=this.pos[this.face[r++]],this.temp.append(n[0],n[1],n[2]),n=this.pos[this.face[r++]],this.temp.append(n[0],n[1],n[2]),t.isCross(this.temp)}buildNode(e,t,n){let r=new cn;if(r.bound=n,n.entity=this.entity,n.screen=this.screen,r.data=t,!t)return null;if(t.length<this.maxLength)return r.data=t,r;const{max:i}=n,{min:a}=n;let o=(i[0]-a[0])/2+a[0],s=(i[1]-a[1])/2+a[1],l=(i[2]-a[2])/2+a[2],c=[new ln(i[0],i[1],i[2],o,s,l),new ln(i[0],i[1],l,o,s,a[2]),new ln(o,i[1],l,a[0],s,a[2]),new ln(o,i[1],i[2],a[0],s,l),new ln(i[0],s,i[2],o,a[1],l),new ln(i[0],s,l,o,a[1],a[2]),new ln(o,s,l,a[0],a[1],a[2]),new ln(o,s,i[2],a[0],a[1],l)];for(let n of c){let i=[];for(let e of t)this.trangleIntersection(e,n)&&i.push(e);if(e&&i.length&&i.length==e.data.length){r.child.push(null);break}r.child.push(this.buildNode(r,i,n))}return r}},e.quat=ot,e.vec2=At,e.vec3=ee,e.vec4=Le,e.version="0.3.2",Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=/sm/b5b60e7ed3bb148610f4c68a562738a8cd6e8b4dafd405fe9b3fcb8c8ad4f1af.map