var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e){var s="",t=e.lastIndexOf("/");return-1!==t&&(s=e.substring(0,t+1)),s}function s(e,s){var t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",e,!0),t.onreadystatechange=function(){4==t.readyState&&"200"==t.status&&s(t.responseText,this)},t.send(null)}function t(e,s){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",e,!0),t.onreadystatechange=function(){if(4==t.readyState&&"200"==t.status){var e=t.response;e&&s&&s(e)}},t.send(null)}function i(e,s,t){var i=new Image;i.src=e,i.onload=function(){t(i,s)}}var n=MinimalGLTFLoader.Scene=function(){this.nodes=[]},a=MinimalGLTFLoader.BoundingBox=function(e,s){this.min=e,this.max=s,this.transform=mat4.create()};a.prototype.updateBoundingBox=function(e){vec3.min(this.min,this.min,e.min),vec3.max(this.max,this.max,e.max)},a.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]};var r,o=MinimalGLTFLoader.Accessor=function(e,s){this.bufferView=s,this.componentType=e.componentType,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=s.byteStride,this.normalized=void 0!==e.normalized?e.normalized:!1,this.count=e.count,this.type=e.type,this.size=T[this.type],this.min=e.min,this.max=e.max},f=MinimalGLTFLoader.BufferView=function(e,s){this.byteLength=e.byteLength,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=void 0!==e.byteStride?e.byteStride:0,this.target=void 0!==e.target?e.target:null,this.data=s.slice(this.byteOffset,this.byteOffset+this.byteLength),this.buffer=null},h=MinimalGLTFLoader.Node=function(){this.matrix=mat4.create(),this.children=[],this.mesh=null},u=MinimalGLTFLoader.Mesh=function(){this.meshID=-1,this.primitives=[],this.boundingBox=null},c=MinimalGLTFLoader.Primitive=function(e,s){this.attributes=s.attributes,this.indices=void 0!==s.indices?s.indices:null,this.indicesComponentType=e.accessors[this.indices].componentType,this.indicesLength=e.accessors[this.indices].count,this.indicesOffset=e.accessors[this.indices].byteOffset||0,this.material=void 0!==s.material?e.materials[s.material]:null,this.mode=void 0!==s.mode?s.mode:4,this.targets=s.targets,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.boundingBox=null},d=MinimalGLTFLoader.glTFModel=function(e){this.json=e,this.defaultScene=e.scene,this.version=Number(e.asset.version),e.accessors&&(this.accessors=new Array(e.accessors.length)),e.bufferViews&&(this.bufferViews=new Array(e.bufferViews.length)),e.scenes&&(this.scenes=new Array(e.scenes.length)),e.nodes&&(this.nodes=new Array(e.nodes.length)),e.meshes&&(this.meshes=new Array(e.meshes.length)),e.images&&(this.images=new Array(e.images.length))},l=MinimalGLTFLoader.glTFLoader=function(e){r=void 0!==e?e:null,this._init(),this.glTF=null};l.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},l.prototype._getBufferViewData=function(e,s,t){var i=this.glTF.bufferViews[s];if(void 0===i){var n=e.bufferViews[s],a=this._buffers[n.buffer];if(a)console.log("dependent buffer data ready (instant), create bufferView "+s),this.glTF.bufferViews[s]=i=new f(n,a),t(i),this._checkComplete();else{this._pendingTasks++;var r=this._bufferTasks[n.buffer];r||(this._bufferTasks[n.buffer]=[],r=this._bufferTasks[n.buffer]);var o=this;r.push(function(e){o._finishedPendingTasks++,i=o.glTF.bufferViews[s],void 0===i?(console.log("create new BufferView Data for "+s),i=o.glTF.bufferViews[s]=new f(n,e)):console.log("dependent buffer data ready (queued), create bufferView "+s),t(i)})}}else console.log("use cached bufferView "+s),t(i)},l.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))},l.prototype._parseGLTF=function(e){var s,t,i,a=this;if(e.accessors)for(s=0,t=e.accessors.length;t>s;s++)i=e.accessors[s],void 0!==i.bufferView&&this._getBufferViewData(e,i.bufferView,function(){var t=e.accessors[s],i=s;return function(e){a.glTF.accessors[i]=new o(t,e)}}());if(e.scenes)for(var r=0,f=e.scenes.length;f>r;r++){var h=new n;this.glTF.scenes[r]=h;for(var u=e.scenes[r],c=u.nodes,d=c.length,l=0;d>l;++l){var m=c[l];this._parseNode(e,m,h.nodes)}}this._parseDone=!0,this._checkComplete()},l.prototype._parseMesh=function(e,s){if(void 0===this.glTF.meshes[s]){var t=new u;this.glTF.meshes[s]=t;for(var i,n=e.meshes[s],a=n.primitives,r=a.length,o=0;r>o;++o)i=a[o],t.primitives.push(new c(e,i))}};var m=vec3.create(),g=quat.create(),b=vec3.create(),p=mat4.create();l.prototype._parseNode=function(e,s,t){if(void 0===this.glTF.nodes[s]){var i=e.nodes[s],n=new h;this.glTF.nodes[s]=n,t.push(s);var a=n.matrix;if(i.hasOwnProperty("matrix"))for(var r=0;16>r;++r)a[r]=i.matrix[r];else i.translation?vec3.set(m,i.translation[0],i.translation[1],i.translation[2]):vec3.set(m,0,0,0),i.rotation?quat.set(g,i.rotation[0],i.rotation[1],i.rotation[2],i.rotation[3]):quat.set(g,0,0,0,1),i.scale?vec3.set(b,i.scale[0],i.scale[1],i.scale[2]):vec3.set(b,1,1,1),mat4.fromRotationTranslation(p,g,m),mat4.scale(a,p,b);void 0!==i.mesh&&(n.mesh=i.mesh,this._parseMesh(e,i.mesh));var o=i.children;if(o)for(var f=o.length,u=0;f>u;++u){var c=o[u];this._parseNode(e,c,n.children)}}},l.prototype.loadGLTF=function(n,a){this._init(),this.onload=a||function(e){console.log("glTF model loaded."),console.log(e)},this.baseUri=e(n);var r=this;s(n,function(e){var s=JSON.parse(e);r.glTF=new d(s);var n,a=function(e){if(r._buffers[n]=e,r._bufferLoaded++,r._bufferTasks[n]){var s,t;for(s=0,t=r._bufferTasks[n].length;t>s;++s)r._bufferTasks[n][s](e)}r._checkComplete()};if(s.buffers)for(n in s.buffers)r._bufferRequested++,t(r.baseUri+s.buffers[n].uri,a);var o,f=function(e,s){r._imageLoaded++,r.glTF.images[s]=e,r._checkComplete()};if(s.images)for(o in s.images)r._imageRequested++,i(r.baseUri+s.images[o].uri,o,f);r._parseGLTF(s)})},l.prototype._postprocess=function(){console.log("finish loading all assets, do a second pass postprocess");var e,s,t,i,n,r,o;for(e=0,s=this.glTF.meshes.length;s>e;e++){for(n=this.glTF.meshes[e],n.boundingBox=new a(vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),t=0,i=n.primitives.length;i>t;t++)r=n.primitives[t],void 0!==r.attributes.POSITION&&(o=this.glTF.accessors[r.attributes.POSITION],o.max&&"VEC3"===o.type&&(r.boundingBox=new a(vec3.fromValues(o.min[0],o.min[1],o.min[2]),vec3.fromValues(o.max[0],o.max[1],o.max[2])),r.boundingBox.calculateTransform(),n.boundingBox.updateBoundingBox(r.boundingBox)));n.boundingBox.calculateTransform()}};var T={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();