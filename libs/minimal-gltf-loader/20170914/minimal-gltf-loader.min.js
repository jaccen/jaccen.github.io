var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e,t,i,s){switch(s){case 5122:return new Int16Array(e,t,i);case 5123:return new Uint16Array(e,t,i);case 5124:return new Int32Array(e,t,i);case 5125:return new Uint32Array(e,t,i);case 5126:return new Float32Array(e,t,i);default:return null}}function t(t){return e(t.bufferView.data,t.byteOffset,t.count*B[t.type],t.componentType)}function i(e){var t="",i=e.lastIndexOf("/");return-1!==i&&(t=e.substring(0,i+1)),t}function s(e,t){var i=new XMLHttpRequest;i.overrideMimeType("application/json"),i.open("GET",e,!0),i.onreadystatechange=function(){4==i.readyState&&"200"==i.status&&t(i.responseText,this)},i.send(null)}function r(e,t){var i=new XMLHttpRequest;i.responseType="arraybuffer",i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState&&"200"==i.status){var e=i.response;e&&t&&t(e)}},i.send(null)}function n(e,t,i){var s=new Image;s.crossOrigin="Anonymous",s.src=e,s.onload=function(){i(s,t)}}var a=MinimalGLTFLoader.Scene=function(e){this.name=void 0!==e.name?e.name:null,this.nodes=[],this.boundingBox=null},o=MinimalGLTFLoader.BoundingBox=function(e,t,i){e=e||vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),t=t||vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),void 0===i||i===!0?(this.min=vec3.clone(e),this.max=vec3.clone(t)):(this.min=e,this.max=t),this.transform=mat4.create()};o.prototype.updateBoundingBox=function(e){vec3.min(this.min,this.min,e.min),vec3.max(this.max,this.max,e.max)},o.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]},o.getAABBFromOBB=function(){var e=vec3.create(),t=vec3.create(),i=vec3.create(),s=vec3.create(),r=vec3.create();return function(n,a){vec3.set(e,a[0],a[1],a[2]),vec3.set(t,a[4],a[5],a[6]),vec3.set(i,a[8],a[9],a[10]);var h=vec3.fromValues(a[12],a[13],a[14]),l=vec3.clone(h);vec3.scale(s,e,n.min[0]),vec3.scale(r,e,n.max[0]),vec3.min(e,s,r),vec3.add(h,h,e),vec3.max(e,s,r),vec3.add(l,l,e),vec3.scale(s,t,n.min[1]),vec3.scale(r,t,n.max[1]),vec3.min(t,s,r),vec3.add(h,h,t),vec3.max(t,s,r),vec3.add(l,l,t),vec3.scale(s,i,n.min[2]),vec3.scale(r,i,n.max[2]),vec3.min(i,s,r),vec3.add(h,h,i),vec3.max(i,s,r),vec3.add(l,l,i);var u=new o(h,l,!1);return u.calculateTransform(),u}}();var h=MinimalGLTFLoader.Accessor=function(e,t){this.bufferView=t,this.componentType=e.componentType,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=t.byteStride,this.normalized=void 0!==e.normalized?e.normalized:!1,this.count=e.count,this.type=e.type,this.size=B[this.type],this.min=e.min,this.max=e.max};h.prototype.prepareVertexAttrib=function(e,t){t.vertexAttribPointer(e,this.size,this.componentType,this.normalized,this.byteStride,this.byteOffset),t.enableVertexAttribArray(e)};var l=MinimalGLTFLoader.BufferView=function(e,t){this.byteLength=e.byteLength,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=void 0!==e.byteStride?e.byteStride:0,this.target=void 0!==e.target?e.target:null,this.data=t.slice(this.byteOffset,this.byteOffset+this.byteLength),this.buffer=null};l.prototype.createBuffer=function(e){this.buffer=e.createBuffer()},l.prototype.bindData=function(e){return this.target?(e.bindBuffer(this.target,this.buffer),e.bufferData(this.target,this.data,e.STATIC_DRAW),e.bindBuffer(this.target,null),!0):!1};var u=MinimalGLTFLoader.Node=function(e){this.nodeID=e,this.matrix=mat4.create(),this.translation=null,this.rotation=null,this.scale=null,this.children=[],this.mesh=null,this.skin=null,this.jointID=null,this.aabb=null,this.bvh=new o};u.prototype.traverse=function(e,t){t(this,e);for(var i=0,s=this.children.length;s>i;i++)this.children[i].traverse(this,t)},u.prototype.traversePostOrder=function(e,t){for(var i=0,s=this.children.length;s>i;i++)this.children[i].traversePostOrder(this,t);t(this,e)},u.prototype.traverseTwoExecFun=function(e,t,i){t(this,e);for(var s=0,r=this.children.length;r>s;s++)this.children[s].traverseTwoExecFun(this,t,i);i(this,e)};var c=mat4.create();u.prototype.getTransformMatrixFromTRS=function(e,t,i){this.translation=void 0!==e?vec3.fromValues(e[0],e[1],e[2]):vec3.fromValues(0,0,0),this.rotation=void 0!==t?vec4.fromValues(t[0],t[1],t[2],t[3]):vec4.fromValues(0,0,0,1),this.scale=void 0!==i?vec3.fromValues(i[0],i[1],i[2]):vec3.fromValues(1,1,1),this.updateMatrixFromTRS()},u.prototype.updateMatrixFromTRS=function(){mat4.fromRotationTranslation(c,this.rotation,this.translation),mat4.scale(this.matrix,c,this.scale)};var d=MinimalGLTFLoader.Mesh=function(){this.meshID=-1,this.primitives=[],this.boundingBox=null},m=MinimalGLTFLoader.Primitive=function(e,t){this.attributes=t.attributes,this.indices=void 0!==t.indices?t.indices:null,null!==this.indices?(this.indicesComponentType=e.json.accessors[this.indices].componentType,this.indicesLength=e.json.accessors[this.indices].count,this.indicesOffset=e.json.accessors[this.indices].byteOffset||0):(this.drawArraysCount=e.json.accessors[this.attributes.POSITION].count,this.drawArraysOffset=e.json.accessors[this.attributes.POSITION].byteOffset||0),this.material=void 0!==t.material?e.materials[t.material]:null,this.mode=void 0!==t.mode?t.mode:4,this.targets=t.targets,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.boundingBox=null},f=MinimalGLTFLoader.Texture=function(e){this.sampler=void 0!==e.sampler?e.sampler:null,this.source=void 0!==e.source?e.source:null,this.texture=null};f.prototype.createTexture=function(e,t){t.activeTexture(t.TEXTURE0+e),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)};var p=MinimalGLTFLoader.Sampler=function(e){this.magFilter=void 0!==e.magFilter?e.magFilter:null,this.minFilter=void 0!==e.minFilter?e.minFilter:null,this.wrapS=void 0!==e.wrapS?e.wrapS:10497,this.wrapT=void 0!==e.wrapT?e.wrapT:10497,this.sampler=null};p.prototype.createSampler=function(e){this.sampler=e.createSampler(),this.minFilter?e.samplerParameteri(this.sampler,e.TEXTURE_MIN_FILTER,this.minFilter):e.samplerParameteri(this.sampler,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_LINEAR),this.magFilter?e.samplerParameteri(this.sampler,e.TEXTURE_MAG_FILTER,this.magFilter):e.samplerParameteri(this.sampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.sampler,e.TEXTURE_WRAP_S,this.wrapS),e.samplerParameteri(this.sampler,e.TEXTURE_WRAP_T,this.wrapT)};var T=MinimalGLTFLoader.TextureInfo=function(e){this.index=e.index,this.texCoord=void 0!==e.texCoord?e.texCoord:0},v=(MinimalGLTFLoader.PbrMetallicRoughness=function(e){this.baseColorFactor=void 0!==e.baseColorFactor?e.baseColorFactor:[1,1,1,1],this.baseColorTexture=void 0!==e.baseColorTexture?new T(e.baseColorTexture):null,this.metallicFactor=void 0!==e.metallicFactor?e.metallicFactor:1,this.roughnessFactor=void 0!==e.roughnessFactor?e.roughnessFactor:1,this.metallicRoughnessTexture=void 0!==e.metallicRoughnessTexture?new T(e.metallicRoughnessTexture):null},MinimalGLTFLoader.NormalTextureInfo=function(e){this.index=e.index,this.texCoord=void 0!==e.texCoord?e.texCoord:0,this.scale=void 0!==e.scale?e.scale:1}),g=MinimalGLTFLoader.Material=function(e){this.name=void 0!==e.name?e.name:null,this.pbrMetallicRoughness=void 0!==e.pbrMetallicRoughness?e.pbrMetallicRoughness:{baseColorFactor:[1,1,1,1],metallicFactor:1,metallicRoughnessTexture:1},this.normalTexture=void 0!==e.normalTexture?new v(e.normalTexture):null,this.occlusionTexture=void 0!==e.occlusionTexture?e.occlusionTexture:null,this.emissiveTexture=void 0!==e.emissiveTexture?e.emissiveTexture:null,this.emissiveFactor=void 0!==e.emissiveFactor?e.emissiveFactor:[0,0,0],this.alphaMode=void 0!==e.alphaMode?e.alphaMode:"OPAQUE",this.alphaCutoff=void 0!==e.alphaCutoff?e.alphaCutoff:.5,this.doubleSided=e.doubleSided||!1},b=MinimalGLTFLoader.Skin=function(e,i,s){this.name=void 0!==i.name?i.name:null,this.skinID=s,this.joints=new Array(i.joints.length);var r,n;for(r=0,n=this.joints.length;n>r;r++)this.joints[r]=e.nodes[i.joints[r]];if(this.skeleton=void 0!==i.skeleton?e.nodes[i.skeleton]:null,this.inverseBindMatrices=void 0!==i.inverseBindMatrices?e.accessors[i.inverseBindMatrices]:null,this.inverseBindMatrices)for(this.inverseBindMatricesData=t(this.inverseBindMatrices),this.inverseBindMatrix=[],this.jointMatrixUniformBuffer=null,this.jointMatrixUnidormBufferData=new Float32Array(512),r=0,n=this.inverseBindMatricesData.length;n>r;r+=16)this.inverseBindMatrix.push(mat4.fromValues(this.inverseBindMatricesData[r],this.inverseBindMatricesData[r+1],this.inverseBindMatricesData[r+2],this.inverseBindMatricesData[r+3],this.inverseBindMatricesData[r+4],this.inverseBindMatricesData[r+5],this.inverseBindMatricesData[r+6],this.inverseBindMatricesData[r+7],this.inverseBindMatricesData[r+8],this.inverseBindMatricesData[r+9],this.inverseBindMatricesData[r+10],this.inverseBindMatricesData[r+11],this.inverseBindMatricesData[r+12],this.inverseBindMatricesData[r+13],this.inverseBindMatricesData[r+14],this.inverseBindMatricesData[r+15]))},x=MinimalGLTFLoader.Target=function(e){this.nodeID=void 0!==e.node?e.node:null,this.path=e.path},F=MinimalGLTFLoader.Channel=function(e,t){this.sampler=t.samplers[e.sampler],this.target=new x(e.target)},y=MinimalGLTFLoader.AnimationSampler=function(e,i){this.input=e.accessors[i.input],this.output=e.accessors[i.output],this.inputTypedArray=t(this.input),this.outputTypedArray=t(this.output),this.interpolation=void 0!==i.interpolation?i.interpolation:"LINEAR",this.curIdx=0,this.curValue=vec4.create(),this.inputMax=this.inputTypedArray[this.inputTypedArray.length-1],this.loopOffset=0},M=vec4.create(),w=vec4.create();y.prototype.getValue=function(e){e-=this.loopOffset;for(var t=this.inputTypedArray.length;this.curIdx<=t-2&&e>=this.inputTypedArray[this.curIdx+1];)this.curIdx++;this.curIdx>=t-1&&(this.loopOffset+=this.inputMax,e-=this.inputMax,this.curIdx=0);for(var i=B[this.output.type],s=4===i?quat.slerp:vec4.lerp,r=this.curIdx,n=r*i,a=n+i,o=Math.max(0,e-this.inputTypedArray[r])/(this.inputTypedArray[r+1]-this.inputTypedArray[r]),h=0;i>h;h++)M[h]=this.outputTypedArray[n+h],w[h]=this.outputTypedArray[a+h];switch(this.interpolation){case"LINEAR":s(this.curValue,M,w,o)}};var _,I=MinimalGLTFLoader.Animation=function(e,t){this.name=void 0!==t.name?t.name:null;var i,s;for(this.samplers=[],i=0,s=t.samplers.length;s>i;i++)this.samplers[i]=new y(e,t.samplers[i]);for(this.channels=[],i=0,s=t.channels.length;s>i;i++)this.channels[i]=new F(t.channels[i],this)},L=MinimalGLTFLoader.glTFModel=function(e){this.json=e,this.defaultScene=void 0!==e.scene?e.scene:0,this.version=Number(e.asset.version),e.accessors&&(this.accessors=new Array(e.accessors.length)),e.bufferViews&&(this.bufferViews=new Array(e.bufferViews.length)),e.scenes&&(this.scenes=new Array(e.scenes.length)),e.nodes&&(this.nodes=new Array(e.nodes.length)),e.meshes&&(this.meshes=new Array(e.meshes.length)),e.materials&&(this.materials=new Array(e.materials.length)),e.textures&&(this.textures=new Array(e.textures.length)),e.samplers&&(this.samplers=new Array(e.samplers.length)),e.images&&(this.images=new Array(e.images.length)),e.skins&&(this.skins=new Array(e.skins.length)),e.animations&&(this.animations=new Array(e.animations.length))},A=MinimalGLTFLoader.glTFLoader=function(e){_=void 0!==e?e:null,this._init(),this.glTF=null};A.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers=[],this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},A.prototype._getBufferViewData=function(e,t,i){var s=this.glTF.bufferViews[t];if(void 0===s){var r=e.bufferViews[t],n=this._buffers[r.buffer];if(n)console.log("dependent buffer data ready (instant), create bufferView "+t),this.glTF.bufferViews[t]=s=new l(r,n),i(s),this._checkComplete();else{this._pendingTasks++;var a=this._bufferTasks[r.buffer];a||(this._bufferTasks[r.buffer]=[],a=this._bufferTasks[r.buffer]);var o=this;a.push(function(e){o._finishedPendingTasks++,s=o.glTF.bufferViews[t],void 0===s?(console.log("create new BufferView Data for "+t),s=o.glTF.bufferViews[t]=new l(r,e)):console.log("dependent buffer data ready (queued), create bufferView "+t),i(s)})}}else console.log("use cached bufferView "+t),i(s)},A.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))},A.prototype._parseGLTF=function(e){function t(){var t=e.accessors[i],s=i;return function(e){n.glTF.accessors[s]=new h(t,e)}}var i,s,r,n=this;if(e.accessors)for(i=0,s=e.accessors.length;s>i;i++)r=e.accessors[i],void 0!==r.bufferView&&this._getBufferViewData(e,r.bufferView,t());if(e.textures)for(i=0,s=e.textures.length;s>i;i++)this.glTF.textures[i]=new f(e.textures[i]);if(e.samplers)for(i=0,s=e.samplers.length;s>i;i++)this.glTF.samplers[i]=new p(e.samplers[i]);if(e.materials)for(i=0,s=e.materials.length;s>i;i++)this.glTF.materials[i]=new g(e.materials[i]);if(e.scenes)for(var o=0,l=e.scenes.length;l>o;o++){var u=new a(e.scenes[o]);this.glTF.scenes[o]=u;for(var c=e.scenes[o],d=c.nodes,m=d.length,T=0;m>T;++T){var v=d[T];u.nodes[T]=this._parseNode(e,v)}}this._parseDone=!0,this._checkComplete()},A.prototype._parseMesh=function(e,t){if(void 0!==this.glTF.meshes[t])return this.glTF.meshes[t];var i=new d;this.glTF.meshes[t]=i;for(var s,r=e.meshes[t],n=r.primitives,a=n.length,o=0;a>o;++o)s=n[o],i.primitives.push(new m(this.glTF,s));return i},A.prototype._parseNode=function(e,t){if(void 0!==this.glTF.nodes[t])return this.glTF.nodes[t];var i=e.nodes[t],s=new u(t);s.skin=void 0!==i.skin?i.skin:null,this.glTF.nodes[t]=s;var r=s.matrix;if(i.hasOwnProperty("matrix"))for(var n=0;16>n;++n)r[n]=i.matrix[n];else s.getTransformMatrixFromTRS(i.translation,i.rotation,i.scale);void 0!==i.mesh&&(s.mesh=this._parseMesh(e,i.mesh));var a=i.children;if(a)for(var o=a.length,h=0;o>h;++h){var l=a[h];s.children[h]=this._parseNode(e,l)}return s},A.prototype.loadGLTF=function(e,t){this._init(),this.onload=t||function(e){console.log("glTF model loaded."),console.log(e)},this.baseUri=i(e);var a=this;s(e,function(e){var t=JSON.parse(e);a.glTF=new L(t);var i,s=function(e){if(a._buffers[i]=e,a._bufferLoaded++,a._bufferTasks[i]){var t,s;for(t=0,s=a._bufferTasks[i].length;s>t;++t)a._bufferTasks[i][t](e)}a._checkComplete()};if(t.buffers)for(i in t.buffers)a._bufferRequested++,r(a.baseUri+t.buffers[i].uri,s);var o,h=function(e,t){a._imageLoaded++,a.glTF.images[t]=e,a._checkComplete()};if(t.images)for(o in t.images)a._imageRequested++,n(a.baseUri+t.images[o].uri,o,h);a._parseGLTF(t)})},A.prototype._postprocess=function(){function e(e,t){var i=d[e.nodeID];null!==t?mat4.mul(i,d[t.nodeID],e.matrix):mat4.copy(i,e.matrix)}function t(e,t){var i,s=d[e.nodeID];i=null!==t?t.bvh:a.boundingBox,e.mesh&&(l=e.mesh,l.boundingBox&&(e.aabb=o.getAABBFromOBB(l.boundingBox,s),0===e.children.length&&(vec3.copy(e.bvh.min,e.aabb.min),vec3.copy(e.bvh.max,e.aabb.max)))),vec3.min(i.min,i.min,e.bvh.min),vec3.max(i.max,i.max,e.bvh.max)}console.log("finish loading all assets, do a second pass postprocess");var i,s,r,n,a,h,l,u,c;for(i=0,s=this.glTF.meshes.length;s>i;i++){for(l=this.glTF.meshes[i],l.boundingBox=new o,r=0,n=l.primitives.length;n>r;r++)u=l.primitives[r],void 0!==u.attributes.POSITION&&(c=this.glTF.accessors[u.attributes.POSITION],c.max&&"VEC3"===c.type&&(u.boundingBox=new o(vec3.fromValues(c.min[0],c.min[1],c.min[2]),vec3.fromValues(c.max[0],c.max[1],c.max[2]),!1),u.boundingBox.calculateTransform(),l.boundingBox.updateBoundingBox(u.boundingBox)));l.boundingBox.calculateTransform()}var d=new Array(this.glTF.nodes.length);for(i=0,s=d.length;s>i;i++)d[i]=mat4.create();for(i=0,s=this.glTF.scenes.length;s>i;i++){for(a=this.glTF.scenes[i],a.boundingBox=new o,r=0,n=a.nodes.length;n>r;r++)h=a.nodes[r],h.traverseTwoExecFun(null,e,t);a.boundingBox.calculateTransform()}for(r=0,n=this.glTF.nodes.length;n>r;r++)h=this.glTF.nodes[r],null!==h.bvh&&h.bvh.calculateTransform();if(this.glTF.textures)for(i=0,s=this.glTF.textures.length;s>i;i++)this.glTF.samplers&&null!==this.glTF.textures[i].sampler&&(this.glTF.textures[i].sampler=this.glTF.samplers[this.glTF.textures[i].sampler]),this.glTF.images&&null!==this.glTF.textures[i].source&&(this.glTF.textures[i].source=this.glTF.images[this.glTF.textures[i].source]);if(this.glTF.animations)for(i=0,s=this.glTF.animations.length;s>i;i++)this.glTF.animations[i]=new I(this.glTF,this.glTF.json.animations[i]);var m;if(this.glTF.skins)for(i=0,s=this.glTF.skins.length;s>i;i++)for(this.glTF.skins[i]=new b(this.glTF,this.glTF.json.skins[i],i),m=this.glTF.skins[i].joints,r=0,n=m.length;n>r;r++)m[r].jointID=r;for(i=0,s=this.glTF.nodes.length;s>i;i++)h=this.glTF.nodes[i],null!==h.skin&&(h.skin=this.glTF.skins[h.skin])};var B={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();