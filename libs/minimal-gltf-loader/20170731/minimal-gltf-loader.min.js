var MinimalGLTFLoader=MinimalGLTFLoader||{};!function(){"use strict";function e(e){var t="",s=e.lastIndexOf("/");return-1!==s&&(t=e.substring(0,s+1)),t}function t(e,t){var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",e,!0),s.onreadystatechange=function(){4==s.readyState&&"200"==s.status&&t(s.responseText,this)},s.send(null)}function s(e,t){var s=new XMLHttpRequest;s.responseType="arraybuffer",s.open("GET",e,!0),s.onreadystatechange=function(){if(4==s.readyState&&"200"==s.status){var e=s.response;e&&t&&t(e)}},s.send(null)}function i(e,t,s){var i=new Image;i.crossOrigin="Anonymous",i.src=e,i.onload=function(){s(i,t)}}var r=MinimalGLTFLoader.Scene=function(){this.nodes=[],this.boundingBox=null},n=MinimalGLTFLoader.BoundingBox=function(e,t){this.min=e,this.max=t,this.transform=mat4.create()};n.prototype.updateBoundingBox=function(e){vec3.min(this.min,this.min,e.min),vec3.max(this.max,this.max,e.max)},n.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]};var a=MinimalGLTFLoader.Accessor=function(e,t){this.bufferView=t,this.componentType=e.componentType,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=t.byteStride,this.normalized=void 0!==e.normalized?e.normalized:!1,this.count=e.count,this.type=e.type,this.size=_[this.type],this.min=e.min,this.max=e.max},o=MinimalGLTFLoader.BufferView=function(e,t){this.byteLength=e.byteLength,this.byteOffset=void 0!==e.byteOffset?e.byteOffset:0,this.byteStride=void 0!==e.byteStride?e.byteStride:0,this.target=void 0!==e.target?e.target:null,this.data=t.slice(this.byteOffset,this.byteOffset+this.byteLength),this.buffer=null};o.prototype.createBuffer=function(e){this.buffer=e.createBuffer()},o.prototype.bindData=function(e){return this.target?(e.bindBuffer(this.target,this.buffer),e.bufferData(this.target,this.data,e.STATIC_DRAW),e.bindBuffer(this.target,null),!0):!1};var h=MinimalGLTFLoader.Node=function(e){this.nodeID=e,this.matrix=mat4.create(),this.children=[],this.mesh=null};h.prototype.traverse=function(e,t){t(this,e);for(var s=0,i=this.children.length;i>s;s++)this.children[s].traverse(this,t)};var l=MinimalGLTFLoader.Mesh=function(){this.meshID=-1,this.primitives=[],this.boundingBox=null},u=MinimalGLTFLoader.Primitive=function(e,t){this.attributes=t.attributes,this.indices=void 0!==t.indices?t.indices:null,this.indicesComponentType=e.accessors[this.indices].componentType,this.indicesLength=e.accessors[this.indices].count,this.indicesOffset=e.accessors[this.indices].byteOffset||0,this.material=void 0!==t.material?e.materials[t.material]:null,this.mode=void 0!==t.mode?t.mode:4,this.targets=t.targets,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.boundingBox=null},f=MinimalGLTFLoader.Texture=function(e){this.sampler=void 0!==e.sampler?e.sampler:null,this.source=void 0!==e.source?e.source:null,this.texture=null};f.prototype.createTexture=function(e,t){t.activeTexture(t.TEXTURE0+e),this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.source),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)};var m=MinimalGLTFLoader.Sampler=function(e){this.magFilter=void 0!==e.magFilter?e.magFilter:null,this.minFilter=void 0!==e.minFilter?e.minFilter:null,this.wrapS=void 0!==e.wrapS?e.wrapS:10497,this.wrapT=void 0!==e.wrapT?e.wrapT:10497,this.sampler=null};m.prototype.createSampler=function(e){this.sampler=e.createSampler(),this.minFilter?e.samplerParameteri(this.sampler,e.TEXTURE_MIN_FILTER,this.minFilter):e.samplerParameteri(this.sampler,e.TEXTURE_MIN_FILTER,e.NEAREST_MIPMAP_LINEAR),this.magFilter?e.samplerParameteri(this.sampler,e.TEXTURE_MAG_FILTER,this.magFilter):e.samplerParameteri(this.sampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.sampler,e.TEXTURE_WRAP_S,this.wrapS),e.samplerParameteri(this.sampler,e.TEXTURE_WRAP_T,this.wrapT)};var c,d=(MinimalGLTFLoader.Material=function(e){},MinimalGLTFLoader.glTFModel=function(e){this.json=e,this.defaultScene=e.scene,this.version=Number(e.asset.version),e.accessors&&(this.accessors=new Array(e.accessors.length)),e.bufferViews&&(this.bufferViews=new Array(e.bufferViews.length)),e.scenes&&(this.scenes=new Array(e.scenes.length)),e.nodes&&(this.nodes=new Array(e.nodes.length)),e.meshes&&(this.meshes=new Array(e.meshes.length)),e.textures&&(this.textures=new Array(e.textures.length)),e.samplers&&(this.samplers=new Array(e.samplers.length)),e.images&&(this.images=new Array(e.images.length))}),T=MinimalGLTFLoader.glTFLoader=function(e){c=void 0!==e?e:null,this._init(),this.glTF=null};T.prototype._init=function(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null},T.prototype._getBufferViewData=function(e,t,s){var i=this.glTF.bufferViews[t];if(void 0===i){var r=e.bufferViews[t],n=this._buffers[r.buffer];if(n)console.log("dependent buffer data ready (instant), create bufferView "+t),this.glTF.bufferViews[t]=i=new o(r,n),s(i),this._checkComplete();else{this._pendingTasks++;var a=this._bufferTasks[r.buffer];a||(this._bufferTasks[r.buffer]=[],a=this._bufferTasks[r.buffer]);var h=this;a.push(function(e){h._finishedPendingTasks++,i=h.glTF.bufferViews[t],void 0===i?(console.log("create new BufferView Data for "+t),i=h.glTF.bufferViews[t]=new o(r,e)):console.log("dependent buffer data ready (queued), create bufferView "+t),s(i)})}}else console.log("use cached bufferView "+t),s(i)},T.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))},T.prototype._parseGLTF=function(e){var t,s,i,n=this;if(e.accessors)for(t=0,s=e.accessors.length;s>t;t++)i=e.accessors[t],void 0!==i.bufferView&&this._getBufferViewData(e,i.bufferView,function(){var s=e.accessors[t],i=t;return function(e){n.glTF.accessors[i]=new a(s,e)}}());if(e.textures)for(t=0,s=e.textures.length;s>t;t++)this.glTF.textures[t]=new f(e.textures[t]);if(e.samplers)for(t=0,s=e.samplers.length;s>t;t++)this.glTF.samplers[t]=new m(e.samplers[t]);if(e.scenes)for(var o=0,h=e.scenes.length;h>o;o++){var l=new r;this.glTF.scenes[o]=l;for(var u=e.scenes[o],c=u.nodes,d=c.length,T=0;d>T;++T){var g=c[T];l.nodes[T]=this._parseNode(e,g)}}this._parseDone=!0,this._checkComplete()},T.prototype._parseMesh=function(e,t){if(void 0!==this.glTF.meshes[t])return this.glTF.meshes[t];var s=new l;this.glTF.meshes[t]=s;for(var i,r=e.meshes[t],n=r.primitives,a=n.length,o=0;a>o;++o)i=n[o],s.primitives.push(new u(e,i));return s};var g=vec3.create(),p=quat.create(),b=vec3.create(),v=mat4.create();T.prototype._parseNode=function(e,t){if(void 0!==this.glTF.nodes[t])return this.glTF.nodes[t];var s=e.nodes[t],i=new h(t);this.glTF.nodes[t]=i;var r=i.matrix;if(s.hasOwnProperty("matrix"))for(var n=0;16>n;++n)r[n]=s.matrix[n];else s.translation?vec3.set(g,s.translation[0],s.translation[1],s.translation[2]):vec3.set(g,0,0,0),s.rotation?quat.set(p,s.rotation[0],s.rotation[1],s.rotation[2],s.rotation[3]):quat.set(p,0,0,0,1),s.scale?vec3.set(b,s.scale[0],s.scale[1],s.scale[2]):vec3.set(b,1,1,1),mat4.fromRotationTranslation(v,p,g),mat4.scale(r,v,b);void 0!==s.mesh&&(i.mesh=this._parseMesh(e,s.mesh));var a=s.children;if(a)for(var o=a.length,l=0;o>l;++l){var u=a[l];i.children[l]=this._parseNode(e,u)}return i},T.prototype.loadGLTF=function(r,n){this._init(),this.onload=n||function(e){console.log("glTF model loaded."),console.log(e)},this.baseUri=e(r);var a=this;t(r,function(e){var t=JSON.parse(e);a.glTF=new d(t);var r,n=function(e){if(a._buffers[r]=e,a._bufferLoaded++,a._bufferTasks[r]){var t,s;for(t=0,s=a._bufferTasks[r].length;s>t;++t)a._bufferTasks[r][t](e)}a._checkComplete()};if(t.buffers)for(r in t.buffers)a._bufferRequested++,s(a.baseUri+t.buffers[r].uri,n);var o,h=function(e,t){a._imageLoaded++,a.glTF.images[t]=e,a._checkComplete()};if(t.images)for(o in t.images)a._imageRequested++,i(a.baseUri+t.images[o].uri,o,h);a._parseGLTF(t)})},T.prototype._postprocess=function(){function e(e,t){var s=c[e.nodeID];null!==t?mat4.mul(s,c[t.nodeID],e.matrix):mat4.copy(s,e.matrix),e.mesh&&(h=e.mesh,h.boundingBox&&(vec3.transformMat4(f,h.boundingBox.min,s),vec3.transformMat4(m,h.boundingBox.max,s),vec3.min(a.boundingBox.min,a.boundingBox.min,f),vec3.min(a.boundingBox.min,a.boundingBox.min,m),vec3.max(a.boundingBox.max,a.boundingBox.max,m),vec3.max(a.boundingBox.max,a.boundingBox.max,f)))}console.log("finish loading all assets, do a second pass postprocess");var t,s,i,r,a,o,h,l,u;for(t=0,s=this.glTF.meshes.length;s>t;t++){for(h=this.glTF.meshes[t],h.boundingBox=new n(vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),i=0,r=h.primitives.length;r>i;i++)l=h.primitives[i],void 0!==l.attributes.POSITION&&(u=this.glTF.accessors[l.attributes.POSITION],u.max&&"VEC3"===u.type&&(l.boundingBox=new n(vec3.fromValues(u.min[0],u.min[1],u.min[2]),vec3.fromValues(u.max[0],u.max[1],u.max[2])),l.boundingBox.calculateTransform(),h.boundingBox.updateBoundingBox(l.boundingBox)));h.boundingBox.calculateTransform()}var f=vec3.create(),m=vec3.create(),c=new Array(this.glTF.nodes.length);for(t=0,s=c.length;s>t;t++)c[t]=mat4.create();for(t=0,s=this.glTF.scenes.length;s>t;t++){for(a=this.glTF.scenes[t],a.boundingBox=new n(vec3.fromValues(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),vec3.fromValues(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)),i=0,r=a.nodes.length;r>i;i++)o=a.nodes[i],o.traverse(null,e);a.boundingBox.calculateTransform()}if(this.glTF.textures)for(t=0,s=this.glTF.textures.length;s>t;t++)this.glTF.samplers&&null!==this.glTF.textures[t].sampler&&(this.glTF.textures[t].sampler=this.glTF.samplers[this.glTF.textures[t].sampler]),this.glTF.images&&null!==this.glTF.textures[t].source&&(this.glTF.textures[t].source=this.glTF.images[this.glTF.textures[t].source])};var _={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};MinimalGLTFLoader.Attributes=["POSITION","NORMAL","TEXCOORD","COLOR","JOINT","WEIGHT"]}();