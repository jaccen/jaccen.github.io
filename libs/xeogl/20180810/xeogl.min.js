/*
 * xeogl V0.8
 *
 * A WebGL-based 3D visualization engine from xeoLabs
 * http://xeogl.org/
 *
 * Built on 2018-08-10
 *
 * MIT License
 * Copyright 2018, Lindsay Kay
 * http://xeolabs.com/
 *
 */

!function(){"use strict";var a=function(){var a=[],b=0,c=[],d=0;this.length=0,this.shift=function(){if(d>=b){var e=a;if(e.length=0,a=c,c=e,d=0,!(b=a.length))return}var f=a[d];return d<0?delete a[d++]:a[d++]=void 0,this.length--,f},this.push=function(a){return this.length++,c.push(a),this},this.unshift=function(b){return a[--d]=b,this.length++,this}},b=function(){this._debug={forceHighShaderPrecision:!1},this.version=null,this.WEBGL_INFO=function(){var a={WEBGL:!1},b=document.createElement("canvas");if(!b)return a;var c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return a.WEBGL=!!c,a.WEBGL?(a.ANTIALIAS=c.getContextAttributes().antialias,c.getShaderPrecisionFormat?c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?a.FS_MAX_FLOAT_PRECISION="mediump":a.FS_MAX_FLOAT_PRECISION="lowp":a.FS_MAX_FLOAT_PRECISION="mediump",a.DEPTH_BUFFER_BITS=c.getParameter(c.DEPTH_BITS),a.MAX_TEXTURE_SIZE=c.getParameter(c.MAX_TEXTURE_SIZE),a.MAX_CUBE_MAP_SIZE=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),a.MAX_RENDERBUFFER_SIZE=c.getParameter(c.MAX_RENDERBUFFER_SIZE),a.MAX_TEXTURE_UNITS=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),a.MAX_TEXTURE_IMAGE_UNITS=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS),a.MAX_VERTEX_ATTRIBS=c.getParameter(c.MAX_VERTEX_ATTRIBS),a.MAX_VERTEX_UNIFORM_VECTORS=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),a.MAX_FRAGMENT_UNIFORM_VECTORS=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),a.MAX_VARYING_VECTORS=c.getParameter(c.MAX_VARYING_VECTORS),a.SUPPORTED_EXTENSIONS={},c.getSupportedExtensions().forEach(function(b){a.SUPPORTED_EXTENSIONS[b]=!0}),a):a}(),this.stats={build:{version:b.version},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}},this._sceneIDMap=null,this._scene=null,this.scenes={},this._scenesRenderInfo={},this._superTypes={},this._taskQueue=new a;var c=this;!function(){function a(){g=Date.now();var a=c._runScheduledTasks(g+k),b=c._taskQueue.length;c.stats.frame.tasksRun=a,c.stats.frame.tasksScheduled=b,c.stats.frame.tasksBudget=k,j.time=g;for(h in c.scenes)c.scenes.hasOwnProperty(h)&&(i=c.scenes[h],j.sceneId=h,j.startTime=i.startTime,j.deltaTime=null!=j.prevTime?j.time-j.prevTime:0,i.fire("tick",j,!0));j.prevTime=g}function b(){var a,b,d,e=c.scenes,f=c._scenesRenderInfo;for(h in e)e.hasOwnProperty(h)&&(a=e[h],b=f[h],d=a.ticksPerRender,b.ticksPerRender!==d&&(b.ticksPerRender=d,b.renderCountdown=d),0==--b.renderCountdown&&(a.render(!1),b.renderCountdown=d))}var d,e,f,g,h,i,j={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},k=10,l=0,m=[],n=30,o=0,p=function(){d=Date.now(),l>0&&(e=d-l,f=1e3/e,o+=f,m.push(f),m.length>=n&&(o-=m.shift()),c.stats.frame.fps=Math.round(o/m.length)),a(),b(),l=d,window.requestAnimationFrame(p)};window.requestAnimationFrame(p)}()};b.prototype={constructor:b,get scene(){return this._scene||(this._scene=new window.xeogl.Scene({id:"default.scene"}))},set scene(a){this._scene=a},_addScene:function(a){if(this._sceneIDMap=this._sceneIDMap||new window.xeogl.utils.Map,a.id){if(this.scenes[a.id])return void console.error("[ERROR] Scene "+b._inQuotes(a.id)+" already exists")}else a.id=this._sceneIDMap.addItem({});this.scenes[a.id]=a;var c=a.ticksPerRender;this._scenesRenderInfo[a.id]={ticksPerRender:c,renderCountdown:c},this.stats.components.scenes++;var d=this;a.on("destroyed",function(){d._sceneIDMap.removeItem(a.id),delete d.scenes[a.id],delete d._scenesRenderInfo[a.id],d.stats.components.scenes--})},scheduleTask:function(a,b){this._taskQueue.push(a),this._taskQueue.push(b)},deferTask:function(a,b){b?a.call(b):a()},_runScheduledTasks:function(a){for(var b,c,d=(new Date).getTime(),e=this._taskQueue,f=0;e.length>0&&d<a;)b=e.shift(),c=e.shift(),c?b.call(c):b(),d=(new Date).getTime(),f++;return f},clear:function(){var a;for(var b in this.scenes)this.scenes.hasOwnProperty(b)&&(a=this.scenes[b],"default.scene"===b?a.clear():a.destroy());this.scenes={}},_isArray:function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},_isString:function(a){return"string"==typeof a||a instanceof String},_isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},_isID:function(a){return b.prototype._isString(a)||b.prototype._isNumeric(a)},_isSameComponent:function(a,c){return!(!a||!c)&&(b.prototype._isNumeric(a)||b.prototype._isString(a)?""+a:a.id)===(b.prototype._isNumeric(c)||b.prototype._isString(c)?""+c:c.id)},_isFunction:function(a){return"function"==typeof a},_isObject:function(){var a={}.constructor;return function(b){return!!b&&b.constructor===a}}(),_isComponentType:function(a,b){if(b=b||"xeogl.Component",a===b)return!0;var c=this._superTypes[a];if(!c)return!1;for(var d=c.length-1;d>=0;d--)if(c[d]===b)return!0;return!1},_copy:function(a){return this._apply(a,{})},_apply:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_apply2:function(a,b){for(var c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&null!==a[c]&&(b[c]=a[c]);return b},_applyIf:function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0!==b[c]&&null!==b[c]||(b[c]=a[c]));return b},_isEmptyObject:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},_inQuotes:function(a){return this._isNumeric(a)?""+a:"'"+a+"'"},_concat:function(a,b){var c=new a.constructor(a.length+b.length);return c.set(a),c.set(b,a.length),c}},window.xeogl=window.xeogl=new b}();var Canvas2Image=function(){var a=document.createElement("canvas"),b=String.fromCharCode,c="image/octet-stream",d=!1;if(!a.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var e=!!a.getContext("2d").getImageData,f=!!a.toDataURL,g=!!window.btoa,h=function(a){var b=parseInt(a.width),c=parseInt(a.height);return a.getContext("2d").getImageData(0,0,b,c)},i=function(a){var c,d,e="";if("string"==typeof a)e=a;else for(d=a,c=0;c<d.length;c++)e+=b(d[c]);return btoa(e)},j=function(a){var c="",d=a.width,e=a.height;c+="BM";var f=d*e*4+54;c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),f=Math.floor(f/256),c+=b(f%256),c+=b(0,0,0,0,54,0,0,0),c+=b(40,0,0,0);var g=d;c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256),g=Math.floor(g/256),c+=b(g%256);var h=e;c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),h=Math.floor(h/256),c+=b(h%256),c+=b(1,0,32,0),c+=b(0,0,0,0);var j=d*e*4;c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),j=Math.floor(j/256),c+=b(j%256),c+=b(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var k,l,m,n,o=a.data,p="",q=e;do{for(m=d*(q-1)*4,n="",k=0;k<d;k++)l=4*k,n+=b(o[m+l+2],o[m+l+1],o[m+l],o[m+l+3]);p+=n}while(--q);return i(c+p)},k=function(a){window.open(a)||(document.location.href=a)},l=function(a,b){return"data:"+b+";base64,"+a},m=function(a){var b=document.createElement("img");return b.src=a,b},n=function(a,b,c){if(b&&c){var d=document.createElement("canvas");d.width=b,d.height=c,d.style.width=b+"px",d.style.height=c+"px";return d.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b,b),d}return a};return{saveAsPNG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/png",j=h.toDataURL(i);return b?m(j):(k(d?j.replace(i,c):j),!0)},saveAsJPEG:function(a,b,e,g){if(!f)return!1;var h=n(a,e,g),i="image/jpeg",j=h.toDataURL(i);return 5==j.indexOf(i)&&(b?m(j):(k(d?j.replace(i,c):j),!0))},saveAsBMP:function(a,b,c,d){if(!(f&&e&&g))return!1;var i=n(a,c,d),o="image/bmp",p=h(i),q=j(p);return b?m(l(q,o)):(k(l(q,o)),!0)}}}();!function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(d){function e(){!a&&this.__init&&this.__init.apply(this,arguments)}var f=this.prototype;a=!0;var g=new this;a=!1;for(var h in d)if("_props"!==h){var i=!!f[h],j="function"==typeof d[h],k="function"==typeof f[h];b.test(d[h]);if(i){if(j&&!k)throw"Can't override super class property with function: '"+h+"'";if(!j&&k)throw"Can't override super class function with property: '"+h+"'"}g[h]=j&&i?function(a,b){return function(){var c=this._super;this._super=f[a];var d=b.apply(this,arguments);return this._super=c,d}}(h,d[h]):d[h]}else{var l,m=d[h];for(var n in m)if(l=m[n],n.indexOf(",")>=0)for(var o=n.split(","),p=0,q=o.length;p<q;p++){var r=o[p].trim();l.set||function(){var a=r;l.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),l.enumerable=!0,Object.defineProperty(g,r,l)}else l.set||function(){var a=n;l.set=function(){this.warn("Property '"+a+"' is read-only, ignoring assignment")}}(),l.enumerable=!0,Object.defineProperty(g,n,l)}return g.superTypes=f.superTypes?f.superTypes.concat(f.type):[],d.type?xeogl._superTypes[d.type]=g.superTypes:d.type=f.type+"_"+c(),e.prototype=g,e.prototype.constructor=e,e.extend=arguments.callee,window[d.type]=e,e};var c=function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;e<36;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(d<=2&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}()}(),xeogl.utils=xeogl.utils||{},xeogl.utils.Map=function(a,b){this.items=a||[],b=b||0;var c=b+1;this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(a=arguments[0]||{};;){var d=c++;if(!this.items[d])return this.items[d]=a,d}},this.removeItem=function(a){var b=this.items[a];return delete this.items[a],b}},function(){"use strict";var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(4),d=!1,e=[],f=0,g=xeogl.math={MAX_DOUBLE:Number.MAX_VALUE,MIN_DOUBLE:Number.MIN_VALUE,DEGTORAD:.0174532925,RADTODEG:57.295779513,openCache:function(){d=!0,f=0},cacheVec3:function(a){return a||(d?e[f++]||(e[f-1]=new Float32Array(3)):new Float32Array(3))},cacheVec4:function(a){return a||(d?e[vec4CacheLen++]||(e[vec4CacheLen-1]=new Float32Array(4)):new Float32Array(4))},closeCache:function(){d=!1},vec2:function(a){return new Float32Array(a||2)},vec3:function(a){return new Float32Array(a||3)},vec4:function(a){return new Float32Array(a||4)},mat3:function(a){return new Float32Array(a||9)},mat3ToMat4:function(a,b){return b=b||new Float32Array(16),b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=0,b[4]=a[3],b[5]=a[4],b[6]=a[5],b[7]=0,b[8]=a[6],b[9]=a[7],b[10]=a[8],b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},mat4:function(a){return new Float32Array(a||16)},mat4ToMat3:function(a,b){},createUUID:function(){for(var a=[],b=0;b<256;b++)a[b]=(b<16?"0":"")+b.toString(16);return function(){var b=4294967295*Math.random()|0,c=4294967295*Math.random()|0,d=4294967295*Math.random()|0,e=4294967295*Math.random()|0;return a[255&b]+a[b>>8&255]+a[b>>16&255]+a[b>>24&255]+"-"+a[255&c]+a[c>>8&255]+"-"+a[c>>16&15|64]+a[c>>24&255]+"-"+a[63&d|128]+a[d>>8&255]+"-"+a[d>>16&255]+a[d>>24&255]+a[255&e]+a[e>>8&255]+a[e>>16&255]+a[e>>24&255]}}(),clamp:function(a,b,c){return Math.max(b,Math.min(c,a))},fmod:function(a,b){if(a<b)return console.error("xeogl.math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;b<=a;)a-=b;return a},negateVec4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},addVec4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},addVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},addVec3:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},addVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},subVec4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},subVec3:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},subVec2:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},subVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},subScalarVec4:function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},mulVec4:function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},mulVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},mulVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},mulVec2Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},divVec3:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},divVec4:function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},divScalarVec3:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},divVec3Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},divVec4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},divScalarVec4:function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},dotVec4:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},cross3Vec4:function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},cross3Vec3:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},sqLenVec4:function(a){return g.dotVec4(a,a)},lenVec4:function(a){return Math.sqrt(g.sqLenVec4(a))},dotVec3:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},dotVec2:function(a,b){return a[0]*b[0]+a[1]*b[1]},sqLenVec3:function(a){return g.dotVec3(a,a)},sqLenVec2:function(a){return g.dotVec2(a,a)},lenVec3:function(a){return Math.sqrt(g.sqLenVec3(a))},distVec3:function(){var a=new Float32Array(3);return function(b,c){return g.lenVec3(g.subVec3(b,c,a))}}(),lenVec2:function(a){return Math.sqrt(g.sqLenVec2(a))},distVec2:function(){var a=new Float32Array(2);return function(b,c){return g.lenVec2(g.subVec2(b,c,a))}}(),rcpVec3:function(a,b){return g.divScalarVec3(1,a,b)},normalizeVec4:function(a,b){var c=1/g.lenVec4(a);return g.mulVec4Scalar(a,c,b)},normalizeVec3:function(a,b){var c=1/g.lenVec3(a);return g.mulVec3Scalar(a,c,b)},normalizeVec2:function(a,b){var c=1/g.lenVec2(a);return g.mulVec2Scalar(a,c,b)},angleVec3:function(a,b){var c=xeogl.math.dotVec3(a,b)/Math.sqrt(xeogl.math.sqLenVec3(a)*xeogl.math.sqLenVec3(b));return c=c<-1?-1:c>1?1:c,Math.acos(c)},vec3FromMat4Scale:function(){var a=new Float32Array(3);return function(b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],c[0]=g.lenVec3(a),a[0]=b[4],a[1]=b[5],a[2]=b[6],c[1]=g.lenVec3(a),a[0]=b[8],a[1]=b[9],a[2]=b[10],c[2]=g.lenVec3(a),c}}(),vecToArray:function(){function a(a){return Math.round(1e5*a)/1e5}return function(b){b=Array.prototype.slice.call(b);for(var c=0,d=b.length;c<d;c++)b[c]=a(b[c]);return b}}(),dupMat4:function(a){return a.slice(0,16)},mat4To3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},m4s:function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},setMat4ToZeroes:function(){return g.m4s(0)},setMat4ToOnes:function(){return g.m4s(1)},diagonalMat4v:function(a){return new Float32Array([a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]])},diagonalMat4c:function(a,b,c,d){return g.diagonalMat4v([a,b,c,d])},diagonalMat4s:function(a){return g.diagonalMat4c(a,a,a,a)},identityMat4:function(a){return a=a||new Float32Array(16),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},identityMat3:function(a){return a=a||new Float32Array(9),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},isIdentityMat4:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},negateMat4:function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},addMat4:function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},addMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},addScalarMat4:function(a,b,c){return g.addMat4Scalar(b,a,c)},subMat4:function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},subMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},subScalarMat4:function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},mulMat4:function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},mulMat3:function(a,b,c){c||(c=new Float32Array(9));var d=a[0],e=a[3],f=a[6],g=a[1],h=a[4],i=a[7],j=a[2],k=a[5],l=a[8],m=b[0],n=b[3],o=b[6],p=b[1],q=b[4],r=b[7],s=b[2],t=b[5],u=b[8];return c[0]=d*m+e*p+f*s,c[3]=d*n+e*q+f*t,c[6]=d*o+e*r+f*u,c[1]=g*m+h*p+i*s,c[4]=g*n+h*q+i*t,c[7]=g*o+h*r+i*u,c[2]=j*m+k*p+l*s,c[5]=j*n+k*q+l*t,c[8]=j*o+k*r+l*u,c},mulMat4Scalar:function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},mulMat4v4:function(a,b,c){c=c||g.vec4();var d=b[0],e=b[1],f=b[2],h=b[3];return c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*h,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*h,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*h,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*h,c},transposeMat4:function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a===b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},transposeMat3:function(a,b){if(b===a){var c=a[1],d=a[2],e=a[5];b[1]=a[3],b[2]=a[6],b[3]=c,b[5]=a[7],b[6]=d,b[7]=e}else b[0]=a[0],b[1]=a[3],b[2]=a[6],b[3]=a[1],b[4]=a[4],b[5]=a[7],b[6]=a[2],b[7]=a[5],b[8]=a[8];return b},determinantMat4:function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},inverseMat4:function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},traceMat4:function(a){return a[0]+a[5]+a[10]+a[15]},translationMat4v:function(a,b){var c=b||g.identityMat4();return c[12]=a[0],c[13]=a[1],c[14]=a[2],c},translationMat3v:function(a,b){var c=b||g.identityMat3();return c[6]=a[0],c[7]=a[1],c},translationMat4c:function(){var a=new Float32Array(3);return function(b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,g.translationMat4v(a,e)}}(),translationMat4s:function(a,b){return g.translationMat4c(a,a,a,b)},translateMat4v:function(a,b){return g.translateMat4c(a[0],a[1],a[2],b)},OLDtranslateMat4c:function(a,b,c,d){var e=d[12];d[0]+=e*a,d[4]+=e*b,d[8]+=e*c;var f=d[13];d[1]+=f*a,d[5]+=f*b,d[9]+=f*c;var g=d[14];d[2]+=g*a,d[6]+=g*b,d[10]+=g*c;var h=d[15];return d[3]+=h*a,d[7]+=h*b,d[11]+=h*c,d},translateMat4c:function(a,b,c,d){var e=d[3];d[0]+=e*a,d[1]+=e*b,d[2]+=e*c;var f=d[7];d[4]+=f*a,d[5]+=f*b,d[6]+=f*c;var g=d[11];d[8]+=g*a,d[9]+=g*b,d[10]+=g*c;var h=d[15];return d[12]+=h*a,d[13]+=h*b,d[14]+=h*c,d},rotationMat4v:function(a,b,c){var d,e,f,h,i,j,k=g.normalizeVec4([b[0],b[1],b[2],0],[]),l=Math.sin(a),m=Math.cos(a),n=1-m,o=k[0],p=k[1],q=k[2];return d=o*p,e=p*q,f=q*o,h=o*l,i=p*l,j=q*l,c=c||g.mat4(),c[0]=n*o*o+m,c[1]=n*d+j,c[2]=n*f-i,c[3]=0,c[4]=n*d-j,c[5]=n*p*p+m,c[6]=n*e+h,c[7]=0,c[8]=n*f+i,c[9]=n*e-h,c[10]=n*q*q+m,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,c},rotationMat4c:function(a,b,c,d,e){return g.rotationMat4v(a,[b,c,d],e)},scalingMat4v:function(a,b){return b=b||g.identityMat4(),b[0]=a[0],b[5]=a[1],b[10]=a[2],b},scalingMat3v:function(a,b){return b=b||g.identityMat3(),b[0]=a[0],b[4]=a[1],b},scalingMat4c:function(){var a=new Float32Array(3);return function(b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,g.scalingMat4v(a,e)}}(),scaleMat4c:function(a,b,c,d){return d[0]*=a,d[4]*=b,d[8]*=c,d[1]*=a,d[5]*=b,d[9]*=c,d[2]*=a,d[6]*=b,d[10]*=c,d[3]*=a,d[7]*=b,d[11]*=c,d},scaleMat4v:function(a,b){var c=a[0],d=a[1],e=a[2];return b[0]*=c,b[4]*=d,b[8]*=e,b[1]*=c,b[5]*=d,b[9]*=e,b[2]*=c,b[6]*=d,b[10]*=e,b[3]*=c,b[7]*=d,b[11]*=e,b},scalingMat4s:function(a){return g.scalingMat4c(a,a,a)},rotationTranslationMat4:function(a,b,c){c=c||g.mat4();var d=a[0],e=a[1],f=a[2],h=a[3],i=d+d,j=e+e,k=f+f,l=d*i,m=d*j,n=d*k,o=e*j,p=e*k,q=f*k,r=h*i,s=h*j,t=h*k;return c[0]=1-(o+q),c[1]=m+t,c[2]=n-s,c[3]=0,c[4]=m-t,c[5]=1-(l+q),c[6]=p+r,c[7]=0,c[8]=n+s,c[9]=p-r,c[10]=1-(l+o),c[11]=0,c[12]=b[0],c[13]=b[1],c[14]=b[2],c[15]=1,c},mat4ToEuler:function(a,b,c){c=c||g.vec4();var d=g.clamp,e=a[0],f=a[4],h=a[8],i=a[1],j=a[5],k=a[9],l=a[2],m=a[6],n=a[10];return"XYZ"===b?(c[1]=Math.asin(d(h,-1,1)),Math.abs(h)<.99999?(c[0]=Math.atan2(-k,n),c[2]=Math.atan2(-f,e)):(c[0]=Math.atan2(m,j),c[2]=0)):"YXZ"===b?(c[0]=Math.asin(-d(k,-1,1)),Math.abs(k)<.99999?(c[1]=Math.atan2(h,n),c[2]=Math.atan2(i,j)):(c[1]=Math.atan2(-l,e),c[2]=0)):"ZXY"===b?(c[0]=Math.asin(d(m,-1,1)),Math.abs(m)<.99999?(c[1]=Math.atan2(-l,n),c[2]=Math.atan2(-f,j)):(c[1]=0,c[2]=Math.atan2(i,e))):"ZYX"===b?(c[1]=Math.asin(-d(l,-1,1)),Math.abs(l)<.99999?(c[0]=Math.atan2(m,n),c[2]=Math.atan2(i,e)):(c[0]=0,c[2]=Math.atan2(-f,j))):"YZX"===b?(c[2]=Math.asin(d(i,-1,1)),Math.abs(i)<.99999?(c[0]=Math.atan2(-k,j),c[1]=Math.atan2(-l,e)):(c[0]=0,c[1]=Math.atan2(h,n))):"XZY"===b&&(c[2]=Math.asin(-d(f,-1,1)),Math.abs(f)<.99999?(c[0]=Math.atan2(m,j),c[1]=Math.atan2(h,e)):(c[0]=Math.atan2(-k,n),c[1]=0)),c},composeMat4:function(a,b,c,d){return d=d||g.mat4(),g.quaternionToRotationMat4(b,d),g.scaleMat4v(c,d),g.translateMat4v(a,d),d},decomposeMat4:function(){var a=new Float32Array(3),b=new Float32Array(16);return function(c,d,e,f){a[0]=c[0],a[1]=c[1],a[2]=c[2];var h=g.lenVec3(a);a[0]=c[4],a[1]=c[5],a[2]=c[6];var i=g.lenVec3(a);a[8]=c[8],a[9]=c[9],a[10]=c[10];var j=g.lenVec3(a);g.determinantMat4(c)<0&&(h=-h),d[0]=c[12],d[1]=c[13],d[2]=c[14],b.set(c);var k=1/h,l=1/i,m=1/j;return b[0]*=k,b[1]*=k,b[2]*=k,b[4]*=l,b[5]*=l,b[6]*=l,b[8]*=m,b[9]*=m,b[10]*=m,g.mat4ToQuaternion(b,e),f[0]=h,f[1]=i,f[2]=j,this}}(),lookAtMat4v:function(a,b,c,d){d||(d=g.mat4());var e=a[0],f=a[1],h=a[2],i=c[0],j=c[1],k=c[2],l=b[0],m=b[1],n=b[2];if(e===l&&f===m&&h===n)return g.identityMat4();var o,p,q,r,s,t,u,v,w,x;return o=e-l,p=f-m,q=h-n,x=1/Math.sqrt(o*o+p*p+q*q),o*=x,p*=x,q*=x,r=j*q-k*p,s=k*o-i*q,t=i*p-j*o,x=Math.sqrt(r*r+s*s+t*t),x?(x=1/x,r*=x,s*=x,t*=x):(r=0,s=0,t=0),u=p*t-q*s,v=q*r-o*t,w=o*s-p*r,x=Math.sqrt(u*u+v*v+w*w),x?(x=1/x,u*=x,v*=x,w*=x):(u=0,v=0,w=0),d[0]=r,d[1]=u,d[2]=o,d[3]=0,d[4]=s,d[5]=v,d[6]=p,d[7]=0,d[8]=t,d[9]=w,d[10]=q,d[11]=0,d[12]=-(r*e+s*f+t*h),d[13]=-(u*e+v*f+w*h),d[14]=-(o*e+p*f+q*h),d[15]=1,d},lookAtMat4c:function(a,b,c,d,e,f,h,i,j){return g.lookAtMat4v([a,b,c],[d,e,f],[h,i,j],[])},orthoMat4c:function(a,b,c,d,e,f,h){h||(h=g.mat4());var i=b-a,j=d-c,k=f-e;return h[0]=2/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/j,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=-2/k,h[11]=0,h[12]=-(a+b)/i,h[13]=-(d+c)/j,h[14]=-(f+e)/k,h[15]=1,h},frustumMat4v:function(c,d,e){e||(e=g.mat4());var f=[c[0],c[1],c[2],0],h=[d[0],d[1],d[2],0];g.addVec4(h,f,a),g.subVec4(h,f,b);var i=2*f[2],j=b[0],k=b[1],l=b[2];return e[0]=i/j,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i/k,e[6]=0,e[7]=0,e[8]=a[0]/j,e[9]=a[1]/k,e[10]=-a[2]/l,e[11]=-1,e[12]=0,e[13]=0,e[14]=-i*h[2]/l,e[15]=0,e},frustumMat4:function(a,b,c,d,e,f,h){h||(h=g.mat4());var i=b-a,j=d-c,k=f-e;return h[0]=2*e/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*e/j,h[6]=0,h[7]=0,h[8]=(b+a)/i,h[9]=(d+c)/j,h[10]=-(f+e)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-f*e*2/k,h[15]=0,h},perspectiveMat4:function(a,b,c,d,e){var f=[],h=[];return f[2]=c,h[2]=d,h[1]=f[2]*Math.tan(a/2),f[1]=-h[1],h[0]=h[1]*b,f[0]=-h[0],g.frustumMat4v(f,h,e)},transformPoint3:function(a,b,c){return c=c||g.vec3(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14],c},transformPoint4:function(a,b,c){return c=c||g.vec4(),c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3],c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3],c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3],c[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3],c},transformPoints3:function(a,b,c){for(var d,e,f,g,h,i=c||[],j=b.length,k=a[0],l=a[1],m=a[2],n=a[3],o=a[4],p=a[5],q=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11],w=a[12],x=a[13],y=a[14],z=a[15],A=0;A<j;++A)g=b[A],d=g[0],e=g[1],f=g[2],h=i[A]||(i[A]=[0,0,0]),h[0]=k*d+o*e+s*f+w,h[1]=l*d+p*e+t*f+x,h[2]=m*d+q*e+u*f+y,h[3]=n*d+r*e+v*f+z;return i.length=j,i},transformPositions3:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=3)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformPositions4:function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},transformVec3:function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||this.vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},transformVec4:function(a,b,c){var d=b[0],e=b[1],f=b[2],h=b[3];return c=c||g.vec4(),c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*h,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*h,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*h,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*h,c},rotateVec3X:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0],f[1]=e[1]*Math.cos(c)-e[2]*Math.sin(c),f[2]=e[1]*Math.sin(c)+e[2]*Math.cos(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Y:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[2]*Math.sin(c)+e[0]*Math.cos(c),f[1]=e[1],f[2]=e[2]*Math.cos(c)-e[0]*Math.sin(c),d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},rotateVec3Z:function(a,b,c,d){var e=[],f=[];return e[0]=a[0]-b[0],e[1]=a[1]-b[1],e[2]=a[2]-b[2],f[0]=e[0]*Math.cos(c)-e[1]*Math.sin(c),f[1]=e[0]*Math.sin(c)+e[1]*Math.cos(c),f[2]=e[2],d[0]=f[0]+b[0],d[1]=f[1]+b[1],d[2]=f[2]+b[2],d},projectVec4:function(a,b){var c=1/a[3];return b=b||g.vec2(),b[0]=v[0]*c,b[1]=v[1]*c,b},unprojectVec3:function(){var a=new Float32Array(16),b=new Float32Array(16),c=new Float32Array(16);return function(d,e,f,g){return this.transformVec3(this.mulMat4(this.inverseMat4(e,a),this.inverseMat4(f,b),c),d,g)}}(),lerpVec3:function(a,b,c,d,e,f){var h=f||g.vec3(),i=(a-b)/(c-b);return h[0]=d[0]+i*(e[0]-d[0]),h[1]=d[1]+i*(e[1]-d[1]),h[2]=d[2]+i*(e[2]-d[2]),h},flatten:function(a){var b,c,d,e,f,g=[];for(b=0,c=a.length;b<c;b++)for(f=a[b],d=0,e=f.length;d<e;d++)g.push(f[d]);return g},identityQuaternion:function(a){return a=a||g.vec4(),a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},eulerToQuaternion:function(a,b,c){c=c||g.vec4();var d=a[0]*g.DEGTORAD/2,e=a[1]*g.DEGTORAD/2,f=a[2]*g.DEGTORAD/2,h=Math.cos(d),i=Math.cos(e),j=Math.cos(f),k=Math.sin(d),l=Math.sin(e),m=Math.sin(f);return"XYZ"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j-k*l*m):"YXZ"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j+k*l*m):"ZXY"===b?(c[0]=k*i*j-h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j-k*l*m):"ZYX"===b?(c[0]=k*i*j-h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j+k*l*m):"YZX"===b?(c[0]=k*i*j+h*l*m,c[1]=h*l*j+k*i*m,c[2]=h*i*m-k*l*j,c[3]=h*i*j-k*l*m):"XZY"===b&&(c[0]=k*i*j-h*l*m,c[1]=h*l*j-k*i*m,c[2]=h*i*m+k*l*j,c[3]=h*i*j+k*l*m),c},mat4ToQuaternion:function(a,b){b=b||g.vec4();var c,d=a[0],e=a[4],f=a[8],h=a[1],i=a[5],j=a[9],k=a[2],l=a[6],m=a[10],n=d+i+m;return n>0?(c=.5/Math.sqrt(n+1),b[3]=.25/c,b[0]=(l-j)*c,b[1]=(f-k)*c,b[2]=(h-e)*c):d>i&&d>m?(c=2*Math.sqrt(1+d-i-m),b[3]=(l-j)/c,b[0]=.25*c,b[1]=(e+h)/c,b[2]=(f+k)/c):i>m?(c=2*Math.sqrt(1+i-d-m),b[3]=(f-k)/c,b[0]=(e+h)/c,b[1]=.25*c,b[2]=(j+l)/c):(c=2*Math.sqrt(1+m-d-i),b[3]=(h-e)/c,b[0]=(f+k)/c,b[1]=(j+l)/c,b[2]=.25*c),b},vec3PairToQuaternion:function(a,b,c){c=c||g.vec4();var d=Math.sqrt(g.dotVec3(a,a)*g.dotVec3(b,b)),e=d+g.dotVec3(a,b);return e<1e-8*d?(e=0,Math.abs(a[0])>Math.abs(a[2])?(c[0]=-a[1],c[1]=a[0],c[2]=0):(c[0]=0,c[1]=-a[2],c[2]=a[1])):g.cross3Vec3(a,b,c),c[3]=e,g.normalizeQuaternion(c)},angleAxisToQuaternion:function(a,b){b=b||g.vec4();var c=a[3]/2,d=Math.sin(c);return b[0]=d*a[0],b[1]=d*a[1],b[2]=d*a[2],b[3]=Math.cos(c),b},quaternionToEuler:function(){var a=new Float32Array(16);return function(b,c,d){return d=d||g.vec3(),g.quaternionToRotationMat4(b,a),g.mat4ToEuler(a,c,d),d}}(),mulQuaternions:function(a,b,c){c=c||g.vec4();var d=a[0],e=a[1],f=a[2],h=a[3],i=b[0],j=b[1],k=b[2],l=b[3];return c[0]=h*i+d*l+e*k-f*j,c[1]=h*j+e*l+f*i-d*k,c[2]=h*k+f*l+d*j-e*i,c[3]=h*l-d*i-e*j-f*k,c},vec3ApplyQuaternion:function(a,b,c){c=c||g.vec3();var d=b[0],e=b[1],f=b[2],h=a[0],i=a[1],j=a[2],k=a[3],l=k*d+i*f-j*e,m=k*e+j*d-h*f,n=k*f+h*e-i*d,o=-h*d-i*e-j*f;return c[0]=l*k+o*-h+m*-j-n*-i,c[1]=m*k+o*-i+n*-h-l*-j,c[2]=n*k+o*-j+l*-i-m*-h,c},quaternionToMat4:function(a,b){b=g.identityMat4(b);var c=a[0],d=a[1],e=a[2],f=a[3],h=2*c,i=2*d,j=2*e,k=h*f,l=i*f,m=j*f,n=h*c,o=i*c,p=j*c,q=i*d,r=j*d,s=j*e;return b[0]=1-(q+s),b[1]=o+m,b[2]=p-l,b[4]=o-m,b[5]=1-(n+s),b[6]=r+k,b[8]=p+l,b[9]=r-k,b[10]=1-(n+q),b},quaternionToRotationMat4:function(a,b){
var c=a[0],d=a[1],e=a[2],f=a[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return b[0]=1-(m+o),b[4]=k-r,b[8]=l+q,b[1]=k+r,b[5]=1-(j+o),b[9]=n-p,b[2]=l-q,b[6]=n+p,b[10]=1-(j+m),b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},normalizeQuaternion:function(a,b){b=b||a;var c=g.lenVec4([a[0],a[1],a[2],a[3]]);return b[0]=a[0]/c,b[1]=a[1]/c,b[2]=a[2]/c,b[3]=a[3]/c,b},conjugateQuaternion:function(a,b){return b=b||a,b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b},inverseQuaternion:function(a,b){return g.normalizeQuaternion(g.conjugateQuaternion(a,b))},quaternionToAngleAxis:function(a,b){b=b||g.vec4(),a=g.normalizeQuaternion(a,c);var d=a[3],e=2*Math.acos(d),f=Math.sqrt(1-d*d);return f<.001?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=a[0]/f,b[1]=a[1]/f,b[2]=a[2]/f),b[3]=e,b},decompressPosition:function(a,b,c){c[0]=a[0]*b[0]+b[12],c[1]=a[1]*b[5]+b[13],c[2]=a[2]*b[10]+b[14]},decompressPositions:function(a,b,c){c=c||new Float32Array(a.length);for(var d=0,e=a.length;d<e;d+=3)c[d+0]=a[d+0]*b[0]+b[12],c[d+1]=a[d+1]*b[5]+b[13],c[d+2]=a[d+2]*b[10]+b[14];return c},decompressUV:function(a,b,c){c[0]=a[0]*b[0]+b[6],c[1]=a[1]*b[4]+b[7]},decompressUVs:function(a,b,c){c=c||new Float32Array(a.length);for(var d=0,e=a.length;d<e;d+=3)c[d+0]=a[d+0]*b[0]+b[6],c[d+1]=a[d+1]*b[4]+b[7];return c},octDecodeVec2:function(a,b){var c=a[0],d=a[1];c=(2*c+1)/255,d=(2*d+1)/255;var e=1-Math.abs(c)-Math.abs(d);e<0&&(c=(1-Math.abs(d))*(c>=0?1:-1),d=(1-Math.abs(c))*(d>=0?1:-1));var f=Math.sqrt(c*c+d*d+e*e);return b[0]=c/f,b[1]=d/f,b[2]=e/f,b},octDecodeVec2s:function(a,b){for(var c=0,d=0,e=a.length;c<e;c+=2){var f=a[c+0],g=a[c+1];f=(2*f+1)/255,g=(2*g+1)/255;var h=1-Math.abs(f)-Math.abs(g);h<0&&(f=(1-Math.abs(g))*(f>=0?1:-1),g=(1-Math.abs(f))*(g>=0?1:-1));var i=Math.sqrt(f*f+g*g+h*h);b[d+0]=f/i,b[d+1]=g/i,b[d+2]=h/i,d+=3}return b}}}(),function(){"use strict";var a=xeogl.math;a.AABB3=function(a){return new Float32Array(a||6)},a.AABB2=function(a){return new Float32Array(a||4)},a.OBB3=function(a){return new Float32Array(a||32)},a.OBB2=function(a){return new Float32Array(a||16)},a.transformOBB3=function(a,b,c){c=c||b;var d,e,f,g,h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15];for(d=0;d<h;d+=4)e=b[d+0],f=b[d+1],g=b[d+2],c[d+0]=i*e+m*f+q*g+u,c[d+1]=j*e+n*f+r*g+v,c[d+2]=k*e+o*f+s*g+w,c[d+3]=l*e+p*f+t*g+x;return c},a.getAABB3Diag=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e){return b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5],a.subVec3(c,b,d),Math.abs(a.lenVec3(d))}}(),a.getAABB3DiagPoint=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f){b[0]=e[0],b[1]=e[1],b[2]=e[2],c[0]=e[3],c[1]=e[4],c[2]=e[5];var g=a.subVec3(c,b,d),h=f[0]-e[0],i=e[3]-f[0],j=f[1]-e[1],k=e[4]-f[1],l=f[2]-e[2],m=e[5]-f[2];return g[0]+=h>i?h:i,g[1]+=j>k?j:k,g[2]+=l>m?l:m,Math.abs(a.lenVec3(g))}}(),a.getAABB3Center=function(b,c){var d=c||a.vec3();return d[0]=(b[0]+b[3])/2,d[1]=(b[1]+b[4])/2,d[2]=(b[2]+b[5])/2,d},a.getAABB2Center=function(b,c){var d=c||a.vec2();return d[0]=(b[2]+b[0])/2,d[1]=(b[3]+b[1])/2,d},a.collapseAABB3=function(b){return b=b||a.AABB3(),b[0]=xeogl.math.MAX_DOUBLE,b[1]=xeogl.math.MAX_DOUBLE,b[2]=xeogl.math.MAX_DOUBLE,b[3]=-xeogl.math.MAX_DOUBLE,b[4]=-xeogl.math.MAX_DOUBLE,b[5]=-xeogl.math.MAX_DOUBLE,b},a.AABB3ToOBB3=function(b,c){return c=c||a.OBB3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=1,c[4]=b[3],c[5]=b[1],c[6]=b[2],c[7]=1,c[8]=b[3],c[9]=b[4],c[10]=b[2],c[11]=1,c[12]=b[0],c[13]=b[4],c[14]=b[2],c[15]=1,c[16]=b[0],c[17]=b[1],c[18]=b[5],c[19]=1,c[20]=b[3],c[21]=b[1],c[22]=b[5],c[23]=1,c[24]=b[3],c[25]=b[4],c[26]=b[5],c[27]=1,c[28]=b[0],c[29]=b[4],c[30]=b[5],c[31]=1,c},a.positions3ToAABB3=function(){var b=new Float32Array(3);return function(c,d,e){d=d||a.AABB3();for(var f,g,h,i=xeogl.math.MAX_DOUBLE,j=xeogl.math.MAX_DOUBLE,k=xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=-xeogl.math.MAX_DOUBLE,n=-xeogl.math.MAX_DOUBLE,o=0,p=c.length;o<p;o+=3)e?(b[0]=c[o+0],b[1]=c[o+1],b[2]=c[o+2],a.decompressPosition(b,e,b),f=b[0],g=b[1],h=b[2]):(f=c[o+0],g=c[o+1],h=c[o+2]),f<i&&(i=f),g<j&&(j=g),h<k&&(k=h),f>l&&(l=f),g>m&&(m=g),h>n&&(n=h);return d[0]=i,d[1]=j,d[2]=k,d[3]=l,d[4]=m,d[5]=n,d}}(),a.OBB3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m+=4)d=b[m+0],e=b[m+1],f=b[m+2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToAABB3=function(b,c){c=c||a.AABB3();for(var d,e,f,g=xeogl.math.MAX_DOUBLE,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=-xeogl.math.MAX_DOUBLE,m=0,n=b.length;m<n;m++)d=b[m][0],e=b[m][1],f=b[m][2],d<g&&(g=d),e<h&&(h=e),f<i&&(i=f),d>j&&(j=d),e>k&&(k=e),f>l&&(l=f);return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c},a.points3ToSphere3=function(){var b=new Float32Array(3);return function(c,d){d=d||a.vec4();var e,f=0,g=0,h=0,i=c.length;for(e=0;e<i;e++)f+=c[e][0],g+=c[e][1],h+=c[e][2];d[0]=f/i,d[1]=g/i,d[2]=h/i;var j,k=0;for(e=0;e<i;e++)(j=Math.abs(a.lenVec3(a.subVec3(c[e],d,b))))>k&&(k=j);return d[3]=k,d}}(),a.OBB3ToSphere3=function(){var b=new Float32Array(3),c=new Float32Array(3);return function(d,e){e=e||a.vec4();var f,g=0,h=0,i=0,j=d.length,k=j/4;for(f=0;f<j;f+=4)g+=d[f+0],h+=d[f+1],i+=d[f+2];e[0]=g/k,e[1]=h/k,e[2]=i/k;var l,m=0;for(f=0;f<j;f+=4)b[0]=d[f+0],b[1]=d[f+1],b[2]=d[f+2],(l=Math.abs(a.lenVec3(a.subVec3(b,e,c))))>m&&(m=l);return e[3]=m,e}}(),a.getSphere3Center=function(b,c){return c=c||a.vec3(),c[0]=b[0],c[1]=b[1],c[2]=b[2],c},a.expandAABB3=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]>b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a[4]<b[4]&&(a[4]=b[4]),a[5]<b[5]&&(a[5]=b[5]),a},a.expandAABB3Point3=function(a,b){return a[0]<b[0]&&(a[0]=b[0]),a[1]<b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]>b[0]&&(a[3]=b[0]),a[4]>b[1]&&(a[4]=b[1]),a[5]>b[2]&&(a[5]=b[2]),a},a.collapseAABB2=function(b){return b=b||a.AABB2(),b[0]=xeogl.math.MAX_DOUBLE,b[1]=xeogl.math.MAX_DOUBLE,b[2]=-xeogl.math.MAX_DOUBLE,b[3]=-xeogl.math.MAX_DOUBLE,b},a.OBB3ToAABB2=function(b,c){c=c||a.AABB2();for(var d,e,f,g,h=xeogl.math.MAX_DOUBLE,i=xeogl.math.MAX_DOUBLE,j=-xeogl.math.MAX_DOUBLE,k=-xeogl.math.MAX_DOUBLE,l=0,m=b.length;l<m;l+=4)d=b[l+0],e=b[l+1],f=b[l+3]||1,g=1/f,d*=g,e*=g,d<h&&(h=d),e<i&&(i=e),d>j&&(j=d),e>k&&(k=e);return c[0]=h,c[1]=i,c[2]=j,c[3]=k,c},a.expandAABB2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[2]&&(a[2]=b[2]),a[3]<b[3]&&(a[3]=b[3]),a},a.expandAABB2Point2=function(a,b){return a[0]>b[0]&&(a[0]=b[0]),a[1]>b[1]&&(a[1]=b[1]),a[2]<b[0]&&(a[2]=b[0]),a[3]<b[1]&&(a[3]=b[1]),a},a.AABB2ToCanvas=function(a,b,c,d){d=d||a;var e=.5*(a[0]+1),f=.5*(a[1]+1),g=.5*(a[2]+1),h=.5*(a[3]+1);return d[0]=Math.floor(e*b),d[1]=c-Math.floor(h*c),d[2]=Math.floor(g*b),d[3]=c-Math.floor(f*c),d}}(),function(){"use strict";var a=xeogl.math;a.triangleNormal=function(b,c,d,e){e=e||a.vec3();var f=c[0]-b[0],g=c[1]-b[1],h=c[2]-b[2],i=d[0]-b[0],j=d[1]-b[1],k=d[2]-b[2],l=g*k-h*j,m=h*i-f*k,n=f*j-g*i,o=Math.sqrt(l*l+m*m+n*n);return 0===o?(e[0]=0,e[1]=0,e[2]=0):(e[0]=l/o,e[1]=m/o,e[2]=n/o),e},a.rayTriangleIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3);return function(g,h,i,j,k,l){l=l||a.vec3();var m=a.subVec3(j,i,b),n=a.subVec3(k,i,c),o=a.cross3Vec3(h,n,d),p=a.dotVec3(m,o);if(p<1e-6)return null;var q=a.subVec3(g,i,e),r=a.dotVec3(q,o);if(r<0||r>p)return null;var s=a.cross3Vec3(q,m,f),t=a.dotVec3(h,s);if(t<0||r+t>p)return null;var u=a.dotVec3(n,s)/p;return l[0]=g[0]+u*h[0],l[1]=g[1]+u*h[1],l[2]=g[2]+u*h[2],l}}(),a.rayPlaneIntersect=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3);return function(f,g,h,i,j,k){k=k||a.vec3(),g=a.normalizeVec3(g,b);var l=a.subVec3(i,h,c),m=a.subVec3(j,h,d),n=a.cross3Vec3(l,m,e);a.normalizeVec3(n,n);var o=-a.dotVec3(h,n),p=-(a.dotVec3(f,n)+o)/a.dotVec3(g,n);return k[0]=f[0]+p*g[0],k[1]=f[1]+p*g[1],k[2]=f[2]+p*g[2],k}}(),a.cartesianToBarycentric=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3);return function(e,f,g,h,i){var j=a.subVec3(h,f,b),k=a.subVec3(g,f,c),l=a.subVec3(e,f,d),m=a.dotVec3(j,j),n=a.dotVec3(j,k),o=a.dotVec3(j,l),p=a.dotVec3(k,k),q=a.dotVec3(k,l),r=m*p-n*n;if(0===r)return null;var s=1/r,t=(p*o-n*q)*s,u=(m*q-n*o)*s;return i[0]=1-t-u,i[1]=u,i[2]=t,i}}(),a.barycentricInsideTriangle=function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&c+b<1},a.barycentricToCartesian=function(b,c,d,e,f){f=f||a.vec3();var g=b[0],h=b[1],i=b[2];return f[0]=c[0]*g+d[0]*h+e[0]*i,f[1]=c[1]*g+d[1]*h+e[1]*i,f[2]=c[2]*g+d[2]*h+e[2]*i,f},a.mergeVertices=function(a,b,c,d){var e,f,g,h,i,j,k={},l=[],m=[],n=b?[]:null,o=c?[]:null,p=[],q=4,r=Math.pow(10,q),s=0;for(i=0,j=a.length;i<j;i+=3)e=a[i],f=a[i+1],g=a[i+2],h=Math.round(e*r)+"_"+Math.round(f*r)+"_"+Math.round(g*r),void 0===k[h]&&(k[h]=m.length/3,m.push(e),m.push(f),m.push(g),b&&(n.push(b[i]),n.push(b[i+1]),n.push(b[i+2])),c&&(o.push(c[s]),o.push(c[s+1]))),l[i/3]=k[h],s+=2;for(i=0,j=d.length;i<j;i++)p[i]=l[d[i]];var t={positions:m,indices:p};return n&&(t.normals=n),o&&(t.uv=o),t}}(),function(){"use strict";var a=xeogl.math;a.buildNormals=function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();return function(h,i,j){var k,l,m,n,o,p=new Array(h.length/3);for(k=0,l=i.length;k<l;k+=3){m=i[k],n=i[k+1],o=i[k+2],b[0]=h[3*m],b[1]=h[3*m+1],b[2]=h[3*m+2],c[0]=h[3*n],c[1]=h[3*n+1],c[2]=h[3*n+2],d[0]=h[3*o],d[1]=h[3*o+1],d[2]=h[3*o+2],a.subVec3(c,b,e),a.subVec3(d,b,f);var q=a.vec3();a.normalizeVec3(a.cross3Vec3(e,f,g),q),p[m]||(p[m]=[]),p[n]||(p[n]=[]),p[o]||(p[o]=[]),p[m].push(q),p[n].push(q),p[o].push(q)}j=j&&j.length===h.length?j:new Float32Array(h.length);var r,s,t,u;for(k=0,l=p.length;k<l;k++){r=p[k].length,s=0,t=0,u=0;for(var v=0;v<r;v++)s+=p[k][v][0],t+=p[k][v][1],u+=p[k][v][2];j[3*k]=s/r,j[3*k+1]=t/r,j[3*k+2]=u/r}return j}}(),a.buildTangents=function(){var b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3),g=new Float32Array(3),h=new Float32Array(3);return function(i,j,k){for(var l=new Float32Array(i.length),m=0;m<j.length;m+=3){var n=j[m],o=i.subarray(3*n,3*n+3),p=k.subarray(2*n,2*n+2);n=j[m+1];var q=i.subarray(3*n,3*n+3),r=k.subarray(2*n,2*n+2);n=j[m+2];for(var s,t=i.subarray(3*n,3*n+3),u=k.subarray(2*n,2*n+2),v=a.subVec3(q,o,b),w=a.subVec3(t,o,c),x=a.subVec2(r,p,d),y=a.subVec2(u,p,e),z=1/(x[0]*y[1]-x[1]*y[0]),A=a.mulVec3Scalar(a.subVec3(a.mulVec3Scalar(v,y[1],f),a.mulVec3Scalar(w,x[1],g),h),z,g),B=0;B<3;B++)s=3*j[m+B],l[s]+=A[0],l[s+1]+=A[1],l[s+2]+=A[2]}return l}}(),a.buildPickTriangles=function(a,b,c){for(var d,e,f,g,h,i,j=b.length,k=c?new Uint16Array(9*j):new Float32Array(9*j),l=new Uint8Array(12*j),m=0,n=0,o=0,p=0;p<j;p+=3)i=m>>24&255,h=m>>16&255,g=m>>8&255,f=255&m,e=b[p],d=3*e,k[n++]=a[d],k[n++]=a[d+1],k[n++]=a[d+2],l[o++]=f,l[o++]=g,l[o++]=h,l[o++]=i,e=b[p+1],d=3*e,k[n++]=a[d],k[n++]=a[d+1],k[n++]=a[d+2],l[o++]=f,l[o++]=g,l[o++]=h,l[o++]=i,e=b[p+2],d=3*e,k[n++]=a[d],k[n++]=a[d+1],k[n++]=a[d+2],l[o++]=f,l[o++]=g,l[o++]=h,l[o++]=i,m++;return{positions:k,colors:l}},a.faceToVertexNormals=function(b,c,d){d=d||{};var e,f,g,h,i,j,k,l,m,n,o,p=d.smoothNormalsAngleThreshold||20,q={},r=[],s={},t=4,u=Math.pow(10,t);for(k=0,m=b.length;k<m;k+=3){j=k/3,f=b[k],g=b[k+1],h=b[k+2],i=Math.round(f*u)+"_"+Math.round(g*u)+"_"+Math.round(h*u),void 0===q[i]?q[i]=[j]:q[i].push(j);var v=a.normalizeVec3([c[k],c[k+1],c[k+2]]);r[j]=v,e=a.vec4([v[0],v[1],v[2],1]),s[j]=e}for(i in q)if(q.hasOwnProperty(i)){var w=q[i],x=w.length;for(k=0;k<x;k++){var y=w[k];for(e=s[y],l=0;l<x;l++)if(k!==l){var z=w[l];n=r[y],o=r[z];var A=Math.abs(a.angleVec3(n,o)/a.DEGTORAD);A<p&&(e[0]+=o[0],e[1]+=o[1],e[2]+=o[2],e[3]+=1)}}}for(k=0,m=c.length;k<m;k+=3)e=s[k/3],c[k+0]=e[0]/e[3],c[k+1]=e[1]/e[3],c[k+2]=e[2]/e[3]}}(),function(){"use strict";var a=xeogl.math;a.tangentQuadraticBezier=function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},a.tangentQuadraticBezier=function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},a.tangentSpline=function(a){return 6*a*a-6*a+(3*a*a-4*a+1)+(-6*a*a+6*a)+(3*a*a-2*a)},a.catmullRomInterpolate=function(a,b,c,d,e){var f=.5*(c-a),g=.5*(d-b),h=e*e;return(2*b-2*c+f+g)*(e*h)+(-3*b+3*c-2*f-g)*h+f*e+b},a.b2p0=function(a,b){var c=1-a;return c*c*b},a.b2p1=function(a,b){return 2*(1-a)*a*b},a.b2p2=function(a,b){return a*a*b},a.b2=function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},a.b3p0=function(a,b){var c=1-a;return c*c*c*b},a.b3p1=function(a,b){var c=1-a;return 3*c*c*a*b},a.b3p2=function(a,b){return 3*(1-a)*a*a*b},a.b3p3=function(a,b){return a*a*a*b},a.b3=function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)}}(),function(){"use strict";var a=xeogl.math;a.canvasPosToWorldRay=function(){var b=a.mat4(),c=a.mat4(),d=a.vec4(),e=a.vec4(),f=a.vec4(),g=a.vec4();return function(h,i,j,k){var l=h.scene.canvas.canvas,m=h.viewMatrix,n="ortho"===h.projection?h.ortho.matrix:h.perspective.matrix,o=a.mulMat4(n,m,b),p=a.inverseMat4(o,c),q=l.width,r=l.height,s=(i[0]-q/2)/(q/2),t=-(i[1]-r/2)/(r/2);d[0]=s,d[1]=t,d[2]=-1,d[3]=1,a.transformVec4(p,d,e),a.mulVec4Scalar(e,1/e[3]),f[0]=s,f[1]=t,f[2]=1,f[3]=1,a.transformVec4(p,f,g),a.mulVec4Scalar(g,1/g[3]),j[0]=g[0],j[1]=g[1],j[2]=g[2],a.subVec3(g,e,k),a.normalizeVec3(k)}}(),a.canvasPosToLocalRay=function(){var b=a.vec3(),c=a.vec3();return function(d,e,f,g,h){a.canvasPosToWorldRay(d,f,b,c),a.worldRayToLocalRay(e,b,c,g,h)}}(),a.worldRayToLocalRay=function(){var b=a.mat4(),c=a.vec4(),d=a.vec4();return function(e,f,g,h,i){var j=e.worldMatrix||e.matrix,k=a.inverseMat4(j,b);c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=1,a.transformVec4(k,c,d),h[0]=d[0],h[1]=d[1],h[2]=d[2],a.transformVec3(k,g,i)}}()}(),function(){"use strict";function a(e,f,g,h){var i=new Float32Array(6),j={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:i};i[0]=i[1]=i[2]=Number.POSITIVE_INFINITY,i[3]=i[4]=i[5]=Number.NEGATIVE_INFINITY;var k,l;for(k=0,l=e.length;k<l;++k)for(var m=3*e[k],n=0;n<3;++n){var o=3*f[m+n];g[o]<i[0]&&(i[0]=g[o]),g[o]>i[3]&&(i[3]=g[o]),g[o+1]<i[1]&&(i[1]=g[o+1]),g[o+1]>i[4]&&(i[4]=g[o+1]),g[o+2]<i[2]&&(i[2]=g[o+2]),g[o+2]>i[5]&&(i[5]=g[o+2])}if(e.length<c||h>b)return j.triangles=e,j.leaf=!0,j;d[0]=i[3]-i[0],d[1]=i[4]-i[1],d[2]=i[5]-i[2];var p=0;d[1]>d[p]&&(p=1),d[2]>d[p]&&(p=2),j.splitDim=p;var q=(i[p]+i[p+3])/2,r=new Array(e.length),s=0,t=new Array(e.length),u=0;for(k=0,l=e.length;k<l;++k){var m=3*e[k],v=f[m],w=f[m+1],x=f[m+2],y=3*v,z=3*w,A=3*x;g[y+p]<=q||g[z+p]<=q||g[A+p]<=q?r[s++]=e[k]:t[u++]=e[k]}return r.length=s,t.length=u,j.left=a(r,f,g,h+1),j.right=a(t,f,g,h+1),j}var b=10,c=20;xeogl.math.buildKDTree=function(b,c){for(var d=b.length/3,e=new Array(d),f=0;f<d;++f)e[f]=f;return a(e,b,c,0)};var d=new Float32Array}(),xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Renderer=function(a,b,c){"use strict";function d(){p&&(e(),p=!1,q=!0),q&&(l.sort(xeogl.Mesh._compareState),q=!1,r=!0)}function e(){m=0;for(var a in b.meshes)b.meshes.hasOwnProperty(a)&&(l[m++]=b.meshes[a]);for(var c=m,d=l.length;c<d;c++)l[c]=null;l.length=m}function f(a,c,d,e,f){h.reset(),h.backfaces=!0,h.frontface=!0,h.pickViewMatrix=d,h.pickProjMatrix=e,h.pickMeshIndex=1;var g=b.viewport.boundary;j.viewport(g[0],g[1],g[2],g[3]),j.clearColor(0,0,0,0),j.enable(j.DEPTH_TEST),j.disable(j.CULL_FACE),j.disable(j.BLEND),j.clear(j.COLOR_BUFFER_BIT|j.DEPTH_BUFFER_BIT),o=0;var i,k,p,q=f.includeMeshIds,r=f.excludeMeshIds;for(i=0,k=m;i<k;i++)p=l[i],!0!==p._state.culled&&!1!==p._state.visible&&!1!==p._state.pickable&&(q&&!q[p.id]||r&&r[p.id]||(n[o++]=p,p._pickMesh(h)));var s=u.read(Math.round(a),Math.round(c)),t=s[0]+256*s[1]+256*s[2]*256+256*s[3]*256*256;return t--,t>=0?n[t]:null}function g(a,c,d,e,f){h.reset(),h.backfaces=!0,h.frontface=!0,h.pickViewMatrix=e,h.pickProjMatrix=f;var g=b.viewport.boundary;j.viewport(g[0],g[1],g[2],g[3]),j.clearColor(0,0,0,0),j.enable(j.DEPTH_TEST),j.disable(j.CULL_FACE),j.disable(j.BLEND),j.clear(j.COLOR_BUFFER_BIT|j.DEPTH_BUFFER_BIT),a._pickTriangle(h);var i=u.read(c,d),k=i[0]+256*i[1]+256*i[2]*256+256*i[3]*256*256;return k*=3}c=c||{},a=a||{};var h=new xeogl.renderer.Frame,i=b.canvas.canvas,j=b.canvas.gl,k=!0===c.transparent,l=[],m=0,n=[],o=0,p=!0,q=!0,r=!0,s=!0;this.imageForceDirty=!0;var t=!0,u=null,v=null,w=null,x=null;this.meshListDirty=function(){p=!0,q=!0},this.needStateSort=function(){q=!0},this.shadowsDirty=function(){s=!0},this.imageDirty=function(){r=!0},this.setImageForceDirty=function(){this.imageForceDirty=!0},this.setBlendOneMinusSrcAlpha=function(a){t=a},this.webglContextLost=function(){},this.webglContextRestored=function(a){u&&u.webglContextRestored(a),v&&v.webglContextRestored(a),r=!0},this.clear=function(a){a=a||{};var c=b.viewport.boundary;if(j.viewport(c[0],c[1],c[2],c[3]),k)j.clearColor(0,0,0,0);else{var d=a.ambientColor||this.lights.getAmbientColor();j.clearColor(d[0],d[1],d[2],1)}w&&w(a.pass),j.clear(j.COLOR_BUFFER_BIT|j.DEPTH_BUFFER_BIT|j.STENCIL_BUFFER_BIT),x&&x(a.pass)},this.render=function(b){b=b||{},d(),(r||this.imageForceDirty||b.force)&&(y(b),a.frame.frameCount++,r=!1,this.imageForceDirty=!1)};var y=function(){var c=[],d=[],e=[],f=[],g=[],i=[],n=[],o=[],p=[],q=[],r=[],s=[],u=[],v=[],y=[],z=[],A=[],B=[],C=[],D=[],E=[],F=[],G=[],H=[],I=0;return function(J){xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&j.getExtension("OES_element_index_uint"),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_standard_derivatives&&j.getExtension("OES_standard_derivatives");var K=b._lightsState.getAmbientColor();h.reset(),h.pass=J.pass;var L=b.viewport.boundary;j.viewport(L[0],L[1],L[2],L[3]),k?j.clearColor(0,0,0,0):j.clearColor(K[0],K[1],K[2],1),j.enable(j.DEPTH_TEST),j.frontFace(j.CCW),j.enable(j.CULL_FACE),j.depthMask(!0);var M,N,O,P,Q,R,S=Date.now();w&&w(J.pass),!1!==J.clear&&j.clear(j.COLOR_BUFFER_BIT|j.DEPTH_BUFFER_BIT|j.STENCIL_BUFFER_BIT);var T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,_=0,aa=0,ba=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0,na=0;for(I=0,M=0,N=m;M<N;M++)if(O=l[M],P=O._state,Q=O._material._state,!0!==P.culled&&!1!==P.visible&&0!==Q.alpha){if(P.ghosted){var oa=O._ghostMaterial._state;oa.edges&&(oa.edgeAlpha<1?i[Y++]=O:e[V++]=O),oa.vertices&&(oa.vertexAlpha<1?g[X++]=O:d[U++]=O),oa.fill&&(oa.fillAlpha<1?f[W++]=O:c[T++]=O)}else R=2===Q.alphaMode||P.xray||P.colorize[3]<1,R?H[I++]=O:P.outlined?E[Z++]=O:O._draw(h);if(P.selected){var pa=O._selectedMaterial._state;pa.edges&&(pa.edgeAlpha<1?B[la++]=O:y[ia++]=O),pa.vertices&&(pa.vertexAlpha<1?A[ka++]=O:v[ha++]=O),pa.fill&&(pa.fillAlpha<1?z[ja++]=O:u[ga++]=O),P.selected&&(G[_++]=O)}if(P.highlighted){var qa=O._highlightMaterial._state;qa.edges&&(qa.edgeAlpha<1?s[fa++]=O:p[ca++]=O),qa.vertices&&(qa.vertexAlpha<1?r[ea++]=O:o[ba++]=O),qa.fill&&(qa.fillAlpha<1?q[da++]=O:n[aa++]=O),P.highlighted&&(F[$++]=O)}if(P.edges){var ra=O._edgeMaterial._state;ra.edgeAlpha<1?D[na++]=O:C[ma++]=O}}if(Z>0){for(j.enable(j.STENCIL_TEST),j.stencilFunc(j.ALWAYS,1,1),j.stencilOp(j.KEEP,j.KEEP,j.REPLACE),j.stencilMask(1),j.clearStencil(0),j.clear(j.STENCIL_BUFFER_BIT),M=0;M<Z;M++)E[M]._draw(h);for(j.stencilFunc(j.EQUAL,0,1),j.stencilOp(j.KEEP,j.KEEP,j.KEEP),j.stencilMask(0),j.disable(j.CULL_FACE),M=0;M<Z;M++)E[M]._drawOutline(h);j.disable(j.STENCIL_TEST)}if(ma>0)for(M=0;M<ma;M++)C[M]._drawEdges(h);if(T>0)for(M=0;M<T;M++)c[M]._drawGhostFill(h);if(V>0)for(M=0;M<V;M++)e[M]._drawGhostEdges(h);if(U>0)for(M=0;M<U;M++)d[M]._drawGhostVertices(h);if(W>0||Y>0||X>0||I>0){if(j.enable(j.CULL_FACE),j.enable(j.BLEND),t?j.blendFunc(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA):(j.blendEquation(j.FUNC_ADD),j.blendFuncSeparate(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA,j.ONE,j.ONE_MINUS_SRC_ALPHA)),h.backfaces=!1,X>0)for(M=0;M<X;M++)g[M]._drawGhostVertices(h);if(Y>0)for(M=0;M<Y;M++)i[M]._drawGhostEdges(h);if(W>0)for(M=0;M<W;M++)f[M]._drawGhostFill(h);for(Z=0,M=0;M<I;M++)O=H[M],O._state.outlined?E[Z++]=O:O._draw(h);j.disable(j.BLEND)}if(aa>0||ca>0||ba>0){if(h.lastProgramId=null,j.clear(j.DEPTH_BUFFER_BIT),ba>0)for(M=0;M<ba;M++)o[M]._drawHighlightVertices(h);if(ca>0)for(M=0;M<ca;M++)p[M]._drawHighlightEdges(h);if(aa>0)for(M=0;M<aa;M++)n[M]._drawHighlightFill(h)}if(da>0||fa>0||ea>0){if(h.lastProgramId=null,j.clear(j.DEPTH_BUFFER_BIT),j.enable(j.CULL_FACE),j.enable(j.BLEND),j.blendFunc(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA),ea>0)for(M=0;M<ea;M++)r[M]._drawHighlightVertices(h);if(fa>0)for(M=0;M<fa;M++)s[M]._drawHighlightEdges(h);if(da>0)for(M=0;M<da;M++)q[M]._drawHighlightFill(h);j.disable(j.BLEND)}if(ga>0||ia>0||ha>0){if(h.lastProgramId=null,j.clear(j.DEPTH_BUFFER_BIT),ha>0)for(M=0;M<ha;M++)v[M]._drawSelectedVertices(h);if(ia>0)for(M=0;M<ia;M++)y[M]._drawSelectedEdges(h);if(ga>0)for(M=0;M<ga;M++)u[M]._drawSelectedFill(h)}if(ja>0||la>0||ka>0){if(h.lastProgramId=null,j.clear(j.DEPTH_BUFFER_BIT),j.enable(j.CULL_FACE),j.enable(j.BLEND),j.blendFunc(j.SRC_ALPHA,j.ONE_MINUS_SRC_ALPHA),ka>0)for(M=0;M<ka;M++)A[M]._drawSelectedVertices(h);if(la>0)for(M=0;M<la;M++)B[M]._drawSelectedEdges(h);if(ja>0)for(M=0;M<ja;M++)z[M]._drawSelectedFill(h);j.disable(j.BLEND)}var sa=Date.now(),ta=a.frame;ta.renderTime=(sa-S)/1e3,ta.drawElements=h.drawElements,ta.drawElements=h.drawElements,ta.useProgram=h.useProgram,ta.bindTexture=h.bindTexture,ta.bindArray=h.bindArray;for(var ua=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,va=0;va<ua;va++)j.activeTexture(j.TEXTURE0+va);j.bindTexture(j.TEXTURE_CUBE_MAP,null),j.bindTexture(j.TEXTURE_2D,null),x&&x(J.pass)}}();this.pick=function(){var a=xeogl.math,b=a.vec3(),c=a.mat4(),e=a.vec3([0,1,0]),h=a.frustumMat4(-1,1,-1,1,.1,1e4);return function(k){d(),xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&j.getExtension("OES_element_index_uint");var l,m,n,o,p,q=null,r=null;k.canvasPos?(l=k.canvasPos[0],m=k.canvasPos[1]):(n=k.origin||a.vec3([0,0,0]),o=k.direction||a.vec3([0,0,1]),p=a.addVec3(n,o,b),q=a.lookAtMat4v(n,p,e,c),r=h,l=.5*i.clientWidth,m=.5*i.clientHeight),u=u||new xeogl.renderer.RenderBuffer(i,j),u.bind();var s=f(l,m,q,r,k);if(!s)return u.unbind(),null;var t={mesh:s};return k.pickSurface&&(t.primIndex=g(s,l,m,q,r)),q&&(t.origin=n,t.direction=o),u.unbind(),t}}(),this.readPixels=function(a,b,c,d){v=v||(v=new xeogl.renderer.RenderBuffer(i,j)),v.bind(),v.clear(),this.render({force:!0,opaqueOnly:d});var e,f,g,h;for(f=0;f<c;f++)g=2*f,h=4*f,e=v.read(a[g],a[g+1]),b[h]=e[0],b[h+1]=e[1],b[h+2]=e[2],b[h+3]=e[3];v.unbind(),r=!0},this.destroy=function(){u&&u.destroy(),v&&v.destroy()}},xeogl.renderer.webgl={enums:{funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"}},xeogl.renderer=xeogl.renderer||{},xeogl.renderer.Frame=function(){this.reset()},xeogl.renderer.Frame.prototype.reset=function(){this.lastProgramId=null,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickmeshIndex=1},function(){"use strict";function a(a){for(var b,c,d=[],e=0,f=a.length;e<f;e++)b=a[e],c=b.indexOf("/"),c>0&&"/"===b.charAt(c+1)&&(b=b.substring(0,c)),d.push(b);return d.join("\n")}var b=new xeogl.utils.Map({});xeogl.renderer.Program=function(a,c){this.id=b.addItem({}),this.source=c,this.init(a)},xeogl.renderer.Program.prototype.init=function(b){if(this.gl=b,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new xeogl.renderer.Shader(b,b.VERTEX_SHADER,a(this.source.vertex)),this._fragmentShader=new xeogl.renderer.Shader(b,b.FRAGMENT_SHADER,a(this.source.fragment)),!this._vertexShader.allocated)return void(this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors));if(!this._fragmentShader.allocated)return void(this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors));if(this.allocated=!0,!this._vertexShader.compiled)return void(this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors));if(!this._fragmentShader.compiled)return void(this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors));this.compiled=!0;var c,d,e,f,g;if(this.handle=b.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(b.attachShader(this.handle,this._vertexShader.handle),b.attachShader(this.handle,this._fragmentShader.handle),b.linkProgram(this.handle),this.linked=b.getProgramParameter(this.handle,b.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(b.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(shaderSource.vertex),this.errors.push("\nFragment shader:\n"),void(this.errors=this.errors.concat(shaderSource.fragment));var h=b.getProgramParameter(this.handle,b.ACTIVE_UNIFORMS);for(d=0;d<h;++d)(e=b.getActiveUniform(this.handle,d))&&(f=e.name,"\0"===f[f.length-1]&&(f=f.substr(0,f.length-1)),g=b.getUniformLocation(this.handle,f),e.type===b.SAMPLER_2D||e.type===b.SAMPLER_CUBE||35682===e.type?this.samplers[f]=new xeogl.renderer.Sampler(b,g):this.uniforms[f]=g);var i=b.getProgramParameter(this.handle,b.ACTIVE_ATTRIBUTES);for(d=0;d<i;d++)(c=b.getActiveAttrib(this.handle,d))&&(g=b.getAttribLocation(this.handle,c.name),this.attributes[c.name]=new xeogl.renderer.Attribute(b,g));this.allocated=!0},xeogl.renderer.Program.prototype.bind=function(){this.allocated&&this.gl.useProgram(this.handle)},xeogl.renderer.Program.prototype.getLocation=function(a){if(this.allocated)return this.uniforms[a]},xeogl.renderer.Program.prototype.getAttribute=function(a){if(this.allocated)return this.attributes[a]},xeogl.renderer.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this.samplers[a];return!!d&&d.bindTexture(b,c)},xeogl.renderer.Program.prototype.destroy=function(){this.allocated&&(b.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}(),xeogl.renderer.Sampler=function(a,b){this.bindTexture=function(c,d){return!!c.bind(d)&&(a.uniform1i(b,d),!0)}},xeogl.renderer.Shader=function(a,b,c){if(this.allocated=!1,this.compiled=!1,this.handle=a.createShader(b),!this.handle)return void(this.errors=["Failed to allocate"]);if(this.allocated=!0,a.shaderSource(this.handle,c),a.compileShader(this.handle),this.compiled=a.getShaderParameter(this.handle,a.COMPILE_STATUS),!this.compiled&&!a.isContextLost()){for(var d=c.split("\n"),e=[],f=0;f<d.length;f++)e.push(f+1+": "+d[f]+"\n");this.errors=[],this.errors.push(""),this.errors.push(a.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(e.join(""))}},xeogl.renderer.Shader.prototype.destroy=function(){},function(){var a=new xeogl.utils.Map({});xeogl.renderer.State=function(b){this.id=a.addItem({});for(var c in b)b.hasOwnProperty(c)&&(this[c]=b[c])},xeogl.renderer.State.prototype.destroy=function(){a.removeItem(this.id)}}(),xeogl.renderer.Texture2D=function(a,b){this.gl=a,this.target=b||a.TEXTURE_2D,this.texture=a.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0},xeogl.renderer.Texture2D.prototype.setPreloadColor=function(){var a=new Uint8Array([0,0,0,1]);return function(b){b?(a[0]=Math.floor(255*b[0]),a[1]=Math.floor(255*b[1]),a[2]=Math.floor(255*b[2]),a[3]=Math.floor(255*(void 0!==b[3]?b[3]:1))):(a[0]=0,a[1]=0,a[2]=0,a[3]=255);var c=this.gl;if(c.bindTexture(this.target,this.texture),c.texParameteri(this.target,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(this.target,c.TEXTURE_MIN_FILTER,c.NEAREST),this.target===c.TEXTURE_CUBE_MAP)for(var d=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],e=0,f=d.length;e<f;e++)c.texImage2D(d[e],0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a);else c.texImage2D(this.target,0,c.RGBA,1,1,0,c.RGBA,c.UNSIGNED_BYTE,a);c.bindTexture(this.target,null)}}(),xeogl.renderer.Texture2D.prototype.setTarget=function(a){this.target=a||this.gl.TEXTURE_2D},xeogl.renderer.Texture2D.prototype.setImage=function(a,b){var c=this.gl;if(c.bindTexture(this.target,this.texture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,b.flipY),this.target===c.TEXTURE_CUBE_MAP){if(xeogl._isArray(a))for(var d=a,e=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],f=0,g=e.length;f<g;f++)c.texImage2D(e[f],0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,d[f])}else c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a);c.bindTexture(this.target,null)},xeogl.renderer.Texture2D.prototype.setProps=function(a){var b=this.gl;if(b.bindTexture(this.target,this.texture),a.minFilter){var c=this._getGLEnum(a.minFilter);c&&(b.texParameteri(this.target,b.TEXTURE_MIN_FILTER,c),c!==b.NEAREST_MIPMAP_NEAREST&&c!==b.LINEAR_MIPMAP_NEAREST&&c!==b.NEAREST_MIPMAP_LINEAR&&c!==b.LINEAR_MIPMAP_LINEAR||b.generateMipmap(this.target))}if(a.magFilter){var d=this._getGLEnum(a.magFilter);d&&b.texParameteri(this.target,b.TEXTURE_MAG_FILTER,d)}if(a.wrapS){var e=this._getGLEnum(a.wrapS);e&&b.texParameteri(this.target,b.TEXTURE_WRAP_S,e)}if(a.wrapT){var f=this._getGLEnum(a.wrapT);f&&b.texParameteri(this.target,b.TEXTURE_WRAP_T,f)}b.bindTexture(this.target,null)},xeogl.renderer.Texture2D.prototype._getGLEnum=function(a,b){if(void 0===a)return b;var c=xeogl.renderer.webgl.enums[a];return void 0===c?b:this.gl[c]},xeogl.renderer.Texture2D.prototype.bind=function(a){if(this.allocated){if(this.texture){var b=this.gl;return b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,this.texture),!0}return!1}},xeogl.renderer.Texture2D.prototype.unbind=function(a){if(this.allocated&&this.texture){var b=this.gl;b.activeTexture(b["TEXTURE"+a]),b.bindTexture(this.target,null)}},xeogl.renderer.Texture2D.prototype.destroy=function(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)},xeogl.renderer.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=xeogl.renderer.nextHighestPowerOfTwo(e),g.height=xeogl.renderer.nextHighestPowerOfTwo(f)
;g.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},xeogl.renderer.ensureImageSizePowerOfTwo=function(a){if(!xeogl.renderer.isPowerOfTwo(a.width)||!xeogl.renderer.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=xeogl.renderer.nextHighestPowerOfTwo(a.width),b.height=xeogl.renderer.nextHighestPowerOfTwo(a.height);b.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},xeogl.renderer.isPowerOfTwo=function(a){return 0==(a&a-1)},xeogl.renderer.nextHighestPowerOfTwo=function(a){--a;for(var b=1;b<32;b<<=1)a|=a>>b;return a+1},xeogl.renderer.ArrayBuffer=function(a,b,c,d,e,f){switch(this._gl=a,this.type=b,this.allocated=!1,c.constructor){case Uint8Array:this.itemType=a.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=a.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=a.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=a.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=a.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=a.INT,this.itemByteSize=4;break;default:this.itemType=a.FLOAT,this.itemByteSize=4}this.usage=f,this.length=0,this.numItems=0,this.itemSize=e,this._allocate(c)},xeogl.renderer.ArrayBuffer.prototype._allocate=function(a){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,a,this.usage),this._gl.bindBuffer(this.type,null),this.length=a.length,this.numItems=this.length/this.itemSize,this.allocated=!0)},xeogl.renderer.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):(this._gl.bindBuffer(this.type,this._handle),b||0===b?this._gl.bufferSubData(this.type,b*this.itemByteSize,a):this._gl.bufferData(this.type,a,this.usage),this._gl.bindBuffer(this.type,null)))},xeogl.renderer.ArrayBuffer.prototype.bind=function(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)},xeogl.renderer.ArrayBuffer.prototype.unbind=function(){this.allocated&&this._gl.bindBuffer(this.type,null)},xeogl.renderer.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)},xeogl.renderer.Attribute=function(a,b){this._gl=a,this.location=b},xeogl.renderer.Attribute.prototype.bindArrayBuffer=function(a,b){a&&(a.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,b===this._gl.BYTE?2:a.itemSize,b||this._gl.FLOAT,b===this._gl.BYTE,0,0))},xeogl.renderer.RenderBuffer=function(a,b,c){c=c||{},this.gl=b,this.allocated=!1,this.canvas=a,this.buffer=null,this.bound=!1,this.size=c.size},xeogl.renderer.RenderBuffer.prototype.setSize=function(a){this.size=a},xeogl.renderer.RenderBuffer.prototype.webglContextRestored=function(a){this.gl=a,this.buffer=null,this.allocated=!1,this.bound=!1},xeogl.renderer.RenderBuffer.prototype.bind=function(){if(this._touch(),!this.bound){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}},xeogl.renderer.RenderBuffer.prototype._touch=function(){var a,b,c=this.gl;if(this.size?(a=this.size[0],b=this.size[1]):(a=this.canvas.clientWidth,b=this.canvas.clientHeight),this.buffer){if(this.buffer.width===a&&this.buffer.height===b)return;c.deleteTexture(this.buffer.texture),c.deleteFramebuffer(this.buffer.framebuf),c.deleteRenderbuffer(this.buffer.renderbuf)}var d=c.createTexture();c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a,b,0,c.RGBA,c.UNSIGNED_BYTE,null),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);var e=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,e),c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a,b);var f=c.createFramebuffer();if(c.bindFramebuffer(c.FRAMEBUFFER,f),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,e),c.bindTexture(c.TEXTURE_2D,null),c.bindRenderbuffer(c.RENDERBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,null),c.bindFramebuffer(c.FRAMEBUFFER,f),!c.isFramebuffer(f))throw"Invalid framebuffer";c.bindFramebuffer(c.FRAMEBUFFER,null);var g=c.checkFramebufferStatus(c.FRAMEBUFFER);switch(g){case c.FRAMEBUFFER_COMPLETE:break;case c.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case c.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case c.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case c.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+g}this.buffer={framebuf:f,renderbuf:e,texture:d,width:a,height:b},this.bound=!1},xeogl.renderer.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";var a=this.gl;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},xeogl.renderer.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.height-b,e=new Uint8Array(4),f=this.gl;return f.readPixels(c,d,1,1,f.RGBA,f.UNSIGNED_BYTE,e),e},xeogl.renderer.RenderBuffer.prototype.unbind=function(){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null),this.bound=!1},xeogl.renderer.RenderBuffer.prototype.getTexture=function(){var a=this;return{renderBuffer:this,bind:function(b){return!(!a.buffer||!a.buffer.texture)&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buffer.texture),!0)},unbind:function(b){a.buffer&&a.buffer.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},xeogl.renderer.RenderBuffer.prototype.destroy=function(){if(this.allocated){var a=this.gl;a.deleteTexture(this.buffer.texture),a.deleteFramebuffer(this.buffer.framebuf),a.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}},function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.DrawRenderer=function(b,c){this.id=a.addItem({}),this._hash=b,this._scene=c.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.DrawShaderSource(c),this._allocate(c)};var b={};xeogl.renderer.DrawRenderer.get=function(a){var c=a.scene,d=[c.canvas.canvas.id,(c.gammaInput?"gi;":";")+(c.gammaOutput?"go":""),c._lightsState.getHash(),c._clipsState.getHash(),a._geometry._state.hash,a._material._state.hash,a._state.hash].join(";"),e=b[d];if(!e){if(e=new xeogl.renderer.DrawRenderer(d,a),e.errors)return console.log(e.errors.join("\n")),null;b[d]=e,xeogl.stats.memory.programs++}return e._useCount++,e},xeogl.renderer.DrawRenderer.prototype.put=function(){0==--this._useCount&&(a.removeItem(this.id),this._program&&this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.DrawRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.DrawRenderer.prototype.drawMesh=function(a,b){this._program||this._allocate(b);var c=xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS,d=b.scene,e=b._material,f=d.canvas.gl,g=this._program,h=b._state,i=b._material._state,j=b._geometry._state;if(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a)),i.id!==this._lastMaterialId){a.textureUnit=this._baseTextureUnit;var k=i.backfaces;a.backfaces!==k&&(k?f.disable(f.CULL_FACE):f.enable(f.CULL_FACE),a.backfaces=k);var l=i.frontface;switch(a.frontface!==l&&(l?f.frontFace(f.CCW):f.frontFace(f.CW),a.frontface=l),a.lineWidth!==i.lineWidth&&(f.lineWidth(i.lineWidth),a.lineWidth=i.lineWidth),this._uPointSize&&f.uniform1f(this._uPointSize,i.pointSize),i.type){case"LambertMaterial":this._uMaterialAmbient&&f.uniform3fv(this._uMaterialAmbient,i.ambient),this._uMaterialColor&&f.uniform4f(this._uMaterialColor,i.color[0],i.color[1],i.color[2],i.alpha),this._uMaterialEmissive&&f.uniform3fv(this._uMaterialEmissive,i.emissive);break;case"PhongMaterial":this._uMaterialShininess&&f.uniform1f(this._uMaterialShininess,i.shininess),this._uMaterialAmbient&&f.uniform3fv(this._uMaterialAmbient,i.ambient),this._uMaterialDiffuse&&f.uniform3fv(this._uMaterialDiffuse,i.diffuse),this._uMaterialSpecular&&f.uniform3fv(this._uMaterialSpecular,i.specular),this._uMaterialEmissive&&f.uniform3fv(this._uMaterialEmissive,i.emissive),this._uAlphaModeCutoff&&f.uniform4f(this._uAlphaModeCutoff,1*i.alpha,1===i.alphaMode?1:0,i.alphaCutoff,0),e._ambientMap&&e._ambientMap._state.texture&&this._uMaterialAmbientMap&&(g.bindTexture(this._uMaterialAmbientMap,e._ambientMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uMaterialAmbientMapMatrix&&f.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,e._ambientMap._state.matrix)),e._diffuseMap&&e._diffuseMap._state.texture&&this._uDiffuseMap&&(g.bindTexture(this._uDiffuseMap,e._diffuseMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uDiffuseMapMatrix&&f.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,e._diffuseMap._state.matrix)),e._specularMap&&e._specularMap._state.texture&&this._uSpecularMap&&(g.bindTexture(this._uSpecularMap,e._specularMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uSpecularMapMatrix&&f.uniformMatrix4fv(this._uSpecularMapMatrix,!1,e._specularMap._state.matrix)),e._emissiveMap&&e._emissiveMap._state.texture&&this._uEmissiveMap&&(g.bindTexture(this._uEmissiveMap,e._emissiveMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uEmissiveMapMatrix&&f.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,e._emissiveMap._state.matrix)),e._alphaMap&&e._alphaMap._state.texture&&this._uAlphaMap&&(g.bindTexture(this._uAlphaMap,e._alphaMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uAlphaMapMatrix&&f.uniformMatrix4fv(this._uAlphaMapMatrix,!1,e._alphaMap._state.matrix)),e._reflectivityMap&&e._reflectivityMap._state.texture&&this._uReflectivityMap&&(g.bindTexture(this._uReflectivityMap,e._reflectivityMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,this._uReflectivityMapMatrix&&f.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,e._reflectivityMap._state.matrix)),e._normalMap&&e._normalMap._state.texture&&this._uNormalMap&&(g.bindTexture(this._uNormalMap,e._normalMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uNormalMapMatrix&&f.uniformMatrix4fv(this._uNormalMapMatrix,!1,e._normalMap._state.matrix)),e._occlusionMap&&e._occlusionMap._state.texture&&this._uOcclusionMap&&(g.bindTexture(this._uOcclusionMap,e._occlusionMap._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uOcclusionMapMatrix&&f.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,e._occlusionMap._state.matrix)),e._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&f.uniform1f(this._uDiffuseFresnelEdgeBias,e._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&f.uniform1f(this._uDiffuseFresnelCenterBias,e._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&f.uniform3fv(this._uDiffuseFresnelEdgeColor,e._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&f.uniform3fv(this._uDiffuseFresnelCenterColor,e._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&f.uniform1f(this._uDiffuseFresnelPower,e._diffuseFresnel.power)),e._specularFresnel&&(this._uSpecularFresnelEdgeBias&&f.uniform1f(this._uSpecularFresnelEdgeBias,e._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&f.uniform1f(this._uSpecularFresnelCenterBias,e._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&f.uniform3fv(this._uSpecularFresnelEdgeColor,e._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&f.uniform3fv(this._uSpecularFresnelCenterColor,e._specularFresnel.centerColor),this._uSpecularFresnelPower&&f.uniform1f(this._uSpecularFresnelPower,e._specularFresnel.power)),e._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&f.uniform1f(this._uAlphaFresnelEdgeBias,e._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&f.uniform1f(this._uAlphaFresnelCenterBias,e._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&f.uniform3fv(this._uAlphaFresnelEdgeColor,e._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&f.uniform3fv(this._uAlphaFresnelCenterColor,e._alphaFresnel.centerColor),this._uAlphaFresnelPower&&f.uniform1f(this._uAlphaFresnelPower,e._alphaFresnel.power)),e._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&f.uniform1f(this._uReflectivityFresnelEdgeBias,e._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&f.uniform1f(this._uReflectivityFresnelCenterBias,e._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&f.uniform3fv(this._uReflectivityFresnelEdgeColor,e._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&f.uniform3fv(this._uReflectivityFresnelCenterColor,e._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&f.uniform1f(this._uReflectivityFresnelPower,e._reflectivityFresnel.power)),e._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&f.uniform1f(this._uEmissiveFresnelEdgeBias,e._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&f.uniform1f(this._uEmissiveFresnelCenterBias,e._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&f.uniform3fv(this._uEmissiveFresnelEdgeColor,e._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&f.uniform3fv(this._uEmissiveFresnelCenterColor,e._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&f.uniform1f(this._uEmissiveFresnelPower,e._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&f.uniform3fv(this._uBaseColor,i.baseColor),this._uMaterialMetallic&&f.uniform1f(this._uMaterialMetallic,i.metallic),this._uMaterialRoughness&&f.uniform1f(this._uMaterialRoughness,i.roughness),this._uMaterialSpecularF0&&f.uniform1f(this._uMaterialSpecularF0,i.specularF0),this._uMaterialEmissive&&f.uniform3fv(this._uMaterialEmissive,i.emissive),this._uAlphaModeCutoff&&f.uniform4f(this._uAlphaModeCutoff,1*i.alpha,1===i.alphaMode?1:0,i.alphaCutoff,0);var m=e._baseColorMap;m&&m._state.texture&&this._uBaseColorMap&&(g.bindTexture(this._uBaseColorMap,m._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uBaseColorMapMatrix&&f.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,m._state.matrix));var n=e._metallicMap;n&&n._state.texture&&this._uMetallicMap&&(g.bindTexture(this._uMetallicMap,n._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uMetallicMapMatrix&&f.uniformMatrix4fv(this._uMetallicMapMatrix,!1,n._state.matrix));var o=e._roughnessMap;o&&o._state.texture&&this._uRoughnessMap&&(g.bindTexture(this._uRoughnessMap,o._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uRoughnessMapMatrix&&f.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,o._state.matrix));var p=e._metallicRoughnessMap;p&&p._state.texture&&this._uMetallicRoughnessMap&&(g.bindTexture(this._uMetallicRoughnessMap,p._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uMetallicRoughnessMapMatrix&&f.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,p._state.matrix));var q=e._emissiveMap;q&&q._state.texture&&this._uEmissiveMap&&(g.bindTexture(this._uEmissiveMap,q._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uEmissiveMapMatrix&&f.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,q._state.matrix));var r=e._occlusionMap;r&&e._occlusionMap._state.texture&&this._uOcclusionMap&&(g.bindTexture(this._uOcclusionMap,r._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uOcclusionMapMatrix&&f.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._state.matrix));var s=e._alphaMap;s&&s._state.texture&&this._uAlphaMap&&(g.bindTexture(this._uAlphaMap,s._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uAlphaMapMatrix&&f.uniformMatrix4fv(this._uAlphaMapMatrix,!1,s._state.matrix));var t=e._normalMap;t&&t._state.texture&&this._uNormalMap&&(g.bindTexture(this._uNormalMap,t._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uNormalMapMatrix&&f.uniformMatrix4fv(this._uNormalMapMatrix,!1,t._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&f.uniform3fv(this._uMaterialDiffuse,i.diffuse),this._uMaterialSpecular&&f.uniform3fv(this._uMaterialSpecular,i.specular),this._uMaterialGlossiness&&f.uniform1f(this._uMaterialGlossiness,i.glossiness),this._uMaterialReflectivity&&f.uniform1f(this._uMaterialReflectivity,i.reflectivity),this._uMaterialEmissive&&f.uniform3fv(this._uMaterialEmissive,i.emissive),this._uAlphaModeCutoff&&f.uniform4f(this._uAlphaModeCutoff,1*i.alpha,1===i.alphaMode?1:0,i.alphaCutoff,0);var u=e._diffuseMap;u&&u._state.texture&&this._uDiffuseMap&&(g.bindTexture(this._uDiffuseMap,u._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uDiffuseMapMatrix&&f.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,u._state.matrix));var v=e._specularMap;v&&v._state.texture&&this._uSpecularMap&&(g.bindTexture(this._uSpecularMap,v._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uSpecularMapMatrix&&f.uniformMatrix4fv(this._uSpecularMapMatrix,!1,v._state.matrix));var w=e._glossinessMap;w&&w._state.texture&&this._uGlossinessMap&&(g.bindTexture(this._uGlossinessMap,w._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uGlossinessMapMatrix&&f.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,w._state.matrix));var x=e._specularGlossinessMap;x&&x._state.texture&&this._uSpecularGlossinessMap&&(g.bindTexture(this._uSpecularGlossinessMap,x._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uSpecularGlossinessMapMatrix&&f.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,x._state.matrix));var q=e._emissiveMap;q&&q._state.texture&&this._uEmissiveMap&&(g.bindTexture(this._uEmissiveMap,q._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uEmissiveMapMatrix&&f.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,q._state.matrix));var r=e._occlusionMap;r&&r._state.texture&&this._uOcclusionMap&&(g.bindTexture(this._uOcclusionMap,r._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uOcclusionMapMatrix&&f.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._state.matrix));var s=e._alphaMap;s&&s._state.texture&&this._uAlphaMap&&(g.bindTexture(this._uAlphaMap,s._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uAlphaMapMatrix&&f.uniformMatrix4fv(this._uAlphaMapMatrix,!1,s._state.matrix));var t=e._normalMap;t&&t._state.texture&&this._uNormalMap&&(g.bindTexture(this._uNormalMap,t._state.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++,this._uNormalMapMatrix&&f.uniformMatrix4fv(this._uNormalMapMatrix,!1,t._state.matrix))}this._lastMaterialId=i.id}if(f.uniformMatrix4fv(this._uModelMatrix,f.FALSE,b.worldMatrix),this._uModelNormalMatrix&&f.uniformMatrix4fv(this._uModelNormalMatrix,f.FALSE,b.worldNormalMatrix),this._uClippable&&f.uniform1i(this._uClippable,h.clippable),this._uColorize){var y=h.colorize,z=this._lastColorize;z[0]===y[0]&&z[1]===y[1]&&z[2]===y[2]&&z[3]===y[3]||(f.uniform4fv(this._uColorize,y),z[0]=y[0],z[1]=y[1],z[2]=y[2],z[3]=y[3])}if(j.combined){var A=b._geometry._getVertexBufs();A.id!==this._lastVertexBufsId&&(A.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(A.positionsBuf,A.quantized?f.UNSIGNED_SHORT:f.FLOAT),a.bindArray++),A.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(A.normalsBuf,A.quantized?f.BYTE:f.FLOAT),a.bindArray++),A.uvBuf&&this._aUV&&(this._aUV.bindArrayBuffer(A.uvBuf,j.quantized?f.UNSIGNED_SHORT:f.FLOAT),a.bindArray++),A.colorsBuf&&this._aColor&&(this._aColor.bindArrayBuffer(A.colorsBuf),a.bindArray++),A.flagsBuf&&this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf,f.UNSIGNED_SHORT),a.bindArray++),this._lastVertexBufsId=A.id)}j.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&f.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,j.positionsDecodeMatrix),this._uUVDecodeMatrix&&f.uniformMatrix3fv(this._uUVDecodeMatrix,!1,j.uvDecodeMatrix),j.combined?j.indicesBufCombined&&(j.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(j.positionsBuf,j.quantized?f.UNSIGNED_SHORT:f.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(j.normalsBuf,j.quantized?f.BYTE:f.FLOAT),a.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(j.uvBuf,j.quantized?f.UNSIGNED_SHORT:f.FLOAT),a.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(j.colorsBuf),a.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(j.flagsBuf),a.bindArray++),j.indicesBuf?(j.indicesBuf.bind(),a.bindArray++):j.positions),this._lastGeometryId=j.id),j.combined?j.indicesBufCombined&&(f.drawElements(j.primitive,j.indicesBufCombined.numItems,j.indicesBufCombined.itemType,0),a.drawElements++):j.indicesBuf?(f.drawElements(j.primitive,j.indicesBuf.numItems,j.indicesBuf.itemType,0),a.drawElements++):j.positions&&(f.drawArrays(f.TRIANGLES,0,j.positions.numItems),a.drawArrays++)},xeogl.renderer.DrawRenderer.prototype._allocate=function(a){var b=a.scene.canvas.gl,c=a._material,d=a.scene._lightsState,e=a.scene._clipsState,f=a._material._state;if(this._program=new xeogl.renderer.Program(b,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);var g=this._program;this._uPositionsDecodeMatrix=g.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=g.getLocation("uvDecodeMatrix"),this._uModelMatrix=g.getLocation("modelMatrix"),this._uModelNormalMatrix=g.getLocation("modelNormalMatrix"),this._uViewMatrix=g.getLocation("viewMatrix"),this._uViewNormalMatrix=g.getLocation("viewNormalMatrix"),this._uProjMatrix=g.getLocation("projMatrix"),this._uGammaFactor=g.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[];for(var h,i=d.lights,j=0,k=i.length;j<k;j++){switch(h=i[j],h.type){case"ambient":this._uLightAmbient[j]=g.getLocation("lightAmbient");break;case"dir":this._uLightColor[j]=g.getLocation("lightColor"+j),this._uLightPos[j]=null,this._uLightDir[j]=g.getLocation("lightDir"+j);break;case"point":this._uLightColor[j]=g.getLocation("lightColor"+j),this._uLightPos[j]=g.getLocation("lightPos"+j),this._uLightDir[j]=null,this._uLightAttenuation[j]=g.getLocation("lightAttenuation"+j);break;case"spot":this._uLightColor[j]=g.getLocation("lightColor"+j),this._uLightPos[j]=g.getLocation("lightPos"+j),this._uLightDir[j]=g.getLocation("lightDir"+j),this._uLightAttenuation[j]=g.getLocation("lightAttenuation"+j)}h.shadow&&(this._uShadowViewMatrix[j]=g.getLocation("shadowViewMatrix"+j),this._uShadowProjMatrix[j]=g.getLocation("shadowProjMatrix"+j))}d.lightMaps.length>0&&(this._uLightMap="lightMap"),d.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uClips=[];for(var l=e.clips,j=0,k=l.length;j<k;j++)this._uClips.push({active:g.getLocation("clipActive"+j),pos:g.getLocation("clipPos"+j),dir:g.getLocation("clipDir"+j)});switch(this._uPointSize=g.getLocation("pointSize"),f.type){case"LambertMaterial":this._uMaterialColor=g.getLocation("materialColor"),this._uMaterialEmissive=g.getLocation("materialEmissive"),this._uAlphaModeCutoff=g.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=g.getLocation("materialAmbient"),this._uMaterialDiffuse=g.getLocation("materialDiffuse"),this._uMaterialSpecular=g.getLocation("materialSpecular"),this._uMaterialEmissive=g.getLocation("materialEmissive"),this._uAlphaModeCutoff=g.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=g.getLocation("materialShininess"),c._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=g.getLocation("ambientMapMatrix")),c._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=g.getLocation("diffuseMapMatrix")),c._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=g.getLocation("specularMapMatrix")),c._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=g.getLocation("emissiveMapMatrix")),c._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=g.getLocation("alphaMapMatrix")),c._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=g.getLocation("reflectivityMapMatrix")),c._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=g.getLocation("normalMapMatrix")),c._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=g.getLocation("occlusionMapMatrix")),c._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=g.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=g.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=g.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=g.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=g.getLocation("diffuseFresnelPower")),c._specularFresnel&&(this._uSpecularFresnelEdgeBias=g.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=g.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=g.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=g.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=g.getLocation("specularFresnelPower")),c._alphaFresnel&&(this._uAlphaFresnelEdgeBias=g.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=g.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=g.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=g.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=g.getLocation("alphaFresnelPower")),c._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=g.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=g.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=g.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=g.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=g.getLocation("reflectivityFresnelPower")),c._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=g.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=g.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=g.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=g.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=g.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=g.getLocation("materialBaseColor"),this._uMaterialMetallic=g.getLocation("materialMetallic"),this._uMaterialRoughness=g.getLocation("materialRoughness"),this._uMaterialSpecularF0=g.getLocation("materialSpecularF0"),this._uMaterialEmissive=g.getLocation("materialEmissive"),this._uAlphaModeCutoff=g.getLocation("materialAlphaModeCutoff"),c._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=g.getLocation("baseColorMapMatrix")),c._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=g.getLocation("metallicMapMatrix")),c._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=g.getLocation("roughnessMapMatrix")),c._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=g.getLocation("metallicRoughnessMapMatrix")),c._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=g.getLocation("emissiveMapMatrix")),c._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=g.getLocation("occlusionMapMatrix")),c._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=g.getLocation("alphaMapMatrix")),c._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=g.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=g.getLocation("materialDiffuse"),this._uMaterialSpecular=g.getLocation("materialSpecular"),this._uMaterialGlossiness=g.getLocation("materialGlossiness"),this._uMaterialReflectivity=g.getLocation("reflectivityFresnel"),this._uMaterialEmissive=g.getLocation("materialEmissive"),this._uAlphaModeCutoff=g.getLocation("materialAlphaModeCutoff"),c._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=g.getLocation("diffuseMapMatrix")),c._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=g.getLocation("specularMapMatrix")),c._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=g.getLocation("glossinessMapMatrix")),c._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=g.getLocation("materialSpecularGlossinessMapMatrix")),c._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=g.getLocation("emissiveMapMatrix")),c._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=g.getLocation("occlusionMapMatrix")),c._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=g.getLocation("alphaMapMatrix")),c._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=g.getLocation("normalMapMatrix"))}this._aPosition=g.getAttribute("position"),this._aNormal=g.getAttribute("normal"),this._aUV=g.getAttribute("uv"),this._aColor=g.getAttribute("color"),this._aFlags=g.getAttribute("flags"),this._uClippable=g.getLocation("clippable"),this._uColorize=g.getLocation("colorize"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},xeogl.renderer.DrawRenderer.prototype._bindProgram=function(a){var b,c=(xeogl.math,xeogl.WEBGL_INFO.MAX_TEXTURE_UNITS),d=this._scene,e=d.canvas.gl,f=d._lightsState,g=d._clipsState,h=(f.lights,this._program);h.bind(),a.useProgram++,a.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1;var i=d.camera,j=i._state;e.uniformMatrix4fv(this._uViewMatrix,!1,j.matrix),e.uniformMatrix4fv(this._uViewNormalMatrix,!1,j.normalMatrix),e.uniformMatrix4fv(this._uProjMatrix,!1,i._project._state.matrix);for(var k=0,l=f.lights.length;k<l;k++)if(b=f.lights[k],this._uLightAmbient[k])e.uniform4f(this._uLightAmbient[k],b.color[0],b.color[1],b.color[2],b.intensity);else if(this._uLightColor[k]&&e.uniform4f(this._uLightColor[k],b.color[0],b.color[1],b.color[2],b.intensity),this._uLightPos[k]&&(e.uniform3fv(this._uLightPos[k],b.pos),this._uLightAttenuation[k]&&e.uniform1f(this._uLightAttenuation[k],b.attenuation)),this._uLightDir[k]&&e.uniform3fv(this._uLightDir[k],b.dir),b.shadow){this._uShadowViewMatrix[k]&&e.uniformMatrix4fv(this._uShadowViewMatrix[k],!1,b.getShadowViewMatrix()),this._uShadowProjMatrix[k]&&e.uniformMatrix4fv(this._uShadowProjMatrix[k],!1,b.getShadowProjMatrix());var m=b.getShadowRenderBuf();m&&(h.bindTexture("shadowMap"+k,m.getTexture(),a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++)}if(f.lightMaps.length>0&&f.lightMaps[0].texture&&this._uLightMap&&(h.bindTexture(this._uLightMap,f.lightMaps[0].texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++),f.reflectionMaps.length>0&&f.reflectionMaps[0].texture&&this._uReflectionMap&&(h.bindTexture(this._uReflectionMap,f.reflectionMaps[0].texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%c,a.bindTexture++),
g.clips.length>0)for(var n,o,p,q,r=d._clipsState.clips,k=0,l=this._uClips.length;k<l;k++)n=this._uClips[k],o=n.active,p=r[k],o&&e.uniform1i(o,p.active),q=n.pos,q&&e.uniform3fv(n.pos,p.pos),n.dir&&e.uniform3fv(n.dir,p.dir);this._uGammaFactor&&e.uniform1f(this._uGammaFactor,d.gammaFactor),this._baseTextureUnit=a.textureUnit}}(),function(){"use strict";function a(a){if(!a._state.receiveShadow)return!1;var b=a.scene._lightsState.lights;if(!b||0===b.length)return!1;for(var c=0,d=b.length;c<d;c++)if(b[c].shadow)return!0;return!1}function b(a){if(!a._geometry._state.uv)return!1;var b=a._material;return!!(b._ambientMap||b._occlusionMap||b._baseColorMap||b._diffuseMap||b._alphaMap||b._specularMap||b._glossinessMap||b._specularGlossinessMap||b._emissiveMap||b._metallicMap||b._roughnessMap||b._metallicRoughnessMap||b._reflectivityMap||b._normalMap)}function c(a){var b=a._geometry._state.primitiveName;return!(!a._geometry._state.autoVertexNormals&&!a._geometry._state.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function d(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}function e(a){var b,c,d,e=a.scene._clipsState,f=a.scene._lightsState,g=a._geometry._state,h=a._state.billboard,i=a._state.stationary,j=e.clips.length>0,k=!!g.quantized,l=[];if(l.push("// Lambertian drawing vertex shader"),l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),k&&l.push("uniform mat4 positionsDecodeMatrix;"),j&&l.push("varying vec4 vWorldPosition;"),l.push("uniform vec4 lightAmbient;"),l.push("uniform vec4 materialColor;"),g.normals){for(l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;"),b=0,c=f.lights.length;b<c;b++)d=f.lights[b],"ambient"!==d.type&&(l.push("uniform vec4 lightColor"+b+";"),"dir"===d.type&&l.push("uniform vec3 lightDir"+b+";"),"point"===d.type&&l.push("uniform vec3 lightPos"+b+";"),"spot"===d.type&&(l.push("uniform vec3 lightPos"+b+";"),l.push("uniform vec3 lightDir"+b+";")));k&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}if(l.push("varying vec4 vColor;"),"points"===g.primitiveName&&l.push("uniform float pointSize;"),"spherical"!==h&&"cylindrical"!==h||(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===h&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}")),l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),k&&l.push("localPosition = positionsDecodeMatrix * localPosition;"),g.normals&&(k?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),i&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===h||"cylindrical"===h?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),g.normals&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),g.normals&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),g.normals)for(b=0,c=f.lights.length;b<c;b++)if(d=f.lights[b],"ambient"!==d.type){if("dir"===d.type)"view"===d.space?l.push("viewLightDir = normalize(lightDir"+b+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+b+", 0.0)).xyz);");else if("point"===d.type)"view"===d.space?l.push("viewLightDir = normalize(lightPos"+b+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+b+", 0.0)).xyz);");else{if("spot"!==d.type)continue;"view"===d.space?l.push("viewLightDir = normalize(lightDir"+b+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+b+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+b+".rgb * lightColor"+b+".a);")}return l.push("vColor = vec4((reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),j&&l.push("vWorldPosition = worldPosition;"),"points"===g.primitiveName&&l.push("gl_PointSize = pointSize;"),l.push("   gl_Position = projMatrix * viewPosition;"),l.push("}"),l}function f(a){var b,c,d=a.scene,e=d._clipsState,f=(a._material._state,a._geometry._state),g=e.clips.length>0,h=!1,i=d.gammaOutput,j=[];if(j.push("// Lambertian drawing fragment shader"),j.push("precision lowp float;"),g)for(j.push("varying vec4 vWorldPosition;"),j.push("uniform bool clippable;"),b=0,c=e.clips.length;b<c;b++)j.push("uniform bool clipActive"+b+";"),j.push("uniform vec3 clipPos"+b+";"),j.push("uniform vec3 clipDir"+b+";");if(j.push("varying vec4 vColor;"),i&&(j.push("uniform float gammaFactor;"),j.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),j.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),j.push("}")),j.push("void main(void) {"),g){for(j.push("if (clippable) {"),j.push("  float dist = 0.0;"),b=0,c=e.clips.length;b<c;b++)j.push("if (clipActive"+b+") {"),j.push("   dist += clamp(dot(-clipDir"+b+".xyz, vWorldPosition.xyz - clipPos"+b+".xyz), 0.0, 1000.0);"),j.push("}");j.push("  if (dist > 0.0) { discard; }"),h&&(j.push("  if (gl_FrontFacing == false) {"),j.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),j.push("     return;"),j.push("  }")),j.push("}")}return"points"===f.primitiveName&&(j.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),j.push("float r = dot(cxy, cxy);"),j.push("if (r > 1.0) {"),j.push("   discard;"),j.push("}")),i?j.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):j.push("gl_FragColor = vColor;"),j.push("}"),j}function g(d){var e,f,g,h=d.scene,i=d._material,j=d._state,k=h._clipsState,l=d._geometry._state,m=(d._material._state,h._lightsState),n=j.billboard,o=j.stationary,p=b(d),q=c(d),r=k.clips.length>0,s=a(d),t=!!l.quantized,u=[];if(q&&i._normalMap&&u.push("#extension GL_OES_standard_derivatives : enable"),u.push("// Drawing vertex shader"),u.push("attribute  vec3 position;"),t&&u.push("uniform mat4 positionsDecodeMatrix;"),u.push("uniform  mat4 modelMatrix;"),u.push("uniform  mat4 viewMatrix;"),u.push("uniform  mat4 projMatrix;"),u.push("varying  vec3 vViewPosition;"),r&&u.push("varying vec4 vWorldPosition;"),m.lightMaps.length>0&&u.push("varying    vec3 vWorldNormal;"),q){for(u.push("attribute  vec3 normal;"),u.push("uniform    mat4 modelNormalMatrix;"),u.push("uniform    mat4 viewNormalMatrix;"),u.push("varying    vec3 vViewNormal;"),e=0,f=m.lights.length;e<f;e++)g=m.lights[e],"ambient"!==g.type&&("dir"===g.type&&u.push("uniform vec3 lightDir"+e+";"),"point"===g.type&&u.push("uniform vec3 lightPos"+e+";"),"spot"===g.type&&(u.push("uniform vec3 lightPos"+e+";"),u.push("uniform vec3 lightDir"+e+";")),"dir"===g.type&&"view"===g.space||u.push("varying vec4 vViewLightReverseDirAndDist"+e+";"));t&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}if(p&&(u.push("attribute vec2 uv;"),u.push("varying vec2 vUV;"),t&&u.push("uniform mat3 uvDecodeMatrix;")),l.colors&&(u.push("attribute vec4 color;"),u.push("varying vec4 vColor;")),"points"===l.primitiveName&&u.push("uniform float pointSize;"),"spherical"!==n&&"cylindrical"!==n||(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = 1.0;"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),"spherical"===n&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = 1.0;"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}")),s&&u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),t&&u.push("localPosition = positionsDecodeMatrix * localPosition;"),q&&(t?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2     = viewNormalMatrix;")),u.push("mat4 viewMatrix2           = viewMatrix;"),u.push("mat4 modelMatrix2          = modelMatrix;"),o&&u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===n||"cylindrical"===n?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),q&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),q)for(u.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),m.lightMaps.length>0&&u.push("vWorldNormal = worldNormal;"),u.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),u.push("vec3 tmpVec3;"),u.push("float lightDist;"),e=0,f=m.lights.length;e<f;e++)g=m.lights[e],"ambient"!==g.type&&("dir"===g.type&&"world"===g.space&&(u.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+e+", 0.0) ).xyz;"),u.push("vViewLightReverseDirAndDist"+e+" = vec4(-tmpVec3, 0.0);")),"point"===g.type&&("world"===g.space?(u.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+e+", 1.0)).xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")):(u.push("tmpVec3 = lightPos"+e+".xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")),u.push("vViewLightReverseDirAndDist"+e+" = vec4(tmpVec3, lightDist);")));if(p&&(t?u.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):u.push("vUV = uv;")),l.colors&&u.push("vColor = color;"),"points"===l.primitiveName&&u.push("gl_PointSize = pointSize;"),r&&u.push("vWorldPosition = worldPosition;"),u.push("   vViewPosition = viewPosition.xyz;"),u.push("   gl_Position = projMatrix * viewPosition;"),u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),s)for(u.push("vec4 tempx; "),e=0,f=m.lights.length;e<f;e++)m.lights[e].shadow&&u.push("vShadowPosFromLight"+e+" = texUnitConverter * shadowProjMatrix"+e+" * (shadowViewMatrix"+e+" * worldPosition); ");return u.push("}"),u}function h(b){var e,f,g,h=b.scene,j=h.canvas.gl,k=b._material,l=b._geometry._state,m=b.scene._clipsState,n=b.scene._lightsState,o=b._material._state,p=m.clips.length>0,q=c(b),r=l.uv,s=!1,t="PhongMaterial"===o.type,u="MetallicMaterial"===o.type,v="SpecularMaterial"===o.type,w=a(b),x=(h.gammaInput,h.gammaOutput),y=[];if(y.push("// Fragment vertex shader"),q&&k._normalMap&&y.push("#extension GL_OES_standard_derivatives : enable"),y.push("precision "+d(j)+" float;"),w&&(y.push("float unpackDepth (vec4 color) {"),y.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),y.push("  return dot(color, bitShift);"),y.push("}")),y.push("uniform float gammaFactor;"),y.push("vec4 linearToLinear( in vec4 value ) {"),y.push("  return value;"),y.push("}"),y.push("vec4 sRGBToLinear( in vec4 value ) {"),y.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),y.push("}"),y.push("vec4 gammaToLinear( in vec4 value) {"),y.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),y.push("}"),x&&(y.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),y.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),y.push("}")),p){y.push("varying vec4 vWorldPosition;"),y.push("uniform bool clippable;");for(var e=0;e<m.clips.length;e++)y.push("uniform bool clipActive"+e+";"),y.push("uniform vec3 clipPos"+e+";"),y.push("uniform vec3 clipDir"+e+";")}if(q&&(n.lightMaps.length>0&&(y.push("uniform samplerCube lightMap;"),y.push("uniform mat4 viewNormalMatrix;")),n.reflectionMaps.length>0&&y.push("uniform samplerCube reflectionMap;"),(n.lightMaps.length>0||n.reflectionMaps.length>0)&&y.push("uniform mat4 viewMatrix;"),y.push("#define PI 3.14159265359"),y.push("#define RECIPROCAL_PI 0.31830988618"),y.push("#define RECIPROCAL_PI2 0.15915494"),y.push("#define EPSILON 1e-6"),y.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),y.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),y.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),y.push("}"),y.push("struct IncidentLight {"),y.push("   vec3 color;"),y.push("   vec3 direction;"),y.push("};"),y.push("struct ReflectedLight {"),y.push("   vec3 diffuse;"),y.push("   vec3 specular;"),y.push("};"),y.push("struct Geometry {"),y.push("   vec3 position;"),y.push("   vec3 viewNormal;"),y.push("   vec3 worldNormal;"),y.push("   vec3 viewEyeDir;"),y.push("};"),y.push("struct Material {"),y.push("   vec3    diffuseColor;"),y.push("   float   specularRoughness;"),y.push("   vec3    specularColor;"),y.push("   float   shine;"),y.push("};"),t&&((n.lightMaps.length>0||n.reflectionMaps.length>0)&&(y.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.lightMaps.length>0&&(y.push("   vec3 irradiance = "+i[n.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),y.push("   irradiance *= PI;"),y.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),y.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),n.reflectionMaps.length>0&&(y.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),y.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),y.push("   reflectedLight.specular     += radiance;")),y.push("}")),y.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),y.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),y.push("   vec3 irradiance = dotNL * directLight.color * PI;"),y.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),y.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),y.push("}")),(u||v)&&(y.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),y.push("   float r = ggxRoughness + 0.0001;"),y.push("   return (2.0 / (r * r) - 2.0);"),y.push("}"),y.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),y.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),y.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),y.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),y.push("}"),n.reflectionMaps.length>0&&(y.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),y.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),y.push("   vec3 envMapColor = "+i[n.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),y.push("  return envMapColor;"),y.push("}")),y.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),y.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),y.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),y.push("}"),y.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),y.push("   float a2 = ( alpha * alpha );"),y.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),y.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),y.push("   return 1.0 / ( gl * gv );"),y.push("}"),y.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),y.push("   float a2 = ( alpha * alpha );"),y.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),y.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),y.push("   return 0.5 / max( gv + gl, EPSILON );"),y.push("}"),y.push("float D_GGX(const in float alpha, const in float dotNH) {"),y.push("   float a2 = ( alpha * alpha );"),y.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),y.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),y.push("}"),y.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),y.push("   float alpha = ( roughness * roughness );"),y.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),y.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),y.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),y.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),y.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),y.push("   vec3  F = F_Schlick( specularColor, dotLH );"),y.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),y.push("   float D = D_GGX( alpha, dotNH );"),y.push("   return F * (G * D);"),y.push("}"),y.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),y.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),y.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),y.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),y.push("   vec4 r = roughness * c0 + c1;"),y.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),y.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),y.push("   return specularColor * AB.x + AB.y;"),y.push("}"),(n.lightMaps.length>0||n.reflectionMaps.length>0)&&(y.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.lightMaps.length>0&&(y.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),y.push("   irradiance *= PI;"),y.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),y.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),n.reflectionMaps.length>0&&(y.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),y.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),y.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),y.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),y.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),y.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),y.push("}")),y.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),y.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),y.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),y.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),y.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),y.push("}"))),y.push("varying vec3 vViewPosition;"),l.colors&&y.push("varying vec4 vColor;"),r&&(q&&k._normalMap||k._ambientMap||k._baseColorMap||k._diffuseMap||k._emissiveMap||k._metallicMap||k._roughnessMap||k._metallicRoughnessMap||k._specularMap||k._glossinessMap||k._specularGlossinessMap||k._occlusionMap||k._alphaMap)&&y.push("varying vec2 vUV;"),q&&(n.lightMaps.length>0&&y.push("varying vec3 vWorldNormal;"),y.push("varying vec3 vViewNormal;")),o.ambient&&y.push("uniform vec3 materialAmbient;"),o.baseColor&&y.push("uniform vec3 materialBaseColor;"),void 0!==o.alpha&&null!==o.alpha&&y.push("uniform vec4 materialAlphaModeCutoff;"),o.emissive&&y.push("uniform vec3 materialEmissive;"),o.diffuse&&y.push("uniform vec3 materialDiffuse;"),void 0!==o.glossiness&&null!==o.glossiness&&y.push("uniform float materialGlossiness;"),void 0!==o.shininess&&null!==o.shininess&&y.push("uniform float materialShininess;"),o.specular&&y.push("uniform vec3 materialSpecular;"),void 0!==o.metallic&&null!==o.metallic&&y.push("uniform float materialMetallic;"),void 0!==o.roughness&&null!==o.roughness&&y.push("uniform float materialRoughness;"),void 0!==o.specularF0&&null!==o.specularF0&&y.push("uniform float materialSpecularF0;"),r&&k._ambientMap&&(y.push("uniform sampler2D ambientMap;"),k._ambientMap._state.matrix&&y.push("uniform mat4 ambientMapMatrix;")),r&&k._baseColorMap&&(y.push("uniform sampler2D baseColorMap;"),k._baseColorMap._state.matrix&&y.push("uniform mat4 baseColorMapMatrix;")),r&&k._diffuseMap&&(y.push("uniform sampler2D diffuseMap;"),k._diffuseMap._state.matrix&&y.push("uniform mat4 diffuseMapMatrix;")),r&&k._emissiveMap&&(y.push("uniform sampler2D emissiveMap;"),k._emissiveMap._state.matrix&&y.push("uniform mat4 emissiveMapMatrix;")),q&&r&&k._metallicMap&&(y.push("uniform sampler2D metallicMap;"),k._metallicMap._state.matrix&&y.push("uniform mat4 metallicMapMatrix;")),q&&r&&k._roughnessMap&&(y.push("uniform sampler2D roughnessMap;"),k._roughnessMap._state.matrix&&y.push("uniform mat4 roughnessMapMatrix;")),q&&r&&k._metallicRoughnessMap&&(y.push("uniform sampler2D metallicRoughnessMap;"),k._metallicRoughnessMap._state.matrix&&y.push("uniform mat4 metallicRoughnessMapMatrix;")),q&&k._normalMap&&(y.push("uniform sampler2D normalMap;"),k._normalMap._state.matrix&&y.push("uniform mat4 normalMapMatrix;"),y.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),y.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),y.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),y.push("      vec2 st0 = dFdx( uv.st );"),y.push("      vec2 st1 = dFdy( uv.st );"),y.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),y.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),y.push("      vec3 N = normalize( surf_norm );"),y.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),y.push("      mat3 tsn = mat3( S, T, N );"),y.push("      return normalize( tsn * mapN );"),y.push("}")),r&&k._occlusionMap&&(y.push("uniform sampler2D occlusionMap;"),k._occlusionMap._state.matrix&&y.push("uniform mat4 occlusionMapMatrix;")),r&&k._alphaMap&&(y.push("uniform sampler2D alphaMap;"),k._alphaMap._state.matrix&&y.push("uniform mat4 alphaMapMatrix;")),q&&r&&k._specularMap&&(y.push("uniform sampler2D specularMap;"),k._specularMap._state.matrix&&y.push("uniform mat4 specularMapMatrix;")),q&&r&&k._glossinessMap&&(y.push("uniform sampler2D glossinessMap;"),k._glossinessMap._state.matrix&&y.push("uniform mat4 glossinessMapMatrix;")),q&&r&&k._specularGlossinessMap&&(y.push("uniform sampler2D materialSpecularGlossinessMap;"),k._specularGlossinessMap._state.matrix&&y.push("uniform mat4 materialSpecularGlossinessMapMatrix;")),q&&(k._diffuseFresnel||k._specularFresnel||k._alphaFresnel||k._emissiveFresnel||k._reflectivityFresnel)&&(y.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),y.push("    float fr = abs(dot(eyeDir, normal));"),y.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),y.push("    return pow(finalFr, power);"),y.push("}"),k._diffuseFresnel&&(y.push("uniform float  diffuseFresnelCenterBias;"),y.push("uniform float  diffuseFresnelEdgeBias;"),y.push("uniform float  diffuseFresnelPower;"),y.push("uniform vec3   diffuseFresnelCenterColor;"),y.push("uniform vec3   diffuseFresnelEdgeColor;")),k._specularFresnel&&(y.push("uniform float  specularFresnelCenterBias;"),y.push("uniform float  specularFresnelEdgeBias;"),y.push("uniform float  specularFresnelPower;"),y.push("uniform vec3   specularFresnelCenterColor;"),y.push("uniform vec3   specularFresnelEdgeColor;")),k._alphaFresnel&&(y.push("uniform float  alphaFresnelCenterBias;"),y.push("uniform float  alphaFresnelEdgeBias;"),y.push("uniform float  alphaFresnelPower;"),y.push("uniform vec3   alphaFresnelCenterColor;"),y.push("uniform vec3   alphaFresnelEdgeColor;")),k._reflectivityFresnel&&(y.push("uniform float  materialSpecularF0FresnelCenterBias;"),y.push("uniform float  materialSpecularF0FresnelEdgeBias;"),y.push("uniform float  materialSpecularF0FresnelPower;"),y.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),y.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),k._emissiveFresnel&&(y.push("uniform float  emissiveFresnelCenterBias;"),y.push("uniform float  emissiveFresnelEdgeBias;"),y.push("uniform float  emissiveFresnelPower;"),y.push("uniform vec3   emissiveFresnelCenterColor;"),y.push("uniform vec3   emissiveFresnelEdgeColor;"))),y.push("uniform vec4   lightAmbient;"),q)for(e=0,f=n.lights.length;e<f;e++)g=n.lights[e],"ambient"!==g.type&&(y.push("uniform vec4 lightColor"+e+";"),"point"===g.type&&y.push("uniform vec3 lightAttenuation"+e+";"),"dir"===g.type&&"view"===g.space&&y.push("uniform vec3 lightDir"+e+";"),"point"===g.type&&"view"===g.space?y.push("uniform vec3 lightPos"+e+";"):y.push("varying vec4 vViewLightReverseDirAndDist"+e+";"));if(w)for(e=0,f=n.lights.length;e<f;e++)n.lights[e].shadow&&(y.push("varying vec4 vShadowPosFromLight"+e+";"),y.push("uniform sampler2D shadowMap"+e+";"));if(y.push("uniform vec4 colorize;"),y.push("void main(void) {"),p){y.push("if (clippable) {"),y.push("  float dist = 0.0;");for(var e=0;e<m.clips.length;e++)y.push("if (clipActive"+e+") {"),y.push("   dist += clamp(dot(-clipDir"+e+".xyz, vWorldPosition.xyz - clipPos"+e+".xyz), 0.0, 1000.0);"),y.push("}");y.push("  if (dist > 0.0) { discard; }"),s&&(y.push("  if (gl_FrontFacing == false) {"),y.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),y.push("     return;"),y.push("  }")),y.push("}")}if("points"===l.primitiveName&&(y.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),y.push("float r = dot(cxy, cxy);"),y.push("if (r > 1.0) {"),y.push("   discard;"),y.push("}")),y.push("float occlusion = 1.0;"),o.ambient?y.push("vec3 ambientColor = materialAmbient;"):y.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);"),o.diffuse?y.push("vec3 diffuseColor = materialDiffuse;"):o.baseColor?y.push("vec3 diffuseColor = materialBaseColor;"):y.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);"),l.colors&&y.push("diffuseColor *= vColor.rgb;"),o.emissive?y.push("vec3 emissiveColor = materialEmissive;"):y.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);"),o.specular?y.push("vec3 specular = materialSpecular;"):y.push("vec3 specular = vec3(1.0, 1.0, 1.0);"),void 0!==o.alpha?y.push("float alpha = materialAlphaModeCutoff[0];"):y.push("float alpha = 1.0;"),l.colors&&y.push("alpha *= vColor.a;"),void 0!==o.glossiness?y.push("float glossiness = materialGlossiness;"):y.push("float glossiness = 1.0;"),void 0!==o.metallic?y.push("float metallic = materialMetallic;"):y.push("float metallic = 1.0;"),void 0!==o.roughness?y.push("float roughness = materialRoughness;"):y.push("float roughness = 1.0;"),void 0!==o.specularF0?y.push("float specularF0 = materialSpecularF0;"):y.push("float specularF0 = 1.0;"),r&&(q&&k._normalMap||k._ambientMap||k._baseColorMap||k._diffuseMap||k._occlusionMap||k._emissiveMap||k._metallicMap||k._roughnessMap||k._metallicRoughnessMap||k._specularMap||k._glossinessMap||k._specularGlossinessMap||k._alphaMap)&&(y.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),y.push("vec2 textureCoord;")),r&&k._ambientMap&&(k._ambientMap._state.matrix?y.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),y.push("ambientTexel = "+i[k._ambientMap._state.encoding]+"(ambientTexel);"),y.push("ambientColor *= ambientTexel.rgb;")),r&&k._diffuseMap&&(k._diffuseMap._state.matrix?y.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),y.push("diffuseTexel = "+i[k._diffuseMap._state.encoding]+"(diffuseTexel);"),y.push("diffuseColor *= diffuseTexel.rgb;"),y.push("alpha *= diffuseTexel.a;")),r&&k._baseColorMap&&(k._baseColorMap._state.matrix?y.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),y.push("baseColorTexel = "+i[k._baseColorMap._state.encoding]+"(baseColorTexel);"),y.push("diffuseColor *= baseColorTexel.rgb;"),y.push("alpha *= baseColorTexel.a;")),r&&k._emissiveMap&&(k._emissiveMap._state.matrix?y.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),y.push("emissiveTexel = "+i[k._emissiveMap._state.encoding]+"(emissiveTexel);"),y.push("emissiveColor *= emissiveTexel.rgb;")),r&&k._alphaMap&&(k._alphaMap._state.matrix?y.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("alpha *= texture2D(alphaMap, textureCoord).r;")),r&&k._occlusionMap&&(k._occlusionMap._state.matrix?y.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("occlusion *= texture2D(occlusionMap, textureCoord).r;")),q&&(n.lights.length>0||n.lightMaps.length>0||n.reflectionMaps.length>0)){r&&k._normalMap?(k._normalMap._state.matrix?y.push("textureCoord = (normalMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),
y.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):y.push("vec3 viewNormal = normalize(vViewNormal);"),r&&k._specularMap&&(k._specularMap._state.matrix?y.push("textureCoord = (specularMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("specular *= texture2D(specularMap, textureCoord).rgb;")),r&&k._glossinessMap&&(k._glossinessMap._state.matrix?y.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),r&&k._specularGlossinessMap&&(k._specularGlossinessMap._state.matrix?y.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),y.push("specular *= specGlossRGB.rgb;"),y.push("glossiness *= specGlossRGB.a;")),r&&k._metallicMap&&(k._metallicMap._state.matrix?y.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("metallic *= texture2D(metallicMap, textureCoord).r;")),r&&k._roughnessMap&&(k._roughnessMap._state.matrix?y.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),r&&k._metallicRoughnessMap&&(k._metallicRoughnessMap._state.matrix?y.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):y.push("textureCoord = texturePos.xy;"),y.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),y.push("metallic *= metalRoughRGB.b;"),y.push("roughness *= metalRoughRGB.g;")),y.push("vec3 viewEyeDir = normalize(-vViewPosition);"),k._diffuseFresnel&&(y.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),y.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),k._specularFresnel&&(y.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),y.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),k._alphaFresnel&&(y.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),y.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),k._emissiveFresnel&&(y.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),y.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),y.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),y.push("   discard;"),y.push("}"),y.push("IncidentLight  light;"),y.push("Material       material;"),y.push("Geometry       geometry;"),y.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),y.push("vec3           viewLightDir;"),t&&(y.push("material.diffuseColor      = diffuseColor;"),y.push("material.specularColor     = specular;"),y.push("material.shine             = materialShininess;")),v&&(y.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),y.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),y.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),y.push("material.specularColor     = specular;")),u&&(y.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),y.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),y.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),y.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),y.push("geometry.position      = vViewPosition;"),n.lightMaps.length>0&&y.push("geometry.worldNormal   = normalize(vWorldNormal);"),y.push("geometry.viewNormal    = viewNormal;"),y.push("geometry.viewEyeDir    = viewEyeDir;"),t&&(n.lightMaps.length>0||n.reflectionMaps.length>0)&&y.push("computePhongLightMapping(geometry, material, reflectedLight);"),(v||u)&&(n.lightMaps.length>0||n.reflectionMaps.length>0)&&y.push("computePBRLightMapping(geometry, material, reflectedLight);"),y.push("float shadow = 1.0;"),y.push("float shadowAcneRemover = 0.0007;"),y.push("vec3 fragmentDepth;"),y.push("float texelSize = 1.0 / 1024.0;"),y.push("float amountInLight = 0.0;"),y.push("vec3 shadowCoord;"),y.push("vec4 rgbaDepth;"),y.push("float depth;");for(e=0,f=n.lights.length;e<f;e++)g=n.lights[e],"ambient"!==g.type&&("dir"===g.type&&"view"===g.space?y.push("viewLightDir = -normalize(lightDir"+e+");"):"point"===g.type&&"view"===g.space?y.push("viewLightDir = normalize(lightPos"+e+" - vViewPosition);"):y.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+e+".xyz);"),w&&g.shadow?(y.push("shadow = 0.0;"),y.push("fragmentDepth = vShadowPosFromLight"+e+".xyz;"),y.push("fragmentDepth.z -= shadowAcneRemover;"),y.push("for (int x = -3; x <= 3; x++) {"),y.push("  for (int y = -3; y <= 3; y++) {"),y.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+e+", fragmentDepth.xy + vec2(x, y) * texelSize));"),y.push("      if (fragmentDepth.z < texelDepth) {"),y.push("          shadow += 1.0;"),y.push("      }"),y.push("  }"),y.push("}"),y.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a * (shadow / 49.0));")):y.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a );"),y.push("light.direction = viewLightDir;"),t&&y.push("computePhongLighting(light, geometry, material, reflectedLight);"),(v||u)&&y.push("computePBRLighting(light, geometry, material, reflectedLight);"));t?(y.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),y.push("vec3 outgoingLight =  ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;")):y.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (shadow * occlusion * reflectedLight.specular) + emissiveColor;")}else y.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),y.push("vec3 outgoingLight = emissiveColor + ambientColor;");return y.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),x&&y.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);"),y.push("}"),y}xeogl.renderer.DrawShaderSource=function(a){"LambertMaterial"===a._material._state.type?(this.vertex=e(a),this.fragment=f(a)):(this.vertex=g(a),this.fragment=h(a))};const i={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.OutlineRenderer=function(a,b){this._init(a,b)};var b={};xeogl.renderer.OutlineRenderer.get=function(a){var c=[a.scene.canvas.canvas.id,a.scene.gammaOutput?"go":"",a.scene._clipsState.getHash(),a._geometry._state.hash,a._state.hash].join(";"),d=b[c];return d||(d=new xeogl.renderer.OutlineRenderer(c,a),b[c]=d,xeogl.stats.memory.programs++),d._useCount++,d},xeogl.renderer.OutlineRenderer.prototype.put=function(){0==--this._useCount&&(a.removeItem(this.id),this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.OutlineRenderer.prototype._init=function(b,c){if(this.id=a.addItem({}),this._scene=c.scene,this._hash=b,this._shaderSource=new xeogl.renderer.OutlineShaderSource(c),this._program=new xeogl.renderer.Program(c.scene.canvas.gl,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var d=this._program;this._uPositionsDecodeMatrix=d.getLocation("positionsDecodeMatrix"),this._uModelMatrix=d.getLocation("modelMatrix"),this._uViewMatrix=d.getLocation("viewMatrix"),this._uProjMatrix=d.getLocation("projMatrix"),this._uClips=[];for(var e=c.scene._clipsState.clips,f=0,g=e.length;f<g;f++)this._uClips.push({active:d.getLocation("clipActive"+f),pos:d.getLocation("clipPos"+f),dir:d.getLocation("clipDir"+f)});this._uColor=d.getLocation("color"),this._uWidth=d.getLocation("width"),this._aPosition=d.getAttribute("position"),this._aNormal=d.getAttribute("normal"),this._uClippable=d.getLocation("clippable"),this._uGammaFactor=d.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.OutlineRenderer.prototype._bindProgram=function(a){var b=this._scene,c=b.canvas.gl,d=this._program,e=b._clipsState;if(d.bind(),a.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,c.uniformMatrix4fv(this._uViewMatrix,!1,b.viewTransform.matrix),c.uniformMatrix4fv(this._uProjMatrix,!1,b.projTransform.matrix),e.clips.length>0)for(var f,g,h,i,j=0,k=this._uClips.length;j<k;j++)f=this._uClips[j],g=f.active,h=e.clips[j],g&&c.uniform1i(g,h.active),i=f.pos,i&&c.uniform3fv(f.pos,h.pos),f.dir&&c.uniform3fv(f.dir,h.dir);this._uGammaFactor&&c.uniform1f(this._uGammaFactor,b.gammaFactor)},xeogl.renderer.OutlineRenderer.prototype.drawMesh=function(a,b){var c=this._scene,d=c.canvas.gl,e=b.outlineMaterial,f=b._state,g=b._geometry._state;if(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a)),e.id!==this._lastMaterialId){if(this._uWidth&&d.uniform1f(this._uWidth,e.width),this._uColor){var h=e.color,i=e.alpha;d.uniform4f(this._uColor,h[0],h[1],h[2],i)}this._lastMaterialId=e.id}if(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,b.worldMatrix),this._uModelNormalMatrix&&d.uniformMatrix4fv(this._uModelNormalMatrix,d.FALSE,b.worldNormalMatrix),this._uClippable&&d.uniform1i(this._uClippable,f.clippable),g.combined){var j=b._geometry._getVertexBufs();j.id!==this._lastVertexBufsId&&(j.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(j.positionsBuf,j.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),j.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(j.normalsBuf,j.quantized?d.BYTE:d.FLOAT),a.bindArray++),this._lastVertexBufsId=j.id)}g.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,g.positionsDecodeMatrix),this._uUVDecodeMatrix&&d.uniformMatrix3fv(this._uUVDecodeMatrix,!1,g.uvDecodeMatrix),g.combined?g.indicesBufCombined&&(g.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(g.positionsBuf,g.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(g.normalsBuf,g.quantized?d.BYTE:d.FLOAT),a.bindArray++),g.indicesBuf?(g.indicesBuf.bind(),a.bindArray++):g.positions),this._lastGeometryId=g.id),g.combined?g.indicesBufCombined&&(d.drawElements(g.primitive,g.indicesBufCombined.numItems,g.indicesBufCombined.itemType,0),a.drawElements++):g.indicesBuf?(d.drawElements(g.primitive,g.indicesBuf.numItems,g.indicesBuf.itemType,0),a.drawElements++):g.positions&&(d.drawArrays(d.TRIANGLES,0,g.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a){var b=a._geometry._state.primitiveName;return!(!a._geometry._state.autoVertexNormals&&!a._geometry._state.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function b(b){var c=b.scene,d=c._clipsState.clips.length>0,e=!!b._geometry._state.quantized,f=a(b),g=b._state.billboard,h=b._state.stationary,i=[];return i.push("// Outline effect vertex shader"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform float width;"),e&&i.push("uniform mat4 positionsDecodeMatrix;"),d&&i.push("varying vec4 vWorldPosition;"),f&&(i.push("attribute vec3 normal;"),e&&(i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"))),"spherical"!==g&&"cylindrical"!==g||(i.push("void billboard(inout mat4 mat) {"),i.push("   mat[0][0] = 1.0;"),i.push("   mat[0][1] = 0.0;"),i.push("   mat[0][2] = 0.0;"),"spherical"===g&&(i.push("   mat[1][0] = 0.0;"),i.push("   mat[1][1] = 1.0;"),i.push("   mat[1][2] = 0.0;")),i.push("   mat[2][0] = 0.0;"),i.push("   mat[2][1] = 0.0;"),i.push("   mat[2][2] =1.0;"),i.push("}")),i.push("void main(void) {"),i.push("vec4 localPosition = vec4(position, 1.0); "),i.push("vec4 worldPosition;"),e&&i.push("localPosition = positionsDecodeMatrix * localPosition;"),f&&(e?i.push("vec3 localNormal = octDecode(normal.xy); "):i.push("vec3 localNormal = normal; "),i.push("  localPosition.xyz += (normalize(normal) * (width * 0.0005));")),i.push("mat4 viewMatrix2 = viewMatrix;"),i.push("mat4 modelMatrix2 = modelMatrix;"),h&&i.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===g||"cylindrical"===g?(i.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),i.push("billboard(modelMatrix2);"),i.push("billboard(viewMatrix2);"),i.push("billboard(modelViewMatrix);"),i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(i.push("worldPosition = modelMatrix2 * localPosition;"),i.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),d&&i.push("vWorldPosition = worldPosition;"),i.push("   gl_Position = projMatrix * viewPosition;"),i.push("}"),i}function c(a){var b=a.scene,c=b._clipsState,d=c.clips.length>0,e=[];if(e.push("precision lowp float;"),e.push("uniform vec4  color;"),d){e.push("uniform bool clippable;"),e.push("varying vec4 vWorldPosition;");for(var f=0;f<c.clips.length;f++)e.push("uniform bool clipActive"+f+";"),e.push("uniform vec3 clipPos"+f+";"),e.push("uniform vec3 clipDir"+f+";")}if(e.push("void main(void) {"),d){e.push("if (clippable) {"),e.push("  float dist = 0.0;");for(var f=0;f<c.clips.length;f++)e.push("if (clipActive"+f+") {"),e.push("   dist += clamp(dot(-clipDir"+f+".xyz, vWorldPosition.xyz - clipPos"+f+".xyz), 0.0, 1000.0);"),e.push("}");e.push("  if (dist > 0.0) { discard; }"),e.push("}")}return e.push("   gl_FragColor = color;"),e.push("}"),e}xeogl.renderer.OutlineShaderSource=function(a){this.vertex=b(a),this.fragment=c(a)}}(),function(){"use strict";xeogl.renderer.PickMeshRenderer=function(a,b){this._hash=a,this._shaderSource=new xeogl.renderer.PickMeshShaderSource(b),this._scene=b.scene,this._useCount=0,this._allocate(b)};var a={};xeogl.renderer.PickMeshRenderer.get=function(b){var c=[b.scene.canvas.canvas.id,b.scene._clipsState.getHash(),b._geometry._state.hash,b._state.hash].join(";"),d=a[c];if(!d){if(d=new xeogl.renderer.PickMeshRenderer(c,b),d.errors)return console.log(d.errors.join("\n")),null;a[c]=d,xeogl.stats.memory.programs++}return d._useCount++,d},xeogl.renderer.PickMeshRenderer.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete a[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.PickMeshRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.PickMeshRenderer.prototype.drawMesh=function(a,b){this._program||this._allocate(b);var c=this._scene,d=c.canvas.gl,e=b._material._state,f=(b._state,b._geometry._state);if(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a)),e.id!==this._lastMaterialId){var g=e.backfaces;a.backfaces!==g&&(g?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=g);var h=e.frontface;a.frontface!==h&&(h?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=h),a.lineWidth!==e.lineWidth&&(d.lineWidth(e.lineWidth),a.lineWidth=e.lineWidth),this._uPointSize&&d.uniform1i(this._uPointSize,e.pointSize),this._lastMaterialId=e.id}if(d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,b.worldMatrix),f.combined){var i=b._geometry._getVertexBufs();i.id!==this._lastVertexBufsId&&(i.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),this._lastVertexBufsId=i.id)}this._uClippable&&d.uniform1i(this._uClippable,b._state.clippable),f.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,f.positionsDecodeMatrix),f.combined?f.indicesBufCombined&&(f.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(f.positionsBuf,f.quantized?d.UNSIGNED_SHORT:d.FLOAT),a.bindArray++),f.indicesBuf&&(f.indicesBuf.bind(),a.bindArray++)),this._lastGeometryId=f.id);var j=a.pickmeshIndex>>24&255,k=a.pickmeshIndex>>16&255,l=a.pickmeshIndex>>8&255,m=255&a.pickmeshIndex;a.pickmeshIndex++,d.uniform4f(this._uPickColor,m/255,l/255,k/255,j/255),f.combined?f.indicesBufCombined&&(d.drawElements(f.primitive,f.indicesBufCombined.numItems,f.indicesBufCombined.itemType,0),a.drawElements++):f.indicesBuf?(d.drawElements(f.primitive,f.indicesBuf.numItems,f.indicesBuf.itemType,0),a.drawElements++):f.positions&&d.drawArrays(d.TRIANGLES,0,f.positions.numItems)},xeogl.renderer.PickMeshRenderer.prototype._allocate=function(a){var b=a.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(b,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);var c=this._program;this._uPositionsDecodeMatrix=c.getLocation("positionsDecodeMatrix"),this._uModelMatrix=c.getLocation("modelMatrix"),this._uViewMatrix=c.getLocation("viewMatrix"),this._uProjMatrix=c.getLocation("projMatrix"),this._uClips=[];for(var d=a.scene._clipsState.clips,e=0,f=d.length;e<f;e++)this._uClips.push({active:c.getLocation("clipActive"+e),pos:c.getLocation("clipPos"+e),dir:c.getLocation("clipDir"+e)});this._aPosition=c.getAttribute("position"),this._uClippable=c.getLocation("clippable"),this._uPickColor=c.getLocation("pickColor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.PickMeshRenderer.prototype._bindProgram=function(a){this._program||this._allocate(mesh);var b=this._scene,c=b.canvas.gl,d=b._clipsState,e=b.camera,f=e._state;if(this._program.bind(),a.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,c.uniformMatrix4fv(this._uViewMatrix,!1,a.pickViewMatrix||f.matrix),c.uniformMatrix4fv(this._uProjMatrix,!1,a.pickProjMatrix||e.project._state.matrix),d.clips.length>0)for(var g,h,i,j,k=0,l=this._uClips.length;k<l;k++)g=this._uClips[k],h=g.active,i=d.clips[k],h&&c.uniform1i(h,i.active),j=g.pos,j&&c.uniform3fv(g.pos,i.pos),g.dir&&c.uniform3fv(g.dir,i.dir)}}(),function(){"use strict";function a(a){var b=a.scene,c=b._clipsState.clips.length>0,d=!!a._geometry._state.quantized,e=a._state.billboard,f=a._state.stationary,g=[];return g.push("// mesh picking vertex shader"),g.push("attribute vec3 position;"),g.push("uniform mat4 modelMatrix;"),g.push("uniform mat4 viewMatrix;"),g.push("uniform mat4 viewNormalMatrix;"),g.push("uniform mat4 projMatrix;"),g.push("varying vec4 vViewPosition;"),d&&g.push("uniform mat4 positionsDecodeMatrix;"),c&&g.push("varying vec4 vWorldPosition;"),"spherical"!==e&&"cylindrical"!==e||(g.push("void billboard(inout mat4 mat) {"),g.push("   mat[0][0] = 1.0;"),g.push("   mat[0][1] = 0.0;"),g.push("   mat[0][2] = 0.0;"),"spherical"===e&&(g.push("   mat[1][0] = 0.0;"),g.push("   mat[1][1] = 1.0;"),g.push("   mat[1][2] = 0.0;")),g.push("   mat[2][0] = 0.0;"),g.push("   mat[2][1] = 0.0;"),g.push("   mat[2][2] =1.0;"),g.push("}")),g.push("void main(void) {"),g.push("vec4 localPosition = vec4(position, 1.0); "),d&&g.push("localPosition = positionsDecodeMatrix * localPosition;"),g.push("mat4 viewMatrix2 = viewMatrix;"),g.push("mat4 modelMatrix2 = modelMatrix;"),f&&g.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"!==e&&"cylindrical"!==e||(g.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),g.push("billboard(modelMatrix2);"),g.push("billboard(viewMatrix2);")),g.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),g.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),c&&g.push("   vWorldPosition = worldPosition;"),g.push("   gl_Position = projMatrix * viewPosition;"),g.push("}"),g}function b(a){var b=a.scene,c=b._clipsState,d=c.clips.length>0,e=[];if(e.push("// mesh picking fragment shader"),e.push("precision lowp float;"),e.push("uniform vec4 pickColor;"),d){e.push("uniform bool clippable;"),e.push("varying vec4 vWorldPosition;");for(var f=0;f<c.clips.length;f++)e.push("uniform bool clipActive"+f+";"),e.push("uniform vec3 clipPos"+f+";"),e.push("uniform vec3 clipDir"+f+";")}if(e.push("void main(void) {"),d){e.push("if (clippable) {"),e.push("  float dist = 0.0;");for(var f=0;f<c.clips.length;f++)e.push("if (clipActive"+f+") {"),e.push("   dist += clamp(dot(-clipDir"+f+".xyz, vWorldPosition.xyz - clipPos"+f+".xyz), 0.0, 1000.0);"),e.push("}");e.push("  if (dist > 0.0) { discard; }"),e.push("}")}return e.push("   gl_FragColor = pickColor; "),e.push("}"),e}xeogl.renderer.PickMeshShaderSource=function(c){this.vertex=a(c),this.fragment=b(c)}}(),function(){"use strict";xeogl.renderer.PickTriangleRenderer=function(a,b){this._hash=a,this._scene=b.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.PickTriangleShaderSource(b),this._allocate(b)};var a={};xeogl.renderer.PickTriangleRenderer.get=function(b){var c=[b.scene.canvas.canvas.id,b.scene._clipsState.getHash(),b._geometry._state.quantized?"cp":"",b._state.hash].join(";"),d=a[c];if(!d){if(d=new xeogl.renderer.PickTriangleRenderer(c,b),d.errors)return console.log(d.errors.join("\n")),null;a[c]=d,xeogl.stats.memory.programs++}return d._useCount++,d},xeogl.renderer.PickTriangleRenderer.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete a[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.PickTriangleRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.PickTriangleRenderer.prototype.drawMesh=function(a,b){this._program||this._allocate(b);var c=this._scene,d=c.canvas.gl,e=c._clipsState,f=b._material._state,g=(b._state,b._geometry),h=b._geometry._state,i=f.backfaces,j=f.frontface,k=g._getPickTrianglePositions(),l=g._getPickTriangleColors(),m=c.camera,n=m._state;if(this._program.bind(),a.useProgram++,d.uniformMatrix4fv(this._uViewMatrix,!1,a.pickViewMatrix||n.matrix),d.uniformMatrix4fv(this._uProjMatrix,!1,a.pickProjMatrix||m.project._state.matrix),e.clips.length>0)for(var o,p,q,r,s=e.clips,t=0,u=this._uClips.length;t<u;t++)o=this._uClips[t],p=o.active,q=s[t],p&&d.uniform1i(p,q.active),r=o.pos,r&&d.uniform3fv(o.pos,q.pos),o.dir&&d.uniform3fv(o.dir,q.dir);a.backfaces!==i&&(i?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE),a.backfaces=i),a.frontface!==j&&(j?d.frontFace(d.CCW):d.frontFace(d.CW),a.frontface=j),this._lastMaterialId=f.id,d.uniformMatrix4fv(this._uModelMatrix,d.FALSE,b.worldMatrix),this._uClippable&&d.uniform1i(this._uClippable,b._state.clippable),this._uPositionsDecodeMatrix?(d.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(k,h.quantized?d.UNSIGNED_SHORT:d.FLOAT)):this._aPosition.bindArrayBuffer(k),l.bind(),d.enableVertexAttribArray(this._aColor.location),d.vertexAttribPointer(this._aColor.location,l.itemSize,l.itemType,!0,0,0),d.drawArrays(h.primitive,0,k.numItems/3)},xeogl.renderer.PickTriangleRenderer.prototype._allocate=function(a){var b=a.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(b,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var c=this._program;this._uPositionsDecodeMatrix=c.getLocation("positionsDecodeMatrix"),this._uModelMatrix=c.getLocation("modelMatrix"),this._uViewMatrix=c.getLocation("viewMatrix"),this._uProjMatrix=c.getLocation("projMatrix"),this._uClips=[];for(var d=a.scene._clipsState.clips,e=0,f=d.length;e<f;e++)this._uClips.push({active:c.getLocation("clipActive"+e),pos:c.getLocation("clipPos"+e),dir:c.getLocation("clipDir"+e)});this._aPosition=c.getAttribute("position"),this._aColor=c.getAttribute("color"),this._uClippable=c.getLocation("clippable")}}(),function(){"use strict";function a(a){var b=a.scene,c=b._clipsState.clips.length>0,d=!!a._geometry._state.quantized,e=(a._state.billboard,a._state.stationary,[]);return e.push("// Surface picking vertex shader"),e.push("attribute vec3 position;"),e.push("attribute vec4 color;"),e.push("uniform mat4 modelMatrix;"),e.push("uniform mat4 viewMatrix;"),e.push("uniform mat4 projMatrix;"),c&&(e.push("uniform bool clippable;"),e.push("varying vec4 vWorldPosition;")),e.push("varying vec4 vColor;"),d&&e.push("uniform mat4 positionsDecodeMatrix;"),e.push("void main(void) {"),e.push("vec4 localPosition = vec4(position, 1.0); "),d&&e.push("localPosition = positionsDecodeMatrix * localPosition;"),e.push("   vec4 worldPosition = modelMatrix * localPosition; "),e.push("   vec4 viewPosition = viewMatrix * worldPosition;"),c&&e.push("   vWorldPosition = worldPosition;"),e.push("   vColor = color;"),e.push("   gl_Position = projMatrix * viewPosition;"),e.push("}"),e}function b(a){var b=a.scene,c=b._clipsState,d=c.clips.length>0,e=[];if(e.push("// Surface picking fragment shader"),e.push("precision lowp float;"),e.push("varying vec4 vColor;"),d){e.push("uniform bool clippable;"),e.push("varying vec4 vWorldPosition;");for(var f=0;f<c.clips.length;f++)e.push("uniform bool clipActive"+f+";"),e.push("uniform vec3 clipPos"+f+";"),e.push("uniform vec3 clipDir"+f+";")}if(e.push("void main(void) {"),d){e.push("if (clippable) {"),e.push("  float dist = 0.0;");for(var f=0;f<c.clips.length;f++)e.push("if (clipActive"+f+") {"),e.push("   dist += clamp(dot(-clipDir"+f+".xyz, vWorldPosition.xyz - clipPos"+f+".xyz), 0.0, 1000.0);"),e.push("}");e.push("  if (dist > 0.0) { discard; }"),e.push("}")}return e.push("   gl_FragColor = vColor;"),e.push("}"),e}xeogl.renderer.PickTriangleShaderSource=function(c){this.vertex=a(c),this.fragment=b(c)}}(),function(){"use strict";xeogl.renderer.ShadowRenderer=function(a,b){if(this._hash=a,this._shaderSource=new xeogl.renderer.ShadowShaderSource(b),this._program=new xeogl.renderer.Program(b.scene.canvas.gl,this._shaderSource),this._scene=scene,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var c=this._program;this._uPositionsDecodeMatrix=c.getLocation("positionsDecodeMatrix"),this._uModelMatrix=c.getLocation("modelMatrix"),this._uViewMatrix=c.getLocation("viewMatrix"),this._uProjMatrix=c.getLocation("projMatrix"),this._uClips={};for(var d=b.scene._clipsState.clips,e=0,f=d.length;e<f;e++)this._uClips.push({active:c.getLocation("clipActive"+e),pos:c.getLocation("clipPos"+e),dir:c.getLocation("clipDir"+e)});this._aPosition=c.getAttribute("position"),this._uClippable=c.getLocation("clippable"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};var a={};xeogl.renderer.ShadowRenderer.get=function(b){var c=[b.scene.canvas.canvas.id,b.scene._clipsState.getHash(),b._geometry._state.hash,b._state.hash].join(";"),d=a[c];return d||(d=new xeogl.renderer.ShadowRenderer(c,b),a[c]=d),d._useCount++,d},xeogl.renderer.ShadowRenderer.prototype.put=function(){--this._useCount&&(this._program.destroy(),delete a[this._hash])},xeogl.renderer.ShadowRenderer.prototype._bindProgram=function(a){var b=this._scene,c=b.canvas.gl,d=b._clipsState;if(this._program.bind(),a.useProgram++,this._lastLightId=null,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,d.clips.length>0)for(var e,f,g,h,i=0,j=this._uClips.length;i<j;i++)e=this._uClips[i],f=e.active,g=d.clips[i],f&&c.uniform1i(f,g.active),h=e.pos,h&&c.uniform3fv(e.pos,g.pos),e.dir&&c.uniform3fv(e.dir,g.dir)},xeogl.renderer.ShadowRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.ShadowRenderer.prototype.drawMesh=function(a,b,c){var d=this._scene,e=d.canvas.gl,f=b._material._state,g=(b._state,b._geometry._state);if(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a)),a.textureUnit=0,c.id!==this._lastLightId&&(e.uniformMatrix4fv(this._uViewMatrix,!1,c.getShadowViewMatrix()),e.uniformMatrix4fv(this._uProjMatrix,!1,c.getShadowProjMatrix()),this._lastLightId=c.id),f.id!==this._lastMaterialId){var h=f.backfaces;a.backfaces!==h&&(h?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),a.backfaces=h);var i=f.frontface;a.frontface!==i&&(i?e.frontFace(e.CCW):e.frontFace(e.CW),a.frontface=i),a.lineWidth!==f.lineWidth&&(e.lineWidth(f.lineWidth),a.lineWidth=f.lineWidth),this._uPointSize&&e.uniform1i(this._uPointSize,f.pointSize),this._lastMaterialId=f.id}if(e.uniformMatrix4fv(this._uModelMatrix,e.FALSE,b.worldMatrix),this._uClippable&&e.uniform1i(this._uClippable,b._state.clippable),g.combined){var j=b.vertexBufs;j.id!==this._lastVertexBufsId&&(j.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(j.positionsBuf,j.quantized?e.UNSIGNED_SHORT:e.FLOAT),a.bindArray++),this._lastVertexBufsId=j.id)}g.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&e.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,g.positionsDecodeMatrix),g.combined?g.indicesBufCombined&&(g.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(g.positionsBuf,g.quantized?e.UNSIGNED_SHORT:e.FLOAT),a.bindArray++),g.indicesBuf&&(g.indicesBuf.bind(),a.bindArray++)),this._lastGeometryId=g.id),g.combined?g.indicesBufCombined&&(e.drawElements(g.primitive,g.indicesBufCombined.numItems,g.indicesBufCombined.itemType,0),a.drawElements++):g.indicesBuf?(e.drawElements(g.primitive,g.indicesBuf.numItems,g.indicesBuf.itemType,0),a.drawElements++):g.positions&&(e.drawArrays(e.TRIANGLES,0,g.positions.numItems),a.drawArrays++)}}(),function(){"use strict";function a(a){var b=(scene.lights.lights,a._state.billboard),c=[];return c.push("// Shadow drawing vertex shader"),c.push("attribute vec3 position;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),cfg.quantizedGeometry&&c.push("uniform mat4 positionsDecodeMatrix;"),cfg.clipping&&c.push("varying vec4 vWorldPosition;"),"points"===a._geometry._state.primitiveName&&c.push("uniform float pointSize;"),"spherical"!==b&&"cylindrical"!==b||(c.push("void billboard(inout mat4 mat) {"),c.push("   mat[0][0] = 1.0;"),c.push("   mat[0][1] = 0.0;"),c.push("   mat[0][2] = 0.0;"),"spherical"===b&&(c.push("   mat[1][0] = 0.0;"),c.push("   mat[1][1] = 1.0;"),c.push("   mat[1][2] = 0.0;")),c.push("   mat[2][0] = 0.0;"),c.push("   mat[2][1] = 0.0;"),c.push("   mat[2][2] =1.0;"),c.push("}")),c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),c.push("vec4 worldPosition;"),cfg.quantizedGeometry&&c.push("localPosition = positionsDecodeMatrix * localPosition;"),c.push("mat4 viewMatrix2 = viewMatrix;"),c.push("mat4 modelMatrix2 = modelMatrix;"),a._state.stationary&&c.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===b||"cylindrical"===b?(c.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),c.push("billboard(modelMatrix2);"),c.push("billboard(viewMatrix2);"),c.push("billboard(modelViewMatrix);"),cfg.normals&&(c.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),c.push("billboard(modelNormalMatrix2);"),c.push("billboard(viewNormalMatrix2);"),c.push("billboard(modelViewNormalMatrix);")),c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),cfg.clipping&&c.push("vWorldPosition = worldPosition;"),"points"===a._geometry._state.primitiveName&&c.push("gl_PointSize = pointSize;"),c.push("   gl_Position = projMatrix * viewPosition;"),c.push("}"),c}function b(a){var b,d=[];if(d.push("// Shadow fragment shader"),d.push("precision "+c(gl)+" float;"),cfg.clipping)for(d.push("varying vec4 vWorldPosition;"),
d.push("uniform bool clippable;"),b=0;b<scene.clips.clips.length;b++)d.push("uniform bool clipActive"+b+";"),d.push("uniform vec3 clipPos"+b+";"),d.push("uniform vec3 clipDir"+b+";");if(d.push("vec4 packDepth (float depth) {"),d.push("  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);"),d.push("  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);"),d.push("  vec4 comp = fract(depth * bitShift);"),d.push("  comp -= comp.gbaa * bitMask;"),d.push("  return comp;"),d.push("}"),d.push("void main(void) {"),cfg.clipping){for(d.push("if (clippable) {"),d.push("  float dist = 0.0;"),b=0;b<scene.clips.clips.length;b++)d.push("if (clipActive"+b+") {"),d.push("   dist += clamp(dot(-clipDir"+b+".xyz, vWorldPosition.xyz - clipPos"+b+".xyz), 0.0, 1000.0);"),d.push("}");d.push("  if (dist > 0.0) { discard; }"),cfg.solid&&(d.push("  if (gl_FrontFacing == false) {"),d.push("     gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);"),d.push("     return;"),d.push("  }")),d.push("}")}return"points"===a._geometry._state.primitiveName&&(d.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),d.push("float r = dot(cxy, cxy);"),d.push("if (r > 1.0) {"),d.push("   discard;"),d.push("}")),d.push("gl_FragColor = packDepth(gl_FragCoord.z);"),d.push("}"),d}function c(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}xeogl.renderer.ShadowShaderSource=function(c){this.vertex=a(c),this.fragment=b(c)}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.EmphasisFillRenderer=function(b,c){this.id=a.addItem({}),this._hash=b,this._scene=c.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.EmphasisFillShaderSource(c),this._allocate(c)};var b={};xeogl.renderer.EmphasisFillRenderer.get=function(a){var c=[a.scene.id,a.scene.gammaOutput?"go":"",a.scene._clipsState.getHash(),a._geometry.normals?"n":"",a._geometry._state.quantized?"cp":"",a._state.hash].join(";"),d=b[c];return d||(d=new xeogl.renderer.EmphasisFillRenderer(c,a),b[c]=d,xeogl.stats.memory.programs++),d._useCount++,d},xeogl.renderer.EmphasisFillRenderer.prototype.put=function(){0==--this._useCount&&(a.removeItem(this.id),this._program&&this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.EmphasisFillRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.EmphasisFillRenderer.prototype.drawMesh=function(a,b,c){this._program||this._allocate(b);var d=this._scene,e=d.canvas.gl,f=0===c?b._ghostMaterial._state:1===c?b._highlightMaterial._state:b._selectedMaterial._state,g=b._state,h=b._geometry._state;if(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a)),f.id!==this._lastMaterialId){var i=f.fillColor,j=f.backfaces;a.backfaces!==j&&(j?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),a.backfaces=j),e.uniform4f(this._uFillColor,i[0],i[1],i[2],f.fillAlpha),this._lastMaterialId=f.id}if(e.uniformMatrix4fv(this._uModelMatrix,e.FALSE,b.worldMatrix),this._uModelNormalMatrix&&e.uniformMatrix4fv(this._uModelNormalMatrix,e.FALSE,b.worldNormalMatrix),this._uClippable&&e.uniform1i(this._uClippable,g.clippable),h.combined){var k=b._geometry._getVertexBufs();k.id!==this._lastVertexBufsId&&(k.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(k.positionsBuf,k.quantized?e.UNSIGNED_SHORT:e.FLOAT),a.bindArray++),k.normalsBuf&&this._aNormal&&(this._aNormal.bindArrayBuffer(k.normalsBuf,k.quantized?e.BYTE:e.FLOAT),a.bindArray++),this._lastVertexBufsId=k.id)}h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&e.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&e.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),h.combined?h.indicesBufCombined&&(h.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.quantized?e.UNSIGNED_SHORT:e.FLOAT),a.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf,h.quantized?e.BYTE:e.FLOAT),a.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),a.bindArray++):h.positions),this._lastGeometryId=h.id),h.combined?h.indicesBufCombined&&(e.drawElements(h.primitive,h.indicesBufCombined.numItems,h.indicesBufCombined.itemType,0),a.drawElements++):h.indicesBuf?(e.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),a.drawElements++):h.positions&&(e.drawArrays(e.TRIANGLES,0,h.positions.numItems),a.drawArrays++)},xeogl.renderer.EmphasisFillRenderer.prototype._allocate=function(a){var b=a.scene._lightsState,c=a.scene._clipsState,d=a.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(d,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);var e=this._program;this._uPositionsDecodeMatrix=e.getLocation("positionsDecodeMatrix"),this._uModelMatrix=e.getLocation("modelMatrix"),this._uModelNormalMatrix=e.getLocation("modelNormalMatrix"),this._uViewMatrix=e.getLocation("viewMatrix"),this._uViewNormalMatrix=e.getLocation("viewNormalMatrix"),this._uProjMatrix=e.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(var f=0,g=b.lights.length;f<g;f++){switch(b.lights[f].type){case"ambient":this._uLightAmbient[f]=e.getLocation("lightAmbient");break;case"dir":this._uLightColor[f]=e.getLocation("lightColor"+f),this._uLightPos[f]=null,this._uLightDir[f]=e.getLocation("lightDir"+f);break;case"point":this._uLightColor[f]=e.getLocation("lightColor"+f),this._uLightPos[f]=e.getLocation("lightPos"+f),this._uLightDir[f]=null,this._uLightAttenuation[f]=e.getLocation("lightAttenuation"+f)}}this._uClips=[];for(var f=0,g=c.clips.length;f<g;f++)this._uClips.push({active:e.getLocation("clipActive"+f),pos:e.getLocation("clipPos"+f),dir:e.getLocation("clipDir"+f)});this._uFillColor=e.getLocation("fillColor"),this._aPosition=e.getAttribute("position"),this._aNormal=e.getAttribute("normal"),this._uClippable=e.getLocation("clippable"),this._uGammaFactor=e.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.EmphasisFillRenderer.prototype._bindProgram=function(a){var b,c=this._scene,d=c.canvas.gl,e=c._clipsState,f=c._lightsState,g=c.camera,h=g._state;this._program.bind(),a.useProgram++,a.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,d.uniformMatrix4fv(this._uViewMatrix,!1,h.matrix),d.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.normalMatrix),d.uniformMatrix4fv(this._uProjMatrix,!1,g.project._state.matrix);for(var i=0,j=f.lights.length;i<j;i++)b=f.lights[i],this._uLightAmbient[i]?d.uniform4f(this._uLightAmbient[i],b.color[0],b.color[1],b.color[2],b.intensity):(this._uLightColor[i]&&d.uniform4f(this._uLightColor[i],b.color[0],b.color[1],b.color[2],b.intensity),this._uLightPos[i]&&(d.uniform3fv(this._uLightPos[i],b.pos),this._uLightAttenuation[i]&&d.uniform1f(this._uLightAttenuation[i],b.attenuation)),this._uLightDir[i]&&d.uniform3fv(this._uLightDir[i],b.dir));if(e.clips.length>0)for(var k,l,m,n,o=c._clipsState.clips,i=0,j=this._uClips.length;i<j;i++)k=this._uClips[i],l=k.active,m=o[i],l&&d.uniform1i(l,m.active),n=k.pos,n&&d.uniform3fv(k.pos,m.pos),k.dir&&d.uniform3fv(k.dir,m.dir);this._uGammaFactor&&d.uniform1f(this._uGammaFactor,c.gammaFactor)}}(),function(){"use strict";function a(a){var c,d,e,f=a.scene,g=f._lightsState,h=b(a),i=f._clipsState.clips.length>0,j=!!a._geometry._state.quantized,k=a._state.billboard,l=a._state.stationary,m=[];if(m.push("// EmphasisFillShaderSource vertex shader"),m.push("attribute vec3 position;"),m.push("uniform mat4 modelMatrix;"),m.push("uniform mat4 viewMatrix;"),m.push("uniform mat4 projMatrix;"),m.push("uniform vec4 colorize;"),j&&m.push("uniform mat4 positionsDecodeMatrix;"),i&&m.push("varying vec4 vWorldPosition;"),m.push("uniform vec4   lightAmbient;"),m.push("uniform vec4   fillColor;"),h){for(m.push("attribute vec3 normal;"),m.push("uniform mat4 modelNormalMatrix;"),m.push("uniform mat4 viewNormalMatrix;"),c=0,d=g.lights.length;c<d;c++)e=g.lights[c],"ambient"!==e.type&&(m.push("uniform vec4 lightColor"+c+";"),"dir"===e.type&&m.push("uniform vec3 lightDir"+c+";"),"point"===e.type&&m.push("uniform vec3 lightPos"+c+";"),"spot"===e.type&&m.push("uniform vec3 lightPos"+c+";"));j&&(m.push("vec3 octDecode(vec2 oct) {"),m.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),m.push("    if (v.z < 0.0) {"),m.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),m.push("    }"),m.push("    return normalize(v);"),m.push("}"))}if(m.push("varying vec4 vColor;"),"spherical"!==k&&"cylindrical"!==k||(m.push("void billboard(inout mat4 mat) {"),m.push("   mat[0][0] = 1.0;"),m.push("   mat[0][1] = 0.0;"),m.push("   mat[0][2] = 0.0;"),"spherical"===k&&(m.push("   mat[1][0] = 0.0;"),m.push("   mat[1][1] = 1.0;"),m.push("   mat[1][2] = 0.0;")),m.push("   mat[2][0] = 0.0;"),m.push("   mat[2][1] = 0.0;"),m.push("   mat[2][2] =1.0;"),m.push("}")),m.push("void main(void) {"),m.push("vec4 localPosition = vec4(position, 1.0); "),m.push("vec4 worldPosition;"),j&&m.push("localPosition = positionsDecodeMatrix * localPosition;"),h&&(j?m.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):m.push("vec4 localNormal = vec4(normal, 0.0); "),m.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),m.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),m.push("mat4 viewMatrix2 = viewMatrix;"),m.push("mat4 modelMatrix2 = modelMatrix;"),l&&m.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===k||"cylindrical"===k?(m.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),m.push("billboard(modelMatrix2);"),m.push("billboard(viewMatrix2);"),m.push("billboard(modelViewMatrix);"),h&&(m.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),m.push("billboard(modelNormalMatrix2);"),m.push("billboard(viewNormalMatrix2);"),m.push("billboard(modelViewNormalMatrix);")),m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),h&&m.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),m.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),m.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),m.push("float lambertian = 1.0;"),h)for(c=0,d=g.lights.length;c<d;c++)if(e=g.lights[c],"ambient"!==e.type){if("dir"===e.type)"view"===e.space?m.push("viewLightDir = normalize(lightDir"+c+");"):m.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+c+", 0.0)).xyz);");else{if("point"!==e.type)continue;"view"===e.space?m.push("viewLightDir = normalize(lightPos"+c+" - viewPosition.xyz);"):m.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+c+", 0.0)).xyz);")}m.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),m.push("reflectedColor += lambertian * (lightColor"+c+".rgb * lightColor"+c+".a);")}return m.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),i&&m.push("vWorldPosition = worldPosition;"),"points"===a._geometry._state.primitiveName&&m.push("gl_PointSize = pointSize;"),m.push("   gl_Position = projMatrix * viewPosition;"),m.push("}"),m}function b(a){var b=a._geometry._state.primitiveName;return!(!a._geometry._state.autoVertexNormals&&!a._geometry._state.normals||"triangles"!==b&&"triangle-strip"!==b&&"triangle-fan"!==b)}function c(a){var b,c,d=a.scene._clipsState,e=a.scene.gammaOutput,f=d.clips.length>0,g=[];if(g.push("// Lambertian drawing fragment shader"),g.push("precision lowp float;"),e&&(g.push("uniform float gammaFactor;"),g.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),g.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),g.push("}")),f)for(g.push("varying vec4 vWorldPosition;"),g.push("uniform bool clippable;"),b=0,c=d.clips.length;b<c;b++)g.push("uniform bool clipActive"+b+";"),g.push("uniform vec3 clipPos"+b+";"),g.push("uniform vec3 clipDir"+b+";");if(g.push("varying vec4 vColor;"),g.push("void main(void) {"),f){for(g.push("if (clippable) {"),g.push("  float dist = 0.0;"),b=0,c=d.clips.length;b<c;b++)g.push("if (clipActive"+b+") {"),g.push("   dist += clamp(dot(-clipDir"+b+".xyz, vWorldPosition.xyz - clipPos"+b+".xyz), 0.0, 1000.0);"),g.push("}");g.push("  if (dist > 0.0) { discard; }"),g.push("}")}return"points"===a._geometry._state.primitiveName&&(g.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),g.push("float r = dot(cxy, cxy);"),g.push("if (r > 1.0) {"),g.push("   discard;"),g.push("}")),g.push("gl_FragColor = vColor;"),e?g.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):g.push("gl_FragColor = vColor;"),g.push("}"),g}xeogl.renderer.EmphasisFillShaderSource=function(b){this.vertex=a(b),this.fragment=c(b)}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.EmphasisVerticesRenderer=function(b,c){this.id=a.addItem({}),this._hash=b,this._scene=c.scene,this._shaderSource=new xeogl.renderer.EmphasisVerticesShaderSource(c),this._allocate(c)};var b={};xeogl.renderer.EmphasisVerticesRenderer.get=function(a){var c=[a.scene.id,a.scene.gammaOutput?"go":"",a.scene._clipsState.getHash(),a._geometry._state.quantized?"cp":"",a._state.hash].join(";"),d=b[c];return d||(d=new xeogl.renderer.EmphasisVerticesRenderer(c,a),b[c]=d,xeogl.stats.memory.programs++),d._useCount++,d},xeogl.renderer.EmphasisVerticesRenderer.prototype.put=function(){0==--this._useCount&&(this._scene.off(this._onWebglcontextrestored),a.removeItem(this.id),this._program&&this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.EmphasisVerticesRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.EmphasisVerticesRenderer.prototype.drawMesh=function(a,b,c){this._program||this._allocate(b);var d=this._scene,e=d.canvas.gl,f=0===c?b._ghostMaterial._state:1===c?b._highlightMaterial._state:b._selectedMaterial._state,g=b._state,h=b._geometry._state;if(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a,b)),f.id!==this._lastMaterialId){var i=f.backfaces;if(a.backfaces!==i&&(i?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),a.backfaces=i),this._uVertexSize&&e.uniform1f(this._uVertexSize,f.vertexSize),this._uVertexColor){var j=f.vertexColor,k=f.vertexAlpha;e.uniform4f(this._uVertexColor,j[0],j[1],j[2],k)}this._lastMaterialId=f.id}if(e.uniformMatrix4fv(this._uModelMatrix,e.FALSE,b.worldMatrix),this._uModelNormalMatrix&&e.uniformMatrix4fv(this._uModelNormalMatrix,e.FALSE,b.worldNormalMatrix),this._uClippable&&e.uniform1i(this._uClippable,g.clippable),h.combined){var l=b._geometry._getVertexBufs();l.id!==this._lastVertexBufsId&&(l.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf,l.quantized?e.UNSIGNED_SHORT:e.FLOAT),a.bindArray++),this._lastVertexBufsId=l.id)}h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&e.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),h.combined?h.indicesBufCombined&&(h.indicesBufCombined.bind(),a.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.quantized?e.UNSIGNED_SHORT:e.FLOAT),a.bindArray++),h.indicesBuf?(h.indicesBuf.bind(),a.bindArray++):h.positions),this._lastGeometryId=h.id),h.combined?h.indicesBufCombined&&(e.drawElements(e.POINTS,h.indicesBufCombined.numItems,h.indicesBufCombined.itemType,0),a.drawElements++):h.indicesBuf?(e.drawElements(e.POINTS,h.indicesBuf.numItems,h.indicesBuf.itemType,0),a.drawElements++):h.positions&&(e.drawArrays(e.POINTS,0,h.positions.numItems),a.drawArrays++)},xeogl.renderer.EmphasisVerticesRenderer.prototype._allocate=function(a){var b=a.scene._clipsState,c=a.scene.canvas.gl;if(this._program=new xeogl.renderer.Program(c,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);var d=this._program;this._uPositionsDecodeMatrix=d.getLocation("positionsDecodeMatrix"),this._uModelMatrix=d.getLocation("modelMatrix"),this._uViewMatrix=d.getLocation("viewMatrix"),this._uProjMatrix=d.getLocation("projMatrix"),this._uClips=[];for(var e=0,f=b.clips.length;e<f;e++)this._uClips.push({active:d.getLocation("clipActive"+e),pos:d.getLocation("clipPos"+e),dir:d.getLocation("clipDir"+e)});this._uVertexColor=d.getLocation("vertexColor"),this._uVertexSize=d.getLocation("vertexSize"),this._aPosition=d.getAttribute("position"),this._uClippable=d.getLocation("clippable"),this._uGammaFactor=d.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.EmphasisVerticesRenderer.prototype._bindProgram=function(a,b){var c=this._scene,d=c.canvas.gl,e=c._clipsState,f=this._program,g=c.camera,h=g._state;if(f.bind(),a.useProgram++,a.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,d.uniformMatrix4fv(this._uViewMatrix,!1,h.matrix),d.uniformMatrix4fv(this._uProjMatrix,!1,g.project._state.matrix),e.clips.length>0)for(var i,j,k,l,m=e.clips,n=0,o=this._uClips.length;n<o;n++)i=this._uClips[n],j=i.active,k=m[n],j&&d.uniform1i(j,k.active),l=i.pos,l&&d.uniform3fv(i.pos,k.pos),i.dir&&d.uniform3fv(i.dir,k.dir);this._uGammaFactor&&d.uniform1f(this._uGammaFactor,c.gammaFactor)}}(),function(){"use strict";function a(a){var b=a.scene,c=b._clipsState.clips.length>0,d=!!a._geometry._state.quantized,e=a._state.billboard,f=a._state.stationary,g=[];return g.push("// Vertices drawing vertex shader"),g.push("attribute vec3 position;"),g.push("uniform mat4 modelMatrix;"),g.push("uniform mat4 viewMatrix;"),g.push("uniform mat4 projMatrix;"),g.push("uniform vec4 vertexColor;"),g.push("uniform float vertexSize;"),d&&g.push("uniform mat4 positionsDecodeMatrix;"),c&&g.push("varying vec4 vWorldPosition;"),g.push("varying vec4 vColor;"),"spherical"!==e&&"cylindrical"!==e||(g.push("void billboard(inout mat4 mat) {"),g.push("   mat[0][0] = 1.0;"),g.push("   mat[0][1] = 0.0;"),g.push("   mat[0][2] = 0.0;"),"spherical"===e&&(g.push("   mat[1][0] = 0.0;"),g.push("   mat[1][1] = 1.0;"),g.push("   mat[1][2] = 0.0;")),g.push("   mat[2][0] = 0.0;"),g.push("   mat[2][1] = 0.0;"),g.push("   mat[2][2] =1.0;"),g.push("}")),g.push("void main(void) {"),g.push("vec4 localPosition = vec4(position, 1.0); "),g.push("vec4 worldPosition;"),d&&g.push("localPosition = positionsDecodeMatrix * localPosition;"),g.push("mat4 viewMatrix2 = viewMatrix;"),g.push("mat4 modelMatrix2 = modelMatrix;"),f&&g.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===e||"cylindrical"===e?(g.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),g.push("billboard(modelMatrix2);"),g.push("billboard(viewMatrix2);"),g.push("billboard(modelViewMatrix);"),g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),g.push("vColor = vertexColor;"),g.push("gl_PointSize = vertexSize;"),c&&g.push("vWorldPosition = worldPosition;"),g.push("   gl_Position = projMatrix * viewPosition;"),g.push("}"),g}function b(a){var b,c,d=a.scene._clipsState,e=a.scene.gammaOutput,f=d.clips.length>0,g=[];if(g.push("// Vertices drawing fragment shader"),g.push("precision lowp float;"),e&&(g.push("uniform float gammaFactor;"),g.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),g.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),g.push("}")),f)for(g.push("varying vec4 vWorldPosition;"),g.push("uniform bool clippable;"),b=0,c=d.clips.length;b<c;b++)g.push("uniform bool clipActive"+b+";"),g.push("uniform vec3 clipPos"+b+";"),g.push("uniform vec3 clipDir"+b+";");if(g.push("varying vec4 vColor;"),g.push("void main(void) {"),f){for(g.push("if (clippable) {"),g.push("  float dist = 0.0;"),b=0,c=d.clips.length;b<c;b++)g.push("if (clipActive"+b+") {"),g.push("   dist += clamp(dot(-clipDir"+b+".xyz, vWorldPosition.xyz - clipPos"+b+".xyz), 0.0, 1000.0);"),g.push("}");g.push("  if (dist > 0.0) { discard; }"),g.push("}")}return g.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),g.push("float r = dot(cxy, cxy);"),g.push("if (r > 1.0) {"),g.push("   discard;"),g.push("}"),g.push("gl_FragColor = vColor;"),e?g.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):g.push("gl_FragColor = vColor;"),g.push("}"),g}xeogl.renderer.EmphasisVerticesShaderSource=function(c){this.vertex=a(c),this.fragment=b(c)}}(),function(){"use strict";var a=new xeogl.utils.Map({});xeogl.renderer.EmphasisEdgesRenderer=function(b,c){this.id=a.addItem({}),this._hash=b,this._scene=c.scene,this._useCount=0,this._shaderSource=new xeogl.renderer.EmphasisEdgesShaderSource(c),this._allocate(c)};var b={};xeogl.renderer.EmphasisEdgesRenderer.get=function(a){var c=[a.scene.id,a.scene.gammaOutput?"go":"",a.scene._clipsState.getHash(),a._geometry._state.quantized?"cp":"",a._state.hash].join(";"),d=b[c];return d||(d=new xeogl.renderer.EmphasisEdgesRenderer(c,a),b[c]=d,xeogl.stats.memory.programs++),d._useCount++,d},xeogl.renderer.EmphasisEdgesRenderer.prototype.put=function(){0==--this._useCount&&(a.removeItem(this.id),this._program&&this._program.destroy(),delete b[this._hash],xeogl.stats.memory.programs--)},xeogl.renderer.EmphasisEdgesRenderer.prototype.webglContextRestored=function(){this._program=null},xeogl.renderer.EmphasisEdgesRenderer.prototype.drawMesh=function(a,b,c){this._program||this._allocate(b);var d,e=this._scene,f=e.canvas.gl,g=b._state,h=b._geometry,i=h._state;switch(a.lastProgramId!==this._program.id&&(a.lastProgramId=this._program.id,this._bindProgram(a)),c){case 0:d=b._ghostMaterial._state;break;case 1:d=b._highlightMaterial._state;break;case 2:d=b._selectedMaterial._state;break;case 3:default:d=b._edgeMaterial._state}if(d.id!==this._lastMaterialId){var j=d.backfaces;if(a.backfaces!==j&&(j?f.disable(f.CULL_FACE):f.enable(f.CULL_FACE),a.backfaces=j),a.lineWidth!==d.edgeWidth&&(f.lineWidth(d.edgeWidth),a.lineWidth=d.edgeWidth),this._uEdgeColor){var k=d.edgeColor,l=d.edgeAlpha;f.uniform4f(this._uEdgeColor,k[0],k[1],k[2],l)}this._lastMaterialId=d.id}if(f.uniformMatrix4fv(this._uModelMatrix,f.FALSE,b.worldMatrix),this._uModelNormalMatrix&&f.uniformMatrix4fv(this._uModelNormalMatrix,f.FALSE,b.worldNormalMatrix),this._uClippable&&f.uniform1i(this._uClippable,g.clippable),i.combined){var m=b._geometry._getVertexBufs();m.id!==this._lastVertexBufsId&&(m.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(m.positionsBuf,m.quantized?f.UNSIGNED_SHORT:f.FLOAT),a.bindArray++),this._lastVertexBufsId=m.id)}var n;i.primitive===f.TRIANGLES?n=h._getEdgesIndices():i.primitive===f.LINES&&(n=i.indicesBuf),n&&(i.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&f.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,i.positionsDecodeMatrix),i.combined||this._aPosition&&(this._aPosition.bindArrayBuffer(i.positionsBuf,i.quantized?f.UNSIGNED_SHORT:f.FLOAT),a.bindArray++),n.bind(),a.bindArray++,this._lastGeometryId=i.id),f.drawElements(f.LINES,n.numItems,n.itemType,0),a.drawElements++)},xeogl.renderer.EmphasisEdgesRenderer.prototype._allocate=function(a){var b=a.scene.canvas.gl,c=a.scene._clipsState;if(this._program=new xeogl.renderer.Program(b,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);var d=this._program;this._uPositionsDecodeMatrix=d.getLocation("positionsDecodeMatrix"),this._uModelMatrix=d.getLocation("modelMatrix"),this._uViewMatrix=d.getLocation("viewMatrix"),this._uProjMatrix=d.getLocation("projMatrix"),this._uClips=[];for(var e=0,f=c.clips.length;e<f;e++)this._uClips.push({active:d.getLocation("clipActive"+e),pos:d.getLocation("clipPos"+e),dir:d.getLocation("clipDir"+e)});this._uEdgeColor=d.getLocation("edgeColor"),this._aPosition=d.getAttribute("position"),this._uClippable=d.getLocation("clippable"),this._uGammaFactor=d.getLocation("gammaFactor"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},xeogl.renderer.EmphasisEdgesRenderer.prototype._bindProgram=function(a){var b=this._program,c=this._scene,d=c.canvas.gl,e=c._clipsState,f=c.camera,g=f._state;if(b.bind(),a.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,d.uniformMatrix4fv(this._uViewMatrix,!1,g.matrix),d.uniformMatrix4fv(this._uProjMatrix,!1,f.project._state.matrix),e.clips.length>0)for(var h,i,j,k,l=e.clips,m=0,n=this._uClips.length;m<n;m++)h=this._uClips[m],i=h.active,j=l[m],i&&d.uniform1i(i,j.active),k=h.pos,k&&d.uniform3fv(h.pos,j.pos),h.dir&&d.uniform3fv(h.dir,j.dir);this._uGammaFactor&&d.uniform1f(this._uGammaFactor,c.gammaFactor)}}(),function(){"use strict";function a(a){var b=a.scene,c=b._clipsState.clips.length>0,d=!!a._geometry._state.quantized,e=a._state.billboard,f=a._state.stationary,g=[];return g.push("// Edges drawing vertex shader"),g.push("attribute vec3 position;"),g.push("uniform mat4 modelMatrix;"),g.push("uniform mat4 viewMatrix;"),g.push("uniform mat4 projMatrix;"),g.push("uniform vec4 edgeColor;"),d&&g.push("uniform mat4 positionsDecodeMatrix;"),c&&g.push("varying vec4 vWorldPosition;"),g.push("varying vec4 vColor;"),"spherical"!==e&&"cylindrical"!==e||(g.push("void billboard(inout mat4 mat) {"),g.push("   mat[0][0] = 1.0;"),g.push("   mat[0][1] = 0.0;"),g.push("   mat[0][2] = 0.0;"),"spherical"===e&&(g.push("   mat[1][0] = 0.0;"),g.push("   mat[1][1] = 1.0;"),g.push("   mat[1][2] = 0.0;")),g.push("   mat[2][0] = 0.0;"),g.push("   mat[2][1] = 0.0;"),g.push("   mat[2][2] =1.0;"),g.push("}")),g.push("void main(void) {"),g.push("vec4 localPosition = vec4(position, 1.0); "),g.push("vec4 worldPosition;"),d&&g.push("localPosition = positionsDecodeMatrix * localPosition;"),g.push("mat4 viewMatrix2 = viewMatrix;"),g.push("mat4 modelMatrix2 = modelMatrix;"),f&&g.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),"spherical"===e||"cylindrical"===e?(g.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),g.push("billboard(modelMatrix2);"),g.push("billboard(viewMatrix2);"),g.push("billboard(modelViewMatrix);"),g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),g.push("vColor = edgeColor;"),c&&g.push("vWorldPosition = worldPosition;"),g.push("   gl_Position = projMatrix * viewPosition;"),g.push("}"),g}function b(a){var b,c,d=a.scene._clipsState,e=a.scene.gammaOutput,f=d.clips.length>0,g=[];if(g.push("// Edges drawing fragment shader"),g.push("precision lowp float;"),e&&(g.push("uniform float gammaFactor;"),g.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),g.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),g.push("}")),f)for(g.push("varying vec4 vWorldPosition;"),g.push("uniform bool clippable;"),b=0,c=d.clips.length;b<c;b++)g.push("uniform bool clipActive"+b+";"),g.push("uniform vec3 clipPos"+b+";"),g.push("uniform vec3 clipDir"+b+";");if(g.push("varying vec4 vColor;"),g.push("void main(void) {"),f){for(g.push("if (clippable) {"),g.push("  float dist = 0.0;"),b=0,c=d.clips.length;b<c;b++)g.push("if (clipActive"+b+") {"),g.push("   dist += clamp(dot(-clipDir"+b+".xyz, vWorldPosition.xyz - clipPos"+b+".xyz), 0.0, 1000.0);"),g.push("}");g.push("  if (dist > 0.0) { discard; }"),g.push("}")}return g.push("gl_FragColor = vColor;"),e?g.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):g.push("gl_FragColor = vColor;"),g.push("}"),g}xeogl.renderer.EmphasisEdgesShaderSource=function(c){this.vertex=a(c),this.fragment=b(c)}}(),function(){"use strict";xeogl.Component=Class.extend({__init:function(){var a={},b=arguments[0],c=arguments[1];this.scene=null,this._model=null;var d=null;"xeogl.Scene"===this.type?(this.scene=this,b&&(a=b)):(b?"xeogl.Scene"===b.type?(this.scene=b,d=this.scene,c&&(a=c)):b.isType&&b.isType("xeogl.Component")?(this.scene=b.scene,d=b,c&&(a=c)):(this.scene=xeogl.scene,d=this.scene,a=b):(this.scene=xeogl.scene,d=this.scene),this._renderer=this.scene._renderer),this.meta=a.meta||{},this.id=a.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null;var e="xeogl.Scene"===this.type;this.scene&&!e&&this.scene._addComponent(this),this._updateScheduled=!1,this._init&&this._init(a),d&&d._adopt(this)},type:"xeogl.Component",superTypes:[],_addedToModel:function(a){this._model=a},_removedFromModel:function(a){this._model=null},_props:{model:{get:function(){return this._model}}},isType:function(a){return!(!xeogl._isString(a)&&!(a=a.type))&&xeogl._isComponentType(this.type,a)},_init:function(a){},fire:function(a,b,c){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==c&&(this._events[a]=b||!0);var d,e=this._eventSubs[a];if(e)for(var f in e)e.hasOwnProperty(f)&&(d=e[f],this._eventCallDepth++,this._eventCallDepth<300?d.callback.call(d.scope,b):this.error("fire: potential stack overflow from recursive event '"+a+"' - dropping this event"),this._eventCallDepth--)},on:function(a,b,c){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new xeogl.utils.Map),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={});var d=this._eventSubs[a];d||(d={},this._eventSubs[a]=d);var e=this._subIdMap.addItem();d[e]={callback:b,scope:c||this},this._subIdEvents[e]=a;var f=this._events[a];return void 0!==f&&b.call(c||this,f),e},off:function(a){if(void 0!==a&&null!==a&&this._subIdEvents){var b=this._subIdEvents[a];if(b){delete this._subIdEvents[a];var c=this._eventSubs[b];c&&delete c[a],this._subIdMap.removeItem(a)}}},once:function(a,b,c){var d=this,e=this.on(a,function(a){d.off(e),b(a)},c)},hasSubs:function(a){return this._eventSubs&&!!this._eventSubs[a]},log:function(a){a="[LOG]"+this._message(a),window.console.log(a),this.scene.fire("log",a)},_message:function(a){return" ["+this.type+" "+xeogl._inQuotes(this.id)+"]: "+a},warn:function(a){a="[WARN]"+this._message(a),window.console.warn(a),this.scene.fire("warn",a)},error:function(a){a="[ERROR]"+this._message(a),window.console.error(a),this.scene.fire("error",a)},_attach:function(a){var b=a.name;if(!b)return void this.error("Component 'name' expected");var c=a.component,d=a.sceneDefault,e=a.sceneSingleton,f=a.type,g=a.on,h=!1!==a.recompiles,i=!1;if(c)if(xeogl._isNumeric(c)||xeogl._isString(c)){var j=c;if(!(c=this.scene.components[j]))return void this.error("Component not found: "+xeogl._inQuotes(j))}else if(xeogl._isObject(c)){var k=c,l=k.type||f||"xeogl.Component",m=window[l];if(!m)return void this.error("Component type not found: "+l);if(f&&!xeogl._isComponentType(l,f))return void this.error("Expected a "+f+" type or subtype, not a "+l);c=new m(this.scene,k),i=!0}if(!c)if(!0===e){var n=this.scene.types[f];for(var o in n)if(n.hasOwnProperty){c=n[o];break}if(!c)return this.error("Scene has no default component for '"+b+"'"),null}else if(!0===d&&!(c=this.scene[b]))return this.error("Scene has no default component for '"+b+"'"),null;if(c){if(c.scene.id!==this.scene.id)return void this.error("Not in same scene: "+c.type+" "+xeogl._inQuotes(c.id));if(f&&!c.isType(f))return void this.error("Expected a "+f+" type or subtype: "+c.type+" "+xeogl._inQuotes(c.id))}this._attachments||(this._attachments={});var p,q,r,s=this._attached[b];if(s){if(c&&s.id===c.id)return;var t=this._attachments[s.id];for(p=t.subs,q=0,r=p.length;q<r;q++)s.off(p[q]);delete this._attached[b],delete this._attachments[s.id];var u=t.params.onDetached
;u&&(xeogl._isFunction(u)?u(s):u.scope?u.callback.call(u.scope,s):u.callback(s)),t.managingLifecycle&&s.destroy()}if(c){var v={params:a,component:c,subs:[],managingLifecycle:i};v.subs.push(c.on("destroyed",function(){v.params.component=null,this._attach(v.params)},this)),h&&v.subs.push(c.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[b]=c,this._attachments[c.id]=v;var w=a.onAttached;if(w&&(xeogl._isFunction(w)?w(c):w.scope?w.callback.call(w.scope,c):w.callback(c)),g){var x,y,z,A;for(x in g)if(g.hasOwnProperty(x)){if(y=g[x],xeogl._isFunction(y)?(z=y,A=null):(z=y.callback,A=y.scope),!z)continue;v.subs.push(c.on(x,z,A))}}}return h&&this.fire("dirty",this),this.fire(b,c),c},_checkComponent:function(a,b){if(xeogl._isObject(b)){if(b.type){if(!xeogl._isComponentType(b.type,a))return void this.error("Expected a "+a+" type or subtype: "+b.type+" "+xeogl._inQuotes(b.id))}else b.type=a;b=new window[b.type](this.scene,b)}else if(xeogl._isID(b)){var c=b;if(!(b=this.scene.components[c]))return void this.error("Component not found: "+xeogl._inQuotes(b.id))}return b.scene.id!==this.scene.id?void this.error("Not in same scene: "+b.type+" "+xeogl._inQuotes(b.id)):b.isType(a)?b:void this.error("Expected a "+a+" type or subtype: "+b.type+" "+xeogl._inQuotes(b.id))},create:function(a){var b,c;if(xeogl._isObject(a)?(b=a.type||"xeogl.Component",c=xeogl[b.substring(6)]):xeogl._isString(a)?(b=a,c=xeogl[b.substring(6)]):(c=a,b=a.prototype.type),!c)return void this.error("Component type not found: "+b);if(!xeogl._isComponentType(b,"xeogl.Component"))return void this.error("Expected a xeogl.Component type or subtype");a&&a.id&&this.components[a.id]&&(this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),a.id=void 0);var d=new c(this,a);return d&&this._adopt(d),d},_adopt:function(a){this._adoptees||(this._adoptees={}),this._adoptees[a.id]||(this._adoptees[a.id]=a),a.on("destroyed",function(){delete this._adoptees[a.id]},this)},_needUpdate:function(a){this._updateScheduled||(this._updateScheduled=!0,0===a?xeogl.deferTask(this._doUpdate,this):xeogl.scheduleTask(this._doUpdate,this))},_doUpdate:function(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())},_update:null,destroy:function(){if(!this.destroyed){var a,b,c,d,e,f;if(this._attachments)for(a in this._attachments)if(this._attachments.hasOwnProperty(a)){for(b=this._attachments[a],c=b.component,d=b.subs,e=0,f=d.length;e<f;e++)c.off(d[e]);b.managingLifecycle&&c.destroy()}if(this._adoptees)for(a in this._adoptees)this._adoptees.hasOwnProperty(a)&&(c=this._adoptees[a],c.destroy(),delete this._adoptees[a]);this._destroy&&this._destroy(),this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._adoptees=null,this._updateScheduled=!1,this.fire("destroyed",this.destroyed=!0)}},_destroy:function(){}})}(),function(){"use strict";xeogl.Scene=xeogl.Component.extend({type:"xeogl.Scene",_init:function(a){var b=this,c=!!a.transparent;this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this.guidObjects={},this.entityTypes={},this.entities={},this.visibleEntities={},this.ghostedEntities={},this.highlightedEntities={},this.selectedEntities={},this._objectGUIDs=null,this._entityIds=null,this._visibleEntityIds=null,this._ghostedEntityIds=null,this._highlightedEntityIds=null,this._selectedEntityIds=null,this.meshes={},this._needRecompileMeshes=!1,this.types={},this.components={},this.rootObjects={},this.clips={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.canvas=new xeogl.Canvas(this,{canvas:a.canvas,transparent:c,backgroundColor:a.backgroundColor,backgroundImage:a.backgroundImage,webgl2:!1!==a.webgl2,contextAttr:a.contextAttr||{},simulateWebGLContextLost:a.simulateWebGLContextLost}),this.canvas.on("boundary",function(){b._renderer.imageDirty()}),this.canvas.on("webglContextFailed",function(){alert("xeogl failed to find WebGL!")}),this._renderer=new xeogl.renderer.Renderer(xeogl.stats,this,{transparent:c}),this._clipsState=new function(){this.clips=[];var a=null;this.getHash=function(){if(a)return a;var b=this.clips;if(0===b.length)return this.hash=";";for(var c=[],d=0,e=b.length;d<e;d++)b[d],c.push("cp");return c.push(";"),a=c.join("")},this.addClip=function(b){this.clips.push(b),a=null},this.removeClip=function(b){for(var c=0,d=this.clips.length;c<d;c++)if(this.clips[c].id===b.id)return this.clips.splice(c,1),void(a=null)}},this._lightsState=new function(){const a=xeogl.math.vec3([0,0,0]);var b=xeogl.math.vec3();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];var c=null,d=null;this.getHash=function(){if(c)return c;for(var a,b=[],d=this.lights,e=0,f=d.length;e<f;e++)a=d[e],b.push("/"),b.push(a.type),b.push("world"===a.space?"w":"v"),a.shadow&&b.push("sh");return this.lightMaps.length>0&&b.push("/lm"),this.reflectionMaps.length>0&&b.push("/rm"),b.push(";"),c=b.join("")},this.addLight=function(a){this.lights.push(a),d=null,c=null},this.removeLight=function(a){for(var b=0,e=this.lights.length;b<e;b++){if(this.lights[b].id===a.id)return this.lights.splice(b,1),d&&d.id===a.id&&(d=null),void(c=null)}},this.addReflectionMap=function(a){this.reflectionMaps.push(a),c=null},this.removeReflectionMap=function(a){for(var b=0,d=this.reflectionMaps.length;b<d;b++)if(this.reflectionMaps[b].id===a.id)return this.reflectionMaps.splice(b,1),void(c=null)},this.addLightMap=function(a){this.lightMaps.push(a),c=null},this.removeLightMap=function(a){for(var b=0,d=this.lightMaps.length;b<d;b++)if(this.lightMaps[b].id===a.id)return this.lightMaps.splice(b,1),void(c=null)},this.getAmbientColor=function(){if(!d)for(var c=0,e=this.lights.length;c<e;c++){var f=this.lights[c];if("ambient"===f.type){d=f;break}}if(d){var g=d.color,h=d.intensity;return b[0]=g[0]*h,b[1]=g[1]*h,b[2]=g[2]*h,b}return a}},this.input=new xeogl.Input(this,{element:this.canvas.canvas}),xeogl._addScene(this);var d=a.components;if(d)for(var e,f,g,h=0,i=d.length;h<i;h++)e=d[h],(f=e.type)&&(g=window[f])&&new g(this,e);this._initDefaults(),this._viewport=new xeogl.Viewport(this,{id:"default.viewport",autoBoundary:!0}),this._camera=new xeogl.Camera(this,{id:"default.camera"}),new xeogl.DirLight(this,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{dir:[-.8,-.4,-.4],color:[1,1,1],intensity:1,space:"view"}),new xeogl.DirLight(this,{dir:[.2,-.8,.8],color:[.6,.6,.6],intensity:1,space:"view"});var j=(this._viewport,this._renderer);this._camera.on("dirty",function(){j.imageDirty()}),this.ticksPerRender=a.ticksPerRender,this.passes=a.passes,this.clearEachPass=a.clearEachPass,this.gammaInput=a.gammaInput,this.gammaOutput=a.gammaOutput,this.gammaFactor=a.gammaFactor},_initDefaults:function(){this.geometry,this.material,this.ghostMaterial,this.outlineMaterial},_addComponent:function(a){if(a.id&&this.components[a.id]&&(this.error("Component "+xeogl._inQuotes(a.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),a.id=null),!a.id)for(void 0===window.nextID&&(window.nextID=0),a.id="_"+window.nextID++;this.components[a.id];)a.id=xeogl.math.createUUID();this.components[a.id]=a;var b=a.type,c=this.types[a.type];c||(c=this.types[b]={}),c[a.id]=a},_removeComponent:function(a){delete this.components[a.id];var b=this.types[a.type];b&&(delete b[a.id],xeogl._isEmptyObject(b)&&delete this.types[a.type])},_clipCreated:function(a){this.clips[a.id]=a,this.scene._clipsState.addClip(a._state),this._needRecompileMeshes=!0},_lightCreated:function(a){this.lights[a.id]=a,this.scene._lightsState.addLight(a._state),this._needRecompileMeshes=!0},_lightMapCreated:function(a){this.lightMaps[a.id]=a,this.scene._lightsState.addLightMap(a._state),this._needRecompileMeshes=!0},_reflectionMapCreated:function(a){this.reflectionMaps[a.id]=a,this.scene._lightsState.addReflectionMap(a._state),this._needRecompileMeshes=!0},_objectCreated:function(a){this.objects[a.id]=a,a.guid&&(this.guidObjects[a.id]=a,this._objectGUIDs=null),a.parent||(this.rootObjects[a.id]=a),xeogl.stats.components.objects++},_meshCreated:function(a){this.meshes[a.id]=a,xeogl.stats.components.meshes++},_modelCreated:function(a){this.models[a.id]=a,xeogl.stats.components.models++},_clipDestroyed:function(a){delete this.clips[a.id],this.scene._clipsState.removeClip(a._state),this._needRecompileMeshes=!0},_lightDestroyed:function(a){delete this.lights[a.id],this.scene._lightsState.removeLight(a._state),this._needRecompileMeshes=!0},_lightMapDestroyed:function(a){delete this.lightMaps[a.id],this.scene._lightsState.removeLightMap(a._state),this._needRecompileMeshes=!0},_reflectionMapDestroyed:function(a){delete this.reflectionMaps[a.id],this.scene._lightsState.removeReflectionMap(a._state),this._needRecompileMeshes=!0},_objectDestroyed:function(a){delete this.objects[a.id],a.guid&&(delete this.guidObjects[a.guid],this._objectGUIDs=null),a.parent||delete this.rootObjects[a.id],xeogl.stats.components.objects--},_meshDestroyed:function(a){xeogl.stats.components.meshes--,delete this.meshes[a.id],xeogl.stats.components.meshes--},_modelDestroyed:function(a){this.models[a.id]=a,xeogl.stats.components.models++},_entityTypeAssigned:function(a,b){this.entities[a.id]=a;var c=this.entityTypes[b];c||(c={},this.entityTypes[b]=c),c[a.id]=a,this._entityIds=null,this._entityTypeIds=null},_entityTypeRemoved:function(a,b){delete this.entities[a.id];var c=this.entityTypes[b];c&&delete c[a.id],this._entityIds=null,this._entityTypeIds=null},_entityVisibilityUpdated:function(a,b){b?this.visibleEntities[a.id]=a:delete this.visibleEntities[a.id],this._visibleEntityIds=null},_entityGhostedUpdated:function(a,b){b?this.ghostedEntities[a.id]=a:delete this.ghostedEntities[a.id],this._ghostedEntityIds=null},_entityHighlightedUpdated:function(a,b){b?this.highlightedEntities[a.id]=a:delete this.highlightedEntities[a.id],this._highlightedEntityIds=null},_entitySelectedUpdated:function(a,b){b?this.selectedEntities[a.id]=a:delete this.selectedEntities[a.id],this._selectedEntityIds=null},_webglContextLost:function(){this.canvas.spinner.processes++;for(var a in this.components)if(this.components.hasOwnProperty(a)){var b=this.components[a];b._webglContextLost&&b._webglContextLost()}this._renderer.webglContextLost()},_webglContextRestored:function(){var a=this.canvas.gl;for(var b in this.components)if(this.components.hasOwnProperty(b)){var c=this.components[b];c._webglContextRestored&&c._webglContextRestored(a)}this._renderer.webglContextRestored(a),this.canvas.spinner.processes--},render:function(){var a={sceneId:null,pass:0};return function(b){if(this._needRecompileMeshes&&(this._recompileMeshes(),this._needRecompileMeshes=!1),this.loading>0||this.canvas.spinner.processes>0)return void(this.canvas.canvas.style.opacity=0);var c=Number.parseFloat(this.canvas.canvas.style.opacity);c<1&&(c+=.1,this.canvas.canvas.style.opacity=c),a.sceneId=this.id;var d,e,f=this._passes,g=this._clearEachPass;for(d=0;d<f;d++)a.pass=d,this.fire("rendering",a,!0),e=g||0===d,this._renderer.render({pass:d,clear:e,force:b}),this.fire("rendered",a,!0);this._saveAmbientColor()}}(),_recompileMeshes:function(){for(var a in this.meshes)this.meshes.hasOwnProperty(a)&&this.meshes[a]._compile()},_saveAmbientColor:function(){var a=this.canvas;if(a.transparent||a.backgroundImage||a.backgroundColor)this._lastAmbientColor=null;else{var b=this._lightsState.getAmbientColor();this._lastAmbientColor&&this._lastAmbientColor[0]===b[0]&&this._lastAmbientColor[1]===b[1]&&this._lastAmbientColor[2]===b[2]&&this._lastAmbientColor[3]===b[3]||(a.backgroundColor=b,this._lastAmbientColor||(this._lastAmbientColor=xeogl.math.vec4([0,0,0,1])),this._lastAmbientColor.set(b))}},_props:{objectGUIDs:{get:function(){return this._objectGUIDs||(this._objectGUIDs=Object.keys(this.guidObjects)),this._objectGUIDs}},entityTypeIds:{get:function(){return this._entityTypeIds||(this._entityTypeIds=Object.keys(this.entityTypes)),this._entityTypeIds}},entityIds:{get:function(){return this._entityIds||(this._entityIds=Object.keys(this.entities)),this._entityIds}},visibleEntityIds:{get:function(){return this._visibleEntityIds||(this._visibleEntityIds=Object.keys(this.visibleEntities)),this._visibleEntityIds}},ghostedEntityIds:{get:function(){return this._ghostedEntityIds||(this._ghostedEntityIds=Object.keys(this.ghostedEntities)),this._ghostedEntityIds}},highlightedEntityIds:{get:function(){return this._highlightedEntityIds||(this._highlightedEntityIds=Object.keys(this.highlightedEntities)),this._highlightedEntityIds}},selectedEntityIds:{get:function(){return this._selectedEntityIds||(this._selectedEntityIds=Object.keys(this.selectedEntities)),this._selectedEntityIds}},ticksPerRender:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._ticksPerRender&&(this._ticksPerRender=a)},get:function(){return this._ticksPerRender}},passes:{set:function(a){void 0===a||null===a?a=1:(!xeogl._isNumeric(a)||a<=0)&&(this.error("Unsupported value for 'passes': '"+a+"' - should be an integer greater than zero."),a=1),a!==this._passes&&(this._passes=a,this._renderer.imageDirty())},get:function(){return this._passes}},clearEachPass:{set:function(a){(a=!!a)!==this._clearEachPass&&(this._clearEachPass=a,this._renderer.imageDirty())},get:function(){return this._clearEachPass}},gammaInput:{set:function(a){(a=!1!==a)!==this._renderer.gammaInput&&(this._renderer.gammaInput=a,this._needRecompileMeshes=!0)},get:function(){return this._renderer.gammaInput}},gammaOutput:{set:function(a){(a=!1!==a)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=a,this._needRecompileMeshes=!0)},get:function(){return this._renderer.gammaOutput}},gammaFactor:{set:function(a){(a=void 0===a||null===a?2.2:a)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=a,this._renderer.imageDirty())},get:function(){return this._renderer.gammaFactor}},geometry:{get:function(){return this.components["default.geometry"]||new xeogl.BoxGeometry(this,{id:"default.geometry",isDefault:!0})}},material:{get:function(){return this.components["default.material"]||new xeogl.PhongMaterial(this,{id:"default.material",isDefault:!0,emissive:[.4,.4,.4]})}},ghostMaterial:{get:function(){return this.components["default.ghostMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.ghostMaterial",preset:"sepia",isDefault:!0})}},highlightMaterial:{get:function(){return this.components["default.highlightMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.highlightMaterial",preset:"yellowHighlight",isDefault:!0})}},selectedMaterial:{get:function(){return this.components["default.selectedMaterial"]||new xeogl.EmphasisMaterial(this,{id:"default.selectedMaterial",preset:"greenSelected",isDefault:!0})}},edgeMaterial:{get:function(){return this.components["default.edgeMaterial"]||new xeogl.EdgeMaterial(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,isDefault:!0})}},outlineMaterial:{get:function(){return this.components["default.outlineMaterial"]||new xeogl.OutlineMaterial(this,{id:"default.outlineMaterial",isDefault:!0})}},viewport:{get:function(){return this._viewport}},camera:{get:function(){return this._camera}},center:{get:function(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=xeogl.math.vec3());var a=this.aabb;this._center[0]=(a[0]+a[3])/2,this._center[1]=(a[1]+a[4])/2,this._center[2]=(a[2]+a[5])/2}return this._center}},aabb:{get:function(){if(this._aabbDirty){this._aabb||(this._aabb=xeogl.math.AABB3());var a,b,c=xeogl.math.MAX_DOUBLE,d=xeogl.math.MAX_DOUBLE,e=xeogl.math.MAX_DOUBLE,f=-xeogl.math.MAX_DOUBLE,g=-xeogl.math.MAX_DOUBLE,h=-xeogl.math.MAX_DOUBLE,i=this.meshes;for(var j in i)if(i.hasOwnProperty(j)){if(b=i[j],!b.collidable)continue;a=b.aabb,a[0]<c&&(c=a[0]),a[1]<d&&(d=a[1]),a[2]<e&&(e=a[2]),a[3]>f&&(f=a[3]),a[4]>g&&(g=a[4]),a[5]>h&&(h=a[5])}this._aabb[0]=c,this._aabb[1]=d,this._aabb[2]=e,this._aabb[3]=f,this._aabb[4]=g,this._aabb[5]=h,this._aabbDirty=!1}return this._aabb}}},_setBoundaryDirty:function(){this._aabbDirty=!0,this.fire("boundary")},pick:function(){function a(a,b){for(var c,d,e={},f=0,g=b.length;f<g;f++)c=b[f],d=a.meshes[c],d?e[c]=!0:a.warn("pick(): Mesh not found: "+c);return e}var b=xeogl.math,c=b.vec3(),d=b.vec3(),e=b.vec3(),f=b.vec3(),g=b.vec3(),h=b.vec3(),i=b.vec4(),j=b.vec3(),k=b.vec3(),l=b.vec3(),m=b.vec3(),n=b.vec3(),o=b.vec3(),p=b.vec3(),q=b.vec3(),r=b.vec3(),s=b.vec4(),t=b.vec4(),u=b.vec4(),v=b.vec3(),w=b.vec3(),x=b.vec3(),y=b.vec3(),z=b.vec3(),A=b.vec3(),B=b.vec3(),C=b.vec3(),D=b.vec3(),E=b.vec3(),F=b.vec3();return function(G){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;G=G||{},G.pickSurface=G.pickSurface||G.rayPick,G.canvasPos||G.origin&&G.direction||this.warn("picking without canvasPos or ray origin and direction");var H=G.includeMeshes||G.include;H&&(G.includeMeshIds=a(this,H));var I=G.excludeMeshes||G.exclude;I&&(G.excludeMeshIds=a(this,I));var J=this._renderer.pick(G);if(J){if(J.object=J.mesh,G.pickSurface&&void 0!==J.primIndex&&J.primIndex>-1){var K=J.mesh.geometry._state;if("triangles"===K.primitiveName){J.primitive="triangle";var L,M,N,O=J.primIndex,P=K.indices,Q=K.positions;if(P){var R=P[O+0],S=P[O+1],T=P[O+2];h[0]=R,h[1]=S,h[2]=T,J.indices=h,L=3*R,M=3*S,N=3*T}else L=3*O,M=L+3,N=M+3;if(e[0]=Q[L+0],e[1]=Q[L+1],e[2]=Q[L+2],f[0]=Q[M+0],f[1]=Q[M+1],f[2]=Q[M+2],g[0]=Q[N+0],g[1]=Q[N+1],g[2]=Q[N+2],K.quantized){var U=K.positionsDecodeMatrix;U&&(b.decompressPosition(e,U,e),b.decompressPosition(f,U,f),b.decompressPosition(g,U,g))}var V;G.canvasPos?(V=G.canvasPos,J.canvasPos=G.canvasPos,b.canvasPosToLocalRay(this.camera,J.mesh,V,c,d)):G.origin&&G.direction&&b.worldRayToLocalRay(J.mesh,G.origin,G.direction,c,d),b.normalizeVec3(d),b.rayPlaneIntersect(c,d,e,f,g,i),J.localPos=i,J.position=i,s[0]=i[0],s[1]=i[1],s[2]=i[2],s[3]=1,b.transformVec4(J.mesh.worldMatrix,s,t),j[0]=t[0],j[1]=t[1],j[2]=t[2],J.worldPos=j,b.transformVec4(J.mesh.scene.camera.matrix,t,u),k[0]=u[0],k[1]=u[1],k[2]=u[2],J.viewPos=k,b.cartesianToBarycentric(i,e,f,g,l),J.bary=l;var W=K.normals;if(W){if(K.quantized){var X=2*R,Y=2*S,Z=2*T;b.octDecodeVec2(W.subarray(X,X+2),m),b.octDecodeVec2(W.subarray(Y,Y+2),n),b.octDecodeVec2(W.subarray(Z,Z+2),o)}else m[0]=W[L],m[1]=W[L+1],m[2]=W[L+2],n[0]=W[M],n[1]=W[M+1],n[2]=W[M+2],o[0]=W[N],o[1]=W[N+1],o[2]=W[N+2];var $=b.addVec3(b.addVec3(b.mulVec3Scalar(m,l[0],v),b.mulVec3Scalar(n,l[1],w),x),b.mulVec3Scalar(o,l[2],y),z);J.normal=b.transformVec3(J.mesh.worldNormalMatrix,$,A)}var _=K.uv;if(_){if(p[0]=_[2*R],p[1]=_[2*R+1],q[0]=_[2*S],q[1]=_[2*S+1],r[0]=_[2*T],r[1]=_[2*T+1],K.quantized){var aa=K.uvDecodeMatrix;aa&&(b.decompressUV(p,aa,p),b.decompressUV(q,aa,q),b.decompressUV(r,aa,r))}J.uv=b.addVec3(b.addVec3(b.mulVec2Scalar(p,l[0],B),b.mulVec2Scalar(q,l[1],C),D),b.mulVec2Scalar(r,l[2],E),F)}}}return J.mesh.fire("picked",J),J}}}(),getAABB:function(){function a(a){var i=a.aabb;i[0]<c&&(c=i[0]),i[1]<d&&(d=i[1]),i[2]<e&&(e=i[2]),i[3]>f&&(f=i[3]),i[4]>g&&(g=i[4]),i[5]>h&&(h=i[5]),b=!0}var b,c=1e5,d=1e5,e=1e5,f=-1e5,g=-1e5,h=-1e5;return function(i){if(void 0===i)return this.aabb;if(xeogl._isString(i)){var j=this.objects[i];if(j)return j.aabb;i=[i]}if(0===i.length)return this.aabb;if(c=1e5,d=1e5,e=1e5,f=-1e5,g=-1e5,h=-1e5,this.withObjects(i,a),b){var k=new xeogl.math.AABB3;return k[0]=c,k[1]=d,k[2]=e,k[3]=f,k[4]=g,k[5]=h,k}return this.aabb}}(),clear:function(){for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this._initDefaults()},clearLights:function(){for(var a=Object.keys(this.lights),b=0,c=a.length;b<c;b++)this.lights[a[b]].destroy()},clearClips:function(){for(var a=Object.keys(this.clips),b=0,c=a.length;b<c;b++)this.clips[a[b]].destroy()},setVisible:function(){function a(a){var c=a.visible!=b;return a.visible=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),setCulled:function(){function a(a){var c=a.culled!=b;return a.culled=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),setSelected:function(){function a(a){var c=a.selected!=b;return a.selected=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),setHighlighted:function(){function a(a){var c=a.highlighted!=b;return a.highlighted=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),setGhosted:function(){function a(a){var c=a.ghosted!=b;return a.ghosted=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),setEdges:function(){function a(a){var c=a.edges!=b;return a.edges=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),setOutlined:void 0,setColorize:function(){function a(a){a.colorize=b}var b;return function(c,d){b=d,this.withObjects(c,a)}}(),setOpacity:function(){function a(a){a.opacity=b}var b;return function(c,d){b=d,this.withObjects(c,a)}}(),setPickable:function(){function a(a){var c=a.pickable!=b;return a.pickable=b,c}var b;return function(c,d){return b=d,this.withObjects(c,a)}}(),withObjects:function(a,b){xeogl._isString(a)&&(a=[a]);for(var c=!1,d=0,e=a.length;d<e;d++){var f=a[d],g=this.objects[f];if(g)c=b(g)||c;else if(g=this.guidObjects[f])c=b(g)||c;else{var h=this.entityTypes[f];if(h)for(var i in h)h.hasOwnProperty(i)&&(c=b(h[i])||c)}}return c},_destroy:function(){this.clear(),this.canvas.gl=null,this.models=null,this.objects=null,this.guidObjects=null,this.entityTypes=null,this.entities=null,this.visibleEntities=null,this.ghostedEntities=null,this.highlightedEntities=null,this.selectedEntities=null,this.clips=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectGUIDs=null,this._entityIds=null,this._visibleEntityIds=null,this._ghostedEntityIds=null,this._highlightedEntityIds=null,this._selectedEntityIds=null,this.meshes=null,this.types=null,this.components=null,this.rootObjects=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}})}(),xeogl.Object=xeogl.Component.extend({type:"xeogl.Object",_init:function(a){var b=xeogl.math;if(this._guid=a.guid,this._parent=null,this._childList=[],this._childMap={},this._childIDs=null,this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._scale=b.vec3(),this._quaternion=b.identityQuaternion(),this._rotation=b.vec3(),this._position=b.vec3(),this._worldMatrix=b.identityMat4(),this._worldNormalMatrix=b.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,a.matrix?this.matrix=a.matrix:(this.scale=a.scale,this.position=a.position,a.quaternion||(this.rotation=a.rotation)),a.entityType&&(this._entityType=a.entityType,this.scene._entityTypeAssigned(this,this._entityType)),this.visible=a.visible,this.culled=a.culled,this.pickable=a.pickable,this.clippable=a.clippable,this.collidable=a.collidable,this.castShadow=a.castShadow,this.receiveShadow=a.receiveShadow,this.outlined=a.outlined,this.solid=a.solid,this.ghosted=a.ghosted,this.highlighted=a.highlighted,this.selected=a.selected,this.edges=a.edges,this.aabbVisible=a.aabbVisible,this.layer=a.layer,this.colorize=a.colorize,this.opacity=a.opacity,a.children)for(var c=a.children,d=0,e=c.length;d<e;d++)this.addChild(c[d],a.inheritStates);a.parent&&a.parent.addChild(this),this.scene._objectCreated(this)},_setLocalMatrixDirty:function(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()},_setWorldMatrixDirty:function(){if(this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0,this._childList)for(var a=0,b=this._childList.length;a<b;a++)this._childList[a]._setWorldMatrixDirty()},_buildWorldMatrix:function(){var a=this.matrix;if(this._parent)xeogl.math.mulMat4(this._parent.worldMatrix,a,this._worldMatrix);else for(var b=0,c=a.length;b<c;b++)this._worldMatrix[b]=a[b];this._worldMatrixDirty=!1},_buildWorldNormalMatrix:function(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=xeogl.math.mat4()),xeogl.math.inverseMat4(this._worldMatrix,this._worldNormalMatrix),xeogl.math.transposeMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1},_setAABBDirty:function(){function a(b){if(b._aabbDirty=!0,b.fire("boundary",!0),b._childList)for(var c=0,d=b._childList.length;c<d;c++)a(b._childList[c])}return function(){if(a(this),this.collidable)for(var b=this;b;b=b._parent)b._aabbDirty=!0,b.fire("boundary",!0)}}(),_updateAABB:function(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=xeogl.math.AABB3()),this._buildMeshAABB)this._buildMeshAABB(this.worldMatrix,this._aabb);else{xeogl.math.collapseAABB3(this._aabb);for(var a,b=0,c=this._childList.length;b<c;b++)a=this._childList[b],a.collidable&&xeogl.math.expandAABB3(this._aabb,a.aabb);this._aabbCenter||(this._aabbCenter=new Float32Array(3)),xeogl.math.getAABB3Center(this._aabb,this._aabbCenter)}this._aabbDirty=!1},addChild:function(a,b){if(xeogl._isNumeric(a)||xeogl._isString(a)){var c=a;if(!(a=this.scene.objects[c]))return void this.warn("Object not found: "+xeogl._inQuotes(c))}else if(xeogl._isObject(a)){throw"addChild( * ) not implemented"}else{if(!a.isType("xeogl.Object"))return void this.error("Not a xeogl.Object: "+a.id);if(a._parent){if(a._parent.id===this.id)return void this.warn("Already a child object: "+a.id);a._parent.removeChild(a)}}a.id;return a.scene.id!==this.scene.id?void this.error("Object not in same Scene: "+a.id):(delete this.scene.rootObjects[a.id],this._childList.push(a),this._childMap[a.id]=a,this._childIDs=null,a._parent=this,b&&(a.visible=this.visible,a.culled=this.culled,a.ghosted=this.ghosted,a.highlited=this.highlighted,a.selected=this.selected,a.edges=this.edges,a.outlined=this.outlined,a.clippable=this.clippable,a.pickable=this.pickable,a.collidable=this.collidable,a.castShadow=this.castShadow,a.receiveShadow=this.receiveShadow,a.colorize=this.colorize,a.opacity=this.opacity),a._setWorldMatrixDirty(),a._setAABBDirty(),a)},removeChild:function(a){for(var b=0,c=this._childList.length;b<c;b++)if(this._childList[b].id===a.id)return a._parent=null,this._childList=this._childList.splice(b,1),delete this._childMap[a.id],this._childIDs=null,this.scene.rootObjects[a.id]=a,a._setWorldMatrixDirty(),a._setAABBDirty(),void this._setAABBDirty()},removeChildren:function(){for(var a,b=0,c=this._childList.length;b<c;b++)a=this._childList[b],a._parent=null,this.scene.rootObjects[a.id]=a,a._setWorldMatrixDirty(),a._setAABBDirty();this._childList=[],this._childMap={},this._childIDs=null,this._setAABBDirty()},rotate:function(){var a=new Float32Array(4),b=new Float32Array(4),c=new Float32Array(4);return function(d,e){return a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=e*xeogl.math.DEGTORAD,xeogl.math.angleAxisToQuaternion(a,b),xeogl.math.mulQuaternions(this.quaternion,b,c),this.quaternion=c,this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty(),this}}(),rotateOnWorldAxis:function(){var a=new Float32Array(4),b=new Float32Array(4);return function(c,d){return a[0]=c[0],a[1]=c[1],a[2]=c[2],a[3]=d*xeogl.math.DEGTORAD,xeogl.math.angleAxisToQuaternion(a,b),xeogl.math.mulQuaternions(b,this.quaternion,b),this}}(),rotateX:function(){var a=new Float32Array([1,0,0]);return function(b){return this.rotate(a,b)}}(),rotateY:function(){var a=new Float32Array([0,1,0]);return function(b){return this.rotate(a,b)}}(),rotateZ:function(){var a=new Float32Array([0,0,1]);return function(b){return this.rotate(a,b)}}(),translate:function(){var a=new Float32Array(3),b=new Float32Array(3);return function(c,d){return xeogl.math.vec3ApplyQuaternion(this.quaternion,c,a),xeogl.math.mulVec3Scalar(a,d,b),xeogl.math.addVec3(this.position,b,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty(),this}}(),translateX:function(){var a=new Float32Array([1,0,0]);return function(b){return this.translate(a,b)}}(),translateY:function(){var a=new Float32Array([0,1,0]);return function(b){return this.translate(a,b)}}(),translateZ:function(){var a=new Float32Array([0,0,1]);return function(b){return this.translate(a,b)}}(),_props:{guid:{get:function(){return this._guid}},entityType:{get:function(){return this._entityType}},numChildren:{get:function(){return this._childList.length}},children:{get:function(){return this._childList}},childMap:{get:function(){return this._childMap}},childIDs:{get:function(){return this._childIDs||(this._childIDs=Object.keys(this._childMap)),this._childIDs}},parent:{set:function(a){if(xeogl._isNumeric(a)||xeogl._isString(a)){var b=a;if(!(a=this.scene.objects[b]))return void this.warn("Group not found: "+xeogl._inQuotes(b))}return a.scene.id!==this.scene.id?void this.error("Group not in same Scene: "+a.id):this._parent&&this._parent.id===a.id?void this.warn("Already a child of Group: "+a.id):void a.addChild(this)},get:function(){return this._parent}},position:{set:function(a){this._position.set(a||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._position}},rotation:{set:function(a){this._rotation.set(a||[0,0,0]),xeogl.math.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._rotation}},quaternion:{set:function(a){this._quaternion.set(a||[0,0,0,1]),xeogl.math.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._quaternion}},scale:{set:function(a){this._scale.set(a||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()},get:function(){return this._scale}},matrix:{set:function(){var a=xeogl.math.identityMat4();return function(b){this.__localMatrix||(this.__localMatrix=xeogl.math.identityMat4()),this.__localMatrix.set(b||a),xeogl.math.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this._renderer.imageDirty()}}(),get:function(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=xeogl.math.identityMat4()),xeogl.math.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}},worldMatrix:{get:function(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}},worldNormalMatrix:{get:function(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}},aabb:{get:function(){return this._aabbDirty&&this._updateAABB(),this._aabb}},center:{get:function(){return this._aabbDirty&&this._updateAABB(),this._aabbCenter}},visible:{set:function(a){a=!1!==a,this._visible=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].visible=a;this._entityType&&this.scene._entityVisibilityUpdated(this,a)},get:function(){return this._visible}},highlighted:{set:function(a){a=!!a,this._highlighted=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].highlighted=a;this._entityType&&this.scene._entityHighlightedUpdated(this,a)},get:function(){return this._highlighted}},ghosted:{set:function(a){a=!!a,this._ghosted=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].ghosted=a;this._entityType&&this.scene._entityGhostedUpdated(this,a)},get:function(){return this._ghosted}},selected:{set:function(a){a=!!a,this._selected=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].selected=a;this._entityType&&this.scene._entitySelectedUpdated(this,a)},get:function(){return this._selected}},edges:{set:function(a){a=!!a,this._edges=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].edges=a},get:function(){return this._edges}},culled:{set:function(a){a=!!a,this._culled=a
;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].culled=a},get:function(){return this._culled}},clippable:{set:function(a){a=!1!==a,this._clippable=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].clippable=a},get:function(){return this._clippable}},collidable:{set:function(a){a=!1!==a,this._collidable=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].collidable=a},get:function(){return this._collidable}},pickable:{set:function(a){a=!1!==a,this._pickable=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].pickable=a},get:function(){return this._pickable}},colorize:{set:function(a){var b=this._colorize;b||(b=this._colorize=new Float32Array(4),b[3]=1),a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1);for(var c=0,d=this._childList.length;c<d;c++)this._childList[c].colorize=b},get:function(){return this._colorize.slice(0,3)}},opacity:{set:function(a){var b=this._colorize;b||(b=this._colorize=new Float32Array(4),b[0]=1,b[1]=1,b[2]=1),b[3]=null!==a&&void 0!==a?a:1;for(var c=0,d=this._childList.length;c<d;c++)this._childList[c].opacity=a},get:function(){return this._colorize[3]}},outlined:{set:function(a){a=!!a,this._outlined=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].outlined=a},get:function(){return this._outlined}},castShadow:{set:function(a){a=!!a,this._castShadow=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].castShadow=a},get:function(){return this._castShadow}},receiveShadow:{set:function(a){a=!!a,this._receiveShadow=a;for(var b=0,c=this._childList.length;b<c;b++)this._childList[b].receiveShadow=a},get:function(){return this._receiveShadow}},aabbVisible:{set:function(a){(a||this._aabbHelper)&&(this._aabbHelper||(this._aabbHelper=new xeogl.Mesh(this,{geometry:new xeogl.AABBGeometry(this,{target:this}),material:new xeogl.PhongMaterial(this,{diffuse:[.5,1,.5],emissive:[.5,1,.5],lineWidth:2})})),this._aabbHelper.visible=a)},get:function(){return!!this._aabbHelper&&this._aabbHelper.visible}}},_destroy:function(){if(this._super(),this._parent&&this._parent.removeChild(this),this._entityType){var a=this.scene;a._entityTypeRemoved(this,this._entityType),this._visible&&a._entityVisibilityUpdated(this,!1),this._ghosted&&a._entityGhostedUpdated(this,!1),this._selected&&a._entitySelectedUpdated(this,!1),this._highlighted&&a._entityHighlightedUpdated(this,!1)}for(var b,c=0,d=this._childList.length;c<d;c++)b=this._childList[c],b.destroy();this._childList=[],this._childMap={},this._childIDs=null,this._setAABBDirty(),this.scene._aabbDirty=!0,this.scene._objectDestroyed(this)}}),xeogl.Group=xeogl.Object.extend({type:"xeogl.Group",_init:function(a){this._super(a)}}),function(){"use strict";xeogl.Mesh=xeogl.Object.extend({type:"xeogl.Mesh",_init:function(a){this._state=new xeogl.renderer.State({visible:!0,culled:!1,pickable:null,clippable:null,colorize:null,collidable:null,castShadow:null,receiveShadow:null,outlined:null,ghosted:!1,highlighted:!1,selected:!1,edges:!1,layer:null,billboard:this._checkBillboard(a.billboard),stationary:!!a.stationary,hash:""}),this._drawRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._emphasisVerticesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._worldPositions=null,this._worldPositionsDirty=!0,this._geometry=a.geometry?this._checkComponent("xeogl.Geometry",a.geometry):this.scene.geometry,this._vertexBufs=this._geometry._getVertexBufs(),this._material=a.material?this._checkComponent("xeogl.Material",a.material):this.scene.material,this._ghostMaterial=a.ghostMaterial?this._checkComponent("xeogl.EmphasisMaterial",a.ghostMaterial):this.scene.ghostMaterial,this._outlineMaterial=a.outlineMaterial?this._checkComponent("xeogl.EmphasisMaterial",a.outlineMaterial):this.scene.outlineMaterial,this._highlightMaterial=a.highlightMaterial?this._checkComponent("xeogl.EmphasisMaterial",a.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=a.selectedMaterial?this._checkComponent("xeogl.EmphasisMaterial",a.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=a.edgeMaterial?this._checkComponent("xeogl.EdgeMaterial",a.edgeMaterial):this.scene.edgeMaterial,this._compile(),this._super(a),this.scene._meshCreated(this)},_checkBillboard:function(a){return a=a||"none","spherical"!==a&&"cylindrical"!==a&&"none"!==a&&(this.error("Unsupported value for 'billboard': "+a+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),a="none"),a},_compile:function(){this._putRenderers(),this._makeHash(),this._drawRenderer=xeogl.renderer.DrawRenderer.get(this),this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this),this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this),this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this),this._pickMeshRenderer=xeogl.renderer.PickMeshRenderer.get(this),this._renderer.meshListDirty()},_webglContextRestored:function(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._emphasisVerticesRenderer&&this._emphasisVerticesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored()},_makeHash:function(){var a=[],b=this._state;b.stationary&&a.push("/s"),"none"===b.billboard?a.push("/n"):"spherical"===b.billboard?a.push("/s"):"cylindrical"===b.billboard&&a.push("/c"),b.receiveShadow&&a.push("/rs"),a.push(";"),this._state.hash=a.join("")},_buildMeshAABB:function(){var a=xeogl.math,b=a.OBB3();return function(c,d){a.transformOBB3(c,this._geometry.obb,b),a.OBB3ToAABB3(b,d)}}(),_getSceneHash:function(){return(this.scene.gammaInput?"gi;":";")+(this.scene.gammaOutput?"go":"")},_draw:function(a){(this._drawRenderer||(this._drawRenderer=xeogl.renderer.DrawRenderer.get(this)))&&this._drawRenderer.drawMesh(a,this)},_drawGhostFill:function(a){(this._emphasisFillRenderer||(this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this)))&&this._emphasisFillRenderer.drawMesh(a,this,0)},_drawGhostEdges:function(a){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(a,this,0)},_drawGhostVertices:function(a){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this)))&&this._emphasisVerticesRenderer.drawMesh(a,this,0)},_drawHighlightFill:function(a){(this._emphasisFillRenderer||(this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this)))&&this._emphasisFillRenderer.drawMesh(a,this,1)},_drawHighlightEdges:function(a){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(a,this,1)},_drawHighlightVertices:function(a){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this)))&&this._emphasisVerticesRenderer.drawMesh(a,this,1)},_drawSelectedFill:function(a){(this._emphasisFillRenderer||(this._emphasisFillRenderer=xeogl.renderer.EmphasisFillRenderer.get(this)))&&this._emphasisFillRenderer.drawMesh(a,this,2)},_drawSelectedEdges:function(a){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(a,this,2)},_drawSelectedVertices:function(a){(this._emphasisVerticesRenderer||(this._emphasisVerticesRenderer=xeogl.renderer.EmphasisVerticesRenderer.get(this)))&&this._emphasisVerticesRenderer.drawMesh(a,this,2)},_drawEdges:function(a){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=xeogl.renderer.EmphasisEdgesRenderer.get(this)))&&this._emphasisEdgesRenderer.drawMesh(a,this,3)},_drawShadow:function(a,b){(this._shadowRenderer||(this._shadowRenderer=xeogl.renderer.ShadowRenderer.get(this)))&&this._shadowRenderer.drawMesh(a,this,b)},_drawOutline:function(a){(this._shadowRenderer||(this._outlineRenderer=xeogl.renderer.OutlineRenderer.get(this)))&&this._outlineRenderer.drawMesh(a,this)},_pickMesh:function(a){(this._pickMeshRenderer||(this._pickMeshRenderer=xeogl.renderer.PickMeshRenderer.get(this)))&&this._pickMeshRenderer.drawMesh(a,this)},_pickTriangle:function(a){(this._pickTriangleRenderer||(this._pickTriangleRenderer=xeogl.renderer.PickTriangleRenderer.get(this)))&&this._pickTriangleRenderer.drawMesh(a,this)},_pickVertex:function(a){(this._pickVertexRenderer||(this._pickVertexRenderer=xeogl.renderer.PickVertexRenderer.get(this)))&&this._pickVertexRenderer.drawMesh(a,this)},_getOutlineRenderer:function(){return this._outlineRenderer=xeogl.renderer.OutlineRenderer.get(this),!this._outlineRenderer.errors||(this.errors=(this.errors||[]).concat(this._outlineRenderer.errors),this.error(this._outlineRenderer.errors.join("\n")),!1)},_putRenderers:function(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null),this._emphasisVerticesRenderer&&(this._emphasisVerticesRenderer.put(),this._emphasisVerticesRenderer=null),this._outlineRenderer&&(this._outlineRenderer.put(),this._outlineRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null),this._pickVertexRenderer&&(this._pickVertexRenderer.put(),this._pickVertexRenderer=null)},_props:{worldPositions:{get:function(){if(this._worldPositionsDirty){var a=this._geometry.positions;this._worldPositions||(this._worldPositions=new Float32Array(a.length)),xeogl.math.transformPositions3(this.worldMatrix,a,this._worldPositions),this._worldPositionsDirty=!1}return this._worldPositions},set:function(a){(a=null===a)&&(this._worldPositions=null,this._worldPositionsDirty=!0)}},geometry:{get:function(){return this._geometry}},material:{get:function(){return this._material}},ghostMaterial:{get:function(){return this._ghostMaterial}},highlightMaterial:{get:function(){return this._highlightMaterial}},selectedMaterial:{get:function(){return this._selectedMaterial}},edgeMaterial:{get:function(){return this._edgeMaterial}},outlineMaterial:{get:function(){return this._outlineMaterial}},visible:{set:function(a){a=!1!==a,this._state.visible=a,this._entityType&&this.scene._entityVisibilityUpdated(this,a),this._renderer.imageDirty()},get:function(){return this._state.visible}},"ghosted,ghost":{set:function(a){a=!!a,this._state.ghosted!==a&&(this._state.ghosted=a,this._entityType&&this.scene._entityGhostedUpdated(this,a),this._renderer.imageDirty())},get:function(){return this._state.ghosted}},"highlight,highlighted":{set:function(a){(a=!!a)!==this._state.highlighted&&(this._state.highlighted=a,this._entityType&&this.scene._entityHighlightedUpdated(this,a),this._renderer.imageDirty())},get:function(){return this._state.highlighted}},selected:{set:function(a){(a=!!a)!==this._state.selected&&(this._state.selected=a,this._entityType&&this.scene._entitySelectedUpdated(this,a),this._renderer.imageDirty())},get:function(){return this._state.selected}},edges:{set:function(a){(a=!!a)!==this._state.edges&&(this._state.edges=a,this._renderer.imageDirty())},get:function(){return this._state.edges}},culled:{set:function(a){this._state.culled=!!a,this._renderer.imageDirty()},get:function(){return this._state.culled}},pickable:{set:function(a){a=!1!==a,this._state.pickable!==a&&(this._state.pickable=a)},get:function(){return this._state.pickable}},clippable:{set:function(a){a=!1!==a,this._state.clippable!==a&&(this._state.clippable=a,this._renderer.imageDirty())},get:function(){return this._state.clippable}},collidable:{set:function(a){(a=!1!==a)!==this._state.collidable&&(this._state.collidable=a)},get:function(){return this._state.collidable}},castShadow:{set:function(a){},get:function(){return this._state.castShadow}},receiveShadow:{set:function(a){},get:function(){return this._state.receiveShadow}},"outlined,outline":{set:function(a){(a=!!a)!==this._state.outlined&&(this._state.outlined=a,this._renderer.imageDirty())},get:function(){return this._state.outlined}},colorize:{set:function(a){var b=this._state.colorize;b||(b=this._state.colorize=new Float32Array(4),b[3]=1),a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.colorize}},opacity:{set:function(a){var b=this._state.colorize;b||(b=this._state.colorize=new Float32Array(4),b[0]=1,b[1]=1,b[2]=1),b[3]=null!==a&&void 0!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.colorize[3]}},layer:{set:function(a){a=a||0,(a=Math.round(a))!==this._state.layer&&(this._state.layer=a,this._renderer.needStateSort())},get:function(){return this._state.layer}},stationary:{get:function(){return this._state.stationary}},billboard:{get:function(){return this._state.billboard}}},_destroy:function(){this._super(),this._putRenderers(),this._renderer.meshListDirty(),this.scene._meshDestroyed(this)}}),xeogl.Mesh._compareState=function(a,b){return a._state.layer-b._state.layer||a._drawRenderer.id-b._drawRenderer.id||a._material._state.id-b._material._state.id||a._vertexBufs.id-b._vertexBufs.id||a._geometry._state.id-b._geometry._state.id}}(),function(){"use strict";var a=xeogl.math;xeogl.CameraFlightAnimation=xeogl.Component.extend({type:"xeogl.CameraFlightAnimation",_init:function(b){this._aabbHelper=this.create({type:"xeogl.Mesh",geometry:this.create({type:"xeogl.AABBGeometry"}),material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2}),visible:!1,collidable:!1}),this._obbHelper=this.create({type:"xeogl.Mesh",geometry:this.create({type:"xeogl.OBBGeometry",material:this.create({type:"xeogl.PhongMaterial",diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[.5,1,.5],lineWidth:2})}),visible:!1,collidable:!1}),this._look1=a.vec3(),this._eye1=a.vec3(),this._up1=a.vec3(),this._look2=a.vec3(),this._eye2=a.vec3(),this._up2=a.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingUp=!1,this._callback=null,this._callbackScope=null,this._onTick=null,this._time1=null,this._time2=null,this.easing=!1!==b.easing,this.duration=b.duration,this.fit=b.fit,this.fitFOV=b.fitFOV,this.trail=b.trail},flyTo:function(){var b=a.vec3();return function(c,d,e){c=c||this.scene,this._flying&&this.stop(),this._flying=!1,this._callback=d,this._callbackScope=e;var f=this.scene.camera;this._eye1[0]=f.eye[0],this._eye1[1]=f.eye[1],this._eye1[2]=f.eye[2],this._look1[0]=f.look[0],this._look1[1]=f.look[1],this._look1[2]=f.look[2],this._up1[0]=f.up[0],this._up1[1]=f.up[1],this._up1[2]=f.up[2],this._orthoScale1=f.ortho.scale,this._orthoScale2=c.orthoScale||this._orthoScale1;var g,h,i,j,k;if(c.aabb)g=c.aabb;else if(6===c.length)g=c;else if(c.eye&&c.look||c.up)h=c.eye,i=c.look,j=c.up;else if(c.eye)h=c.eye;else if(c.look)i=c.look;else{var l=c;if((xeogl._isNumeric(l)||xeogl._isString(l))&&(k=l,!(l=this.scene.components[k])))return this.error("Component not found: "+xeogl._inQuotes(k)),void(d&&(e?d.call(e):d()));g=l.aabb||this.scene.aabb}var m=c.poi;if(g){if(g[3]<g[0]||g[4]<g[1]||g[5]<g[2])return;if(g[3]===g[0]&&g[4]===g[1]&&g[5]===g[2])return;!1!==c.showAABB&&(this._aabbHelper.geometry.targetAABB=g),g=g.slice();var n=a.getAABB3Center(g);this._look2=m||n;var o=a.subVec3(this._eye1,this._look1,b),p=a.normalizeVec3(o),q=m?a.getAABB3DiagPoint(g,m):a.getAABB3Diag(g),r=c.fitFOV||this._fitFOV,s=Math.abs(q/Math.tan(r*xeogl.math.DEGTORAD));this._orthoScale2=1.1*q,this._eye2[0]=this._look2[0]+p[0]*s,this._eye2[1]=this._look2[1]+p[1]*s,this._eye2[2]=this._look2[2]+p[2]*s,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyEyeLookUp=!1}else(h||i||j)&&(this._flyEyeLookUp=!!h&&!!i&&!!j,this._flyingEye=!!h&&!i,this._flyingLook=!!i&&!h,i&&(this._look2[0]=i[0],this._look2[1]=i[1],this._look2[2]=i[2]),h&&(this._eye2[0]=h[0],this._eye2[1]=h[1],this._eye2[2]=h[2]),j&&(this._up2[0]=j[0],this._up2[1]=j[1],this._up2[2]=j[2]));this.fire("started",c,!0),this._time1=Date.now(),this._time2=this._time1+(c.duration?1e3*c.duration:this._duration),this._flying=!0,xeogl.scheduleTask(this._update,this)}}(),jumpTo:function(a){this._jumpTo(a)},_jumpTo:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(g){this._flying&&this.stop();var h,i,j=this.scene.camera;if(g.aabb)h=g.aabb;else if(6===g.length)h=g;else if(g.eye||g.look||g.up)b=g.eye,c=g.look,d=g.up;else{var k=g;if((xeogl._isNumeric(k)||xeogl._isString(k))&&(i=k,!(k=this.scene.components[i])))return void this.error("Component not found: "+xeogl._inQuotes(i));h=k.aabb||this.scene.aabb}var l=g.poi;if(h){var m;if(h[3]<=h[0]||h[4]<=h[1]||h[5]<=h[2])return;var m=l?a.getAABB3DiagPoint(h,l):a.getAABB3Diag(h);c=l||a.getAABB3Center(h,c),this._trail?a.subVec3(j.look,c,e):a.subVec3(j.eye,j.look,e),a.normalizeVec3(e);var n;n=(void 0!==g.fit?g.fit:this._fit)?Math.abs(m/Math.tan((g.fitFOV||this._fitFOV)*xeogl.math.DEGTORAD)):a.lenVec3(a.subVec3(j.eye,j.look,f)),a.mulVec3Scalar(e,n),j.eye=a.addVec3(c,e,b),j.look=c}else(b||c||d)&&(b&&(j.eye=b),c&&(j.look=c),d&&(j.up=d))}}(),_update:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3();return function(){if(this._flying){var g=Date.now(),h=(g-this._time1)/(this._time2-this._time1),i=h>=1;h>1&&(h=1),h=this.easing?this._ease(h,0,1,1):h;var j=this.scene.camera;if(this._flyingEye||this._flyingLook)this._flyingEye?(a.subVec3(j.eye,j.look,b),j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.subVec3(c,b,d)):this._flyingLook&&(j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.up=a.lerpVec3(h,0,1,this._up1,this._up2,e));else if(this._flyEyeLookUp)j.eye=a.lerpVec3(h,0,1,this._eye1,this._eye2,c),j.look=a.lerpVec3(h,0,1,this._look1,this._look2,d),j.up=a.lerpVec3(h,0,1,this._up1,this._up2,e);else{a.lerpVec3(h,0,1,this._look1,this._look2,d);var k;this._trail?a.subVec3(d,j.look,b):a.subVec3(j.eye,j.look,b),a.normalizeVec3(b),a.lerpVec3(h,0,1,this._eye1,this._eye2,c),a.subVec3(c,d,f),k=a.lenVec3(f),a.mulVec3Scalar(b,k),j.eye=a.addVec3(d,b,c),j.look=d}if(this.scene.camera.ortho.scale=this._orthoScale1+h*(this._orthoScale2-this._orthoScale1),i)return void this.stop();xeogl.scheduleTask(this._update,this)}}}(),_ease:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},stop:function(){if(this._flying){this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null;var a=this._callback;a&&(this._callback=null,this._callbackScope?a.call(this._callbackScope):a()),this.fire("stopped",!0,!0)}},cancel:function(){this._flying&&(this._aabbHelper.visible=!1,this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))},_props:{duration:{set:function(a){this._duration=a?1e3*a:500,this.stop()},get:function(){return this._duration/1e3}},fit:{set:function(a){this._fit=!1!==a},get:function(){return this._fit}},fitFOV:{set:function(a){this._fitFOV=a||45},get:function(){return this._fitFOV}},trail:{set:function(a){this._trail=!!a},get:function(){return this._trail}}},_destroy:function(){this.stop()}})}(),function(){"use strict";xeogl.Canvas=xeogl.Component.extend({type:"xeogl.Canvas",serializable:!1,_WEBGL_CONTEXT_NAMES:["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],_init:function(a){if(this.canvas=null,this.gl=null,this.webgl2=!1,this.transparent=!!a.transparent,this.contextAttr=a.contextAttr||{},this.contextAttr.alpha=this.transparent,void 0!==this.contextAttr.preserveDrawingBuffer&&null!==this.contextAttr.preserveDrawingBuffer||(this.contextAttr.preserveDrawingBuffer=!0),this.contextAttr.stencil=!1,this.contextAttr.antialias=!0,this.contextAttr.premultipliedAlpha=!1!==this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,a.canvas?xeogl._isString(a.canvas)?(this.canvas=document.getElementById(a.canvas),this.canvas||(this.error("Canvas element not found: "+xeogl._inQuotes(a.canvas)+" - creating default canvas instead."),this._createCanvas())):this.canvas=a.canvas:this._createCanvas(),!this.canvas)return void this.error("Faied to create canvas");this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._createBackground(),a.simulateWebGLContextLost&&(window.WebGLDebugUtils?this.canvas=WebGLDebugUtils.makeLostContextSimulatingCanvas(this.canvas):this.error("To simulate context loss, please include WebGLDebugUtils")),this._initWebGL(a);var b=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(a){console.time("webglcontextrestored"),b.scene._webglContextLost(),b.fire("webglcontextlost"),a.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(a){b._initWebGL(),b.gl&&(b.scene._webglContextRestored(b.gl),b.fire("webglcontextrestored",b.gl),a.preventDefault()),console.timeEnd("webglcontextrestored")},!1);var c=null,d=null,e=null,f=null,g=null,h=null,i=null;this._tick=this.scene.on("tick",function(){var a=b.canvas,j=window.innerWidth!==c||window.innerHeight!==d,k=a.clientWidth!==e||a.clientHeight!==f,l=a.offsetLeft!==g||a.offsetTop!==h,m=a.parentElement,n=m!==i;if(j||k||l||n){if(b._spinner._adjustPosition(),k||l){var o=a.clientWidth,p=a.clientHeight;if(k){var q,r=0;for(var s in xeogl.scenes)xeogl.scenes.hasOwnProperty(s)&&(q=xeogl.scenes[s],r+=q.canvas.canvas.clientWidth*q.canvas.canvas.clientHeight);xeogl.stats.memory.pixels=r,a.width=a.clientWidth,a.height=a.clientHeight}var t=b.boundary;t[0]=a.offsetLeft,t[1]=a.offsetTop,t[2]=o,t[3]=p,b.fire("boundary",t),e=o,f=p}j&&(c=window.innerWidth,d=window.innerHeight),l&&(g=a.offsetLeft,h=a.offsetTop),i=m}}),this.canvas.oncontextmenu=function(a){a.preventDefault()},this._spinner=new xeogl.Spinner(this.scene,{canvas:this.canvas}),this.backgroundColor=a.backgroundColor,this.backgroundImage=a.backgroundImage},_createCanvas:function(){var a="xeogl-canvas-"+xeogl.math.createUUID(),b=document.getElementsByTagName("body")[0],c=document.createElement("div"),d=c.style;d.height="100%",d.width="100%",d.padding="0",d.margin="0",d.background="rgba(0,0,0,0);",d.float="left",d.left="0",d.top="0",d.position="absolute",d.opacity="1.0",d["z-index"]="-10000",c.innerHTML+='<canvas id="'+a+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',b.appendChild(c),this.canvas=document.getElementById(a)},_createBackground:function(){var a=document.createElement("div"),b=a.style;b.padding="0",b.margin="0",b.background=null,b.backgroundImage=null,b.float="left",b.left="0",b.top="0",b.width="100%",b.height="100%",b.position="absolute",b.opacity=1,b["z-index"]="-20000",this.canvas.parentElement.appendChild(a),this._backgroundElement=a},_getElementXY:function(a){for(var b=0,c=0;a;)b+=a.offsetLeft-a.scrollLeft,c+=a.offsetTop-a.scrollTop,a=a.offsetParent;return{x:b,y:c}},_initWebGL:function(a){if(!this.gl)for(var b=0;!this.gl&&b<this._WEBGL_CONTEXT_NAMES.length;b++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[b],this.contextAttr)}catch(c){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl&&xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_standard_derivatives&&this.gl.getExtension("OES_standard_derivatives")},getSnapshot:function(a,b){if(!this.canvas)return this.error("Can't get snapshot - no canvas."),void b(null);if(!b)return this._getSnapshot(a);var c=this;requestAnimationFrame(function(){c.scene.render(!0),b(c._getSnapshot(a))})},_getSnapshot:function(a){a=a||{};var b,c=a.width||this.canvas.width,d=a.height||this.canvas.height,e=a.format||"jpeg";switch(e){case"jpeg":b=Canvas2Image.saveAsJPEG(this.canvas,!1,c,d);break;case"png":b=Canvas2Image.saveAsPNG(this.canvas,!0,c,d);break;case"bmp":b=Canvas2Image.saveAsBMP(this.canvas,!0,c,d);break;default:this.error("Unsupported snapshot format: '"+e+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),b=Canvas2Image.saveAsJPEG(this.canvas,!0,c,d)}return b.src},readPixels:function(a,b,c,d){return this.scene._renderer.readPixels(a,b,c,d)},loseWebGLContext:function(){this.canvas.loseContext&&this.canvas.loseContext()},_props:{backgroundColor:{set:function(a){if(a){if((this._backgroundColor=this._backgroundColor||new xeogl.math.vec4).set(a||[0,0,0,1]),!this._backgroundImageSrc){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}}else this._backgroundColor=null},get:function(){return this._backgroundColor}},backgroundImage:{set:function(a){if(a){if(!xeogl._isString(a))return void this.error("Value for 'backgroundImage' should be a string");if(a!==this._backgroundImageSrc&&(this._backgroundElement.style.backgroundImage="url('"+a+"')",this._backgroundImageSrc=a,!this._backgroundImageSrc)){var b="rgb("+Math.round(255*this._backgroundColor[0])+", "+Math.round(255*this._backgroundColor[1])+","+Math.round(255*this._backgroundColor[2])+")";this._backgroundElement.style.background=b}}},get:function(){return this._backgroundImageSrc}},spinner:{get:function(){return this._spinner}}},_destroy:function(){this.scene.off(this._tick),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.canvas=null}})}(),function(){"use strict";var a=!1;xeogl.Spinner=xeogl.Component.extend({type:"xeogl.Spinner",serializable:!1,_init:function(a){this._canvas=a.canvas,this._injectSpinnerCSS();var b=document.createElement("div"),c=b.style;c["z-index"]="9000",c.position="absolute",b.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(b),this._element=b,this._adjustPosition(),this.processes=0,this.textures=a.textures},_props:{textures:{set:function(a){a=!1!==a,this._textures=a},get:function(){return this._textures}},processes:{set:function(a){if(a=a||0,this._processes!==a&&!(a<0)){var b=this._processes;this._processes=a,this._element.style.visibility=this._processes>0?"visible":"hidden",this.fire("processes",this._processes),0===this._processes&&this._processes!==b&&this.fire("zeroProcesses",this._processes)}},get:function(){return this._processes}}},_adjustPosition:function(){if(this._canvas&&this._element){var a=this._canvas,b=this._element,c=b.style;c.left=a.offsetLeft+.5*a.clientWidth-.5*b.clientWidth+"px",c.top=a.offsetTop+.5*a.clientHeight-.5*b.clientHeight+"px"}},_injectSpinnerCSS:function(){if(!a){var b=document.createElement("style");b.innerHTML=this._spinnerCSS,document.body.appendChild(b),a=!0}},_spinnerCSS:".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }"})}(),function(){"use strict";xeogl.Clip=xeogl.Component.extend({type:"xeogl.Clip",_init:function(a){
this._state=new xeogl.renderer.State({active:!0,pos:new Float32Array(3),dir:new Float32Array(3)}),this.active=a.active,this.pos=a.pos,this.dir=a.dir,this.scene._clipCreated(this)},_props:{active:{set:function(a){this._state.active=!1!==a,this._renderer.imageDirty(),this.fire("active",this._state.active)},get:function(){return this._state.active}},pos:{set:function(a){this._state.pos.set(a||[0,0,0]),this._renderer.imageDirty(),this.fire("pos",this._state.pos)},get:function(){return this._state.pos}},dir:{set:function(a){this._state.dir.set(a||[0,0,-1]),this._renderer.imageDirty(),this.fire("dir",this._state.dir)},get:function(){return this._state.dir}}},_destroy:function(){this.scene._clipDestroyed(this)}})}(),function(){"use strict";xeogl.CameraControl=xeogl.Component.extend({type:"xeogl.CameraControl",_init:function(a){var b=this;this._boundaryHelper=new xeogl.Mesh(this,{geometry:new xeogl.AABBGeometry(this),material:new xeogl.PhongMaterial(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],emissive:[1,1,.6],lineWidth:4}),visible:!1,collidable:!1}),this._pivoter=new function(){var a,c=xeogl.math,d=b.scene,e=d.camera,f=d.canvas,g=new Float32Array(3),h=0,i=0,j=0,k=!1,l=document.createElement("div");l.innerText=" ",l.style.color="#ffffff",l.style.position="absolute",l.style.width="25px",l.style.height="25px",l.style.left="0px",l.style.top="0px",l.style["border-radius"]="15px",l.style.border="2px solid #ffffff",l.style.background="black",l.style.visibility="hidden",l.style["box-shadow"]="5px 5px 15px 1px #000000",l.style["z-index"]=0,l.style["pointer-events"]="none",document.body.appendChild(l),function(){var a=c.vec4(),b=c.vec4(),h=c.vec2(),i=!0;e.on("viewMatrix",function(){i=!0}),e.on("projMatrix",function(){i=!0}),d.on("tick",function(){if(k&&i){c.transformPoint3(e.viewMatrix,g,a),a[3]=1,c.transformPoint4(e.projMatrix,a,b);var d=f.boundary;h[0]=Math.floor((1+b[0]/b[3])*d[2]/2),h[1]=Math.floor((1-b[1]/b[3])*d[3]/2);var j=f.canvas,m=j.getBoundingClientRect();l.style.left=Math.floor(m.left+h[0])-12+"px",l.style.top=Math.floor(m.top+h[1])-12+"px",l.style.visibility="visible",i=!1}})}(),this.startPivot=function(b){b&&g.set(b);var d=c.lookAtMat4v(e.eye,e.look,e.worldUp);a=c.transformPoint3(d,g),a[2]+=c.distVec3(e.eye,g),d=c.inverseMat4(d);var f=c.transformVec3(d,a),l=c.vec3();if(c.subVec3(e.eye,g,l),c.addVec3(l,f),1===e.worldUp[2]){var m=l[1];l[1]=l[2],l[2]=m}j=c.lenVec3(l),i=Math.acos(l[1]/j),h=Math.atan2(l[0],l[2]),k=!0},this.getPivoting=function(){return k},this.getPivotPos=function(){return g},this.continuePivot=function(b,d){if(k&&(0!==b||0!==d)){1===e.worldUp[2]&&(f=-f);var f=-b,m=-d;h+=.01*-f,i+=.01*m,i=c.clamp(i,.001,Math.PI-.001);var n=[j*Math.sin(i)*Math.sin(h),j*Math.cos(i),j*Math.sin(i)*Math.cos(h)];if(1===e.worldUp[2]){var o=n[1];n[1]=n[2],n[2]=o}var p=c.lenVec3(c.subVec3(e.look,e.eye,c.vec3()));c.addVec3(n,g);var q=c.lookAtMat4v(n,g,e.worldUp);q=c.inverseMat4(q);var r=c.transformVec3(q,a);q[12]-=r[0],q[13]-=r[1],q[14]-=r[2];var s=[q[8],q[9],q[10]];e.eye=[q[12],q[13],q[14]],c.subVec3(e.eye,c.mulVec3Scalar(s,p),e.look),e.up=[q[4],q[5],q[6]],l.style.visibility="visible"}},this.endPivot=function(){l.style.visibility="hidden",k=!1}},this._cameraFlight=new xeogl.CameraFlightAnimation(this,{duration:.5}),this.firstPerson=a.firstPerson,this.walking=a.walking,this.keyboardLayout=a.keyboardLayout,this.doublePickFlyTo=a.doublePickFlyTo,this.active=a.active,this.pivoting=a.pivoting,this.panToPointer=a.panToPointer,this.panToPivot=a.panToPivot,this.inertia=a.inertia,this._initEvents()},_props:{active:{set:function(a){this._active=!1!==a},get:function(){return this._active}},pivoting:{set:function(a){this._pivoting=!!a},get:function(){return this._pivoting}},panToPointer:{set:function(a){this._panToPointer=!!a,this._panToPointer&&(this._panToPivot=!1)},get:function(){return this._panToPointer}},panToPivot:{set:function(a){this._panToPivot=!!a,this._panToPivot&&(this._panToPointer=!1)},get:function(){return this._panToPivot}},firstPerson:{set:function(a){this._firstPerson=!!a},get:function(){return this._firstPerson}},walking:{set:function(a){this._walking=!!a},get:function(){return this._walking}},doublePickFlyTo:{set:function(a){this._doublePickFlyTo=!1!==a},get:function(){return this._doublePickFlyTo}},inertia:{set:function(a){this._inertia=void 0===a?.5:a},get:function(){return this._inertia}},keyboardLayout:{set:function(a){this._keyboardLayout=a||"qwerty"},get:function(){return this._keyboardLayout}}},_destroy:function(){this.active=!1},_initEvents:function(){function a(){if(v||w){if(x=!1,y=!1,s=w||b.hasSubs("hoverSurface")?c.pick({pickSurface:!0,canvasPos:u}):c.pick({canvasPos:u})){x=!0;var a=s.mesh.id;r!==a&&(void 0!==r&&b.fire("hoverOut",{mesh:c.meshes[r]}),b.fire("hoverEnter",s),r=a),b.fire("hover",s),s.worldPos&&(y=!0,b.fire("hoverSurface",s))}else void 0!==r&&(b.fire("hoverOut",{mesh:c.meshes[r]}),r=void 0),b.fire("hoverOff",{canvasPos:u});v=!1,w=!1}}var b=this,c=this.scene,d=c.input,e=c.camera,f=xeogl.math,g=this.scene.canvas.canvas,h=!1,i=.4,j=.4,k=.8,l=.02,m=.02,n=.02,o=.3,p=.2,q=.05;g.oncontextmenu=function(a){a.preventDefault()};var r,s,t=function(a,b){if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b[0]=a.x,b[1]=a.y;return b},u=[0,0],v=!1,w=!1,x=!1,y=!1;c.on("tick",a),function(){function r(){var a=c.aabb,b=a[3]-a[0],d=a[4]-a[1],e=a[5]-a[2],f=b>d?b:d;return(f=e>f?e:f)/30}var u=0,v=0,x=0,z=0,A=0,B=0,C=f.vec2(),D=!1,E=!1,F=!1,G=!1,H={},I=.001,J=function(){var a=new Float32Array(3);return function(){return f.lenVec3(f.subVec3(e.look,e.eye,a))}}(),K=function(){var a=!0;e.on("projMatrix",function(){a=!0});var b=f.mat4();return function(){return a&&f.inverseMat4(e.projMatrix,b),b}}(),L=function(){var a=!0;e.on("projMatrix",function(){a=!0});var b=f.mat4();return function(){return a&&f.transposeMat4(e.projMatrix,b),b}}(),M=function(){var a=!0;e.on("viewMatrix",function(){a=!0});var b=f.mat4();return function(){return a&&f.inverseMat4(e.viewMatrix,b),b}}(),N=function(){var a=!0,b=1;return c.on("boundary",function(){a=!0}),function(){return a&&(b=f.getAABB3Diag(c.aabb)),b}}(),O=function(){var a=f.vec4(),b=f.vec4(),d=f.vec4(),g=f.vec3(),h=function(b,d,e,g,h,i){var j=c.canvas.canvas,k=j.offsetWidth/2,l=j.offsetHeight/2;a[0]=(e[0]-k)/k,a[1]=(e[1]-l)/l,a[2]=g,a[3]=1,f.mulMat4v4(b,a,h),f.mulVec3Scalar(h,1/h[3]),h[3]=1,h[1]*=-1,f.mulMat4v4(d,h,i)};return function(a,c){var i=0,j=K(),k=M(),l=L(),m=l.subarray(8,12),n=l.subarray(12),o=[0,0,-(i||N()),1],p=f.dotVec4(o,m)/f.dotVec4(o,n);h(j,k,a,p,b,d),f.subVec3(d,e.eye,g),f.normalizeVec3(g);var q=g[0]*c,r=g[1]*c,s=g[2]*c,t=e.eye,u=e.look;e.eye=[t[0]+q,t[1]+r,t[2]+s],e.look=[u[0]+q,u[1]+r,u[2]+s]}}(),P=function(){var a=f.vec3();return function(b,c){f.subVec3(b,e.eye,a),f.normalizeVec3(a);var d=a[0]*c,g=a[1]*c,h=a[2]*c,i=e.eye,j=e.look;e.eye=[i[0]+d,i[1]+g,i[2]+h],e.look=[j[0]+d,j[1]+g,j[2]+h]}}();c.on("tick",function(){var c=b._inertia;if(Math.abs(u)<I&&(u=0),Math.abs(v)<I&&(v=0),0===v&&0===u||(b._pivoter.getPivoting()?b._pivoter.continuePivot(v,u):(0!==u&&(b._firstPerson?e.pitch(-u):e.orbitPitch(u)),0!==v&&(b._firstPerson?e.yaw(v):e.orbitYaw(v))),u*=c,v*=c),Math.abs(x)<I&&(x=0),Math.abs(z)<I&&(z=0),Math.abs(A)<I&&(A=0),0!==x||0!==z||0!==A){var d=J()/80;if(b._walking){var f=e.eye[1];e.pan([x*d,z*d,A*d]);var g=e.eye;g[1]=f,e.eye=g}else e.pan([x*d,z*d,A*d])}if(x*=c,z*=c,A*=c,Math.abs(B)<I&&(B=0),0!==B){if(b._firstPerson){var f;if(b._walking&&(f=e.eye[1]),D?O(C,2*-B):e.pan([0,0,B]),b._walking){var g=e.eye;g[1]=f,e.eye=g}}else b._panToPointer?(a(),y?P(s.worldPos,-B):e.zoom(B)):b._panToPivot?P(b._pivoter.getPivotPos(),-B):e.zoom(B),e.ortho.scale=e.ortho.scale+B;B*=c}}),document.addEventListener("keyDown",function(a){b._active&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(E=a.ctrlKey||17===a.keyCode||a.metaKey,F=a.altKey||18===a.keyCode,G=16===a.keyCode,H[a.keyCode]=!0)},!0),document.addEventListener("keyup",function(a){b._active&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&((a.ctrlKey||17===a.keyCode)&&(E=!1),(a.altKey||18===a.keyCode)&&(F=!1),16===a.keyCode&&(G=!1),H[a.keyCode]=!1)}),function(){var a,e,f,l,o,p=0,q=0,s=!1;g.addEventListener("mousedown",function(c){if(b._active)switch(h=!0,c.which){case 1:f=!0,s=!0,p=0,q=0,t(c,C),a=C[0],e=C[1];break;case 2:l=!0;break;case 3:o=!0,s=!0,p=0,q=0,t(c,C),a=C[0],e=C[1]}}),g.addEventListener("mouseup",function(a){if(b._active){switch(a.which){case 1:f=!1;break;case 2:l=!1;break;case 3:o=!1}s=!1,p=0,q=0}}),document.addEventListener("mouseup",function(a){if(b._active){switch(a.which){case 1:f=!1;break;case 2:l=!1;break;case 3:o=!1}s=!1,p=0,q=0}}),g.addEventListener("mouseenter",function(){b._active&&(h=!0,p=0,q=0)}),g.addEventListener("mouseleave",function(){b._active&&(h=!1,p=0,q=0)}),g.addEventListener("mousemove",function(c){if(b._active&&h&&(t(c,C),D=!0,s)){var d=C[0],f=C[1];p+=(d-a)*i,q+=(f-e)*i,a=d,e=f}}),c.on("tick",function(){if(b._active&&(0!==Math.abs(p)||0!==Math.abs(q))){G||o?(x=p*j,z=q*j):(v=-p*i,u=q*i),p=0,q=0}}),g.addEventListener("wheel",function(a){if(b._active){b._panToPointer&&(w=!0);var c=Math.max(-1,Math.min(1,40*-a.deltaY));if(0!==c){var d=c/Math.abs(c);B=-d*r()*k,a.preventDefault()}}}),c.on("tick",function(a){if(b._active&&h){var c=a.deltaTime;if(!b.ctrlDown&&!b.altDown){var e=d.keyDown[d.KEY_ADD],f=d.keyDown[d.KEY_SUBTRACT];(e||f)&&(f?B=c*r()*n:e&&(B=-c*r()*n))}}}),function(){c.on("tick",function(a){if(b._active&&h){var c,e,f,g,i,j,k=a.deltaTime;"azerty"==b._keyboardLayout?(c=d.keyDown[d.KEY_Z],e=d.keyDown[d.KEY_S],f=d.keyDown[d.KEY_Q],g=d.keyDown[d.KEY_D],i=d.keyDown[d.KEY_W],j=d.keyDown[d.KEY_X]):(c=d.keyDown[d.KEY_W],e=d.keyDown[d.KEY_S],f=d.keyDown[d.KEY_A],g=d.keyDown[d.KEY_D],i=d.keyDown[d.KEY_Z],j=d.keyDown[d.KEY_X]),(c||e||f||g||i||j)&&(j?z+=k*m:i&&(z-=-k*m),g?x+=-k*m:f&&(x=k*m),e?A=k*m:c&&(A=-k*m))}})}()}(),function(){function a(a){var b=Date.now();return n===m?(n=a,!0):n===a?b-s>l:(n=a,s=b,!1)}var c,d=new Float32Array(2),e=-1,h=[],i=0,j=new Float32Array(2),k=new Float32Array(2),l=50,m=0,n=m,s=Date.now();g.addEventListener("touchstart",function(a){if(b._active){var f=a.touches,g=a.changedTouches;for(c=Date.now(),1===f.length&&1===g.length?(e=c,d[0]=f[0].pageX,d[1]=f[0].pageY):e=-1;h.length<f.length;)h.push(new Float32Array(2));for(var j=0,k=f.length;j<k;++j)h[j][0]=f[j].pageX,h[j][1]=f[j].pageY;n=m,i=f.length,a.stopPropagation()}},{passive:!0}),g.addEventListener("touchmove",function(c){if(b._active){var d=c.touches;if(1===i){var e=d[0];if(a(1)){var g=e.pageX-h[0][0],l=e.pageY-h[0][1],m=g*o;u=l*o,v=-m}}else if(2===i){var e=d[0],n=d[1];f.subVec2([e.pageX,e.pageY],h[0],j),f.subVec2([n.pageX,n.pageY],h[1],k);var s=f.dotVec2(j,k)>0;if(s&&a(2)&&(f.subVec2([e.pageX,e.pageY],h[0],j),x=j[0]*p,z=j[1]*p),!s&&a(4)){var t=f.distVec2([e.pageX,e.pageY],[n.pageX,n.pageY]),w=f.distVec2(h[0],h[1]);B=(w-t)*r()*q}}for(var y=0;y<i;++y)h[y][0]=d[y].pageX,h[y][1]=d[y].pageY;c.stopPropagation()}},{passive:!0})}(),function(){c.on("tick",function(a){if(b._active&&h){var c=a.deltaTime,e=d.keyDown[d.KEY_LEFT_ARROW],f=d.keyDown[d.KEY_RIGHT_ARROW],g=d.keyDown[d.KEY_UP_ARROW],i=d.keyDown[d.KEY_DOWN_ARROW];(e||f||g||i)&&(f?v+=-c*l:e&&(v+=c*l),i?u+=c*l:g&&(u+=-c*l))}})}(),function(){c.on("tick",function(a){if(b._active&&h){var c,e,f=a.deltaTime;"azerty"==b._keyboardLayout?(c=d.keyDown[d.KEY_A],e=d.keyDown[d.KEY_E]):(c=d.keyDown[d.KEY_Q],e=d.keyDown[d.KEY_E]),(e||c)&&(c?v+=f*l:e&&(v+=-f*l))}})}()}(),function(){!function(){g.addEventListener("mousemove",function(a){b._active&&(t(a,u),(b.hasSubs("hover")||b.hasSubs("hoverOut")||b.hasSubs("hoverOff")||b.hasSubs("hoverSurface"))&&(v=!0))});var c,d,e,f;g.addEventListener("mousedown",function(g){b._active&&(c=g.clientX,d=g.clientY,e=u[0],f=u[1],w=b._pivoting,a(),b._pivoting&&(s?b._pivoter.startPivot(s.worldPos):b._pivoter.startPivot()))}),g.addEventListener("mouseup",function(g){var h,i=0;return function(g){if(b._active&&(b._pivoter.endPivot(),!(Math.abs(g.clientX-c)>3||Math.abs(g.clientY-d)>3))){if(!(b._doublePickFlyTo||b.hasSubs("doublePicked")||b.hasSubs("doublePickedSurface")||b.hasSubs("doublePickedNothing")))return w=!!b.hasSubs("pickedSurface"),a(),void(s?(b.fire("picked",s),y&&b.fire("pickedSurface",s)):b.fire("pickedNothing"));i++,1==i?h=setTimeout(function(){v=b._doublePickFlyTo,w=v||!!b.hasSubs("pickedSurface"),u[0]=e,u[1]=f,a(),s?(b.fire("picked",s),y&&b.fire("pickedSurface",s)):b.fire("pickedNothing"),i=0},250):(clearTimeout(h),v=b._doublePickFlyTo,w=v&&!!b.hasSubs("doublePickedSurface"),a(),s?(b.fire("doublePicked",s),y&&b.fire("doublePickedSurface",s),b._doublePickFlyTo&&b._flyTo(s)):(b.fire("doublePickedNothing"),b._doublePickFlyTo&&b._flyTo()),i=0)}}}(),!1)}(),function(){var c,d=150,e=325,f=4,h=[],i=new Float32Array(2),j=-1,k=-1;g.addEventListener("touchstart",function(a){if(b._active){var d=a.touches,e=a.changedTouches;for(c=Date.now(),1===d.length&&1===e.length?(j=c,i[0]=d[0].pageX,i[1]=d[0].pageY):j=-1;h.length<d.length;)h.push(new Float32Array(2));for(var f=0,g=d.length;f<g;++f)h[f][0]=d[f].pageX,h[f][1]=d[f].pageY;h.length=d.length,a.stopPropagation()}},{passive:!0}),g.addEventListener("touchend",function(c){if(b._active){var g=Date.now(),l=c.touches,m=c.changedTouches;0===l.length&&1===m.length&&j>-1&&g-j<d&&(k>-1&&j-k<e?(u[0]=Math.round(m[0].clientX),u[1]=Math.round(m[0].clientY),v=!0,w=!!b.hasSubs("pickedSurface"),a(),s?(b.fire("doublePicked",s),y&&b.fire("doublePickedSurface",s),b._doublePickFlyTo&&b._flyTo(s)):(b.fire("doublePickedNothing"),b._doublePickFlyTo&&b._flyTo()),k=-1):xeogl.math.distVec2(h[0],i)<f&&(u[0]=Math.round(m[0].clientX),u[1]=Math.round(m[0].clientY),v=!0,w=!!b.hasSubs("pickedSurface"),a(),s?(b.fire("picked",s),y&&b.fire("pickedSurface",s)):b.fire("pickedNothing"),k=g),j=-1),h.length=l.length;for(var n=0,o=l.length;n<o;++n)h[n][0]=l[n].pageX,h[n][1]=l[n].pageY;c.stopPropagation()}},{passive:!0})}()}(),function(){var a=49,d=50,g=51,i=52,j=53,k=54,l=new f.vec3,m=new f.vec3,n=new f.vec3,o=new f.vec3,p={eye:new Float32Array(3),look:new Float32Array(3),up:new Float32Array(3)};document.addEventListener("keydown",function(q){if(b._active&&h){var r=q.keyCode;if(r===a||r===d||r===g||r===i||r===j||r===k){var s=c.aabb,t=f.getAABB3Diag(s);l[0]=s[0]+s[3]/2,l[1]=s[1]+s[4]/2,l[2]=s[2]+s[5]/2;var u=Math.abs(t/Math.tan(b._cameraFlight.fitFOV/2));switch(r){case a:p.eye.set(f.mulVec3Scalar(e.worldRight,u,m)),p.look.set(l),p.up.set(e.worldUp);break;case d:p.eye.set(f.mulVec3Scalar(e.worldForward,u,m)),p.look.set(l),p.up.set(e.worldUp);break;case g:p.eye.set(f.mulVec3Scalar(e.worldRight,-u,m)),p.look.set(l),p.up.set(e.worldUp);break;case i:p.eye.set(f.mulVec3Scalar(e.worldForward,-u,m)),p.look.set(l),p.up.set(e.worldUp);break;case j:p.eye.set(f.mulVec3Scalar(e.worldUp,u,m)),p.look.set(l),p.up.set(f.normalizeVec3(f.mulVec3Scalar(e.worldForward,1,n),o));break;case k:p.eye.set(f.mulVec3Scalar(e.worldUp,-u,m)),p.look.set(l),p.up.set(f.normalizeVec3(f.mulVec3Scalar(e.worldForward,-1,n)));break;default:return}b._cameraFlight.duration>0?b._cameraFlight.flyTo(p):b._cameraFlight.jumpTo(p)}}})}()},_flyTo:function(a){var b;a&&a.worldPos&&(b=a.worldPos);var c=a?a.mesh.aabb:this.scene.aabb;if(this._boundaryHelper.geometry.targetAABB=c,b){var d=this.scene.camera;xeogl.math.subVec3(d.eye,d.look,[]);this._cameraFlight.flyTo({aabb:c},this._hideBoundary,this)}else this._cameraFlight.flyTo({aabb:c},this._hideBoundary,this)},_hideBoundary:function(){}})}(),function(){const a=c?Number.MAX_SAFE_INTEGER/6:256e3;var b=xeogl.stats.memory,c=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint,d=(c?Uint32Array:Uint16Array,new xeogl.renderer.State({}));xeogl.SceneVertexBufs=function(e,f,g,h,i,j){function k(){r={};var b,d,e=0;y=null;var k=0,n=0,q=0,z=0;for(b in o)o.hasOwnProperty(b)&&(d=o[b],f&&(k+=d.positions.length),g&&(n+=d.normals.length),i&&(q+=d.uv.length),h&&(z+=d.uv.length));for(b in o)if(o.hasOwnProperty(b)){d=o[b];var A=!y||u.length+d.positions.length>a;if(A&&(y&&l(y),y=new xeogl.renderer.State({positionsBuf:null,normalsBuf:null,uvBuf:null,colorsBuf:null,quantized:j}),e=0),r[b]=y,f)for(var B=0,C=d.positions.length;B<C;B++)u.push(d.positions[B]);if(g)for(var B=0,C=d.normals.length;B<C;B++)v.push(d.normals[B]);if(h)for(var B=0,C=d.colors.length;B<C;B++)w.push(d.colors[B]);if(i)for(var B=0,C=d.uv.length;B<C;B++)x.push(d.uv[B]);p[b]=e;var D;if(e){D=new(c?Uint32Array:Uint16Array)(d.indices);for(var B=0,C=D.length;B<C;B++)D[B]+=e,D[B]>a/3&&console.error("out of range: "+D[B])}else D=d.indices;d.indicesBufCombined?d.indicesBufCombined.setData(D):d.indicesBufCombined=new xeogl.renderer.ArrayBuffer(m,m.ELEMENT_ARRAY_BUFFER,D,D.length,1,m.STATIC_DRAW),e+=d.positions.length/3}y&&l(y),s=!1,t=!1}function l(a){var c,d=e.canvas.gl;f&&(c=j?new Uint16Array(u):new Float32Array(u),a.positionsBuf=new xeogl.renderer.ArrayBuffer(d,d.ARRAY_BUFFER,c,c.length,3,d.STATIC_DRAW),b.positions+=a.positionsBuf.numItems,u=[]),g&&(c=j?new Int8Array(v):new Float32Array(v),a.normalsBuf=new xeogl.renderer.ArrayBuffer(d,d.ARRAY_BUFFER,c,c.length,3,d.STATIC_DRAW),b.normals+=a.normalsBuf.numItems,v=[]),h&&(c=new Float32Array(w),a.colorsBuf=new xeogl.renderer.ArrayBuffer(d,d.ARRAY_BUFFER,c,c.length,4,d.STATIC_DRAW),b.colors+=a.colorsBuf.numItems,w=[]),i&&(c=j?new Uint16Array(x):new Float32Array(x),a.uvBuf=new xeogl.renderer.ArrayBuffer(d,d.ARRAY_BUFFER,c,c.length,2,d.STATIC_DRAW),b.uvs+=a.uvBuf.numItems,x=[])}var m=e.canvas.gl,n=!1,o={},p={},q=[],r={},s=!1,t=!1,u=[],v=[],w=[],x=[],y=null;this.addGeometry=function(a){if(!a.positions||!a.indices)return void e.warn("Ignoring geometry with no positions or indices: "+a.id);o[a.id]=a,p[a.id]=0,q.push(a),t=!0},this.getIndicesOffset=function(a){return(s||t)&&k(),p[a.id]},this.getVertexBufs=function(a){return o[a.id]?((s||t)&&k(),r[a.id]):d},this.setPositions=function(a){var b=r[a.id];if(b&&a.positions){var c=b.positionsBuf;c&&c.setData(a.positions,3*p[a.id])}},this.setNormals=function(a){var b=r[a.id];if(b&&a.normals){var c=b.normalsBuf;c&&c.setData(a.normals,3*p[a.id])}},this.setUVs=function(a){var b=r[a.id];if(b&&a.uv){var c=b.uvBuf;c&&c.setData(a.uv,2*p[a.id])}},this.setColors=function(a){var b=r[a.id];if(b&&a.color){var c=b.colorsBuf;c&&c.setData(a.colors,4*p[a.id])}},this.removeGeometry=function(a){var b=a.id;o[b]&&(delete o[b],delete p[b],a.indicesBufCombined&&a.indicesBufCombined.destroy(),s=!0)},this.webglContextLost=function(){n=!0},this.webglContextRestored=function(){if(n){for(var a in o)o.hasOwnProperty(a)&&(o[a].indicesBufCombined=null);k(),n=!1}}},xeogl.SceneVertexBufs.get=function(a,b){var c=!!b.positions,d=!!b.quantized,e=!!b.normals,f=!!b.colors,g=!!b.uv,h=[a.id,c?"p":"",d?"c":"",e?"n":"",f?"c":"",g?"u":""].join(";");a._sceneVertexBufs||(a._sceneVertexBufs={});var i=a._sceneVertexBufs[h];return i||(i=new xeogl.SceneVertexBufs(a,c,e,f,g,d),a._sceneVertexBufs[h]=i),i}}(),function(){"use strict";function a(a,b){var c,d,e=new Float32Array(b),f=new Float32Array(b);for(c=0;c<b;c++)e[c]=Number.MAX_VALUE,f[c]=-Number.MAX_VALUE;for(c=0;c<a.length;c+=b)for(d=0;d<b;d++)e[d]=Math.min(e[d],a[c+d]),f[d]=Math.max(f[d],a[c+d]);return{min:e,max:f}}function b(a){var b,f,g,h,i,j,k,l=new Int8Array(2*a.length/3);for(j=0,k=0;j<a.length;j+=3,k+=2)g=b=c(a,j,"floor","floor"),f=d(b),h=i=e(a,j,f),b=c(a,j,"ceil","floor"),f=d(b),h=e(a,j,f),h>i&&(g=b,i=h),b=c(a,j,"floor","ceil"),f=d(b),h=e(a,j,f),h>i&&(g=b,i=h),b=c(a,j,"ceil","ceil"),f=d(b),h=e(a,j,f),h>i&&(g=b,i=h),l[k]=g[0],l[k+1]=g[1];return l}function c(a,b,c,d){var e=a[b]/(Math.abs(a[b])+Math.abs(a[b+1])+Math.abs(a[b+2])),f=a[b+1]/(Math.abs(a[b])+Math.abs(a[b+1])+Math.abs(a[b+2]));if(a[b+2]<0){var g=e,h=f;g=(1-Math.abs(f))*(e>=0?1:-1),h=(1-Math.abs(e))*(f>=0?1:-1),e=g,f=h}return new Int8Array([Math[c](127.5*e+(e<0?-1:0)),Math[d](127.5*f+(f<0?-1:0))])}function d(a){var b=a[0],c=a[1];b/=b<0?127:128,c/=c<0?127:128;var d=1-Math.abs(b)-Math.abs(c);d<0&&(b=(1-Math.abs(c))*(b>=0?1:-1),c=(1-Math.abs(b))*(c>=0?1:-1));var e=Math.sqrt(b*b+c*c+d*d);return[b/e,c/e,d/e]}function e(a,b,c){return a[b]*c[0]+a[b+1]*c[1]+a[b+2]*c[2]}g&&Number.MAX_SAFE_INTEGER;var f=xeogl.stats.memory,g=xeogl.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint,h=g?Uint32Array:Uint16Array,i=new xeogl.renderer.State({});xeogl.Geometry=xeogl.Component.extend({type:"xeogl.Geometry",_init:function(c){var d=this;this._state=new xeogl.renderer.State({combined:!!c.combined,quantized:!!c.quantized,autoVertexNormals:!!c.autoVertexNormals,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,indicesBufCombined:null,hash:""}),this._edgeThreshold=c.edgeThreshold||2,this._edgesIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._boundaryDirty=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;var e=this._state,i=this.scene.canvas.gl;switch(c.primitive=c.primitive||"triangles",c.primitive){case"points":e.primitive=i.POINTS,e.primitiveName=c.primitive;break;case"lines":e.primitive=i.LINES,e.primitiveName=c.primitive;break;case"line-loop":e.primitive=i.LINE_LOOP,e.primitiveName=c.primitive;break;case"line-strip":e.primitive=i.LINE_STRIP,e.primitiveName=c.primitive;break;case"triangles":e.primitive=i.TRIANGLES,e.primitiveName=c.primitive;break;case"triangle-strip":e.primitive=i.TRIANGLE_STRIP,e.primitiveName=c.primitive;break;case"triangle-fan":e.primitive=i.TRIANGLE_FAN,e.primitiveName=c.primitive;break;default:this.error("Unsupported value for 'primitive': '"+c.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),e.primitive=i.TRIANGLES,e.primitiveName=c.primitive}if(c.positions)if(this._state.quantized){var l=a(c.positions,3),m=j(c.positions,l.min,l.max);e.positions=m.quantized,e.positionsDecodeMatrix=m.decode}else e.positions=c.positions.constructor===Float32Array?c.positions:new Float32Array(c.positions);if(c.colors&&(e.colors=c.colors.constructor===Float32Array?c.colors:new Float32Array(c.colors)),c.uv)if(this._state.quantized){var l=a(c.uv,2),m=k(c.uv,l.min,l.max);e.uv=m.quantized,e.uvDecodeMatrix=m.decode}else e.uv=c.uv.constructor===Float32Array?c.uv:new Float32Array(c.uv);if(c.normals&&(this._state.quantized?e.normals=b(c.normals):e.normals=c.normals.constructor===Float32Array?c.normals:new Float32Array(c.normals)),c.indices){if(!g&&c.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");e.indices=c.indices.constructor===Uint32Array||c.indices.constructor===Uint16Array?c.indices:new h(c.indices)}e.indices&&(e.indicesBuf=new xeogl.renderer.ArrayBuffer(i,i.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,i.STATIC_DRAW),f.indices+=e.indicesBuf.numItems),this._buildHash(),f.meshes++,this._state.combined&&(this._sceneVertexBufs=xeogl.SceneVertexBufs.get(this.scene,this._state),this._sceneVertexBufs.addGeometry(this._state)),this._buildVBOs(),d.fire("created",this.created=!0)},_buildVBOs:function(){var a=this._state,b=this.scene.canvas.gl;a.indices&&(a.indicesBuf=new xeogl.renderer.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,a.indices,a.indices.length,1,b.STATIC_DRAW),f.indices+=a.indicesBuf.numItems),a.combined?a.indices:(a.positions&&(a.positionsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.positions,a.positions.length,3,b.STATIC_DRAW),f.positions+=a.positionsBuf.numItems),a.normals&&(a.normalsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.normals,a.normals.length,3,b.STATIC_DRAW),f.normals+=a.normalsBuf.numItems),a.colors&&(a.colorsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.colors,a.colors.length,4,b.STATIC_DRAW),f.colors+=a.colorsBuf.numItems),a.uv&&(a.uvBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,a.uv,a.uv.length,2,b.STATIC_DRAW),f.uvs+=a.uvBuf.numItems))},_buildHash:function(){var a=this._state,b=["/g"];b.push("/"+a.primitive+";"),a.positions&&b.push("p"),a.colors&&b.push("c"),(a.normals||a.autoVertexNormals)&&b.push("n"),a.uv&&b.push("u"),a.quantized&&b.push("cp"),b.push(";"),a.hash=b.join("")},_getEdgesIndices:function(){return this._edgesIndicesBuf||this._buildEdgesIndices(),this._edgesIndicesBuf},_getPickTrianglePositions:function(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf},_getPickTriangleColors:function(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf},_buildEdgesIndices:function(){var a=this._state;if(a.positions&&a.indices){var b=this.scene.canvas.gl,c=l(a.positions,a.indices,a.positionsDecodeMatrix,this._edgeThreshold,a.combined);if(a.combined)for(var d=this._sceneVertexBufs.getIndicesOffset(a),e=0,g=c.length;e<g;e++)c[e]+=d;this._edgesIndicesBuf=new xeogl.renderer.ArrayBuffer(b,b.ELEMENT_ARRAY_BUFFER,c,c.length,1,b.STATIC_DRAW),f.indices+=this._edgesIndicesBuf.numItems}},_buildPickTriangleVBOs:function(){var a=this._state;if(a.positions&&a.indices){var b=this.scene.canvas.gl,c=xeogl.math.buildPickTriangles(a.positions,a.indices,a.quantized),d=c.positions,e=c.colors;this._pickTrianglePositionsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,d,d.length,3,b.STATIC_DRAW),this._pickTriangleColorsBuf=new xeogl.renderer.ArrayBuffer(b,b.ARRAY_BUFFER,e,e.length,4,b.STATIC_DRAW,!0),f.positions+=this._pickTrianglePositionsBuf.numItems,f.colors+=this._pickTriangleColorsBuf.numItems}},_buildPickVertexVBOs:function(){},_webglContextLost:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()},_webglContextRestored:function(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgesIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null},_props:{primitive:{get:function(){return this._state.primitiveName}},quantized:{get:function(){return this._state.quantized}},combined:{get:function(){return this._state.combined}},positions:{get:function(){if(this._state.positions)return this._state.quantized?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),xeogl.math.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions},set:function(b){var c=this._state,d=c.positions;if(!d)return void this.error("can't update geometry positions - geometry has no positions");if(d.length!==b.length)return void this.error("can't update geometry positions - new positions are wrong length");if(this._state.quantized){var e=a(b,3),f=j(b,e.min,e.max);b=f.quantized,c.positionsDecodeMatrix=f.decode}d.set(b),c.positionsBuf&&c.positionsBuf.setData(d),this._state.combined&&this._sceneVertexBufs.setPositions(c),this._setBoundaryDirty(),this._renderer.imageDirty()}},normals:{get:function(){if(this._state.normals){if(!this._state.quantized)return this._state.normals;if(!this._decompressedNormals){var a=this._state.normals.length,b=a+a/2;this._decompressedNormals=new Float32Array(b),xeogl.math.octDecodeVec2s(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}},set:function(a){if(this._state.quantized)return void this.error("can't update geometry normals - quantized geometry is immutable");var b=this._state,c=b.normals;return c?c.length!==a.length?void this.error("can't update geometry normals - new normals are wrong length"):(c.set(a),b.normalsBuf&&b.normalsBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setNormals(b),void this._renderer.imageDirty()):void this.error("can't update geometry normals - geometry has no normals")}},uv:{get:function(){if(this._state.uv)return this._state.quantized?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),xeogl.math.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv},set:function(a){if(this._state.quantized)return void this.error("can't update geometry UVs - quantized geometry is immutable");var b=this._state,c=b.uv;return c?c.length!==a.length?void this.error("can't update geometry UVs - new UVs are wrong length"):(c.set(a),b.uvBuf&&b.uvBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setUVs(b),void this._renderer.imageDirty()):void this.error("can't update geometry UVs - geometry has no UVs")}},colors:{get:function(){return this._state.colors},set:function(a){if(this._state.quantized)return void this.error("can't update geometry colors - quantized geometry is immutable");var b=this._state,c=b.colors;return c?c.length!==a.length?void this.error("can't update geometry colors - new colors are wrong length"):(c.set(a),b.colorsBuf&&b.colorsBuf.setData(c),this._state.combined&&this._sceneVertexBufs.setColors(b),void this._renderer.imageDirty()):void this.error("can't update geometry colors - geometry has no colors")}},indices:{get:function(){return this._state.indices}},aabb:{get:function(){return this._aabbDirty&&(this._aabb||(this._aabb=xeogl.math.AABB3()),xeogl.math.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}},obb:{get:function(){var a=xeogl.math.AABB3();return function(){return this._obbDirty&&(this._obb||(this._obb=xeogl.math.OBB3()),xeogl.math.positions3ToAABB3(this._state.positions,a,this._state.positionsDecodeMatrix),xeogl.math.AABB3ToOBB3(a,this._obb),this._obbDirty=!1),this._obb}}()},kdtree:{get:function(){var a=this._state;return a.indices&&a.positions?(this._kdtree||(this._kdtree=xeogl.math.buildKDTree(a.indices,a.positions,this._state.positionsDecodeMatrix)),this._kdtree):void this.error("Can't provide a KD-tree: no indices/positions")}}},_setBoundaryDirty:function(){this._boundaryDirty||(this._boundaryDirty=!0,this._aabbDirty=!0,this._obbDirty=!0,this.fire("boundary"))},_getState:function(){return this._state},_getVertexBufs:function(){return this._state&&this._state.combined?this._sceneVertexBufs.getVertexBufs(this._state):i},_destroy:function(){var a=this._state;a.indicesBuf&&a.indicesBuf.destroy(),this._edgesIndicesBuf&&this._edgesIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),this._state.combined&&this._sceneVertexBufs.removeGeometry(a),a.destroy(),f.meshes--}});var j=function(){var a=xeogl.math,b=a.mat4(),c=a.mat4();return function(d,e,f){var g,h=new Uint16Array(d.length),i=new Float32Array([65535/(f[0]-e[0]),65535/(f[1]-e[1]),65535/(f[2]-e[2])]);for(g=0;g<d.length;g+=3)h[g+0]=Math.floor((d[g+0]-e[0])*i[0]),h[g+1]=Math.floor((d[g+1]-e[1])*i[1]),h[g+2]=Math.floor((d[g+2]-e[2])*i[2]);return a.identityMat4(b),a.translationMat4v(e,b),a.identityMat4(c),a.scalingMat4v([(f[0]-e[0])/65535,(f[1]-e[1])/65535,(f[2]-e[2])/65535],c),{quantized:h,decode:a.mulMat4(b,c,a.identityMat4())}}}(),k=function(){var a=xeogl.math,b=a.mat3(),c=a.mat3();return function(d,e,f){var g,h=new Uint16Array(d.length),i=new Float32Array([65535/(f[0]-e[0]),65535/(f[1]-e[1])]);for(g=0;g<d.length;g+=2)h[g+0]=Math.floor((d[g+0]-e[0])*i[0]),h[g+1]=Math.floor((d[g+1]-e[1])*i[1]);return a.identityMat3(b),a.translationMat3v(e,b),a.identityMat3(c),a.scalingMat3v([(f[0]-e[0])/65535,(f[1]-e[1])/65535],c),{quantized:h,decode:a.mulMat3(b,c,a.identityMat3())}}}(),l=function(){function a(a,b){var c,h,i,j,k,l,m={},n=4,o=Math.pow(10,n),p=0;for(k=0,l=a.length;k<l;k+=3)c=a[k],h=a[k+1],i=a[k+2],j=Math.round(c*o)+"_"+Math.round(h*o)+"_"+Math.round(i*o),void 0===m[j]&&(m[j]=p/3,d[p++]=c,d[p++]=h,d[p++]=i),e[k/3]=m[j];for(k=0,
l=b.length;k<l;k++)g[k]=e[b[k]],f[g[k]]=b[k]}function b(a,b){i=0;for(var e=0,f=a;e<f;e+=3){var t=3*g[e],u=3*g[e+1],v=3*g[e+2];b?(j[0]=d[t],j[1]=d[t+1],j[2]=d[t+2],k[0]=d[u],k[1]=d[u+1],k[2]=d[u+2],l[0]=d[v],l[1]=d[v+1],l[2]=d[v+2],c.decompressPosition(j,b,m),c.decompressPosition(k,b,n),c.decompressPosition(l,b,o)):(m[0]=d[t],m[1]=d[t+1],m[2]=d[t+2],n[0]=d[u],n[1]=d[u+1],n[2]=d[u+2],o[0]=d[v],o[1]=d[v+1],o[2]=d[v+2]),c.subVec3(o,n,p),c.subVec3(m,n,q),c.cross3Vec3(p,q,r),c.normalizeVec3(r,s);var w=h[i]||(h[i]={normal:c.vec3()});w.normal[0]=s[0],w.normal[1]=s[1],w.normal[2]=s[2],i++}}var c=xeogl.math,d=[],e=[],f=[],g=[],h=[],i=0,j=new Uint16Array(3),k=new Uint16Array(3),l=new Uint16Array(3),m=c.vec3(),n=c.vec3(),o=c.vec3(),p=c.vec3(),q=c.vec3(),r=c.vec3(),s=c.vec3();return function(d,e,i,j,k){a(d,e),b(e.length,i);for(var l,m,n,o,p,q,r,s,t,u,v=[],w=Math.cos(xeogl.math.DEGTORAD*j),x={},y=!1,z=0,A=e.length;z<A;z+=3)for(var B=z/3,C=0;C<3;C++)l=g[z+C],m=g[z+(C+1)%3],n=Math.min(l,m),o=Math.max(l,m),p=n+","+o,void 0===x[p]?x[p]={index1:n,index2:o,face1:B,face2:void 0}:x[p].face2=B;for(p in x)q=x[p],void 0!==q.face2&&(r=h[q.face1].normal,s=h[q.face2].normal,c.dotVec3(r,s)>w)||(t=q.index1,u=q.index2,(!y&&t>65535||u>65535)&&(y=!0),v.push(f[t]),v.push(f[u]));return y||k?new Uint32Array(v):new Uint16Array(v)}}()}(),function(){"use strict";xeogl.BoxGeometry=xeogl.Geometry.extend({type:"xeogl.BoxGeometry",_init:function(a){var b=a.xSize||1;b<0&&(this.error("negative xSize not allowed - will invert"),b*=-1);var c=a.ySize||1;c<0&&(this.error("negative ySize not allowed - will invert"),c*=-1);var d=a.zSize||1;d<0&&(this.error("negative zSize not allowed - will invert"),d*=-1);var e=a.center,f=e?e[0]:0,g=e?e[1]:0,h=e?e[2]:0,i=-b+f,j=-c+g,k=-d+h,l=b+f,m=c+g,n=d+h;this._super(xeogl._apply(a,{positions:[l,m,n,i,m,n,i,j,n,l,j,n,l,m,n,l,j,n,l,j,k,l,m,k,l,m,n,l,m,k,i,m,k,i,m,n,i,m,n,i,m,k,i,j,k,i,j,n,i,j,k,l,j,k,l,j,n,i,j,n,l,j,k,i,j,k,i,m,k,l,m,k],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],tangents:null})),this.box=!0}})}(),function(){"use strict";xeogl.TorusGeometry=xeogl.Geometry.extend({type:"xeogl.TorusGeometry",_init:function(a){var b=a.radius||1;b<0&&(this.error("negative radius not allowed - will invert"),b*=-1),b*=.5;var c=a.tube||.3;c<0&&(this.error("negative tube not allowed - will invert"),c*=-1);var d=a.radialSegments||32;d<0&&(this.error("negative radialSegments not allowed - will invert"),d*=-1),d<4&&(d=4);var e=a.tubeSegments||24;e<0&&(this.error("negative tubeSegments not allowed - will invert"),e*=-1),e<4&&(e=4);var f=a.arc||2*Math.PI;f<0&&(this.warn("negative arc not allowed - will invert"),f*=-1),f>360&&(f=360);var g,h,i,j,k,l,m,n,o=a.center,p=o?o[0]:0,q=o?o[1]:0,r=o?o[2]:0,s=[],t=[],u=[],v=[];for(n=0;n<=e;n++)for(m=0;m<=d;m++)g=m/d*f,h=.785398+n/e*Math.PI*2,p=b*Math.cos(g),q=b*Math.sin(g),i=(b+c*Math.cos(h))*Math.cos(g),j=(b+c*Math.cos(h))*Math.sin(g),k=c*Math.sin(h),s.push(i+p),s.push(j+q),s.push(k+r),u.push(1-m/d),u.push(n/e),l=xeogl.math.normalizeVec3(xeogl.math.subVec3([i,j,k],[p,q,r],[]),[]),t.push(l[0]),t.push(l[1]),t.push(l[2]);var w,x,y,z;for(n=1;n<=e;n++)for(m=1;m<=d;m++)w=(d+1)*n+m-1,x=(d+1)*(n-1)+m-1,y=(d+1)*(n-1)+m,z=(d+1)*n+m,v.push(w),v.push(x),v.push(y),v.push(y),v.push(z),v.push(w);this._super(xeogl._apply(a,{positions:s,normals:t,uv:u,indices:v}))}})}(),function(){"use strict";xeogl.SphereGeometry=xeogl.Geometry.extend({type:"xeogl.SphereGeometry",_init:function(a){var b=a.lod||1,c=a.center?a.center[0]:0,d=a.center?a.center[1]:0,e=a.center?a.center[2]:0,f=a.radius||1;f<0&&(this.warn("negative radius not allowed - will invert"),f*=-1);var g=a.heightSegments||18;g<0&&(this.warn("negative heightSegments not allowed - will invert"),g*=-1),(g=Math.floor(b*g))<18&&(g=18);var h=a.widthSegments||18;h<0&&(this.warn("negative widthSegments not allowed - will invert"),h*=-1),(h=Math.floor(b*h))<18&&(h=18);var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=[],y=[],z=[],A=[];for(i=0;i<=g;i++)for(k=i*Math.PI/g,l=Math.sin(k),m=Math.cos(k),j=0;j<=h;j++)n=2*j*Math.PI/h,o=Math.sin(n),p=Math.cos(n),q=p*l,r=m,s=o*l,t=1-j/h,u=i/g,y.push(q),y.push(r),y.push(s),z.push(t),z.push(u),x.push(c+f*q),x.push(d+f*r),x.push(e+f*s);for(i=0;i<g;i++)for(j=0;j<h;j++)v=i*(h+1)+j,w=v+h+1,A.push(v+1),A.push(w+1),A.push(w),A.push(v+1),A.push(w),A.push(v);this._super(xeogl._apply(a,{positions:x,normals:y,uv:z,indices:A}))}})}(),function(){"use strict";xeogl.OBBGeometry=xeogl.Geometry.extend({type:"xeogl.OBBGeometry",_init:function(a){this._super(xeogl._apply(a,{combined:!0,quantized:!1,primitive:a.primitive||"lines",positions:a.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]})),a.target?this.target=a.target:a.targetOBB&&(this.targetOBB=a.targetOBB)},_props:{target:{set:function(a){var b=!1,c=this;this._attach({name:"target",type:"xeogl.Component",component:a,sceneDefault:!1,on:{boundary:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromOBB(c._attached.target.obb),b=!1}))}},onAttached:function(){c._setPositionsFromOBB(c._attached.target.obb)}})},get:function(){return this._attached.target}},targetOBB:{set:function(a){a&&(this._attached.target&&(this.target=null),this._setPositionsFromOBB(a))}}},_setPositionsFromOBB:function(a){this.positions=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10],a[12],a[13],a[14],a[16],a[17],a[18],a[20],a[21],a[22],a[24],a[25],a[26],a[28],a[29],a[30]]}})}(),function(){"use strict";xeogl.AABBGeometry=xeogl.Geometry.extend({type:"xeogl.AABBGeometry",_init:function(a){this._super(xeogl._apply(a,{combined:!0,quantized:!0,primitive:a.primitive||"lines",indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7],positions:a.positions||[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1]})),a.target?this.target=a.target:a.targetAABB&&(this.targetAABB=a.targetAABB)},_props:{target:{set:function(a){var b=!1,c=this;this._attach({name:"target",type:"xeogl.Component",component:a,sceneDefault:!1,on:{boundary:function(){b||(b=!0,xeogl.scheduleTask(function(){c._setPositionsFromAABB(c._attached.target.aabb),b=!1}))}},onAttached:function(){c._setPositionsFromAABB(c._attached.target.aabb)}})},get:function(){return this._attached.target}},targetAABB:{set:function(a){a&&(this._attached.target&&(this.target=null),this._setPositionsFromAABB(a))}}},_setPositionsFromAABB:function(a){this.positions=[a[3],a[4],a[5],a[3],a[1],a[5],a[0],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[2],a[3],a[1],a[2],a[0],a[1],a[2],a[0],a[4],a[2]]}})}(),xeogl.PathGeometry=xeogl.Geometry.extend({type:"xeogl.PathGeometry",_init:function(a){this._super(a),this.path=a.path,this.divisions=a.divisions},_update:function(){var a=this._attached.path;if(a){var b,c,d,e=a.getPoints(this._divisions),f=[];for(b=0,c=e.length;b<c;b++)d=e[b],f.push(d[0]),f.push(d[1]),f.push(d[2]);var g=[];for(b=0,c=e.length-1;b<c;b++)g.push(b),g.push(b+1);this.primitive="lines",this.positions=f,this.indices=g,this.normals=null,this.uv=null}},_props:{path:{set:function(a){this._attach({name:"path",type:"xeogl.Curve",component:a,sceneDefault:!1,on:{curves:{callback:this._needUpdate,scope:this}}})},get:function(){return this._attached.path}},divisions:{set:function(a){a=a||6,this._divisions=a,this._needUpdate()},get:function(){return this._divisions}}}}),function(){"use strict";xeogl.CylinderGeometry=xeogl.Geometry.extend({type:"xeogl.CylinderGeometry",_init:function(a){var b=a.radiusTop||1;b<0&&(this.error("negative radiusTop not allowed - will invert"),b*=-1);var c=a.radiusBottom||1;c<0&&(this.error("negative radiusBottom not allowed - will invert"),c*=-1);var d=a.height||1;d<0&&(this.error("negative height not allowed - will invert"),d*=-1);var e=a.radialSegments||32;e<0&&(this.error("negative radialSegments not allowed - will invert"),e*=-1),e<3&&(e=3);var f=a.heightSegments||1;f<0&&(this.error("negative heightSegments not allowed - will invert"),f*=-1),f<1&&(f=1);var g,h,i,j,k,l,m,n,o,p,q,r=!!a.openEnded,s=a.center,t=s?s[0]:0,u=s?s[1]:0,v=s?s[2]:0,w=d/2,x=d/f,y=2*Math.PI/e,z=1/e,A=(b-c)/f,B=[],C=[],D=[],E=[],F=(90-180*Math.atan(d/(c-b))/Math.PI)/90;for(g=0;g<=f;g++)for(k=b-g*A,l=w-g*x,h=0;h<=e;h++)i=Math.sin(h*y),j=Math.cos(h*y),C.push(k*i),C.push(F),C.push(k*j),D.push(h*z),D.push(1*g/f),B.push(k*i+t),B.push(l+u),B.push(k*j+v);for(g=0;g<f;g++)for(h=0;h<=e;h++)m=g*(e+1)+h,n=m+e,E.push(m),E.push(n),E.push(n+1),E.push(m),E.push(n+1),E.push(m+1);if(!r&&b>0){for(o=B.length/3,C.push(0),C.push(1),C.push(0),D.push(.5),D.push(.5),B.push(0+t),B.push(w+u),B.push(0+v),h=0;h<=e;h++)i=Math.sin(h*y),j=Math.cos(h*y),p=.5*Math.sin(h*y)+.5,q=.5*Math.cos(h*y)+.5,C.push(b*i),C.push(1),C.push(b*j),D.push(p),D.push(q),B.push(b*i+t),B.push(w+u),B.push(b*j+v);for(h=0;h<e;h++)s=o,m=o+1+h,E.push(m),E.push(m+1),E.push(s)}if(!r&&c>0){for(o=B.length/3,C.push(0),C.push(-1),C.push(0),D.push(.5),D.push(.5),B.push(0+t),B.push(0-w+u),B.push(0+v),h=0;h<=e;h++)i=Math.sin(h*y),j=Math.cos(h*y),p=.5*Math.sin(h*y)+.5,q=.5*Math.cos(h*y)+.5,C.push(c*i),C.push(-1),C.push(c*j),D.push(p),D.push(q),B.push(c*i+t),B.push(0-w+u),B.push(c*j+v);for(h=0;h<e;h++)s=o,m=o+1+h,E.push(s),E.push(m+1),E.push(m)}this._super(xeogl._apply(a,{positions:B,normals:C,uv:D,indices:E}))}})}(),function(){"use strict";xeogl.PlaneGeometry=xeogl.Geometry.extend({type:"xeogl.PlaneGeometry",_init:function(a){var b=a.xSize||1;b<0&&(this.error("negative xSize not allowed - will invert"),b*=-1);var c=a.zSize||1;c<0&&(this.error("negative zSize not allowed - will invert"),c*=-1);var d=a.xSegments||1;d<0&&(this.error("negative xSegments not allowed - will invert"),d*=-1),d<1&&(d=1);var e=a.xSegments||1;e<0&&(this.error("negative zSegments not allowed - will invert"),e*=-1),e<1&&(e=1);var f,g,h,i,j,k,l,m=a.center,n=m?m[0]:0,o=m?m[1]:0,p=m?m[2]:0,q=b/2,r=c/2,s=Math.floor(d)||1,t=Math.floor(e)||1,u=s+1,v=t+1,w=b/s,x=c/t,y=new Float32Array(u*v*3),z=new Float32Array(u*v*3),A=new Float32Array(u*v*2),B=0,C=0;for(f=0;f<v;f++){var D=f*x-r;for(g=0;g<u;g++)h=g*w-q,y[B]=h+n,y[B+1]=o,y[B+2]=-D+p,z[B+2]=-1,A[C]=(s-g)/s,A[C+1]=(t-f)/t,B+=3,C+=2}B=0;var E=new(y.length/3>65535?Uint32Array:Uint16Array)(s*t*6);for(f=0;f<t;f++)for(g=0;g<s;g++)i=g+u*f,j=g+u*(f+1),k=g+1+u*(f+1),l=g+1+u*f,E[B]=l,E[B+1]=j,E[B+2]=i,E[B+3]=l,E[B+4]=k,E[B+5]=j,B+=6;this._super(xeogl._apply(a,{positions:y,normals:z,uv:A,indices:E}))}})}(),function(){"use strict";xeogl.Input=xeogl.Component.extend({type:"xeogl.Input",serializable:!1,_init:function(a){var b=this;this._element=a.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.mouseover=!1,document.addEventListener("keydown",this._keyDownListener=function(a){b.enabled&&("INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!0:a.altKey?b.altDown=!0:(b.keyDown[a.keyCode]=!0,b.fire("keydown",a.keyCode,!0))),b.mouseover&&a.preventDefault())},!0),document.addEventListener("keyup",this._keyUpListener=function(a){b.enabled&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName&&(a.ctrlKey?b.ctrlDown=!1:a.altKey?b.altDown=!1:(b.keyDown[a.keyCode]=!1,b.fire("keyup",a.keyCode,!0)))}),a.element.addEventListener("mouseenter",this._mouseEnterListener=function(a){if(b.enabled){b.mouseover=!0;var c=b._getClickCoordsWithinElement(a);b.fire("mouseenter",c,!0)}}),a.element.addEventListener("mouseleave",this._mouseLeaveListener=function(a){if(b.enabled){b.mouseover=!1;var c=b._getClickCoordsWithinElement(a);b.fire("mouseleave",c,!0)}}),a.element.addEventListener("mousedown",this._mouseDownListener=function(c){if(b.enabled){switch(c.which){case 1:b.mouseDownLeft=!0;break;case 2:b.mouseDownMiddle=!0;break;case 3:b.mouseDownRight=!0}var d=b._getClickCoordsWithinElement(c);a.element.focus(),b.fire("mousedown",d,!0),b.mouseover&&c.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("mouseup",c,!0),b.mouseover&&a.preventDefault()}},!0),document.addEventListener("dblclick",this._dblClickListener=function(a){if(b.enabled){switch(a.which){case 1:b.mouseDownLeft=!1,b.mouseDownRight=!1;break;case 2:b.mouseDownMiddle=!1;break;case 3:b.mouseDownLeft=!1,b.mouseDownRight=!1}var c=b._getClickCoordsWithinElement(a);b.fire("dblclick",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("mousemove",this._mouseMoveListener=function(a){if(b.enabled){var c=b._getClickCoordsWithinElement(a);b.fire("mousemove",c,!0),b.mouseover&&a.preventDefault()}}),a.element.addEventListener("wheel",this._mouseWheelListener=function(a,c){if(b.enabled){var d=Math.max(-1,Math.min(1,40*-a.deltaY));b.fire("mousewheel",d,!0)}},{passive:!0}),function(){var a,c,d=2;b.on("mousedown",function(b){a=b[0],c=b[1]}),b.on("mouseup",function(e){a>=e[0]-d&&a<=e[0]+d&&c>=e[1]-d&&c<=e[1]+d&&b.fire("mouseclicked",e,!0)})}(),function(){var a,c,d={"landscape-primary":90,"landscape-secondary":-90,"portrait-secondary":180,"portrait-primary":0},e=xeogl.math.vec3(),f=xeogl.math.vec3(),g={orientation:null,orientationAngle:0},h={orientationAngle:0,acceleration:null,accelerationIncludingGravity:f,rotationRate:xeogl.math.vec3(),interval:0},i={alpha:0,beta:0,gamma:0,absolute:!1};window.OrientationChangeEvent&&window.addEventListener("orientationchange",b._orientationchangedListener=function(){a=window.screen.orientation||window.screen.mozOrientation||window.msOrientation||null,c=a?d[a]||0:0,g.orientation=a,g.orientationAngle=c,b.fire("orientationchange",g)},!1),window.DeviceMotionEvent&&window.addEventListener("devicemotion",b._deviceMotionListener=function(a){h.interval=a.interval,h.orientationAngle=c;var d=a.acceleration;d?(e[0]=d.x,e[1]=d.y,e[2]=d.z,h.acceleration=e):h.acceleration=null;var g=a.accelerationIncludingGravity;g?(f[0]=g.x,f[1]=g.y,f[2]=g.z,h.accelerationIncludingGravity=f):h.accelerationIncludingGravity=null,h.rotationRate=a.rotationRate,b.fire("devicemotion",h)},!1),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",b._deviceOrientListener=function(a){i.gamma=a.gamma,i.beta=a.beta,i.alpha=a.alpha,i.absolute=a.absolute,b.fire("deviceorientation",i)},!1)}()},_getClickCoordsWithinElement:function(a){var b=[0,0];if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b[0]=a.pageX-d,b[1]=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b},setEnabled:function(a){this.enabled!==a&&this.fire("enabled",this.enabled=a)},KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KEY_CTRL:17,KEY_ALT:18,KEY_PAUSE_BREAK:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT_ARROW:37,KEY_UP_ARROW:38,KEY_RIGHT_ARROW:39,KEY_DOWN_ARROW:40,KEY_INSERT:45,KEY_DELETE:46,KEY_NUM_0:48,KEY_NUM_1:49,KEY_NUM_2:50,KEY_NUM_3:51,KEY_NUM_4:52,KEY_NUM_5:53,KEY_NUM_6:54,KEY_NUM_7:55,KEY_NUM_8:56,KEY_NUM_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_LEFT_WINDOW:91,KEY_RIGHT_WINDOW:92,KEY_SELECT_KEY:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SUBTRACT:109,KEY_DECIMAL_POINT:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_NUM_LOCK:144,KEY_SCROLL_LOCK:145,KEY_SEMI_COLON:186,KEY_EQUAL_SIGN:187,KEY_COMMA:188,KEY_DASH:189,KEY_PERIOD:190,KEY_FORWARD_SLASH:191,KEY_GRAVE_ACCENT:192,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_SINGLE_QUOTE:222,KEY_SPACE:32,_destroy:function(){document.removeEventListener("keydown",this._keyDownListener),document.removeEventListener("keyup",this._keyUpListener),this._element.removeEventListener("mouseenter",this._mouseEnterListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("dblclick",this._dblClickListener),this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",this._deviceOrientListener)}})}(),function(){"use strict";xeogl.AmbientLight=xeogl.Component.extend({type:"xeogl.AmbientLight",_init:function(a){this._state={type:"ambient",color:xeogl.math.vec3([.7,.7,.7]),intensity:1},this.color=a.color,this.intensity=a.intensity,this.scene._lightCreated(this)},_props:{color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.setImageForceDirty()},get:function(){return this._state.color}},intensity:{set:function(a){this._state.intensity=void 0!==a?a:1,this._renderer.setImageForceDirty()},get:function(){return this._state.intensity}}},_destroy:function(){this.scene._lightDestroyed(this)}})}(),function(){"use strict";var a=xeogl.math;xeogl.DirLight=xeogl.Component.extend({type:"xeogl.DirLight",_init:function(b){var c=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.State({type:"dir",dir:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,space:b.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){var b=(a.vec3(),a.vec3([0,1,0]));return function(){if(c._shadowViewMatrixDirty){c._shadowViewMatrix||(c._shadowViewMatrix=a.identityMat4());var d=c._state.dir;a.lookAtMat4v([-d[0],-d[1],-d[2]],[0,0,0],b,c._shadowViewMatrix),c._shadowViewMatrixDirty=!1}return c._shadowViewMatrix}}(),getShadowProjMatrix:function(){return c._shadowProjMatrixDirty&&(c._shadowProjMatrix||(c._shadowProjMatrix=a.identityMat4()),xeogl.math.orthoMat4c(-10,10,-10,10,0,1e3,c._shadowProjMatrix),c._shadowProjMatrixDirty=!1),c._shadowProjMatrix},getShadowRenderBuf:function(){return c._shadowRenderBuf||(c._shadowRenderBuf=new xeogl.renderer.RenderBuffer(c.scene.canvas.canvas,c.scene.canvas.gl)),c._shadowRenderBuf}}),this.dir=b.dir,this.color=b.color,this.intensity=b.intensity,this.shadow=b.shadow,this.scene._lightCreated(this)},_props:{dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty()},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty()},get:function(){return this._state.intensity}},shadow:{set:function(a){a=!!a,this._state.shadow!==a&&(this._state.shadow=a,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty())},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}})}(),function(){"use strict";var a=xeogl.math;xeogl.PointLight=xeogl.Component.extend({type:"xeogl.PointLight",_init:function(b){var c=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.State({type:"point",pos:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:b.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){var b=a.vec3([0,0,0]),d=a.vec3([0,1,0]);return function(){return c._shadowViewMatrixDirty&&(c._shadowViewMatrix||(c._shadowViewMatrix=a.identityMat4()),a.lookAtMat4v(c._state.pos,b,d,c._shadowViewMatrix),c._shadowViewMatrixDirty=!1),c._shadowViewMatrix}}(),getShadowProjMatrix:function(){if(c._shadowProjMatrixDirty){c._shadowProjMatrix||(c._shadowProjMatrix=a.identityMat4());var b=c.scene.canvas.canvas;a.perspectiveMat4(Math.PI/180*70,b.clientWidth/b.clientHeight,.1,500,c._shadowProjMatrix),c._shadowProjMatrixDirty=!1}return c._shadowProjMatrix},getShadowRenderBuf:function(){return c._shadowRenderBuf||(c._shadowRenderBuf=new xeogl.renderer.RenderBuffer(c.scene.canvas.canvas,c.scene.canvas.gl)),c._shadowRenderBuf}}),this.pos=b.pos,this.color=b.color,this.intensity=b.intensity,this.constantAttenuation=b.constantAttenuation,this.linearAttenuation=b.linearAttenuation,this.quadraticAttenuation=b.quadraticAttenuation,this.shadow=b.shadow,this.scene._lightCreated(this)},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.pos}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty()},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty()},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[2]}},shadow:{set:function(a){a=!!a,this._state.shadow!==a&&(this._state.shadow=a,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty())},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}})}(),function(){"use strict";var a=xeogl.math;xeogl.SpotLight=xeogl.Component.extend({type:"xeogl.SpotLight",_init:function(b){var c=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0,this._state=new xeogl.renderer.State({type:"spot",pos:a.vec3([1,1,1]),dir:a.vec3([0,-1,0]),color:a.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:b.space||"view",shadow:!1,shadowDirty:!0,getShadowViewMatrix:function(){var b=a.vec3(),d=a.vec3([0,1,0]);return function(){return c._shadowViewMatrixDirty&&(c._shadowViewMatrix||(c._shadowViewMatrix=a.identityMat4()),a.addVec3(c._state.pos,c._state.dir,b),a.lookAtMat4v(c._state.pos,b,d,c._shadowViewMatrix),c._shadowViewMatrixDirty=!1),c._shadowViewMatrix}}(),getShadowProjMatrix:function(){if(c._shadowProjMatrixDirty){c._shadowProjMatrix||(c._shadowProjMatrix=a.identityMat4());var b=c.scene.canvas.canvas;a.perspectiveMat4(Math.PI/180*60,b.clientWidth/b.clientHeight,.1,400,c._shadowProjMatrix),c._shadowProjMatrixDirty=!1}return c._shadowProjMatrix},getShadowRenderBuf:function(){return c._shadowRenderBuf||(c._shadowRenderBuf=new xeogl.renderer.RenderBuffer(c.scene.canvas.canvas,c.scene.canvas.gl)),c._shadowRenderBuf}}),this.pos=b.pos,this.color=b.color,this.intensity=b.intensity,this.constantAttenuation=b.constantAttenuation,this.linearAttenuation=b.linearAttenuation,this.quadraticAttenuation=b.quadraticAttenuation,this.shadow=b.shadow,this.scene._lightCreated(this)},_props:{pos:{set:function(a){this._state.pos.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.pos}},dir:{set:function(a){this._state.dir.set(a||[1,1,1]),this._shadowViewMatrixDirty=!0,this._renderer.imageDirty()},get:function(){return this._state.dir}},color:{set:function(a){this._state.color.set(a||[.7,.7,.8]),this._renderer.imageDirty()},get:function(){return this._state.color}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty()},get:function(){return this._state.intensity}},constantAttenuation:{set:function(a){this._state.attenuation[0]=a||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[0]}},linearAttenuation:{set:function(a){this._state.attenuation[1]=a||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[1]}},quadraticAttenuation:{set:function(a){this._state.attenuation[2]=a||0,this._renderer.imageDirty()},get:function(){return this._state.attenuation[2]}},shadow:{set:function(a){a=!!a,this._state.shadow!==a&&(this._state.shadow=a,this._shadowViewMatrixDirty=!0,this._renderer.imageDirty(),this.fire("dirty",!0))},get:function(){return this._state.shadow}}},_destroy:function(){this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this)}})}(),function(){"use strict";xeogl.CubeTexture=xeogl.Component.extend({type:"xeogl.CubeTexture",_init:function(a){var b=this.scene.canvas.gl;this._state=new xeogl.renderer.State({texture:new xeogl.renderer.Texture2D(b,b.TEXTURE_CUBE_MAP),flipY:this._checkFlipY(a.minFilter),encoding:this._checkEncoding(a.encoding),minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._src=a.src,this._images=[],this._loadSrc(a.src),xeogl.stats.memory.textures++},_checkFlipY:function(a){return!!a},_checkEncoding:function(a){return a=a||"linear","linear"!==a&&"sRGB"!==a&&"gamma"!==a&&(this.error("Unsupported value for 'encoding': '"+a+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),a="linear"),a},_webglContextRestored:function(){this.scene.canvas.gl;this._state.texture=null,this._src&&this._loadSrc(this._src)},_loadSrc:function(a){var b=this,c=this.scene.canvas.gl;this._images=[];for(var d=!1,e=0,f=0;f<a.length;f++){var g=new Image;g.onload=function(){var a=g,h=f;return function(){if(!d&&(a=xeogl.renderer.ensureImageSizePowerOfTwo(a),b._images[h]=a,6===++e)){var f=b._state.texture;f||(f=new xeogl.renderer.Texture2D(c,c.TEXTURE_CUBE_MAP),b._state.texture=f),f.setImage(b._images,b._state),f.setProps(b._state),b.fire("loaded",b._src)}}}(),g.onerror=function(){d=!0},g.src=a[f]}},_destroy:function(){this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.LightMap=xeogl.CubeTexture.extend({type:"xeogl.LightMap",_init:function(a){this._super(a),this.scene._lightMapCreated(this)},_destroy:function(){this._super(),this.scene._lightMapDestroyed(this)}})}(),function(){"use strict";xeogl.ReflectionMap=xeogl.CubeTexture.extend({type:"xeogl.ReflectionMap",_init:function(a){this._super(a),this.scene._lightsState.addReflectionMap(this._state),this.scene._reflectionMapCreated(this)},_destroy:function(){this._super(),this.scene._reflectionMapDestroyed(this)}})}(),function(){"use strict";xeogl.Shadow=xeogl.Component.extend({type:"xeogl.Shadow",_init:function(a){this._state={resolution:xeogl.math.vec3([1e3,1e3]),intensity:1},this.resolution=a.resolution,this.intensity=a.intensity},_props:{resolution:{set:function(a){this._state.resolution.set(a||[1e3,1e3]),this._renderer.imageDirty(),this.fire("resolution",this._state.resolution)},get:function(){return this._state.resolution}},intensity:{set:function(a){a=void 0!==a?a:1,this._state.intensity=a,this._renderer.imageDirty(),this.fire("intensity",this._state.intensity)},get:function(){return this._state.intensity}}}})}(),function(){"use strict";xeogl.Model=xeogl.Group.extend({type:"xeogl.Model",_init:function(a){this.components={},this.numComponents=0,this.types={},this.objects={},this.guidObjects={},this.meshes={},this.entities={},this.entityTypes={},this._objectGUIDs=null,this._entityIds=null,this._super(a),this.scene._modelCreated(this)},_addComponent:function(a){var b;if(xeogl._isNumeric(a)||xeogl._isString(a)){if(!(a=this.scene.components[a]))return void this.warn("Component not found: "+xeogl._inQuotes(a))}else if(xeogl._isObject(a)){var c=a.type||"xeogl.Component";if(!xeogl._isComponentType(c))return void this.error("Not a xeogl component type: "+c);a=new window[c](this.scene,a)}if(a.scene!==this.scene)return void this.error("Attempted to add component from different xeogl.Scene: "+xeogl._inQuotes(a.id));if(!this.components[a.id]){if(a.model&&a.model.id!==this.id&&a.model._removeComponent(a),this.components[a.id]=a,b=this.types[a.type],b||(b=this.types[a.type]={}),b[a.id]=a,a.isType("xeogl.Object")){var d=a;if(this.objects[d.id]=d,d.entityType){this.entities[d.id]=d;var e=this.entityTypes[d.entityType];e||(e={},this.entityTypes[d.entityType]=e),e[d.id]=d,this._entityIds=null,this._entityTypeIds=null}d.guid&&(this.guidObjects[d.id]=d,this._objectGUIDs=null),a.isType("xeogl.Mesh")&&(this.meshes[a.id]=a)}return this.numComponents++,a._addedToModel(this),a}},_removeComponent:function(a){var b=a.id;if(delete this.components[b],delete this.meshes[b],delete this.objects[b],a.entityType){delete this.entities[b];var c=this.entityTypes[a.entityType];c&&delete c[b],this._entityIds=null,this._entityTypeIds=null}a.guid&&(delete this.guidObjects[a.guid],this._objectGUIDs=null)},clear:function(){for(var a in this.meshes)this.meshes.hasOwnProperty(a)&&this.meshes[a].destroy();for(var a in this.components)this.components.hasOwnProperty(a)&&this.components[a].destroy();this.components={},this.numComponents=0,this.types={},this.objects={},this.meshes={},this.entities={}},_props:{objectGUIDs:{get:function(){return this._objectGUIDs||(this._objectGUIDs=Object.keys(this.guidObjects)),this._objectGUIDs}},entityTypeIds:{get:function(){return this._entityTypeIds||(this._entityTypeIds=Object.keys(this.entityTypes)),this._entityTypeIds}},entityIds:{get:function(){return this._entityIds||(this._entityIds=Object.keys(this.entities)),this._entityIds}}},destroyAll:function(){this.clear()},_destroy:function(){this._super(),this.clear(),this.scene._modelDestroyed(this)}})}(),function(){"use strict";xeogl.Material=xeogl.Component.extend({type:"xeogl.Material",_init:function(){xeogl.stats.memory.materials++},_destroy:function(){xeogl.stats.memory.materials--}})}(),function(){"use strict";xeogl.PhongMaterial=xeogl.Material.extend({type:"xeogl.PhongMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"PhongMaterial",ambient:xeogl.math.vec3([1,1,1]),diffuse:xeogl.math.vec3([1,1,1]),specular:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=a.ambient,this.diffuse=a.diffuse,this.specular=a.specular,this.emissive=a.emissive,this.alpha=a.alpha,this.shininess=a.shininess,this.reflectivity=a.reflectivity,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,a.ambientMap&&(this._ambientMap=this._checkComponent("xeogl.Texture",a.ambientMap)),a.diffuseMap&&(this._diffuseMap=this._checkComponent("xeogl.Texture",a.diffuseMap)),a.specularMap&&(this._specularMap=this._checkComponent("xeogl.Texture",a.specularMap)),a.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",a.emissiveMap)),a.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",a.alphaMap)),a.reflectivityMap&&(this._reflectivityMap=this._checkComponent("xeogl.Texture",a.reflectivityMap)),a.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",a.normalMap)),a.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",a.occlusionMap)),
a.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("xeogl.Fresnel",a.diffuseFresnel)),a.specularFresnel&&(this._specularFresnel=this._checkComponent("xeogl.Fresnel",a.specularFresnel)),a.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("xeogl.Fresnel",a.emissiveFresnel)),a.alphaFresnel&&(this._alphaFresnel=this._checkComponent("xeogl.Fresnel",a.alphaFresnel)),a.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("xeogl.Fresnel",a.reflectivityFresnel)),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface,this._makeHash()},_makeHash:function(){var a=this._state,b=["/p"];this._normalMap&&(b.push("/nm"),this._normalMap.hasMatrix&&b.push("/mat")),this._ambientMap&&(b.push("/am"),this._ambientMap.hasMatrix&&b.push("/mat"),b.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(b.push("/dm"),this._diffuseMap.hasMatrix&&b.push("/mat"),b.push("/"+this._diffuseMap.encoding)),this._specularMap&&(b.push("/sm"),this._specularMap.hasMatrix&&b.push("/mat")),this._emissiveMap&&(b.push("/em"),this._emissiveMap.hasMatrix&&b.push("/mat"),b.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(b.push("/opm"),this._alphaMap.hasMatrix&&b.push("/mat")),this._reflectivityMap&&(b.push("/rm"),this._reflectivityMap.hasMatrix&&b.push("/mat")),this._occlusionMap&&(b.push("/ocm"),this._occlusionMap.hasMatrix&&b.push("/mat")),this._diffuseFresnel&&b.push("/df"),this._specularFresnel&&b.push("/sf"),this._emissiveFresnel&&b.push("/ef"),this._alphaFresnel&&b.push("/of"),this._reflectivityFresnel&&b.push("/rf"),b.push(";"),a.hash=b.join("")},_props:{ambient:{set:function(a){var b=this._state.ambient;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.ambient=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.ambient}},diffuse:{set:function(a){var b=this._state.diffuse;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.diffuse=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.diffuse}},specular:{set:function(a){var b=this._state.specular;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.specular=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.specular}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},shininess:{set:function(a){this._state.shininess=void 0!==a?a:80,this._renderer.imageDirty()},get:function(){return this._state.shininess}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}},reflectivity:{set:function(a){this._state.reflectivity=void 0!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.reflectivity}},normalMap:{get:function(){return this._normalMap}},ambientMap:{get:function(){return this._ambientMap}},diffuseMap:{get:function(){return this._diffuseMap}},specularMap:{get:function(){return this._specularMap}},emissiveMap:{get:function(){return this._emissiveMap}},alphaMap:{get:function(){return this._alphaMap}},reflectivityMap:{get:function(){return this._reflectivityMap}},occlusionMap:{get:function(){return this._occlusionMap}},diffuseFresnel:{get:function(){return this._diffuseFresnel}},specularFresnel:{get:function(){return this._specularFresnel}},emissiveFresnel:{get:function(){return this._emissiveFresnel}},alphaFresnel:{get:function(){return this._alphaFresnel}},reflectivityFresnel:{get:function(){return this._reflectivityFresnel}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" - defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty())},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.LambertMaterial=xeogl.Material.extend({type:"xeogl.LambertMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"LambertMaterial",ambient:xeogl.math.vec3([1,1,1]),color:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=a.ambient,this.color=a.color,this.emissive=a.emissive,this.alpha=a.alpha,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this.backfaces=a.backfaces,this.frontface=a.frontface},_props:{ambient:{set:function(a){var b=this._state.ambient;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.ambient=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.ambient}},color:{set:function(a){var b=this._state.color;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.color=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.color}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._state.alphaMode=a<1?2:0,this._renderer.imageDirty())},get:function(){return this._state.alpha}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}}},_getState:function(){return this._state},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.SpecularMaterial=xeogl.Material.extend({type:"xeogl.SpecularMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"SpecularMaterial",diffuse:xeogl.math.vec3([1,1,1]),emissive:xeogl.math.vec3([0,0,0]),specular:xeogl.math.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=a.diffuse,this.specular=a.specular,this.glossiness=a.glossiness,this.specularF0=a.specularF0,this.emissive=a.emissive,this.alpha=a.alpha,a.diffuseMap&&(this._diffuseMap=this._checkComponent("xeogl.Texture",a.diffuseMap)),a.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",a.emissiveMap)),a.specularMap&&(this._specularMap=this._checkComponent("xeogl.Texture",a.specularMap)),a.glossinessMap&&(this._glossinessMap=this._checkComponent("xeogl.Texture",a.glossinessMap)),a.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("xeogl.Texture",a.specularGlossinessMap)),a.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",a.occlusionMap)),a.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",a.alphaMap)),a.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",a.normalMap)),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this._makeHash()},_makeHash:function(){var a=this._state,b=["/spe"];this._diffuseMap&&(b.push("/dm"),this._diffuseMap.hasMatrix&&b.push("/mat"),b.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(b.push("/em"),this._emissiveMap.hasMatrix&&b.push("/mat")),this._glossinessMap&&(b.push("/gm"),this._glossinessMap.hasMatrix&&b.push("/mat")),this._specularMap&&(b.push("/sm"),this._specularMap.hasMatrix&&b.push("/mat")),this._specularGlossinessMap&&(b.push("/sgm"),this._specularGlossinessMap.hasMatrix&&b.push("/mat")),this._occlusionMap&&(b.push("/ocm"),this._occlusionMap.hasMatrix&&b.push("/mat")),this._normalMap&&(b.push("/nm"),this._normalMap.hasMatrix&&b.push("/mat")),this._alphaMap&&(b.push("/opm"),this._alphaMap.hasMatrix&&b.push("/mat")),b.push(";"),a.hash=b.join("")},_props:{diffuse:{set:function(a){var b=this._state.diffuse;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.diffuse=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.diffuse}},diffuseMap:{get:function(){return this._diffuseMap}},specular:{set:function(a){var b=this._state.specular;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.specular=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.specular}},specularMap:{get:function(){return this._specularMap}},specularGlossinessMap:{get:function(){return this._specularGlossinessMap}},glossiness:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.glossiness!==a&&(this._state.glossiness=a,this._renderer.imageDirty())},get:function(){return this._state.glossiness}},glossinessMap:{get:function(){return this._glossinessMap}},specularF0:{set:function(a){a=void 0!==a&&null!==a?a:0,this._state.specularF0!==a&&(this._state.specularF0=a,this._renderer.imageDirty())},get:function(){return this._state.specularF0}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},emissiveMap:{get:function(){return this._emissiveMap}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},alphaMap:{get:function(){return this._alphaMap}},normalMap:{get:function(){return this._normalMap}},occlusionMap:{get:function(){return this._occlusionMap}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty())},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.MetallicMaterial=xeogl.Material.extend({type:"xeogl.MetallicMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"MetallicMaterial",baseColor:xeogl.math.vec4([1,1,1]),emissive:xeogl.math.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=a.baseColor,this.metallic=a.metallic,this.roughness=a.roughness,this.specularF0=a.specularF0,this.emissive=a.emissive,this.alpha=a.alpha,a.baseColorMap&&(this._baseColorMap=this._checkComponent("xeogl.Texture",a.baseColorMap)),a.metallicMap&&(this._metallicMap=this._checkComponent("xeogl.Texture",a.metallicMap)),a.roughnessMap&&(this._roughnessMap=this._checkComponent("xeogl.Texture",a.roughnessMap)),a.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("xeogl.Texture",a.metallicRoughnessMap)),a.emissiveMap&&(this._emissiveMap=this._checkComponent("xeogl.Texture",a.emissiveMap)),a.occlusionMap&&(this._occlusionMap=this._checkComponent("xeogl.Texture",a.occlusionMap)),a.alphaMap&&(this._alphaMap=this._checkComponent("xeogl.Texture",a.alphaMap)),a.normalMap&&(this._normalMap=this._checkComponent("xeogl.Texture",a.normalMap)),this.alphaMode=a.alphaMode,this.alphaCutoff=a.alphaCutoff,this.backfaces=a.backfaces,this.frontface=a.frontface,this.lineWidth=a.lineWidth,this.pointSize=a.pointSize,this._makeHash()},_makeHash:function(){var a=this._state,b=["/met"];this._baseColorMap&&(b.push("/bm"),this._baseColorMap._state.hasMatrix&&b.push("/mat"),b.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(b.push("/mm"),this._metallicMap._state.hasMatrix&&b.push("/mat")),this._roughnessMap&&(b.push("/rm"),this._roughnessMap._state.hasMatrix&&b.push("/mat")),this._metallicRoughnessMap&&(b.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&b.push("/mat")),this._emissiveMap&&(b.push("/em"),this._emissiveMap._state.hasMatrix&&b.push("/mat")),this._occlusionMap&&(b.push("/ocm"),this._occlusionMap._state.hasMatrix&&b.push("/mat")),this._alphaMap&&(b.push("/am"),this._alphaMap._state.hasMatrix&&b.push("/mat")),this._normalMap&&(b.push("/nm"),this._normalMap._state.hasMatrix&&b.push("/mat")),b.push(";"),a.hash=b.join("")},_props:{baseColor:{set:function(a){var b=this._state.baseColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.baseColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=1,b[2]=1),this._renderer.imageDirty()},get:function(){return this._state.baseColor}},baseColorMap:{get:function(){return this._baseColorMap}},metallic:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.metallic!==a&&(this._state.metallic=a,this._renderer.imageDirty())},get:function(){return this._state.metallic}},metallicMap:{get:function(){return this._attached.metallicMap}},roughness:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.roughness!==a&&(this._state.roughness=a,this._renderer.imageDirty())},get:function(){return this._state.roughness}},roughnessMap:{get:function(){return this._attached.roughnessMap}},metallicRoughnessMap:{get:function(){return this._attached.metallicRoughnessMap}},specularF0:{set:function(a){a=void 0!==a&&null!==a?a:0,this._state.specularF0!==a&&(this._state.specularF0=a,this._renderer.imageDirty())},get:function(){return this._state.specularF0}},emissive:{set:function(a){var b=this._state.emissive;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.emissive=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=0,b[1]=0,b[2]=0),this._renderer.imageDirty()},get:function(){return this._state.emissive}},emissiveMap:{get:function(){return this._attached.emissiveMap}},occlusionMap:{get:function(){return this._attached.occlusionMap}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},alphaMap:{get:function(){return this._attached.alphaMap}},normalMap:{get:function(){return this._attached.normalMap}},alphaMode:function(){var a={opaque:0,mask:1,blend:2},b=["opaque","mask","blend"];return{set:function(b){b=b||"opaque";var c=a[b];void 0===c&&(this.error("Unsupported value for 'alphaMode': "+b+" defaulting to 'opaque'"),c="opaque"),this._state.alphaMode!==c&&(this._state.alphaMode=c,this._renderer.imageDirty())},get:function(){return b[this._state.alphaMode]}}}(),alphaCutoff:{set:function(a){null!==a&&void 0!==a||(a=.5),this._state.alphaCutoff!==a&&(this._state.alphaCutoff=a)},get:function(){return this._state.alphaCutoff}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},frontface:{set:function(a){a="cw"!==a,this._state.frontface!==a&&(this._state.frontface=a,this._renderer.imageDirty())},get:function(){return this._state.frontface?"ccw":"cw"}},lineWidth:{set:function(a){this._state.lineWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.lineWidth}},pointSize:{set:function(a){this._state.pointSize=a||1,this._renderer.imageDirty()},get:function(){return this._state.pointSize}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.EmphasisMaterial=xeogl.Material.extend({type:"xeogl.EmphasisMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"EmphasisMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,vertices:null,vertexColor:null,vertexAlpha:null,vertexSize:null,fill:null,fillColor:null,fillAlpha:null,backfaces:!0}),this._preset="default",a.preset?(this.preset=a.preset,void 0!==a.edges&&(this.edges=a.edges),a.edgeColor&&(this.edgeColor=a.edgeColor),void 0!==a.edgeAlpha&&(this.edgeAlpha=a.edgeAlpha),void 0!==a.edgeWidth&&(this.edgeWidth=a.edgeWidth),void 0!==a.vertices&&(this.vertices=a.vertices),a.vertexColor&&(this.vertexColor=a.vertexColor),void 0!==a.vertexAlpha&&(this.vertexAlpha=a.vertexAlpha),a.vertexSize&&(this.vertexSize=a.vertexSize),void 0!==a.fill&&(this.fill=a.fill),a.fillColor&&(this.fillColor=a.fillColor),void 0!==a.fillAlpha&&(this.fillAlpha=a.fillAlpha),void 0!==a.backfaces&&(this.backfaces=a.backfaces)):(this.edges=a.edges,this.edgeColor=a.edgeColor,this.edgeAlpha=a.edgeAlpha,this.edgeWidth=a.edgeWidth,this.vertices=a.vertices,this.vertexColor=a.vertexColor,this.vertexAlpha=a.vertexAlpha,this.vertexSize=a.vertexSize,this.fill=a.fill,this.fillColor=a.fillColor,this.fillAlpha=a.fillAlpha,this.backfaces=a.backfaces)},_props:{edges:{set:function(a){a=!1!==a,this._state.edges!==a&&(this._state.edges=a,this._renderer.imageDirty())},get:function(){return this._state.edges}},edgeColor:{set:function(a){var b=this._state.edgeColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.edgeColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},edgeAlpha:{set:function(a){a=void 0!==a&&null!==a?a:.5,this._state.edgeAlpha!==a&&(this._state.edgeAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.edgeAlpha}},edgeWidth:{set:function(a){this._state.edgeWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.edgeWidth}},vertices:{set:function(a){a=!!a,this._state.vertices!==a&&(this._state.vertices=a,this._renderer.imageDirty())},get:function(){return this._state.vertices}},vertexColor:{set:function(a){var b=this._state.vertexColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.vertexColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.4,b[1]=.4,b[2]=.4),this._renderer.imageDirty()},get:function(){return this._state.vertexColor}},vertexAlpha:{set:function(a){a=void 0!==a&&null!==a?a:.7,this._state.vertexAlpha!==a&&(this._state.vertexAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.vertexAlpha}},vertexSize:{set:function(a){this._state.vertexSize=a||4,this._renderer.imageDirty()},get:function(){return this._state.vertexSize}},fill:{set:function(a){a=!1!==a,this._state.fill!==a&&(this._state.fill=a,this._renderer.imageDirty())},get:function(){return this._state.fill}},fillColor:{set:function(a){var b=this._state.fillColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.fillColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.4,b[1]=.4,b[2]=.4),this._renderer.imageDirty()},get:function(){return this._state.fillColor}},fillAlpha:{set:function(a){a=void 0!==a&&null!==a?a:.2,this._state.fillAlpha!==a&&(this._state.fillAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.fillAlpha}},backfaces:{set:function(a){a=!!a,this._state.backfaces!==a&&(this._state.backfaces=a,this._renderer.imageDirty())},get:function(){return this._state.backfaces}},preset:{set:function(a){if(a=a||"default",this._preset!==a){var b=xeogl.EmphasisMaterial.presets[a];if(!b)return void this.error("unsupported preset: '"+a+"' - supported values are "+Object.keys(xeogl.EmphasisMaterial.presets).join(", "));this.edges=b.edges,this.edgeColor=b.edgeColor,this.edgeAlpha=b.edgeAlpha,this.edgeWidth=b.edgeWidth,this.vertices=b.vertices,this.vertexColor=b.vertexColor,this.vertexAlpha=b.vertexAlpha,this.vertexSize=b.vertexSize,this.fill=b.fill,this.fillColor=b.fillColor,this.fillAlpha=b.fillAlpha,this._preset=a}},get:function(){return this._preset}}},_destroy:function(){this._super(),this._state.destroy()}}),xeogl.EmphasisMaterial.presets={default:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[1,1,1],fillAlpha:.6},defaultLightBG:{edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},defaultDarkBG:{edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:4,fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2},phosphorous:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[0,0,0],fillAlpha:.4},sunset:{edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1,vertices:!1,vertexColor:[.4,.4,.4],vertexAlpha:.7,vertexSize:1,fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2},vectorscope:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2,vertices:!0,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:.7},battlezone:{edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3,vertices:!1,vertexColor:[.8,1,.8],vertexAlpha:.9,vertexSize:8,fill:!0,fillColor:[0,0,0],fillAlpha:1},sepia:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4},yellowHighlight:{edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[1,1,0],fillAlpha:.5},greenSelected:{edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[0,1,0],fillAlpha:.5},gamegrid:{edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3,vertices:!1,vertexColor:[.7,1,.7],vertexAlpha:.9,vertexSize:4,fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9}},xeogl.GhostMaterial=xeogl.EmphasisMaterial}(),function(){"use strict";xeogl.EdgeMaterial=xeogl.Material.extend({type:"xeogl.EdgeMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"EdgeMaterial",edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",a.preset?(this.preset=a.preset,a.edgeColor&&(this.edgeColor=a.edgeColor),void 0!==a.edgeAlpha&&(this.edgeAlpha=a.edgeAlpha),void 0!==a.edgeWidth&&(this.edgeWidth=a.edgeWidth)):(this.edgeColor=a.edgeColor,this.edgeAlpha=a.edgeAlpha,this.edgeWidth=a.edgeWidth)},_props:{edgeColor:{set:function(a){var b=this._state.edgeColor;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.edgeColor=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=.2,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},edgeAlpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.edgeAlpha!==a&&(this._state.edgeAlpha=a,this._renderer.imageDirty())},get:function(){return this._state.edgeAlpha}},edgeWidth:{set:function(a){this._state.edgeWidth=a||1,this._renderer.imageDirty()},get:function(){return this._state.edgeWidth}},preset:{set:function(a){if(a=a||"default",this._preset!==a){var b=xeogl.EdgeMaterial.presets[a];if(!b)return void this.error("unsupported preset: '"+a+"' - supported values are "+Object.keys(xeogl.EdgeMaterial.presets).join(", "));this.edgeColor=b.edgeColor,this.edgeAlpha=b.edgeAlpha,this.edgeWidth=b.edgeWidth,this._preset=a}},get:function(){return this._preset}}},_destroy:function(){this._super(),this._state.destroy()}}),xeogl.EdgeMaterial.presets={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}}}(),function(){"use strict";xeogl.OutlineMaterial=xeogl.Material.extend({type:"xeogl.OutlineMaterial",_init:function(a){this._super(a),this._state=new xeogl.renderer.State({type:"OutlineMaterial",color:null,alpha:null,width:null}),this.color=a.color,this.alpha=a.alpha,this.width=a.width},_props:{color:{set:function(a){var b=this._state.color;if(b){if(a&&b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2])return}else b=this._state.color=new Float32Array(3);a?(b[0]=a[0],b[1]=a[1],b[2]=a[2]):(b[0]=1,b[1]=.2,b[2]=.2),this._renderer.imageDirty()},get:function(){return this._state.color}},alpha:{set:function(a){a=void 0!==a&&null!==a?a:1,this._state.alpha!==a&&(this._state.alpha=a,this._renderer.imageDirty())},get:function(){return this._state.alpha}},width:{set:function(a){this._state.width=a||4,this._renderer.imageDirty()},get:function(){return this._state.width}}},_destroy:function(){this._super(),this._state.destroy()}})}(),function(){"use strict";xeogl.Texture=xeogl.Component.extend({type:"xeogl.Texture",_init:function(a){this._state=new xeogl.renderer.State({texture:new xeogl.renderer.Texture2D(this.scene.canvas.gl),matrix:xeogl.math.identityMat4(),hasMatrix:a.translate&&(0!==a.translate[0]||0!==a.translate[1])||!!a.rotate||a.scale&&(0!==a.scale[0]||0!==a.scale[1]),minFilter:this._checkMinFilter(a.minFilter),magFilter:this._checkMagFilter(a.minFilter),wrapS:this._checkWrapS(a.wrapS),wrapT:this._checkWrapT(a.wrapT),flipY:this._checkFlipY(a.flipY),encoding:this._checkEncoding(a.encoding)}),this._src=null,this._image=null,this._translate=xeogl.math.vec2([0,0]),this._scale=xeogl.math.vec2([1,1]),this._rotate=xeogl.math.vec2([0,0]),this._matrixDirty=!1,this.translate=a.translate,this.scale=a.scale,this.rotate=a.rotate,a.src?this.src=a.src:a.image&&(this.image=a.image),xeogl.stats.memory.textures++},_checkMinFilter:function(a){return a=a||"linearMipmapLinear","linear"!==a&&"linearMipmapNearest"!==a&&"linearMipmapLinear"!==a&&"nearestMipmapLinear"!==a&&"nearestMipmapNearest"!==a&&(this.error("Unsupported value for 'minFilter': '"+a+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),a="linearMipmapLinear"),a},_checkMagFilter:function(a){return a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),a},_checkFilter:function(a){return a=a||"linear","linear"!==a&&"nearest"!==a&&(this.error("Unsupported value for 'magFilter': '"+a+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),a="linear"),a},_checkWrapS:function(a){return a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapS': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),a},_checkWrapT:function(a){return a=a||"repeat","clampToEdge"!==a&&"mirroredRepeat"!==a&&"repeat"!==a&&(this.error("Unsupported value for 'wrapT': '"+a+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),a="repeat"),a},_checkFlipY:function(a){return!!a},_checkEncoding:function(a){return a=a||"linear","linear"!==a&&"sRGB"!==a&&"gamma"!==a&&(this.error("Unsupported value for 'encoding': '"+a+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),a="linear"),a},_webglContextRestored:function(){this._state.texture=new xeogl.renderer.Texture2D(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)},_update:function(){var a=this._state;if(this._matrixDirty){var b,c;0===this._translate[0]&&0===this._translate[1]||(b=xeogl.math.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(c=xeogl.math.scalingMat4v([this._scale[0],this._scale[1],1]),b=b?xeogl.math.mulMat4(b,c):c),0!==this._rotate&&(c=xeogl.math.rotationMat4v(.0174532925*this._rotate,[0,0,1]),b=b?xeogl.math.mulMat4(b,c):c),b&&(a.matrix=b),this._matrixDirty=!1}this._renderer.imageDirty()},_props:{image:{set:function(a){this._image=xeogl.renderer.ensureImageSizePowerOfTwo(a),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this._renderer.imageDirty()},get:function(){return this._image}},src:{set:function(a){this.scene.loading++,this.scene.canvas.spinner.processes++;var b=this,c=new Image;c.onload=function(){c=xeogl.renderer.ensureImageSizePowerOfTwo(c),b._state.texture.setImage(c,b._state),b._state.texture.setProps(b._state),b.scene.loading--,b.scene.canvas.spinner.processes--,b._renderer.imageDirty()},c.src=a,this._src=a,this._image=null},get:function(){return this._src}},translate:{set:function(a){this._translate.set(a||[0,0]),this._matrixDirty=!0,this._needUpdate()},get:function(){return this._translate}},scale:{set:function(a){this._scale.set(a||[1,1]),this._matrixDirty=!0,this._needUpdate()},get:function(){return this._scale}},rotate:{set:function(a){a=a||0,this._rotate!==a&&(this._rotate=a,this._matrixDirty=!0,this._needUpdate())},get:function(){return this._rotate}}},_destroy:function(){this._state.texture&&this._state.texture.destroy(),xeogl.stats.memory.textures--}})}(),function(){"use strict";xeogl.Fresnel=xeogl.Component.extend({
type:"xeogl.Fresnel",_init:function(a){this._state=new xeogl.renderer.State({edgeColor:xeogl.math.vec3([0,0,0]),centerColor:xeogl.math.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=a.edgeColor,this.centerColor=a.centerColor,this.edgeBias=a.edgeBias,this.centerBias=a.centerBias,this.power=a.power},_props:{edgeColor:{set:function(a){this._state.edgeColor.set(a||[0,0,0]),this._renderer.imageDirty()},get:function(){return this._state.edgeColor}},centerColor:{set:function(a){this._state.centerColor.set(a||[1,1,1]),this._renderer.imageDirty()},get:function(){return this._state.centerColor}},edgeBias:{set:function(a){this._state.edgeBias=a||0,this._renderer.imageDirty()},get:function(){return this._state.edgeBias}},centerBias:{set:function(a){this._state.centerBias=void 0!==a&&null!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.centerBias}},power:{set:function(a){this._state.power=void 0!==a&&null!==a?a:1,this._renderer.imageDirty()},get:function(){return this._state.power}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Viewport=xeogl.Component.extend({type:"xeogl.Viewport",_init:function(a){this._state=new xeogl.renderer.State({boundary:[0,0,100,100]}),this.boundary=a.boundary,this.autoBoundary=a.autoBoundary},_props:{boundary:{set:function(a){if(!this._autoBoundary){if(!a){var b=this.scene.canvas.boundary;a=[0,0,b[2],b[3]]}this._state.boundary=a,this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)}},get:function(){return this._state.boundary}},autoBoundary:{set:function(a){(a=!!a)!==this._autoBoundary&&(this._autoBoundary=a,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(a){var b=a[2],c=a[3];this._state.boundary=[0,0,b,c],this._renderer.imageDirty(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))},get:function(){return this._autoBoundary}}},_getState:function(){return this._state}})}(),function(){"use strict";var a=xeogl.math,b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.vec3(),g=a.vec3();xeogl.Camera=xeogl.Component.extend({type:"xeogl.Camera",_init:function(b){this._state=new xeogl.renderer.State({deviceMatrix:a.mat4(),hasDeviceMatrix:!1,matrix:a.mat4(),normalMatrix:a.mat4()}),this._perspective=new xeogl.Perspective(this),this._ortho=new xeogl.Ortho(this),this._frustum=new xeogl.Frustum(this),this._customProjection=new xeogl.CustomProjection(this),this._project=this._perspective;var c=this;this._eye=a.vec3([0,0,10]),this._look=a.vec3([0,0,0]),this._up=a.vec3([0,1,0]),this._worldUp=a.vec3([0,1,0]),this._worldRight=a.vec3([1,0,0]),this._worldForward=a.vec3([0,0,-1]),this.deviceMatrix=b.deviceMatrix,this.eye=b.eye,this.look=b.look,this.up=b.up,this.worldAxis=b.worldAxis,this.gimbalLock=b.gimbalLock,this.constrainPitch=b.constrainPitch,this.projection=b.projection,this._perspective.on("matrix",function(){"perspective"===c._projectionType&&c.fire("projMatrix",c._perspective.matrix)}),this._ortho.on("matrix",function(){"ortho"===c._projectionType&&c.fire("projMatrix",c._ortho.matrix)}),this._frustum.on("matrix",function(){"frustum"===c._projectionType&&c.fire("projMatrix",c._frustum.matrix)}),this._customProjection.on("matrix",function(){"customProjection"===c._projectionType&&c.fire("projMatrix",c._customProjection.matrix)})},_update:function(){var b=a.vec3(),c=a.vec3(),d=a.vec3(),e=a.vec3(),f=a.mat4();return function(){var g,h=this._state;"ortho"===this.projection?(a.subVec3(this._eye,this._look,b),a.normalizeVec3(b,c),a.mulVec3Scalar(c,1e3,d),a.addVec3(this._look,d,e),g=e):g=this._eye,h.hasDeviceMatrix?(a.lookAtMat4v(g,this._look,this._up,f),a.mulMat4(h.deviceMatrix,f,h.matrix)):a.lookAtMat4v(g,this._look,this._up,h.matrix),a.inverseMat4(this._state.matrix,this._state.normalMatrix),a.transposeMat4(this._state.normalMatrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}}(),orbitYaw:function(){var f=a.mat4();return function(g){var h=a.subVec3(this._eye,this._look,b);a.rotationMat4v(.0174532925*g,this._gimbalLock?this._worldUp:this._up,f),h=a.transformPoint3(f,h,c),this.eye=a.addVec3(this._look,h,d),this.up=a.transformPoint3(f,this._up,e)}}(),orbitPitch:function(){var h=a.mat4();return function(i){var j=a.subVec3(this._eye,this._look,b),k=a.cross3Vec3(a.normalizeVec3(j,c),a.normalizeVec3(this._up,d));a.rotationMat4v(.0174532925*i,k,h),j=a.transformPoint3(h,j,e);var l=a.transformPoint3(h,this._up,f);if(this._constrainPitch){var i=a.dotVec3(l,this._worldUp)/a.DEGTORAD;if(i<1)return}this.up=l,this.eye=a.addVec3(j,this._look,g)}}(),yaw:function(){var f=a.mat4();return function(g){var h=a.subVec3(this._look,this._eye,b);a.rotationMat4v(.0174532925*g,this._gimbalLock?this._worldUp:this._up,f),h=a.transformPoint3(f,h,c),this.look=a.addVec3(h,this._eye,d),this._gimbalLock&&(this.up=a.transformPoint3(f,this._up,e))}}(),pitch:function(){var h=a.mat4();return function(i){var j=a.subVec3(this._look,this._eye,b),k=a.cross3Vec3(a.normalizeVec3(j,c),a.normalizeVec3(this._up,d));a.rotationMat4v(.0174532925*i,k,h);var l=a.transformPoint3(h,this._up,g);if(this._constrainPitch){var i=a.dotVec3(l,this._worldUp)/a.DEGTORAD;if(i<1)return}this.up=l,j=a.transformPoint3(h,j,e),this.look=a.addVec3(j,this._eye,f)}}(),pan:function(h){var i,j=a.subVec3(this._eye,this._look,b),k=[0,0,0];if(0!==h[0]){var l=a.cross3Vec3(a.normalizeVec3(j,[]),a.normalizeVec3(this._up,c));i=a.mulVec3Scalar(l,h[0]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]}0!==h[1]&&(i=a.mulVec3Scalar(a.normalizeVec3(this._up,d),h[1]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),0!==h[2]&&(i=a.mulVec3Scalar(a.normalizeVec3(j,e),h[2]),k[0]+=i[0],k[1]+=i[1],k[2]+=i[2]),this.eye=a.addVec3(this._eye,k,f),this.look=a.addVec3(this._look,k,g)},zoom:function(f){var g=a.subVec3(this._eye,this._look,b),h=Math.abs(a.lenVec3(g,c)),i=Math.abs(h+f);if(!(i<.5)){var j=a.normalizeVec3(g,d);this.eye=a.addVec3(this._look,a.mulVec3Scalar(j,i),e)}},_props:{eye:{set:function(a){this._eye.set(a||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)},get:function(){return this._eye}},look:{set:function(a){this._look.set(a||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)},get:function(){return this._look}},up:{set:function(a){this._up.set(a||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)},get:function(){return this._up}},deviceMatrix:{set:function(a){this._state.deviceMatrix.set(a||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!a,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)},get:function(){return this._state.deviceMatrix}},worldAxis:{set:function(a){a=a||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(a):this._worldAxis=new Float32Array(a),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)},get:function(){return this._worldAxis}},worldUp:{get:function(){return this._worldUp}},worldRight:{get:function(){return this._worldRight}},worldForward:{get:function(){return this._worldForward}},gimbalLock:{set:function(a){this._gimbalLock=!1!==a,this.fire("gimbalLock",this._gimbalLock)},get:function(){return this._gimbalLock}},constrainPitch:{set:function(a){this._constrainPitch=!!a,this.fire("constrainPitch",this._constrainPitch)},get:function(){return this._constrainPitch}},eyeLookDist:{get:function(){var b=new Float32Array(3);return function(){return a.lenVec3(a.subVec3(this._look,this._eye,b))}}()},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},viewMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}},normalMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},viewNormalMatrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}},projMatrix:{get:function(){return this[this.projection].matrix}},perspective:{get:function(){return this._perspective}},ortho:{get:function(){return this._ortho}},frustum:{get:function(){return this._frustum}},customProjection:{get:function(){return this._customProjection}},projection:{set:function(a){a=a||"perspective",this._projectionType!==a&&("perspective"===a?this._project=this._perspective:"ortho"===a?this._project=this._ortho:"frustum"===a?this._project=this._frustum:"customProjection"===a?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+a+" defaulting to 'perspective'"),this._project=this._perspective,a="perspective"),this._projectionType=a,this._renderer.imageDirty(),this._update(),this.fire("dirty"))},get:function(){return this._projectionType}},project:{get:function(){return this._project}},view:{get:function(){return this}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Frustum=xeogl.Component.extend({type:"xeogl.Frustum",_init:function(a){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._near=.1,this._far=5e3,this.left=a.left,this.right=a.right,this.bottom=a.bottom,this.top=a.top,this.near=a.near,this.far=a.far},_update:function(){xeogl.math.frustumMat4(this._left,this._right,this._bottom,this._top,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{left:{set:function(a){this._left=void 0!==a&&null!==a?a:-1,this._needUpdate(),this.fire("left",this._left)},get:function(){return this._left}},right:{set:function(a){this._right=void 0!==a&&null!==a?a:1,this._needUpdate(),this.fire("right",this._right)},get:function(){return this._right}},top:{set:function(a){this._top=void 0!==a&&null!==a?a:1,this._needUpdate(),this.fire("top",this._top)},get:function(){return this._top}},bottom:{set:function(a){this._bottom=void 0!==a&&null!==a?a:-1,this._needUpdate(),this.fire("bottom",this._bottom)},get:function(){return this._bottom}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._state.destroy()}})}(),function(){"use strict";xeogl.Ortho=xeogl.Component.extend({type:"xeogl.Ortho",_init:function(a){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this.scale=a.scale,this.near=a.near,this.far=a.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)},_update:function(){const a=2,b=3;var c,d,e,f,g=this.scene,h=this._scale,i=.5*h,j=g.viewport.boundary,k=j[a],l=j[b],m=k/l;k>l?(c=-i,d=i,e=i/m,f=-i/m):(c=-i*m,d=i*m,e=i,f=-i),xeogl.math.orthoMat4c(c,d,f,e,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{scale:{set:function(a){void 0!==a&&null!==a||(a=1),a<=0&&(a=.01),this._scale=a,this._needUpdate(),this.fire("scale",this._scale)},get:function(){return this._scale}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}})}(),function(){"use strict";xeogl.Perspective=xeogl.Component.extend({type:"xeogl.Perspective",_init:function(a){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this._dirty=!1,this._fov=60,this._near=.1,this._far=1e4,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=a.fov,this.fovAxis=a.fovAxis,this.near=a.near,this.far=a.far},_update:function(){const a=2,b=3;var c=this.scene.viewport.boundary,d=c[a]/c[b],e=this._fov,f=this._fovAxis;("x"==f||"min"==f&&d<1||"max"==f&&d>1)&&(e/=d),e=Math.min(e,120),xeogl.math.perspectiveMat4(e*(Math.PI/180),d,this._near,this._far,this._state.matrix),this._renderer.imageDirty(),this.fire("matrix",this._state.matrix)},_props:{fov:{set:function(a){this._fov=void 0!==a&&null!==a?a:60,this._needUpdate(0),this.fire("fov",this._fov)},get:function(){return this._fov}},fovAxis:{set:function(a){a=a||"min",this._fovAxis!==a&&("x"!==a&&"y"!==a&&"min"!==a&&(this.error("Unsupported value for 'fovAxis': "+a+" - defaulting to 'min'"),a="min"),this._fovAxis=a,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))},get:function(){return this._fovAxis}},near:{set:function(a){this._near=void 0!==a&&null!==a?a:.1,this._needUpdate(0),this.fire("near",this._near)},get:function(){return this._near}},far:{set:function(a){this._far=void 0!==a&&null!==a?a:1e4,this._needUpdate(0),this.fire("far",this._far)},get:function(){return this._far}},matrix:{get:function(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}}},_destroy:function(){this._state.destroy(),this.scene.canvas.off(this._canvasResized)}})}(),function(){"use strict";xeogl.CustomProjection=xeogl.Component.extend({type:"xeogl.CustomProjection",_init:function(a){this._state=new xeogl.renderer.State({matrix:xeogl.math.mat4()}),this.matrix=a.matrix},_props:{matrix:{set:function(a){this._state.matrix.set(a||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.fire("far",this._state.matrix)},get:function(){return this._state.matrix}}},_destroy:function(){this._state.destroy()}})}(),xeogl.version="0.8";